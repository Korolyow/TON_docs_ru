<html>

<head>
<meta http-equiv=Content-Type content="text/html; charset=utf-8">
<meta name=Generator content="Microsoft Word 15 (filtered)">
<title>Telegram Открытая сеть Блокчейн</title>
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Helvetica;
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:Courier;
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Tms Rmn";
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:Helv;
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"New York";
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:System;
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"MS Mincho";
	panose-1:2 2 6 9 4 2 5 8 3 4;}
@font-face
	{font-family:Batang;
	panose-1:2 3 6 0 0 1 1 1 1 1;}
@font-face
	{font-family:SimSun;
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:PMingLiU;
	panose-1:2 2 5 0 0 0 0 0 0 0;}
@font-face
	{font-family:"MS Gothic";
	panose-1:2 11 6 9 7 2 5 8 2 4;}
@font-face
	{font-family:Dotum;
	panose-1:2 11 6 0 0 1 1 1 1 1;}
@font-face
	{font-family:SimHei;
	panose-1:2 1 6 9 6 1 1 1 1 1;}
@font-face
	{font-family:MingLiU;
	panose-1:2 2 5 9 0 0 0 0 0 0;}
@font-face
	{font-family:Mincho;
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:Gulim;
	panose-1:2 11 6 0 0 1 1 1 1 1;}
@font-face
	{font-family:Century;
	panose-1:2 4 6 4 5 5 5 2 3 4;}
@font-face
	{font-family:"Angsana New";
	panose-1:2 2 6 3 5 4 5 2 3 4;}
@font-face
	{font-family:"Cordia New";
	panose-1:2 11 3 4 2 2 2 2 2 4;}
@font-face
	{font-family:Mangal;
	panose-1:2 4 5 3 5 2 3 3 2 2;}
@font-face
	{font-family:Latha;
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:Sylfaen;
	panose-1:1 10 5 2 5 3 6 3 3 3;}
@font-face
	{font-family:Vrinda;
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:Raavi;
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:Shruti;
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:Sendnya;
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:Gautami;
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:Tunga;
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:"Estrangelo Edessa";
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:"Yu Gothic";
	panose-1:2 11 4 0 0 0 0 0 0 0;}
@font-face
	{font-family:DengXian;
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
@font-face
	{font-family:"Calibri Light";
	panose-1:2 15 3 2 2 2 4 3 2 4;}
@font-face
	{font-family:"Palatino Linotype";
	panose-1:2 4 5 2 5 5 5 3 3 4;}
@font-face
	{font-family:Verdana;
	panose-1:2 11 6 4 3 5 4 4 2 4;}
@font-face
	{font-family:"Arial Unicode MS";
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:Cambria;
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Tahoma;
	panose-1:2 11 6 4 3 5 4 4 2 4;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:10.65pt;
	margin-left:.5pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-.5pt;
	line-height:104%;
	font-size:12.0pt;
	font-family:"Calibri",sans-serif;
	color:black;}
h1
	{mso-style-link:"Заголовок 1 Знак";
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:4.45pt;
	margin-left:.5pt;
	text-indent:-.5pt;
	line-height:107%;
	page-break-after:avoid;
	font-size:17.0pt;
	font-family:"Calibri",sans-serif;
	color:black;
	font-weight:normal;}
h2
	{mso-style-link:"Заголовок 2 Знак";
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:4.05pt;
	margin-left:.5pt;
	text-indent:-.5pt;
	line-height:107%;
	page-break-after:avoid;
	font-size:14.5pt;
	font-family:"Calibri",sans-serif;
	color:black;
	font-weight:normal;}
p.MsoToc1, li.MsoToc1, div.MsoToc1
	{margin-top:0cm;
	margin-right:.75pt;
	margin-bottom:.25pt;
	margin-left:1.25pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-.5pt;
	line-height:110%;
	font-size:12.0pt;
	font-family:"Calibri",sans-serif;
	color:black;}
p.MsoToc2, li.MsoToc2, div.MsoToc2
	{margin-top:0cm;
	margin-right:.75pt;
	margin-bottom:8.0pt;
	margin-left:18.8pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-.5pt;
	line-height:104%;
	font-size:12.0pt;
	font-family:"Calibri",sans-serif;
	color:black;}
p.MsoAcetate, li.MsoAcetate, div.MsoAcetate
	{mso-style-link:"Текст выноски Знак";
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:.5pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-.5pt;
	font-size:8.0pt;
	font-family:"Tahoma",sans-serif;
	color:black;}
span.MsoPlaceholderText
	{color:gray;}
p.MsoListParagraph, li.MsoListParagraph, div.MsoListParagraph
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:10.65pt;
	margin-left:36.0pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-.5pt;
	line-height:104%;
	font-size:12.0pt;
	font-family:"Calibri",sans-serif;
	color:black;}
p.MsoListParagraphCxSpFirst, li.MsoListParagraphCxSpFirst, div.MsoListParagraphCxSpFirst
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:36.0pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-.5pt;
	line-height:104%;
	font-size:12.0pt;
	font-family:"Calibri",sans-serif;
	color:black;}
p.MsoListParagraphCxSpMiddle, li.MsoListParagraphCxSpMiddle, div.MsoListParagraphCxSpMiddle
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:36.0pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-.5pt;
	line-height:104%;
	font-size:12.0pt;
	font-family:"Calibri",sans-serif;
	color:black;}
p.MsoListParagraphCxSpLast, li.MsoListParagraphCxSpLast, div.MsoListParagraphCxSpLast
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:10.65pt;
	margin-left:36.0pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-.5pt;
	line-height:104%;
	font-size:12.0pt;
	font-family:"Calibri",sans-serif;
	color:black;}
p.footnotedescription, li.footnotedescription, div.footnotedescription
	{mso-style-name:"footnote description";
	mso-style-link:"footnote description Char";
	margin:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:9.5pt;
	line-height:107%;
	font-size:10.0pt;
	font-family:"Calibri",sans-serif;
	color:black;}
span.footnotedescriptionChar
	{mso-style-name:"footnote description Char";
	mso-style-link:"footnote description";
	font-family:"Calibri",sans-serif;
	color:black;}
span.2
	{mso-style-name:"Заголовок 2 Знак";
	mso-style-link:"Заголовок 2";
	font-family:"Calibri",sans-serif;
	color:black;}
span.1
	{mso-style-name:"Заголовок 1 Знак";
	mso-style-link:"Заголовок 1";
	font-family:"Calibri",sans-serif;
	color:black;}
span.footnotemark
	{mso-style-name:"footnote mark";
	font-family:"Calibri",sans-serif;
	color:black;
	vertical-align:super;}
span.a
	{mso-style-name:"Текст выноски Знак";
	mso-style-link:"Текст выноски";
	font-family:"Tahoma",sans-serif;
	color:black;}
span.msoIns
	{mso-style-name:"";
	text-decoration:underline;
	color:teal;}
span.msoDel
	{mso-style-name:"";
	text-decoration:line-through;
	color:red;}
.MsoChpDefault
	{font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
.MsoPapDefault
	{margin-bottom:8.0pt;
	line-height:107%;}
 /* Page Definitions */
 @page WordSection1
	{size:612.0pt 792.0pt;
	margin:91.5pt 110.6pt 114.65pt 110.85pt;}
div.WordSection1
	{page:WordSection1;}
@page WordSection2
	{size:612.0pt 792.0pt;
	margin:129.05pt 112.6pt 114.25pt 110.85pt;}
div.WordSection2
	{page:WordSection2;}
@page WordSection3
	{size:612.0pt 792.0pt;
	margin:132.7pt 112.6pt 114.25pt 110.85pt;}
div.WordSection3
	{page:WordSection3;}
@page WordSection4
	{size:612.0pt 792.0pt;
	margin:132.7pt 110.1pt 114.2pt 110.85pt;}
div.WordSection4
	{page:WordSection4;}
@page WordSection5
	{size:612.0pt 792.0pt;
	margin:89.75pt 105.1pt 116.7pt 110.85pt;}
div.WordSection5
	{page:WordSection5;}
@page WordSection6
	{size:612.0pt 792.0pt;
	margin:132.7pt 112.6pt 114.25pt 110.85pt;}
div.WordSection6
	{page:WordSection6;}
@page WordSection7
	{size:612.0pt 792.0pt;
	margin:132.7pt 112.6pt 116.75pt 110.85pt;}
div.WordSection7
	{page:WordSection7;}
@page WordSection8
	{size:612.0pt 792.0pt;
	margin:132.7pt 112.6pt 114.25pt 110.85pt;}
div.WordSection8
	{page:WordSection8;}
@page WordSection9
	{size:612.0pt 792.0pt;
	margin:129.05pt 112.55pt 114.65pt 110.85pt;}
div.WordSection9
	{page:WordSection9;}
@page WordSection10
	{size:612.0pt 792.0pt;
	margin:132.7pt 112.6pt 114.65pt 110.85pt;}
div.WordSection10
	{page:WordSection10;}
@page WordSection11
	{size:612.0pt 792.0pt;
	margin:132.45pt 112.6pt 114.25pt 110.85pt;}
div.WordSection11
	{page:WordSection11;}
@page WordSection12
	{size:612.0pt 792.0pt;
	margin:129.05pt 107.5pt 114.6pt 110.85pt;}
div.WordSection12
	{page:WordSection12;}
@page WordSection13
	{size:612.0pt 792.0pt;
	margin:132.7pt 105.35pt 114.25pt 110.85pt;}
div.WordSection13
	{page:WordSection13;}
@page WordSection14
	{size:612.0pt 792.0pt;
	margin:132.6pt 112.15pt 116.75pt 110.85pt;}
div.WordSection14
	{page:WordSection14;}
@page WordSection15
	{size:612.0pt 792.0pt;
	margin:129.05pt 108.35pt 114.25pt 110.85pt;}
div.WordSection15
	{page:WordSection15;}
@page WordSection16
	{size:612.0pt 792.0pt;
	margin:132.6pt 104.4pt 114.25pt 110.85pt;}
div.WordSection16
	{page:WordSection16;}
@page WordSection17
	{size:612.0pt 792.0pt;
	margin:132.55pt 112.6pt 114.25pt 110.85pt;}
div.WordSection17
	{page:WordSection17;}
@page WordSection18
	{size:612.0pt 792.0pt;
	margin:132.7pt 110.65pt 114.25pt 110.85pt;}
div.WordSection18
	{page:WordSection18;}
@page WordSection19
	{size:612.0pt 792.0pt;
	margin:129.05pt 112.6pt 113.9pt 110.85pt;}
div.WordSection19
	{page:WordSection19;}
@page WordSection20
	{size:612.0pt 792.0pt;
	margin:132.65pt 104.45pt 113.9pt 110.85pt;}
div.WordSection20
	{page:WordSection20;}
@page WordSection21
	{size:612.0pt 792.0pt;
	margin:132.25pt 112.6pt 114.65pt 110.85pt;}
div.WordSection21
	{page:WordSection21;}
@page WordSection22
	{size:612.0pt 792.0pt;
	margin:88.5pt 112.6pt 114.05pt 110.85pt;}
div.WordSection22
	{page:WordSection22;}
@page WordSection23
	{size:612.0pt 792.0pt;
	margin:89.75pt 108.25pt 84.35pt 110.85pt;}
div.WordSection23
	{page:WordSection23;}
@page WordSection24
	{size:612.0pt 792.0pt;
	margin:132.7pt 112.6pt 114.25pt 110.85pt;}
div.WordSection24
	{page:WordSection24;}
 /* List Definitions */
 ol
	{margin-bottom:0cm;}
ul
	{margin-bottom:0cm;}
-->
</style>

</head>

<body lang=ru-UA style='word-wrap:break-word'>

<div class=WordSection1>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:2.0pt;
margin-bottom:8.25pt;margin-left:0cm;text-align:center;text-indent:0cm;
line-height:107%'><span lang=EN-US style='font-size:20.5pt;line-height:107%'>Telegram
Open Network Blockchain</span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:127.65pt;
margin-bottom:16.1pt;margin-left:125.6pt;text-align:center;text-indent:0cm;
line-height:159%'><span lang=RU style='font-size:14.5pt;line-height:159%'>Николай</span><span
lang=RU style='font-size:14.5pt;line-height:159%'> </span><span lang=RU
style='font-size:14.5pt;line-height:159%'>Дуров</span><span lang=RU
style='font-size:14.5pt;line-height:159%'> </span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:127.65pt;
margin-bottom:16.1pt;margin-left:125.6pt;text-align:center;text-indent:0cm;
line-height:159%'><span lang=RU style='font-size:14.5pt;line-height:159%'>8
февраля 2020</span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:2.0pt;
margin-bottom:5.9pt;margin-left:0cm;text-align:center;text-indent:0cm;
line-height:107%'><span lang=RU style='font-size:11.0pt;line-height:107%'>Аннотация</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:26.4pt;margin-left:29.25pt;text-align:left;text-indent:16.25pt;
line-height:101%'><span lang=RU style='font-size:11.0pt;line-height:101%'>Целью
этого текста является предоставление подробного описания блокчейна </span><span
lang=EN-US style='font-size:11.0pt;line-height:101%'>Telegram</span><span
lang=EN-US style='font-size:11.0pt;line-height:101%'> </span><span lang=EN-US
style='font-size:11.0pt;line-height:101%'>Open</span><span lang=EN-US
style='font-size:11.0pt;line-height:101%'> </span><span lang=EN-US
style='font-size:11.0pt;line-height:101%'>Network</span><span lang=RU
style='font-size:11.0pt;line-height:101%'> (</span><span lang=EN-US
style='font-size:11.0pt;line-height:101%'>TON</span><span lang=RU
style='font-size:11.0pt;line-height:101%'>).</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:4.45pt;margin-left:-.25pt;text-align:left;line-height:107%'><span
lang=RU style='font-size:17.0pt;line-height:107%'>Знакомство</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.9pt;
margin-left:-.25pt'><span lang=RU>Этот документ содержит подробное описание
блокчейна </span><span lang=EN-US>TON</span><span lang=RU>, включая его точный
формат блока, условия действия, сведения о вызове виртуальной машины </span><span
lang=EN-US>TON</span><span lang=RU> (</span><span lang=EN-US>TVM</span><span
lang=RU>), процесс создания смарт-контракта и криптографические подписи. В этом
отношении он является продолжением технического документа </span><span
lang=EN-US>TON</span><span lang=RU> (см. [3]), поэтому мы свободно используем
терминологию, представленную в этом документе.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>В главе 1 представлен
общий обзор блокчейна </span><span lang=EN-US>TON</span><span lang=RU> и
принципов его проектирования, с особым вниманием к введению условий
совместимости и валидности и реализации гарантий доставки сообщений. Более
подробная информация, такая как схемы </span><span lang=EN-US>TL</span><span
lang=RU>-</span><span lang=EN-US>B</span><span lang=RU>, которые описывают
сериализацию всех необходимых структур данных в деревья или коллекции («мешки»)
ячеек, представлена в последующих главах, кульминацией которых является полное
описание макета блоков </span><span lang=EN-US>TON</span><span lang=EN-US> </span><span
lang=EN-US>Blockchain</span><span lang=RU> (</span><span lang=EN-US>shardchain</span><span
lang=RU> и </span><span lang=EN-US>masterchain</span><span lang=RU>) в главе 5.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.05pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Подробное описание
криптографии эллиптической кривой, используемой для подписи блоков и сообщений,
также доступной через примитивы </span><span lang=EN-US>TVM</span><span
lang=RU>, приведено в Приложении А. Сам </span><span lang=EN-US>TVM</span><span
lang=RU> описан в отдельном документе (ср. [4]).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:24.85pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Некоторые темы намеренно
были исключены из этого документа. Одним из них является византийский
отказоустойчивый протокол (</span><span lang=EN-US>BFT</span><span lang=RU>),
используемый валидаторами для определения следующего блока мастерчейна или
шардчейна; эта тема оставлена для предстоящего документа, посвященного сети </span><span
lang=EN-US>TON</span><span lang=RU>. И хотя этот документ описывает точный
формат блоков </span><span lang=EN-US>TON</span><span lang=EN-US> </span><span
lang=EN-US>Blockchain</span><span lang=RU> и обсуждает условия валидности
блокчейна и сериализованные доказательства недействительности, </span><a
href="#_ftn1" name="_ftnref1" title=""><sup><span lang=EN-US><sup><span
lang=EN-US style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'>[1]</span></sup></span></sup></a><span lang=RU>он не предоставляет
никаких подробностей о сетевых протоколах, используемых для распространения
этих блоков, кандидатов на блоки, сопоставленных блоков и доказательств
недействительности.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Аналогичным образом, этот
документ не предоставляет полный исходный код смарт-контрактов </span><span
lang=EN-US>masterchain</span><span lang=RU>, используемых для выбора
валидаторов, изменения настраиваемых параметров или получения их текущих
значений, или наказания валидаторов за их неправильное поведение, хотя эти
смарт-контракты составляют важную часть общего состояния блокчейна и нулевого
блока мастерчейна. Вместо этого в этом документе описывается местоположение
этих смарт-контрактов и их формальных интерфейсов.</span><a href="#_ftn2"
name="_ftnref2" title=""><sup><span lang=EN-US><sup><span lang=EN-US
style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'>[2]</span></sup></span></sup></a><sup><span lang=EN-US> </span></sup><span
lang=RU>Исходный код этих смарт-контрактов будет предоставлен отдельно в виде
загружаемых файлов с комментариями.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Обратите внимание, что
текущая версия этого документа описывает предварительную тестовую версию
блокчейна </span><span lang=EN-US>TON</span><span lang=RU>; некоторые
незначительные детали могут измениться перед запуском на этапах разработки,
тестирования и развертывания.<br clear=all style='page-break-before:always'>
</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:0cm;margin-left:-.25pt;text-align:left;line-height:107%'><span
lang=EN-US style='font-size:17.0pt;line-height:107%'>Содержание</span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc150756"><span style='color:
black;text-decoration:none'>1 Обзор................................................................................................................. </span><span style='color:black;text-decoration:none'>4</span></a></span></p>

<p class=MsoToc2><span lang=EN-US><a href="#_Toc150757"><span style='color:
black;text-decoration:none'>1.1 Все представляет собой мешок ячеек................................................... </span><span style='color:black;text-decoration:none'>4</span></a></span></p>

<p class=MsoToc2><span lang=EN-US><a href="#_Toc150758"><span style='color:
black;text-decoration:none'>1.2 Основные компоненты блока и состояние блокчейна........................ </span><span style='color:black;text-decoration:none'>7</span></a></span></p>

<p class=MsoToc2><span lang=EN-US><a href="#_Toc150759"><span style='color:
black;text-decoration:none'>1.3 Условия консистенции.......................................................................... </span><span style='color:black;text-decoration:none'>12</span></a></span></p>

<p class=MsoToc2><span lang=EN-US><a href="#_Toc150760"><span style='color:
black;text-decoration:none'>1.4 Логическое время и логические временные
интервалы................... </span><span
style='color:black;text-decoration:none'>21</span></a></span></p>

<p class=MsoToc2><span lang=EN-US><a href="#_Toc150761"><span style='color:
black;text-decoration:none'>1.5 Общее состояние блокчейна................................................................ </span><span style='color:black;text-decoration:none'>23</span></a></span></p>

<p class=MsoToc2><span lang=EN-US><a href="#_Toc150762"><span style='color:
black;text-decoration:none'>1.6 Настраиваемые параметры и смарт-контракты................................. </span><span style='color:black;text-decoration:none'>24</span></a></span></p>

<p class=MsoToc2><span lang=EN-US><a href="#_Toc150763"><span style='color:
black;text-decoration:none'>1.7 Новые смарт-контракты и их адреса................................................... </span><span style='color:black;text-decoration:none'>27</span></a></span></p>

<p class=MsoToc2><span lang=EN-US><a href="#_Toc150764"><span style='color:
black;text-decoration:none'>1.8 Изменение и удаление смарт-контрактов.......................................... </span><span style='color:black;text-decoration:none'>30</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc150765"><span style='color:
black;text-decoration:none'>2 Гарантии пересылки и доставки сообщений............................................... </span><span style='color:black;text-decoration:none'>33</span></a></span></p>

<p class=MsoToc2><span lang=EN-US><a href="#_Toc150766"><span style='color:
black;text-decoration:none'>2.1 Адреса сообщений и вычисления следующего прыжка................... </span><span style='color:black;text-decoration:none'>33</span></a></span></p>

<p class=MsoToc2><span lang=EN-US><a href="#_Toc150767"><span style='color:
black;text-decoration:none'>2.2 Протокол маршрутизации гиперкубов................................................ </span><span style='color:black;text-decoration:none'>40</span></a></span></p>

<p class=MsoToc2><span lang=EN-US><a href="#_Toc150768"><span style='color:
black;text-decoration:none'>2.3 Мгновенная маршрутизация Hypercube и
комбинированные гарантии доставки       </span><span
style='color:black;text-decoration:none'>47</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc150769"><span style='color:
black;text-decoration:none'>3 Сообщения, дескрипторы сообщений и очереди....................................... </span><span style='color:black;text-decoration:none'>53</span></a></span></p>

<p class=MsoToc2><span lang=EN-US><a href="#_Toc150770"><span style='color:
black;text-decoration:none'>3.1 Адрес, валюта и макет сообщения...................................................... </span><span style='color:black;text-decoration:none'>53</span></a></span></p>

<p class=MsoToc2><span lang=EN-US><a href="#_Toc150771"><span style='color:
black;text-decoration:none'>3.2 Дескрипторы входящих сообщений.................................................... </span><span style='color:black;text-decoration:none'>60</span></a></span></p>

<p class=MsoToc2><span lang=EN-US><a href="#_Toc150772"><span style='color:
black;text-decoration:none'>3.3 Очередь исходящих сообщений и дескрипторы................................ </span><span style='color:black;text-decoration:none'>65</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc150773"><span style='color:
black;text-decoration:none'>4 Счета и операции............................................................................................ </span><span style='color:black;text-decoration:none'>69</span></a></span></p>

<p class=MsoToc2><span lang=EN-US><a href="#_Toc150774"><span style='color:
black;text-decoration:none'>4.1 Счета и их состояние............................................................................. </span><span style='color:black;text-decoration:none'>69</span></a></span></p>

<p class=MsoToc2><span lang=EN-US><a href="#_Toc150775"><span style='color:
black;text-decoration:none'>4.2 Транзакции............................................................................................. </span><span style='color:black;text-decoration:none'>75</span></a></span></p>

<p class=MsoToc2><span lang=EN-US><a href="#_Toc150776"><span style='color:
black;text-decoration:none'>4.3 Описания транзакций............................................................................ </span><span style='color:black;text-decoration:none'>83</span></a></span></p>

<p class=MsoToc2><span lang=EN-US><a href="#_Toc150777"><span style='color:
black;text-decoration:none'>4.4 Вызов смарт-контрактов в TVM............................................................ </span><span style='color:black;text-decoration:none'>89</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc150778"><span style='color:
black;text-decoration:none'>5 Макет блока.................................................................................................... </span><span style='color:black;text-decoration:none'>96</span></a></span></p>

<p class=MsoToc2><span lang=EN-US><a href="#_Toc150779"><span style='color:
black;text-decoration:none'>5.1 Схема блока Шардчейн......................................................................... </span><span style='color:black;text-decoration:none'>96</span></a></span></p>

<p class=MsoToc2><span lang=EN-US><a href="#_Toc150780"><span style='color:
black;text-decoration:none'>5.2 Макет блока Мастерчейн................................................................... </span><span style='color:black;text-decoration:none'>101</span></a></span></p>

<p class=MsoToc2><span lang=EN-US><a href="#_Toc150781"><span style='color:
black;text-decoration:none'>5.3 Сериализация мешка ячеек................................................................ </span><span style='color:black;text-decoration:none'>104</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc150782"><span style='color:
black;text-decoration:none'>Криптография эллиптической кривой........................................................... </span><span style='color:black;text-decoration:none'>112</span></a></span></p>

<p class=MsoToc2><span lang=EN-US><a href="#_Toc150783"><span style='color:
black;text-decoration:none'>A.1 Эллиптические кривые....................................................................... </span><span style='color:black;text-decoration:none'>112</span></a></span></p>

<p class=MsoToc2><span lang=EN-US><a href="#_Toc150784"><span style='color:
black;text-decoration:none'>A.2 Curve25519 Криптография.................................................................. </span><span style='color:black;text-decoration:none'>116</span></a></span></p>

<p class=MsoToc2><span lang=EN-US><a href="#_Toc150785"><span style='color:
black;text-decoration:none'>A.3 Ed25519 криптография........................................................................ </span><span style='color:black;text-decoration:none'>118</span></a></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

</div>

<span lang=EN-US style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'><br clear=all style='page-break-before:always'>
</span>

<div class=WordSection2>

<h1><a name="_Toc150756"><span lang=RU>1 Обзор</span></a></h1>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:21.45pt;margin-left:-.25pt;text-align:left;line-height:103%'><span
lang=RU>В этой главе представлен обзор основных функций и принципов
проектирования блокчейна </span><span lang=EN-US>TON</span><span lang=RU>.
Более подробная информация по каждой теме приводится в последующих главах.</span></p>

<h2 style='margin-left:36.0pt;text-indent:-36.0pt'><a name="_Toc150757"><span
lang=EN-US>1.1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>Все – мешок </span></a><span lang=RU>ячее</span><span
lang=EN-US>к</span></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Все данные в блоках и состоянии </span><span
lang=EN-US>TON</span><span lang=EN-US> </span><span lang=EN-US>Blockchain</span><span
lang=RU> представлены в виде совокупности <i>ячеек </i>(ср. [3, 2.5]). Поэтому
эта глава начинается с общего обсуждения клеток.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.1.1. ТВМ-ячейки. Напомним, что блокчейн </span><span
lang=EN-US>TON</span><span lang=RU>, как и виртуальная машина </span><span
lang=EN-US>TON</span><span lang=RU> (</span><span lang=EN-US>TVM</span><span
lang=RU>; см. [4]), представляет все постоянно хранящиеся данные в виде <i>коллекции
</i>или <i>мешка </i>так называемых <i>ячеек. Каждая ячейка состоит из 1023 бит
данных и до четырех ссылок на другие ячейки. Циклические клеточные ссылки не
допускаются, поэтому клетки обычно организованы в деревья клеток, а точнее
направленные ациклические графы (</i></span><i><span lang=EN-US>DAG</span></i><i><span
lang=RU>) клеток. </span></i><a href="#_ftn3" name="_ftnref3" title=""><sup><span
lang=EN-US><sup><span lang=EN-US style='font-size:12.0pt;line-height:104%;
font-family:"Calibri",sans-serif;color:black'>[3]</span></sup></span></sup></a><sup><span
lang=EN-US> </span></sup><span lang=RU>Любое значение абстрактного
алгебраического (зависимого) типа данных может быть представлено
(сериализовано) в виде дерева ячеек. Точный способ представления значений
абстрактного типа данных в виде дерева ячеек выражается с помощью <i>схемы </i></span><i><span
lang=EN-US>TL</span></i><i><span lang=RU>-</span><span lang=EN-US>B</span></i><i><span
lang=RU>.</span></i><a href="#_ftn4" name="_ftnref4" title=""><sup><span
lang=EN-US><sup><span lang=EN-US style='font-size:12.0pt;line-height:104%;
font-family:"Calibri",sans-serif;color:black'>[4]</span></sup></span></sup></a><sup><span
lang=EN-US> </span></sup><span lang=RU>Более подробное обсуждение различных
видов клеток можно найти в [4, 3.1].</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.1.2. Применение к </span><span lang=EN-US>TON</span><span
lang=EN-US> </span><span lang=EN-US>Blockchain</span><span lang=RU> блоков и
состояния. Вышесказанное особенно применимо к блокам и состоянию блокчейна </span><span
lang=EN-US>TON</span><span lang=RU>, которые также являются значениями
определенных (довольно запутанных) зависимых алгебраических типов данных.
Поэтому они сериализуются по различным схемам </span><span lang=EN-US>TL</span><span
lang=RU>-</span><span lang=EN-US>B</span><span lang=RU> (которые постепенно
представлены в этом документе) и представлены в виде коллекции или мешка
клеток.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.1.3. Компоновка одной ячейки. Каждая
отдельная ячейка состоит из 1023 бит данных и до четырех ссылок на другие
ячейки. Когда ячейка хранится в памяти, ее точное представление зависит от
реализации. Однако существует стандартное представление ячеек, полезное,
например, для сериализации ячеек для хранения файлов или передачи по сети. Это
&quot;стандартное представление&quot; или &quot;типовая форма стандартов&quot; </span><span
lang=EN-US>CellRepr</span><span lang=RU>(</span><span lang=EN-US>c</span><span
lang=RU>) ячейки </span><i><span lang=EN-US style='font-family:"Cambria",serif'>c</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>состоит
из следующего:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>На первом месте <i>стоят два дескрипторных </i>байта,
иногда обозначаемые </span><i><span lang=EN-US style='font-family:"Cambria",serif'>d</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>1 </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>d</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>2. Первый из этих байтов </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>d</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>1 </span></i><span lang=RU>равен (в
простейшем случае) количеству ссылок </span><span lang=RU style='font-family:
"Cambria",serif'>0 ≤ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>r</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>≤ 4 </span><span lang=RU>в ячейке. Второй
дескриптор байт </span><i><span lang=EN-US style='font-family:"Cambria",serif'>d</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>2 </span></i><span lang=RU>кодирует
битовую длину </span><i><span lang=EN-US style='font-family:"Cambria",serif'>l</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>части
данных ячейки следующим образом: первые семь битов </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>d</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>2 </span></i><span lang=RU>равны </span><span
lang=RU style='font-family:"Cambria",serif'>[</span><span lang=EN-US
style='font-family:"Cambria",serif'>l</span><span lang=RU style='font-family:
"Cambria",serif'>/8], количеству полных байтов данных, присутствующих в ячейке,
в то время как последний бит </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>d</span></i><i><span lang=RU style='font-family:"Cambria",serif'>2
</span></i><span lang=RU>является <i>тегом завершения, равным единице, если </i></span><i><span
lang=EN-US style='font-family:"Cambria",serif'>l</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>не делится на
восемь. Следовательно</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:-.55pt;
margin-bottom:11.95pt;margin-left:0cm;text-align:left;text-indent:0cm;
line-height:107%'><span lang=RU style='font-size:11.0pt;line-height:107%'>                                    </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>d2 </span></i><span lang=EN-US
style='font-family:"Cambria",serif'>= 2[l/8] + [<i>l</i> mod 8 ≠ 0] = [l/8] +
[l/8]                     </span><span lang=EN-US>(1)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.75pt'><span lang=RU>где </span><span lang=RU style='font-family:
"Cambria",serif'>[</span><span lang=EN-US style='font-family:"Cambria",serif'>A</span><span
lang=RU style='font-family:"Cambria",serif'>] </span><span lang=RU>равно
единице, когда условие </span><i><span lang=EN-US style='font-family:"Cambria",serif'>A</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>истинно,
и нулю в противном случае.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Далее </span><span lang=RU style='font-family:"Cambria",serif'>следуют
байты данных [</span><span lang=EN-US style='font-family:"Cambria",serif'>l</span><span
lang=RU style='font-family:"Cambria",serif'>/8]</span><span lang=RU>. Это
означает, что </span><i><span lang=EN-US style='font-family:"Cambria",serif'>l</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>биты
данных ячейки разделены на группы по восемь, и каждая группа интерпретируется
как 8-битное целое число с большим порядком байтов и хранится в байте. Если </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>l</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>не делится на
восемь, к битам данных добавляется один двоичный единица и подходящее
количество двоичных нулей (до шести), и устанавливается тег завершения
(наименее значимый бит дескриптора </span><i><span lang=RU style='font-family:
"Cambria",serif'>байта </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>d</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>2).</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Наконец, далее следуют ссылки </span><span
lang=EN-US>r</span><span lang=RU> на другие ячейки. Каждая ссылка обычно
представлена 32 байтами, содержащими хэш </span><span lang=EN-US>sha</span><span
lang=RU>256 ячейки, на которую указывает ссылка, вычисляемый, как описано ниже
в 1.1.4.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Таким образом, стандартное представление </span><span
lang=EN-US>CellRepr</span><span lang=RU>(</span><span lang=EN-US>c</span><span
lang=RU>) ячейки </span><i><span lang=EN-US style='font-family:"Cambria",serif'>c</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>с </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>l</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>битами данных и </span><i><span
lang=RU style='font-family:"Cambria",serif'>ссылками </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>r</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>составляет </span><span
lang=RU style='font-family:"Cambria",serif'>2 + [</span><span lang=EN-US
style='font-family:"Cambria",serif'>l</span><span lang=RU style='font-family:
"Cambria",serif'>/8] + [</span><span lang=EN-US style='font-family:"Cambria",serif'>l</span><span
lang=RU style='font-family:"Cambria",serif'>/8] + 32</span><span lang=EN-US
style='font-family:"Cambria",serif'>r</span><span lang=EN-US style='font-family:
"Cambria",serif'> </span><span lang=RU>байт длиной.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.05pt;
margin-left:-.25pt'><span lang=RU>1.1.4. Хэш </span><span lang=EN-US>sha</span><span
lang=RU>256 ячейки. Хэш </span><span lang=EN-US>sha</span><span lang=RU>256
ячейки </span><i><span lang=EN-US style='font-family:"Cambria",serif'>c</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>рекурсивно
определяется как </span><span lang=EN-US>sha</span><span lang=RU>256
стандартного представления </span><span lang=EN-US>CellRepr</span><span
lang=RU>(</span><span lang=EN-US>c</span><span lang=RU>) рассматриваемой
ячейки:</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:-.7pt;
margin-bottom:6.15pt;margin-left:0cm;text-align:left;text-indent:0cm;
line-height:107%'><span lang=RU style='font-size:11.0pt;line-height:107%'>                              </span><span
lang=EN-US>Hash (c) := sha256(c) := sha256 (CellRepr</span><span lang=RU><img
width=17 height=15 id="Picture 148325"
src="tblkch_convertio_ru_done.fld/image001.jpg"></span><span lang=EN-US>                       (2)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:1.8pt;
margin-left:-.25pt'><span lang=RU>Поскольку циклические ссылки на ячейки не
допускаются (отношения между всеми ячейками должны составлять направленный
ациклический граф или </span><span lang=EN-US>DAG</span><span lang=RU>), хэш </span><span
lang=EN-US>sha</span><span lang=RU>256 ячейки всегда четко определен.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.6pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Кроме того, поскольку </span><span
lang=EN-US>sha</span><span lang=RU>256 молчаливо считается устойчивым к
столкновениям, мы предполагаем, что все клетки, с которыми мы сталкиваемся,
полностью определяются их хешами. В частности, клеточные ссылки ячейки </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>c</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>полностью
определяются хэшами ссылочных ячеек, содержащимися в стандартном представлении </span><span
lang=EN-US>CellRepr</span><span lang=RU>(</span><span lang=EN-US>c</span><span
lang=RU>).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.1.5. Экзотические клетки. Помимо <i>обычных
</i>клеток (также называемых <i>простыми </i>или <i>данными</i>), рассмотренных
до сих пор, ячейки других типов, называемые <i>экзотическими клетками, иногда
появляются в реальных представлениях блоков </i></span><i><span lang=EN-US>TON</span></i><i><span
lang=EN-US> </span><span lang=EN-US>Blockchain</span></i><i><span lang=RU> и
других структур данных. Их представление несколько отличается; они отличаются
наличием первого дескрипторного байта </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>d</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>1 </span></i><span lang=RU
style='font-family:"Cambria",serif'>≥ 5 </span><span lang=RU>(ср. [4, 3.1]).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.25pt;
margin-left:-.25pt'><span lang=RU>1.1.6. Внешние опорные ячейки. <i>(Внешние)
ссылочные ячейки, которые содержат 32-байтовый </i></span><i><span lang=EN-US>sha</span></i><i><span
lang=RU>256(</span><span lang=EN-US>c</span></i><i><span lang=RU>) </span></i><span
lang=RU>«истинной» ячейки данных </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>c</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>вместо самой ячейки данных, являются одним из примеров
экзотических ячеек. Эти ячейки могут быть использованы при сериализации пакета
ячеек, соответствующего блоку </span><span lang=EN-US>TON</span><span
lang=EN-US> </span><span lang=EN-US>Blockchain</span><span lang=RU>, чтобы
ссылаться на ячейки данных, отсутствующие в сериализации самого блока, но
предположительно присутствующие где-то еще (например, в предыдущем состоянии
блокчейна).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.65pt;
margin-left:-.25pt'><span lang=RU>1.1.7. Прозрачность опорных ячеек в отношении
большинства операций. Большинство клеточных операций не наблюдают никаких
эталонных клеток или других «экзотических» видов клеток; они видят только
ячейки данных, причем любая ссылочная ячейка прозрачно заменяется ячейкой, на
которую ссылается. Например, когда <i>прозрачный </i>хэш ячейки </span><span
lang=EN-US>Hash<sup>b</sup></span><span lang=RU>(</span><span lang=EN-US>c</span><span
lang=RU>) вычисляется рекурсивно, хэш эталонной ячейки устанавливается равным
хэшу упомянутой ячейки, а не хэшу стандартного представления эталонной ячейки.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:1.5pt;
margin-left:-.25pt'><span lang=RU>1.1.8. Прозрачный хэш и хэш представления
ячейки. Таким образом, </span><span lang=EN-US>sha</span><span lang=RU>256</span><sup><span
lang=EN-US>b</span></sup><span lang=RU>(</span><span lang=EN-US>c</span><span
lang=RU>) = </span><span lang=EN-US>Hash<sup>b</sup></span><span lang=RU>(</span><span
lang=EN-US>c</span><span lang=RU>) является <i>прозрачным хэшем </i>ячейки </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>c</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>(или дерева
ячеек, укорененных в </span><i><span lang=EN-US style='font-family:"Cambria",serif'>c</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>).</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Однако иногда нам нужно
рассуждать о точном представлении дерева клеток, присутствующих в блоке. С этой
целью определяется <i>хэш представления </i></span><span lang=EN-US>Hash<sup>b</sup></span><span
lang=RU>(</span><span lang=EN-US>c</span><span lang=RU>), который не является
прозрачным по отношению к эталонным ячейкам и другим экзотическим типам ячеек.
Мы часто говорим, что хэш представления </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>c</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>является «хэшем» </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>c</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, потому что это наиболее часто
используемый хэш ячейки.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.1.9. Использование репрезентативных хэшей
для подписей. Подписи являются отличным примером применения хэшей
представления. </span><span lang=EN-US>Например:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Валидаторы подписывают хэш представления блока, а
не только его прозрачный хэш, потому что им необходимо подтвердить, что блок
содержит необходимые данные, а не только некоторые внешние ссылки на них.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Когда внешние сообщения подписываются и
отправляются сторонами вне цепочки (например, клиентами-людьми, использующими
приложение для инициирования транзакций блокчейна), если внешние ссылки могут
присутствовать в некоторых из этих сообщений, именно хэши представления
сообщений должны быть подписаны.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:20.85pt;
margin-left:.5pt'><span lang=RU>1.1.10. Высшие хэши ячейки. Помимо прозрачных и
репрезентативных хэшей ячейки </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>c</span></i><i><span lang=RU style='font-family:"Cambria",serif'>,
существует последовательность высших </span></i><i><span lang=RU>хэшей </span></i><span
lang=EN-US>Hash<sub>i</sub></span><span lang=RU>(</span><span lang=EN-US>c</span><span
lang=RU>), </span><i><span lang=EN-US style='font-family:"Cambria",serif'>i</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= 1,2,... </span><span lang=RU>может быть
определено, что в конечном итоге стабилизируется при </span><span lang=EN-US>Hash</span><sub><span
lang=RU>∞</span></sub><span lang=RU>(</span><span lang=EN-US>c</span><span
lang=RU>). (Более подробную информацию можно найти в [4, 3.1].)</span></p>

</div>

<span lang=RU style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'><br clear=all style='page-break-before:always'>
</span>

<div class=WordSection3>

<h2 style='margin-left:36.0pt;text-indent:-36.0pt'><a name="_Toc150758"><span
lang=RU>1.2<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=RU>Основные компоненты блока и состояние блокчейна</span></a></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.05pt;
margin-left:-.25pt'><span lang=RU>В этом разделе кратко описываются основные
компоненты блока и состояния блокчейна, не вдаваясь в детали.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.5pt;
margin-left:-.25pt'><span lang=RU>1.2.1. Парадигма бесконечного шардинга (</span><span
lang=EN-US>ISP</span><span lang=RU>), применяемая к блоку и состоянию
блокчейна. Напомним, что в соответствии с парадигмой Бесконечного Шардинга
каждая учетная запись может рассматриваться как лежащая в отдельной «цепочке
учетных записей», а (виртуальные) блоки этих связей счетов затем группируются в
блоки шардчейнов для целей эффективности. В частности, состояние шардчейна
состоит, грубо говоря, из состояний всех его «счетных цепей» (т. е. всех счетов,
назначенных ему); точно так же блок шардчейна по существу состоит из коллекции
виртуальных «блоков» для некоторых учетных записей, назначенных шардчейну. </span><a
href="#_ftn5" name="_ftnref5" title=""><sup><span lang=EN-US><sup><span
lang=EN-US style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'>[5]</span></sup></span></sup></a><span lang=EN-US>Мы можем
резюмировать это следующим образом:</span></p>

<table class=TableGrid border=0 cellspacing=0 cellpadding=0 width=398
 style='width:298.35pt;margin-left:90.2pt;border-collapse:collapse'>
 <tr style='height:14.35pt'>
  <td width=378 valign=top style='width:283.35pt;padding:.7pt 0cm 0cm 0cm;
  height:14.35pt'>
  <p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
  margin-bottom:0cm;margin-left:1.65pt;text-align:left;text-indent:0cm;
  line-height:107%'><i><span lang=EN-US>ShardState </span></i><span lang=EN-US
  style='font-family:"Cambria",serif'>≈ </span><i><span lang=EN-US>Hashmap(n, AccountState)</span></i></p>
  </td>
  <td width=20 valign=top style='width:14.95pt;padding:.7pt 0cm 0cm 0cm;
  height:14.35pt'>
  <p class=MsoNormal style='margin:0cm;text-indent:0cm;line-height:107%'><span
  lang=EN-US>(3)</span></p>
  </td>
 </tr>
 <tr style='height:14.35pt'>
  <td width=378 valign=top style='width:283.35pt;padding:.7pt 0cm 0cm 0cm;
  height:14.35pt'>
  <p class=MsoNormal align=left style='margin:0cm;text-align:left;text-indent:
  0cm;line-height:107%'><i><span lang=EN-US>ShardBlock </span></i><span
  lang=EN-US style='font-family:"Cambria",serif'>≈ </span><i><span lang=EN-US>Hashmap(n,
  AccountBlock)</span></i></p>
  </td>
  <td width=20 valign=top style='width:14.95pt;padding:.7pt 0cm 0cm 0cm;
  height:14.35pt'>
  <p class=MsoNormal style='margin:0cm;text-indent:0cm;line-height:107%'><span
  lang=EN-US>(4)</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:2.5pt;
margin-left:-.25pt'><span lang=RU>где </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>n</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>— битовая длина </span><i><span
lang=EN-US>account</span></i><i><span lang=RU>_</span><span lang=EN-US>id</span></i><i><span
lang=RU>, а </span><span lang=EN-US>Hashmap</span></i><i><span lang=RU>(</span><span
lang=EN-US>n</span></i><i><span lang=RU>,</span><span lang=EN-US>X</span></i><i><span
lang=RU>) </span></i><span lang=RU>описывает частичную карту </span><b><span
lang=RU style='font-family:"Cambria",serif'>2</span></b><b><sup><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></sup></b><b><span
lang=EN-US style='font-family:"Cambria",serif'> </span></b><span lang=EN-US
style='font-family:Wingdings'></span><span lang=EN-US> </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>X</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>из битовых строк
длиной </span><i><span lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>в
значения типа </span><i><span lang=EN-US style='font-family:"Cambria",serif'>X</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Напомним, что каждый
шардчейн — или, точнее, каждый блок шардчейна </span><a href="#_ftn6"
name="_ftnref6" title=""><sup><span lang=EN-US><sup><span lang=EN-US
style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'>[6]</span></sup></span></sup></a><span lang=RU>— соответствует
всем цепочкам учетных записей, которые принадлежат к одной и той же «рабочей
цепи» (т. е. имеют одинаковый </span><i><span lang=EN-US>workchain</span></i><i><span
lang=RU>_</span><span lang=EN-US>id</span></i><i><span lang=EN-US> </span></i><span
lang=RU style='font-family:"Cambria",serif'>= </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>w</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) и имеют </span><span lang=EN-US>account</span></i><i><span
lang=RU>_</span><span lang=EN-US>id</span></i><span lang=RU>, начинающуюся с
одного и того же двоичного префикса </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>s</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, так что </span></i><span lang=RU
style='font-family:"Cambria",serif'>(</span><span lang=EN-US style='font-family:
"Cambria",serif'>w</span><span lang=RU style='font-family:"Cambria",serif'>,</span><span
lang=EN-US style='font-family:"Cambria",serif'>s</span><span lang=RU
style='font-family:"Cambria",serif'>) </span><span lang=RU>полностью определяет
осколок. Поэтому приведенные выше хэш-карты должны содержать только ключи,
начинающиеся с префикса </span><i><span lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.35pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Через мгновение мы
увидим, что приведенное выше описание является лишь приближением: состояние и
блок шардчейна должны содержать некоторые дополнительные данные, которые не
разделены в соответствии с </span><i><span lang=EN-US>account</span></i><i><span
lang=RU>_</span><span lang=EN-US>id</span></i><i><span lang=EN-US> </span></i><span
lang=RU>как предлагается (3).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:7.75pt;
margin-left:-.25pt'><span lang=RU>1.2.2. Разделенная и неразделенная часть
шардчейнового блока и состояния. Блок шардчейна и его состояние могут быть
разделены на две отдельные части. Части с продиктованной </span><span
lang=EN-US>ISP</span><span lang=RU> формой (3) будут называться разделенными
частями блока и его состоянием, а остальные будут называться <i>неразделенными </i>частями.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>1.2.3. Взаимодействие с другими блоками и
внешним миром. Условия глобальной и локальной согласованности. Неразделенные
части блока шардчейна и его состояние в основном связаны с взаимодействием
этого блока с некоторыми другими «соседними» блоками. Условия глобальной
согласованности блокчейна в целом сводятся к условиям внутренней
согласованности отдельных блоков сами по себе, а также к внешним локальным
условиям согласованности между определенными блоками (см. 1.3).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Большинство из этих
локальных условий согласованности связаны с пересылкой сообщений между различными
цепочками сегментов, транзакциями, включающими более одного шардчейна, и
гарантиями доставки сообщений. Однако другая группа условий локальной
согласованности связывает блок с его непосредственными предшественниками и
преемниками внутри шардчейна; например, начальное состояние блока обычно должно
совпадать с конечным состоянием его непосредственного предшественника.</span><a
href="#_ftn7" name="_ftnref7" title=""><sup><span lang=EN-US><sup><span
lang=EN-US style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'>[7]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.8pt;
margin-left:-.25pt'><span lang=RU>1.2.4. Входящие и исходящие сообщения блока.
Наиболее важными компонентами нерасщепленной части блока шардчейна являются следующие:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=EN-US>InMsgDescr</span></i><i><span lang=EN-US> </span></i><span
lang=RU>— описание всех сообщений, «импортированных» в этот блок (т.е. либо
обработанных транзакцией, включенной в блок, либо переадресованных в очередь
вывода, в случае транзитного сообщения, движущегося по пути, продиктованному </span><span
lang=EN-US>Hypercube</span><span lang=EN-US> </span><span lang=EN-US>Routing</span><span
lang=RU>).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=EN-US>OutMsgDescr</span></i><i><span lang=EN-US> </span></i><span
lang=RU>— описание всех сообщений, «экспортированных» или «сгенерированных»
блоком (т.е. либо сообщений, сгенерированных транзакцией, включенной в блок,
либо транзитных сообщений с назначением, не принадлежащим текущему </span><span
lang=EN-US>shardchain</span><span lang=RU>, пересылаемого из </span><i><span
lang=EN-US>InMsgDescr</span></i><i><span lang=RU>).</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.2.5. Заголовок блока. Другим неразделенным
компонентом блока </span><span lang=EN-US>shardchain</span><span lang=RU>
является <i>заголовок блока, который содержит общую информацию, такую как </i></span><span
lang=RU style='font-family:"Cambria",serif'>(</span><span lang=EN-US
style='font-family:"Cambria",serif'>w</span><span lang=RU style='font-family:
"Cambria",serif'>,</span><span lang=EN-US style='font-family:"Cambria",serif'>s</span><span
lang=RU style='font-family:"Cambria",serif'>) </span><span lang=RU>(т.е. </span><i><span
lang=EN-US>workchain</span></i><i><span lang=RU>_</span><span lang=EN-US>id</span></i><i><span
lang=EN-US> </span></i><span lang=RU>и общий двоичный префикс всех </span><i><span
lang=EN-US>account</span></i><i><span lang=RU>_</span><span lang=EN-US>ids</span></i><i><span
lang=RU>, назначенных текущему </span><span lang=EN-US>shardchain</span></i><i><span
lang=RU>), порядковый номер блока </span></i><span lang=RU>(определяемый как
наименьшее неотрицательное целое число, большее, чем порядковые номера его
предшественников), <i>логическое время и генерация </i></span><i><span
lang=EN-US>unixtime</span></i><i><span lang=RU>. Он также содержит хэш
непосредственного предшественника блока (или двух его непосредственных
предшественников в случае предшествующего события слияния </span><span
lang=EN-US>shardchain</span></i><i><span lang=RU>), хэши его начального и
конечного состояний (т. е. состояний </span><span lang=EN-US>shardchain</span></i><i><span
lang=RU> непосредственно до и сразу после обработки текущего блока) и хэш
самого последнего блока </span><span lang=EN-US>masterchain</span></i><i><span
lang=RU>, известного на момент генерации блока </span><span lang=EN-US>shardchain</span></i><i><span
lang=RU>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.2.6. Подписи Валидатора, подписанные и
неподписанные блоки. Блок, описанный до сих пор, является <i>беззнаковым
блоком; он генерируется полностью и рассматривается валидаторами как единое
целое. Когда валидаторы в конечном итоге подписывают его, </i>создается
подписанный блок, состоящий из беззнакового блока вместе со списком подписей
валидатора (определенного хэша представления беззнакового блока, см. 1.1.9).
Этот список подписей также является неразделенным компонентом (подписанного)
блока; однако, поскольку он находится за пределами беззнакового блока, он
несколько отличается от других данных, хранящихся в блоке.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.7pt;
margin-left:-.25pt'><span lang=RU>1.2.7. Очередь исходящих сообщений </span><span
lang=EN-US>shardchain</span><span lang=RU>. Аналогичным образом, наиболее
важной неразделенной частью состояния </span><span lang=EN-US>shardchain</span><span
lang=RU> является </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=RU>, очередь исходящих сообщений. Он содержит недоставленные </span></i><span
lang=RU>сообщения, включенные в </span><i><span lang=EN-US>OutMsgDescr</span></i><i><span
lang=RU>, либо последним блоком </span><span lang=EN-US>shardchain</span></i><i><span
lang=RU>, ведущим к этому состоянию, либо одним из его предшественников.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.6pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Первоначально каждое
исходящее сообщение включается в </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=RU>; оно удаляется из очереди только после того, как оно либо было
включено в </span><span lang=EN-US>InMsgDescr</span></i><i><span lang=EN-US> </span></i><span
lang=RU>блока «соседнего» шардчейна (следующего по отношению к </span><span
lang=EN-US>Hypercube</span><span lang=EN-US> </span><span lang=EN-US>Routing</span><span
lang=RU>), либо было доставлено (т.е. появилось в </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=RU>)</span></i><span lang=RU> его конечного назначения через </span><span
lang=EN-US>Instant</span><span lang=EN-US> </span><span lang=EN-US>Hypercube</span><span
lang=EN-US> </span><span lang=EN-US>Routing</span><span lang=RU>. В обоих
случаях <i>причина </i>удаления сообщения из </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=EN-US> </span></i><span lang=RU>указывается в </span><i><span lang=EN-US>OutMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>блока, в котором произошло такое
преобразование состояния.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:5.55pt;
margin-left:-.25pt'><span lang=RU>1.2.8. Компоновка </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=RU>, </span><span lang=EN-US>OutMsgDescr</span></i><i><span lang=EN-US> </span></i><span
lang=RU>и </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span lang=RU>.
Все наиболее важные неразделенные структуры данных </span><span lang=EN-US>shardchain</span></i><i><span
lang=RU>, связанные с сообщениями, организованы в виде хэш-карт </span></i><span
lang=RU>или <i>словарей </i>(реализованных с помощью деревьев Патрисии,
сериализованных в дерево ячеек, как описано в [4, 3.3]), со следующими ключами:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.2pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Описание входящего сообщения </span><i><span
lang=EN-US>InMsgDescr</span></i><i><span lang=EN-US> </span></i><span lang=RU>использует
256-битный хэш сообщения в качестве ключа.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.2pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>В описании исходящего сообщения </span><i><span
lang=EN-US>OutMsgDescr</span></i><i><span lang=EN-US> </span></i><span lang=RU>в
качестве ключа используется 256-битный хэш сообщения.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:6.4pt;
margin-left:29.3pt;text-indent:-11.85pt;line-height:103%'><span lang=RU
style='line-height:103%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>В очереди исходящих сообщений </span><i><span
lang=EN-US>OutMsgQueue</span></i><i><span lang=EN-US> </span></i><span lang=RU>в
качестве ключа используется 352-разрядная конкатенация 32-разрядной </span><i><span
lang=EN-US>workchain</span></i><i><span lang=RU>_</span><span lang=EN-US>id</span></i><i><span
lang=RU> назначения, первые 64 бита адреса назначения </span><span lang=EN-US>account</span></i><i><span
lang=RU>_</span><span lang=EN-US>id</span></i><i><span lang=RU> и 256-разрядный
хэш сообщения.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:7.8pt;
margin-left:-.25pt'><span lang=RU>1.2.9. Разделенная часть блока: цепочки транзакций.
Разделенная часть блока </span><span lang=EN-US>shardchain</span><span lang=RU>
состоит из хэш-карты, отображающей некоторые учетные записи, назначенные </span><span
lang=EN-US>shardchain</span><span lang=RU>, с «виртуальными блоками </span><span
lang=EN-US>accountchain</span><span lang=RU>» </span><i><span lang=EN-US>AccountBlock</span></i><i><span
lang=RU>, см. (3). Такой виртуальный блок </span><span lang=EN-US>accountchain</span></i><i><span
lang=RU> состоит из последовательного списка транзакций, связанных </span></i><span
lang=RU>с этим счетом.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:5.9pt;
margin-left:-.25pt'><span lang=RU>1.2.10. Описание транзакции. Каждая
транзакция описывается в блоке экземпляром типа </span><i><span lang=EN-US>Transaction</span></i><span
lang=RU>, который содержит, в частности, следующую информацию:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.5pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Ссылка ровно на одно <i>входящее сообщение </i>(которое
также должно присутствовать в </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=RU>)</span></i><span lang=RU>, которое было обработано транзакцией.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:4.85pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Ссылки на несколько (возможно, ноль) <i>исходящих
сообщений </i>(также присутствующих в </span><i><span lang=EN-US>OutMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>и, скорее всего, включенных в </span><i><span
lang=EN-US>OutMsgQueue</span></i><i><span lang=RU>), которые были сгенерированы
</span></i><span lang=RU>транзакцией.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.8pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Транзакция состоит из
вызова </span><span lang=EN-US>TVM</span><span lang=RU> (ср. [4]) с кодом
смарт-контракта, соответствующим рассматриваемой учетной записи, загруженной в
виртуальную машину, и с корневой ячейкой данных смарт-контракта, загруженной в
регистр виртуальной машины </span><span lang=EN-US>c</span><span lang=RU>4.
Само входящее сообщение передается в стеке в качестве аргумента функции </span><span
lang=EN-US>main</span><span lang=RU>() смарт-контракта вместе с некоторыми
другими важными данными, такими как количество </span><span lang=EN-US>TON</span><span
lang=EN-US> </span><span lang=EN-US>Grams</span><span lang=RU> и других
определенных валют, прикрепленных к сообщению, адрес учетной записи отправителя,
текущий баланс смарт-контракта и так далее.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>В дополнение к
информации, перечисленной выше, <i>экземпляр транзакции </i>также содержит
исходное и окончательное состояния учетной записи (т. Е. Смарт-контракта), а
также некоторую статистику работы </span><span lang=EN-US>TVM</span><span
lang=RU> (потребляемый газ, цена газа, выполненные инструкции, ячейки созданы /
уничтожены, код окончания виртуальной машины и т. Д.).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.65pt;
margin-left:-.25pt'><span lang=RU>1.2.11. Разделенная часть состояния
шардчейна: состояния счета. Напомним, что, согласно пункту (3), разделенная
часть состояния </span><span lang=EN-US>shardchain</span><span lang=RU> состоит
из хэш-карты, отображающей каждый «определенный» идентификатор учетной записи
(принадлежащий рассматриваемой </span><span lang=EN-US>shardchain</span><span
lang=RU>) состоянию соответствующей учетной записи, заданной экземпляром типа </span><i><span
lang=EN-US>AccountState</span></i><span lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.5pt;
margin-left:-.25pt'><span lang=RU>1.2.12. Состояние счета. Само состояние счета
приблизительно состоит из следующих данных:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Его <i>баланс </i>в граммах и (опционально) в
некоторых других определенных криптовалютах/токенах.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Код <i>смарт-контракта или хэш кода
смарт-контракта, если он будет предоставлен (загружен) позже отдельным сообщением.</i></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Постоянные <i>данные смарт-контрактов, которые
могут быть пустыми для простых смарт-контрактов. Это дерево ячеек, корень
которых загружается в регистр </i></span><i><span lang=EN-US>c</span></i><i><span
lang=RU>4 при выполнении смарт-контракта.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Его <i>статистика использования хранилища, включая
количество ячеек и байтов, хранящихся в постоянном хранилище смарт-контракта
(то есть внутри состояния блокчейна), и последний раз, когда с этой учетной
записи взималась плата за использование хранилища.</i></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:7.85pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Необязательное <i>формальное описание интерфейса </i>(предназначенное
для смарт-контрактов) и/или <i>общедоступная информация о пользователях </i>(предназначенная
в основном для пользователей и организаций).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Обратите внимание, что в блокчейне </span><span
lang=EN-US>TON</span><span lang=RU> нет различия между «умным контрактом» и
«учетной записью». Вместо этого «простые» или «кошельковые» учетные записи,
обычно используемые пользователями-людьми и их приложениями криптовалютного
кошелька для простых криптовалютных переводов, являются просто простыми
смарт-контрактами со стандартным (общим) кодом и с постоянными данными,
состоящими из открытого ключа кошелька (или нескольких открытых ключей в случае
кошелька с несколькими подписями; см. 1.7.6 для более подробной информации).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.2.13. Мастерчейн блоков. В дополнение к
блокам шардчейна и их состояниям, блокчейн </span><span lang=EN-US>TON</span><span
lang=RU> содержит <i>блоки мастерчейна </i>и <i>состояние мастерчейна </i>(также
называемое <i>глобальным состоянием). Блоки мастерчейна и состояние очень
похожи на блоки шардчейна и состояние, рассмотренные до сих пор, с некоторыми
заметными различиями:</i></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Мастерчейн не может быть разделен или объединен,
поэтому блок мастерчейна обычно имеет ровно один непосредственный
предшественник. Единственным исключением является «блок мастерчейна ноль»,
отличающийся наличием порядкового номера, равного нулю; он вообще не имеет
предшественников и содержит начальную конфигурацию всего блокчейна </span><span
lang=EN-US>TON</span><span lang=RU> (например, исходный набор валидаторов).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Блоки мастерчейна содержат еще одну важную
неразделенную структуру: </span><i><span lang=EN-US>ShardHashes</span></i><i><span
lang=RU>, двоичное дерево со списком всех определенных шардчейнов вместе с
хэшами последнего блока внутри каждого из перечисленных цепей шардов. Именно
включение блока </span><span lang=EN-US>shardchain</span></i><i><span lang=RU>
в эту структуру делает блок </span><span lang=EN-US>shardchain</span></i><i><span
lang=RU> «каноническим» и позволяет другим блокам </span><span lang=EN-US>shardchains</span></i><i><span
lang=RU> ссылаться на данные (например, исходящие сообщения), содержащиеся в
блоке </span><span lang=EN-US>shardchain</span></i><i><span lang=RU>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Состояние мастерчейна содержит глобальные параметры
конфигурации всего </span><span lang=EN-US>TON</span><span lang=EN-US> </span><span
lang=EN-US>Blockchain</span><span lang=RU>, такие как минимальная и
максимальная цены на газ, поддерживаемые версии </span><span lang=EN-US>TVM</span><span
lang=RU>, минимальная ставка для кандидатов на валидатор, список альтернативных
криптовалют, поддерживаемых в дополнение к </span><span lang=EN-US>Grams</span><span
lang=RU>, общее количество </span><span lang=EN-US>Grams</span><span lang=RU>,
выпущенных до сих пор, и текущий набор валидаторов, ответственных за создание и
подписание новых блоков, вместе с их открытыми ключами.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=EN-US style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Состояние мастерчейна также содержит код
смарт-контрактов, используемых для выбора последующих наборов валидаторов и
изменения параметров глобальной конфигурации. Сам код этих смарт-контрактов
является частью глобальных параметров конфигурации и может быть соответствующим
образом изменен. В этом отношении этот код (наряду с текущими значениями этих
параметров) функционирует как «конституция» для блокчейна </span><span
lang=EN-US>TON</span><span lang=RU>. </span><span lang=EN-US>Первоначально он
устанавливается в нулевом блоке мастерчейна.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:21.35pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Транзитные сообщения через мастерчейн отсутствуют:
каждое входящее сообщение должно иметь место назначения внутри мастерчейна, а
каждое исходящее сообщение должно иметь источник внутри мастерчейна.</span></p>

</div>

<span lang=RU style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'><br clear=all style='page-break-before:always'>
</span>

<div class=WordSection4>

<h2 style='margin-left:36.0pt;text-indent:-36.0pt'><a name="_Toc150759"><span
lang=EN-US>1.3<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>Условия согласованности</span></a></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:2.7pt;margin-bottom:8.35pt;
margin-left:3.2pt;line-height:103%'><span lang=RU>В дополнение к структурам
данных, содержащимся в блоке и в состоянии блокчейна, которые сериализуются в
мешки ячеек в соответствии с определенными схемами </span><span lang=EN-US>TL</span><span
lang=RU>-</span><span lang=EN-US>B</span><span lang=RU>, подробно описанными
ниже (см. главы 3-5), важной составляющей макета блокчейна являются <i>условия
согласованности </i>между данными, хранящимися внутри одного или в разных
блоках (как упоминалось в 1.2.3). В этом разделе подробно описана функция
условий согласованности в блокчейне.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.3.1. Выражение условий согласованности. В
принципе, зависимые типы данных (например, используемые в </span><span
lang=EN-US>TL</span><span lang=RU>-</span><span lang=EN-US>B</span><span
lang=RU>) могут использоваться не только для описания сериализации блочных
данных, но и для выражения условий, налагаемых на компоненты таких типов
данных. (Например, можно определить тип данных </span><i><span lang=EN-US>OrderedIntPair</span></i><i><span
lang=RU>, с парами целых чисел </span></i><span lang=RU style='font-family:
"Cambria",serif'>(</span><span lang=EN-US style='font-family:"Cambria",serif'>x</span><span
lang=RU style='font-family:"Cambria",serif'>,</span><span lang=EN-US
style='font-family:"Cambria",serif'>y</span><span lang=RU style='font-family:
"Cambria",serif'>), такими, что </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>x</span></i><i><span lang=RU style='font-family:"Cambria",serif'>
&lt; </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>y</span></i><i><span
lang=RU style='font-family:"Cambria",serif'> в виде значений.) Однако </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>TL</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>-</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>B</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> в настоящее время недостаточно
выразителен, чтобы закодировать все необходимые нам условия согласованности,
поэтому мы выбираем полуформализованный подход в этом тексте. В будущем мы
можем представить последующую полную формализацию в подходящем помощнике
доказательства, таком как </span></i><i><span lang=EN-US style='font-family:
"Cambria",serif'>Coq</span></i><i><span lang=RU style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.3.2. Важность условий согласованности.
Условия согласованности в конечном итоге по крайней мере так же важны, как и
«неограниченные» структуры данных, на которые они налагаются, особенно в
контексте блокчейна. Например, условия согласованности гарантируют, что
состояние учетной записи не изменяется между блоками и что оно может изменяться
в блоке только в результате транзакции. Таким образом, условия согласованности
обеспечивают безопасное хранение криптовалютных балансов и другой информации
внутри блокчейна.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.3.3. Виды условий консистенции. Существует
несколько видов условий согласованности, налагаемых на блокчейн </span><span
lang=EN-US>TON</span><span lang=RU>:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Глобальные условия </span></i><span lang=RU>—
Выражают инварианты по всему блокчейну </span><span lang=EN-US>TON</span><span
lang=RU>. Например, <i>гарантии доставки сообщений, которые утверждают, что
каждое сгенерированное сообщение должно быть доставлено на его целевую учетную
запись и доставлено ровно один раз, являются частью глобальных условий.</i></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Внутренние (локальные) условия </span></i><span
lang=RU>— Выражают условия, предъявляемые к данным, хранящимся внутри одного
блока. Например, каждая транзакция, входящая в блок (т.е. присутствующая в
списке транзакций какого-либо аккаунта), обрабатывает ровно одно входящее
сообщение; это входящее сообщение также должно быть указано в </span><i><span
lang=EN-US>InMsgDescr</span></i><i><span lang=RU>.</span></i><span lang=RU>структуре
Блока</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=EN-US style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Внешние (локальные) условия </span></i><span
lang=RU>— Выражают условия, налагаемые на данные разных блоков, обычно
принадлежащих к одному и тому же или к соседним шардчейнам (в отношении </span><span
lang=EN-US>Hypercube</span><span lang=EN-US> </span><span lang=EN-US>Routing</span><span
lang=RU>). </span><span lang=EN-US>Поэтому внешние условия бывают нескольких
вкусов:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:5.9pt;
margin-left:55.05pt;text-indent:-12.6pt'><span lang=RU style='line-height:104%'>–<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span><i><span
lang=RU>Условия антесессора/преемника </span></i><span lang=RU>— Выражают
условия, налагаемые на данные некоторого блока и его непосредственного
предшественника или (в случае предшествующего события слияния шардчейна) двух
непосредственных антесессоров. Наиболее важным из этих условий является то, в
котором говорится, что начальное состояние блока шардчейна должно совпадать с
конечным состоянием шардчейна непосредственного блока предшественника, при
условии, что между ними не произошло события разделения/слияния шардчейна.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:5.75pt;
margin-left:55.05pt;text-indent:-12.6pt'><span lang=RU style='line-height:104%'>–<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span><i><span
lang=RU>Условия </span><span lang=EN-US>Masterchain</span></i><i><span lang=RU>/</span><span
lang=EN-US>shardchain</span></i><i><span lang=EN-US> </span></i><span lang=RU>—
Выражают условия, наложенные на блок </span><span lang=EN-US>shardchain</span><span
lang=RU> и на блок </span><span lang=EN-US>masterchain</span><span lang=RU>,
который ссылается на него в своем <i>списке </i></span><i><span lang=EN-US>ShardHashes</span></i><i><span
lang=EN-US> </span></i><span lang=RU>или упоминается в заголовке блока </span><span
lang=EN-US>shardchain</span><span lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.25pt;
margin-left:55.05pt;text-indent:-12.6pt'><span lang=RU style='line-height:104%'>–<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span><i><span
lang=RU>Соседние (блоковые) условия </span></i><span lang=RU>— Выражают
отношения между блоками соседних шардчейнов относительно </span><span
lang=EN-US>Hypercube</span><span lang=EN-US> </span><span lang=EN-US>Routing</span><span
lang=RU>. Наиболее важные из этих условий выражают отношение между </span><i><span
lang=EN-US>InMsgDescr</span></i><i><span lang=EN-US> </span></i><span lang=RU>блока
и </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span lang=EN-US> </span></i><span
lang=RU>состояния соседнего блока.</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:.25pt;margin-bottom:
0cm;margin-left:0cm;text-indent:-.55pt'><span lang=RU>1.3.4<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
lang=RU>Разложение глобальных и локальных условий на более простые локальные
условия. Условия <i>глобальной </i>согласованности, такие как гарантии доставки
сообщений, действительно необходимы для правильной работы блокчейна; однако их
трудно обеспечить и проверить напрямую. Поэтому вместо этого мы вводим
множество более простых <i>условий локальной </i>согласованности, которые легче
применять и проверять, поскольку они включают только один блок или, возможно,
два соседних блока. Эти локальные условия выбраны таким образом, что желаемые
глобальные условия являются логическими следствиями (соединения) всех локальных
условий. В этой связи мы говорим, что глобальные условия были «разложены» на
более простые локальные условия.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.35pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Иногда локальное условие
все же оказывается слишком громоздким для принудительного исполнения или
проверки. В этом случае он разлагается дальше, в еще более простые локальные
условия.</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:.25pt;margin-bottom:
.4pt;margin-left:0cm;text-indent:0cm'><span lang=RU>1.3.5<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
lang=RU>Декомпозиция может потребовать дополнительных структур данных и
дополнительных внутренних условий согласованности. Декомпозиция условия на
более простые условия локальной согласованности иногда требует введения
дополнительных структур данных. Например, </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>явно перечисляет все входящие сообщения,
обработанные в блоке, даже если этот список мог быть получен путем сканирования
списка всех транзакций, присутствующих в блоке. Тем не менее, </span><i><span
lang=EN-US>InMsgDescr</span></i><i><span lang=EN-US> </span></i><span lang=RU>значительно
упрощает соседние условия, связанные с пересылкой и маршрутизацией сообщений,
которые в конечном итоге складываются в глобальные гарантии доставки сообщений.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Обратите внимание, что
введение таких дополнительных структур данных является своего рода
«денормализацией базы данных» (т. е. это приводит к некоторой избыточности или
к тому, что некоторые данные присутствуют более одного раза), и поэтому
необходимо наложить больше внутренних условий согласованности (например, если
некоторые данные теперь присутствуют в двух копиях, мы должны требовать, чтобы
эти две копии совпадали). Например, как только мы введем </span><i><span
lang=EN-US>InMsgDescr</span></i><i><span lang=EN-US> </span></i><span lang=RU>для
облегчения пересылки сообщений между </span><span lang=EN-US>shardchains</span><span
lang=RU>, нам нужно ввести внутренние условия согласованности, связывающие </span><i><span
lang=EN-US>InMsgDescr</span></i><i><span lang=EN-US> </span></i><span lang=RU>со
списком транзакций того же блока.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:0cm;text-indent:0cm'><span lang=RU>1.3.6<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=RU>Правильные условия сериализации. Помимо
высокоуровневых условий внутренней согласованности, которые рассматривают
содержимое блока как значение абстрактного типа данных, существуют некоторые
условия внутренней согласованности более низкого уровня, называемые
«(правильными) условиями сериализации», которые гарантируют, что дерево ячеек,
присутствующих в блоке, действительно является допустимой сериализацией
значения ожидаемого абстрактного типа данных. Такие условия сериализации могут
быть автоматически сгенерированы из схемы </span><span lang=EN-US>TL</span><span
lang=RU>-</span><span lang=EN-US>B</span><span lang=RU>, описывающей
абстрактный тип данных и его сериализацию в дерево ячеек.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.5pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Обратите внимание, что
условия сериализации представляют собой набор взаимно рекурсивных предикатов на
ячейках или срезах ячеек. Например, если значение типа </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>A</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>состоит из
32-битного магического числа </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>mA</span></i><i><span lang=RU style='font-family:"Cambria",serif'>,
64-битного целого числа </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>l</span></i><i><span
lang=RU style='font-family:"Cambria",serif'> и двух ссылок на ячейки,
содержащие значения типов </span></i><i><span lang=EN-US style='font-family:
"Cambria",serif'>B</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>и </span><i><span lang=EN-US style='font-family:"Cambria",serif'>C</span></i><i><span
lang=RU style='font-family:"Cambria",serif'> соответственно, то правильное
условие сериализации для значений типа </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>A</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>потребует, чтобы
ячейка или срез ячейки содержали ровно 96 бит данных и две ссылки на ячейки </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>r</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>1 </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>r</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>2, с дополнительными требованиями, чтобы
первые 32 бита данных содержали мА, и две ячейки, обозначаемые </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>r</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>1 </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>r</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>2</span></i><span lang=RU>, удовлетворяли
условиям сериализации для значений типов </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>B</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>C</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> соответственно.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:15.25pt;
margin-left:0cm;text-indent:0cm'><span lang=RU>1.3.7<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=RU>Конструктивное устранение кванторов существования.
Местные условия, которые иногда можно было бы навязать,<i> неконструируемы, а
это означает, что они не обязательно содержат объяснение того, почему они
истинны. Типичный пример такого условия </i></span><i><span lang=RU
style='font-family:"Cambria",serif'>С </span></i><span lang=RU>приведен</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:8.4pt;margin-left:0cm;text-align:left;text-indent:0cm;line-height:
107%'><span lang=RU style='font-size:11.0pt;line-height:107%'>                                             </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>C</span></i><span lang=EN-US
style='font-family:"Cambria",serif'>: ≡ ∀<sub>(x: X)</sub> ∃<sub>(y: Y)</sub></span><span
lang=EN-US style='font-size:8.0pt;line-height:107%;font-family:"Cambria",serif'>
</span><span lang=EN-US style='line-height:107%;font-family:"Cambria",serif'>A</span><span
lang=EN-US style='font-size:8.0pt;line-height:107%;font-family:"Cambria",serif'>
(x, y)</span><span lang=EN-US style='font-family:"Cambria",serif'>                      
<i> </i></span><span lang=EN-US>(</span><span lang=EN-US>5)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:1.1pt;
margin-left:-.25pt'><span lang=RU>&quot;для любого </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>x</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>из </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>X</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> существует </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>y</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>из </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>Y</span></i><span lang=RU>,
такое, что условие </span><i><span lang=EN-US style='font-family:"Cambria",serif'>A</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>x</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>,</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>y</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU>выполняется&quot;.
Даже если мы знаем</span><i><span lang=RU style='font-family:"Cambria",serif'>,
что </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>C</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>истинен,
у нас нет способа быстро найти </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>y</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU style='font-family:"Cambria",serif'>: </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>Y</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>,</span></i><span lang=RU> такой, что </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>A</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>x</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>,</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>y</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>), для данного </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>: </span><i><span lang=EN-US style='font-family:"Cambria",serif'>X</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>. Как следствие, проверка С </span></i><span
lang=RU>может быть довольно трудоемкой.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.0pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Чтобы упростить проверку
локальных условий, их делают <i>конструируемыми </i>(т.е. проверяемыми в
ограниченное время) путем добавления некоторых <i>структур данных-свидетелей</i>.
Например, условие </span><i><span lang=EN-US style='font-family:"Cambria",serif'>C</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>из (5)
может быть преобразовано путем добавления новой структуры данных </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>f</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>: </span><i><span lang=EN-US style='font-family:"Cambria",serif'>X</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>→ </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>Y</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>(карта </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>f</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>от </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>X</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>до </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>Y</span></i><span lang=RU>) и
введения вместо</span><i><span lang=RU style='font-family:"Cambria",serif'>
условия </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>C</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>этого
следующего</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:6.4pt;margin-left:0cm;text-align:left;text-indent:0cm;line-height:
110%'><span lang=RU style='font-size:11.0pt;line-height:110%'>                                            </span><span
lang=RU><img width=112 height=15 id="Picture 148326"
src="tblkch_convertio_ru_done.fld/image002.jpg"></span><i><span lang=RU
style='font-family:"Cambria",serif'>    .                                        </span></i><span
lang=RU>(6)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.9pt;
margin-left:-.25pt'><span lang=RU>Конечно, &quot;свидетельское&quot; значение </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>f</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>x</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) : </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>Y</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>может быть
включено в (модифицированный) тип данных </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>X</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>вместо того,
чтобы храниться в отдельной таблице </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>f</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.4pt;
margin-left:-.25pt'><span lang=RU>1.3.8. Пример: условие согласованности для </span><i><span
lang=EN-US>InMsgDescr</span></i><i><span lang=RU>. Например, условие
согласованности между </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>X</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>:= </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=RU>, списком всех входящих сообщений, обработанных в блоке, и </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>Y</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>:= </span><i><span lang=EN-US>Transactions</span></i><i><span
lang=RU>, списком всех транзакций, присутствующих в блоке, имеет следующий вид:
«Для любого входного сообщения </span></i><i><span lang=EN-US style='font-family:
"Cambria",serif'>x</span></i><i><span lang=RU style='font-family:"Cambria",serif'>,
</span></i><span lang=RU>присутствующего в </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=RU>, транзакция </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>y</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>должна
присутствовать в блоке таким образом, чтобы </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>y</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>обрабатывала </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>».</span></i><a href="#_ftn8"
name="_ftnref8" title=""><sup><span lang=EN-US><sup><span lang=EN-US
style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'>[8]</span></sup></span></sup></a><sup><span lang=EN-US> </span></sup><span
lang=RU>Процедура устранения </span><span lang=RU style='font-family:"Cambria",serif'>∃,
описанная в 1.3.7, приводит к введению дополнительного поля в дескрипторы
входящих сообщений </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=RU>, содержащего ссылку на транзакцию, в которой сообщение фактически
обрабатывается.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:5.35pt;
margin-left:-.25pt;line-height:110%'><span lang=RU>1.3.9. Конструктивное
устранение логических расхождений. Аналогично преобразованию, описанному в
разделе 1.3.7, условие</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:6.4pt;margin-left:0cm;text-align:left;text-indent:0cm;line-height:
110%'><span lang=RU style='font-size:11.0pt;line-height:110%'>                                        </span><span
lang=RU><img width=138 height=15 id="Picture 148327"
src="tblkch_convertio_ru_done.fld/image003.jpg"></span><i><span lang=RU
style='font-family:"Cambria",serif'>    ,                                   </span></i><span
lang=RU>(7)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:13.6pt;
margin-left:-.25pt'><span lang=RU>&quot;для всех </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>x</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>из </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>X</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, по меньшей мере один из </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>A</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>1</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>x</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>A</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>2</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>x</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU>содержит&quot;,
может быть преобразован в функцию </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>i</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU style='font-family:"Cambria",serif'>: </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>X</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>→ <b>2 </b>= {1,2} </span><span lang=RU>и новое условие</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:8.4pt;margin-left:0cm;text-align:left;text-indent:0cm;line-height:
107%'><span lang=RU style='font-size:11.0pt;line-height:107%'>                                                </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>D</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ </span></i><span lang=RU
style='font-family:"Cambria",serif'>: ≡ ∀ <sub>(</sub></span><sub><span
lang=EN-US style='font-family:"Cambria",serif'>x</span></sub><sub><span
lang=RU style='font-family:"Cambria",serif'>: </span></sub><sub><span
lang=EN-US style='font-family:"Cambria",serif'>X</span></sub><sub><span
lang=RU style='font-family:"Cambria",serif'>)</span></sub><span lang=RU
style='font-family:"Cambria",serif'> </span><span lang=EN-US style='font-family:
"Cambria",serif'>A<sub>i</sub></span><sub><span lang=RU style='font-family:
"Cambria",serif'>(</span></sub><sub><span lang=EN-US style='font-family:"Cambria",serif'>x</span></sub><sub><span
lang=RU style='font-family:"Cambria",serif'>)</span></sub><span lang=RU
style='font-family:"Cambria",serif'> (</span><span lang=EN-US style='font-family:
"Cambria",serif'>x</span><span lang=RU style='font-family:"Cambria",serif'>)                                            </span><span
lang=RU> (8)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:9.15pt;
margin-left:-.25pt;line-height:103%'><span lang=RU>Это частный случай
элиминации экзистенциального квантора, рассмотренный ранее для </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>Y</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= <b>2 </b>= {1,2}. Это может быть полезно, когда </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>A</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>1</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>x</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>A</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>2</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>x</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU>являются
сложными условиями, которые не могут быть быстро проверены, так что полезно
заранее знать, какой из них на самом деле верен.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Например, </span><i><span
lang=EN-US>InMsgDescr</span></i><i><span lang=RU>, как рассмотрено в 1.3.8,
может содержать как сообщения, обработанные в блоке, так и транзитные
сообщения. Мы могли бы ввести поле в описание входящего сообщения, чтобы
указать, является ли сообщение транзитным или нет, и, в последнем случае,
включить поле свидетеля для транзакции, обрабатывающей сообщение.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.3.10. Конструктивизация условий. Этот
процесс устранения неконструируемых логических связующих </span><span lang=RU
style='font-family:"Cambria",serif'>∃ </span><span lang=RU>(квантификатор
существования) и (иногда) </span><span lang=RU style='font-family:"Cambria",serif'>∨
</span><span lang=RU>(логическая дизъюнкция) путем введения дополнительных
структур данных и полей, то есть процесса создания конструктивизма условия,
будет называться <i>конструктивизацией. Если довести этот процесс до
теоретического предела, то получается логические формулы, содержащие только универсальные
квантификаторы и логические соединения, за счет добавления некоторых
полей-свидетелей в определенные структуры данных.</i></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.3.11. Условия действия блока. В конечном
счете, все внутренние условия для блока, наряду с локальным предшественником и
соседними условиями, включающими этот блок и другой ранее сгенерированный блок,
составляют <i>условия действительности </i>для блока шардчейна или мастерчейна.
Блок действителен<i>,</i> если он удовлетворяет условиям действительности.
Валидаторы несут ответственность за генерацию допустимых блоков, а также за
проверку валидности блоков, сгенерированных другими валидаторами.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.4pt;
margin-left:-.25pt'><span lang=RU>1.3.12. Свидетели недействительности
блокировки. Если блок не удовлетворяет всем условиям действительности </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>C</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>1</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'>,..., </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>C<sub>n</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>(т.е.
соединению </span><i><span lang=EN-US style='font-family:"Cambria",serif'>V</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>:≡ ⋀</span><sub><span lang=EN-US
style='font-family:"Cambria",serif'>i</span></sub><span lang=EN-US
style='font-family:"Cambria",serif'> </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>C<sub>i</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>условий
валидности), он <i>является недействительным. Это означает, что он
удовлетворяет «условию недействительности»    </i></span><span lang=RU
style='font-family:"Cambria",serif'>¬</span><span lang=EN-US style='font-family:
"Cambria",serif'>V</span><span lang=RU style='font-family:"Cambria",serif'> = ⋁</span><sub><span
lang=EN-US style='font-family:"Cambria",serif'>i</span></sub><span lang=RU
style='font-family:"Cambria",serif'>¬</span><span lang=EN-US style='font-family:
"Cambria",serif'>C<sub>i</sub></span><span lang=RU style='font-family:"Cambria",serif'>.
Если все </span><i><span lang=EN-US style='font-family:"Cambria",serif'>C<sub>i</sub></span></i><i><span
lang=RU style='font-family:"Cambria",serif'> — и, следовательно, также </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>V</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>— были
«конструированы» в смысле, описанном в 1.3.10, так что они содержат только логические
соединения и универсальные кванторы (и простые атомные предложения), то </span><span
lang=RU style='font-family:"Cambria",serif'>¬</span><span lang=EN-US
style='font-family:"Cambria",serif'>V</span><span lang=EN-US style='font-family:
"Cambria",serif'> </span><span lang=RU>содержит только логические дизъюнкции и
экзистенциальные кванторы. Затем может быть определена конструктивизация </span><span
lang=RU style='font-family:"Cambria",serif'>¬</span><span lang=EN-US
style='font-family:"Cambria",serif'>V</span><span lang=RU style='font-family:
"Cambria",serif'>,</span><span lang=RU> которая будет включать <i>свидетеля
недействительности, начиная с индекса </i></span><i><span lang=EN-US
style='font-family:"Cambria",serif'>i</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>конкретного
условия валидности </span><i><span lang=EN-US style='font-family:"Cambria",serif'>Ci</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>,</span></i><span lang=RU> которое
не выполняется.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Такие свидетели
недействительности также могут быть сериализованы и представлены другим
валидаторам или помещены в мастерчейн, чтобы доказать, что конкретный блок или
кандидат на блок действительно недействителен. Таким образом, построение и
сериализация свидетелей недействительности является важной частью
блокчейн-дизайна </span><span lang=EN-US>Proof</span><span lang=RU>-</span><span
lang=EN-US>of</span><span lang=RU>-</span><span lang=EN-US>Stake</span><span
lang=RU> (</span><span lang=EN-US>PoS</span><span lang=RU>).</span><a
href="#_ftn9" name="_ftnref9" title=""><sup><span lang=EN-US><sup><span
lang=EN-US style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'>[9]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.1pt;
margin-left:-.25pt'><span lang=RU>1.3.13. Минимизация размера свидетелей.
Важным соображением для проектирования локальных условий, их разложения на
более простые условия и их конструктивизации является то, чтобы сделать
проверку каждого условия как можно более простой. Однако другое требование
состоит в том, что мы должны минимизировать размер свидетелей как для условия
(чтобы размер блока не слишком увеличивался в процессе конструктивизации), так
и для его отрицания (чтобы доказательства недействительности имели ограниченный
размер, что упрощает их проверку, передачу и включение в мастерчейн). Эти два
принципа проектирования иногда противоречат друг другу, и тогда необходимо
искать компромисс.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>1.3.14. Минимизация размера доказательств
Меркла. Условия согласованности первоначально предназначались для обработки
стороной, которая уже имеет все соответствующие данные (например, все блоки,
упомянутые в условии). В некоторых случаях, однако, они должны быть проверены
стороной, которая не имеет всех рассматриваемых блоков, но знает только их
хэши. Например, предположим, что доказательство недействительности блока было
дополнено подписью валидатора, который подписал недействительный блок (и,
следовательно, должен был быть наказан). В этом случае подпись будет содержать
только хэш неправильно подписанного блока; сам блок должен быть восстановлен из
другого места, прежде чем проверять доказательство недействительности блока.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Компромисс между
предоставлением только хэша предположительно недопустимого блока и
предоставлением всего недопустимого блока вместе со свидетелем
недействительности заключается в том, чтобы дополнить свидетеля
недействительности доказательством Меркла, начиная с хэша блока (то есть
корневой ячейки блока). Такое доказательство будет включать в себя все клетки,
упомянутые в свидетеле недействительности, а также все клетки на путях от этих
клеток к корневым клеткам и хэши их братьев и сестер. Тогда доказательство
недействительности становится достаточно самодостаточным, чтобы само по себе
обеспечить достаточное обоснование для наказания валидатора. Например,
доказательство недействительности, предложенное выше, может быть представлено
смарт-контракту, находящемуся в мастерчейне, который наказывает валидаторов за
неправильное поведение.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.15pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Поскольку такое
доказательство недействительности должно быть дополнено доказательством Меркла,
имеет смысл записать условия непротиворечивости так, чтобы доказательства
Меркла для их отрицаний были как можно меньше. В частности, каждое отдельное
состояние должно быть максимально «локальным» (т.е. включать минимальное
количество клеток). Это также оптимизирует время проверки доказательства
недействительности.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:1.15pt;
margin-left:-.25pt'><span lang=RU>1.3.15. Сопоставленные данные для внешних
условий. Когда валидатор предлагает неподписанный блок другим валидаторам
шардчейна, эти другие валидаторы должны проверить достоверность этого кандидата
в блоки, т. е. убедиться, что он удовлетворяет всем внутренним и внешним
условиям локальной согласованности. В то время как внутренние условия не
требуют каких-либо дополнительных данных в дополнение к самому кандидату в
блоки, внешние условия нуждаются в некоторых других блоках или, по крайней
мере, некоторой информации из этих блоков. Такая дополнительная информация может
быть извлечена из этих блоков вместе со всеми ячейками на путях из ячеек,
содержащих необходимую дополнительную информацию, в корневую ячейку
соответствующих блоков и хэши братьев и сестер ячеек на этих путях, чтобы
представить доказательство Меркла, которое может быть обработано без знания
самих упомянутых блоков.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Эта дополнительная
информация, называемая собранными <i>данными, сериализуется в виде пакета ячеек
и представляется валидатором вместе с самим кандидатом в блоки без знака.
Блок-кандидат вместе с собранными данными называется собранным блоком.</i></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.3.16. Условия для сопоставленного блока. Таким
образом, внешние условия согласованности для кандидата в блоки (автоматически)
преобразуются во <i>внутренние </i>условия согласованности для сопоставленного
блока, что значительно упрощает и ускоряет их проверку другими валидаторами.
Однако некоторые данные, такие как конечное состояние непосредственного
предшественника проверяемого блока, не сопоставляются. Вместо этого все
валидаторы должны хранить локальную копию этих данных.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.85pt;
margin-left:-.25pt'><span lang=RU>1.3.17. Условия представительства и хэши
представительства. Обратите внимание, что как только доказательства Меркла
включены в собранный блок, условия согласованности должны учитывать, какие
данные (т. Е. Какие ячейки) фактически присутствуют в собранном блоке, а не
просто упоминаются их хэшами. Это приводит к новой группе условий, называемых
условиями <i>представления, которые должны быть в состоянии отличить внешнюю
ссылку на ячейку (обычно представленную ее 256-битным хэшем) от самой ячейки.
Валидатор может быть наказан за предложение собранного блока, который не
содержит всех ожидаемых сопоставленных данных внутри, даже если сам кандидат в
блок действителен.</i></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Это также приводит к
использованию <i>репрезентативных хэшей </i>вместо прозрачных <i>хэшей </i>для
собранных блоков.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.3.18. Верификация при отсутствии собранных
данных. Обратите внимание, что блок по-прежнему должен быть проверяемым в
отсутствие собранных данных; в противном случае ни одна из сторон, кроме
валидаторов, не сможет проверить ранее зафиксированный блок своими собственными
средствами. В частности, свидетели не могут быть включены в собранные данные:
они должны находиться в самом блоке. Собранные данные должны содержать только
некоторые части соседних блоков, упомянутых в основном блоке, вместе с подходящими
доказательствами Меркла, которые могут быть реконструированы любым, у кого есть
сами блоки, на которые имеются ссылки.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.3.19. Включение доказательств Меркла в сам
блок. Обратите внимание, что в некоторых случаях доказательства Меркла должны
быть встроены в сам блок, а не только в собранные данные. </span><span
lang=EN-US>Например:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Во время мгновенной маршрутизации гиперкубов (</span><span
lang=EN-US>IHR</span><span lang=RU>) сообщение может быть включено
непосредственно в </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>блока шардчейна назначения, не проходя
весь путь по краям гиперкуба. В этом случае доказательство Меркла о
существовании сообщения в </span><i><span lang=EN-US>OutMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>блока исходного шардчейна должно быть
включено в </span><i><span lang=EN-US>InMsgDescr</span></i><i><span lang=EN-US>
</span></i><span lang=RU>вместе с самим сообщением.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Доказательство недействительности или другое
доказательство неправомерного поведения валидатора может быть зафиксировано в
мастерчейне путем включения его в тело сообщения, отправленного на специальный
смарт-контракт. В этом случае доказательство недействительности должно включать
некоторые ячейки вместе с доказательством Меркла, которое, следовательно,
должно содержаться в теле сообщения.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Аналогичным образом, смарт-контракт, определяющий
платежный канал или другой вид боковой цепочки, может принимать сообщения о
завершении или сообщения с доказательством неправильного поведения, которые
содержат подходящие доказательства Меркла.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Конечное состояние шардчейна не входит в блок
шардчейна. Вместо этого включаются только те ячейки, которые были изменены; те
клетки, которые унаследованы от старого состояния, называются их хэшами, наряду
с подходящими доказательствами Меркла, состоящими из клеток на пути от корня
старого состояния к клеткам старого состояния, о которых идет речь.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.3.20. Положения об обработке неполных
данных. Как мы видели, необходимо включать неполные данные и доказательства
Меркла в тело блока, в тело некоторых сообщений, содержащихся в блоке, и в
состояние. Эта необходимость отражается некоторыми дополнительными условиями
представления, а также положениями о том, что сообщения (и, соответственно,
клеточные деревья, обработанные </span><span lang=EN-US>TVM</span><span
lang=RU>) содержат неполные данные (внешние ссылки на ячейки и доказательства
Меркла). В большинстве случаев такие внешние ссылки на ячейки содержат только
256-битный хэш </span><span lang=EN-US>sha</span><span lang=RU>256 ячейки
вместе с флагом; если смарт-контракт пытается проверить содержимое такой ячейки
примитивом </span><span lang=EN-US>CTOS</span><span lang=RU> (например, для
десериализации), срабатывает исключение. Однако внешняя ссылка на такую ячейку
может быть сохранена в постоянном хранилище смарт-контракта, и могут быть
вычислены как прозрачные, так и репрезентативные хэши такой ячейки.</span></p>

</div>

<span lang=RU style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'><br clear=all style='page-break-before:always'>
</span>

<div class=WordSection5>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:7.5pt;
margin-bottom:22.9pt;margin-left:.5pt;text-align:center;line-height:141%'><span
lang=RU style='font-size:11.0pt;line-height:141%'>1.4. Логическое время и
логические временные интервалы</span></p>

<h2 style='margin-top:0cm;margin-right:0cm;margin-bottom:5.6pt;margin-left:
21.3pt;text-indent:-24.0pt'><a name="_Toc150760"><span lang=RU>1.4<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span lang=RU>Логическое
время и логические временные интервалы</span></a></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.5pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>В этом разделе более подробно рассматривается
так называемое логическое <i>время, широко используемое в блокчейне </i></span><i><span
lang=EN-US>TON</span></i><i><span lang=RU> для пересылки сообщений и гарантий
доставки сообщений, среди других целей.</span></i></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:12.25pt;margin-left:-.25pt;text-align:left;line-height:103%'><span
lang=RU>1.4.1. Логическое время. Компонентом </span><span lang=EN-US>TON</span><span
lang=EN-US> </span><span lang=EN-US>Blockchain</span><span lang=RU>, который
также играет важную роль в доставке сообщений, является <i>логическое время,
обычно обозначаемое </i></span><span lang=EN-US>Lt</span><i><span lang=RU>. Это
неотрицательное 64-битное целое число, назначенное определенным событиям
примерно следующим образом:</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:28.9pt;margin-bottom:
8.35pt;margin-left:29.75pt;line-height:125%'><span lang=RU>Если событие </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>e</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>логически зависит
от событий </span><i><span lang=EN-US style='font-family:"Cambria",serif'>e</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>1</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'>,..., </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>e<sub>n</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, то </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>Lt</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>e</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU>является
наименьшим неотрицательным целым числом, большим, чем все </span><span
lang=EN-US>Lt</span><span lang=RU>(</span><span lang=EN-US>e<sub>i</sub></span><span
lang=RU>).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>В частности, если </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>n</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 0 </span><span lang=RU>(т.е. если </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>e</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>не зависит от
каких-либо предшествующих событий), то </span><span lang=EN-US>Lt</span><span
lang=RU>(</span><span lang=EN-US>e</span><span lang=RU>) = 0.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.4.2. Расслабленный вариант логического
времени. В некоторых случаях мы ослабляем определение логического времени,
требуя только того, чтобы</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:15.1pt;margin-left:0cm;text-align:left;text-indent:0cm'><span
lang=RU style='font-size:11.0pt;line-height:104%'>          </span><span
lang=EN-US>Lt</span><span lang=RU>(</span><span lang=EN-US>e</span><span
lang=RU>) </span><i><span lang=RU style='font-family:"Cambria",serif'>&gt; </span></i><span
lang=EN-US>Lt</span><span lang=RU>(</span><span lang=EN-US>e</span><span
lang=RU>’)</span><span lang=RU style='font-family:"Cambria",serif'> </span><span
lang=RU>всякий раз, когда </span><span lang=RU><img width=65 height=13
id="Picture 148328" src="tblkch_convertio_ru_done.fld/image004.jpg"></span><span
lang=RU> логически зависит от </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>e</span></i><i><span lang=RU style='font-family:"Cambria",serif'>’),
(9)</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:-.85pt;margin-bottom:
10.65pt;margin-left:-.25pt'><span lang=RU>не настаивая на том, чтобы </span><span
lang=EN-US>Lt</span><span lang=RU>(</span><span lang=EN-US>e</span><span
lang=RU>) был наименьшим неотрицательным целым числом с этим свойством. В таких
случаях можно говорить о <i>расслабленном </i>логическом времени, в отличие от
строгого логического времени, определенного выше (см. 1.4.1). Заметьте, однако,
что условие (9) является фундаментальным свойством логического времени и не
может быть ослаблено дальше.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:2.15pt;
margin-left:-.25pt'><span lang=RU>1.4.3. Логические временные интервалы. Имеет
смысл присвоить некоторым событиям или коллекциям событий </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>C</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><i><span lang=RU>интервал </span></i><span
lang=RU>логических времен </span><span lang=EN-US>Lt</span><span lang=RU>•(</span><span
lang=EN-US>C</span><span lang=RU>) = [</span><span lang=EN-US>Lt</span><span
lang=RU>−(</span><span lang=EN-US>C</span><span lang=RU>),</span><span
lang=EN-US>Lt</span><span lang=RU>+(</span><span lang=EN-US>C</span><span
lang=RU>)), означающий, что сбор событий </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>C</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>происходил в
указанном «интервале» логических времен, где </span><span lang=EN-US>Lt</span><span
lang=RU>−(</span><span lang=EN-US>C</span><span lang=RU>) </span><i><span
lang=RU style='font-family:"Cambria",serif'>&lt; </span></i><span lang=EN-US>Lt</span><span
lang=RU>+(</span><span lang=EN-US>C</span><span lang=RU>) — некоторые целые
числа (на практике 64-битные целые числа). В этом случае можно сказать, что </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>C</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><i><span lang=RU>начинается </span></i><span
lang=RU>в логическом времени </span><span lang=EN-US>Lt</span><span lang=RU>−(</span><span
lang=EN-US>C</span><span lang=RU>) и <i>заканчивается </i>в логическом времени </span><span
lang=EN-US>Lt</span><span lang=RU>+(</span><span lang=EN-US>C</span><span
lang=RU>).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>По умолчанию мы
предполагаем, что </span><span lang=EN-US>Lt</span><span lang=RU>+(</span><span
lang=EN-US>e</span><span lang=RU>) = </span><span lang=EN-US>Lt</span><span
lang=RU>(</span><span lang=EN-US>e</span><span lang=RU>)+1 и </span><span
lang=EN-US>Lt</span><span lang=RU>−(</span><span lang=EN-US>e</span><span
lang=RU>) = </span><span lang=EN-US>Lt</span><span lang=RU>(</span><span
lang=EN-US>e</span><span lang=RU>) для простых или «атомных» событий,
предполагая, что они длятся ровно одну единицу логического времени.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>В общем, если у нас есть
одно значение </span><span lang=EN-US>Lt</span><span lang=RU>(</span><span
lang=EN-US>C</span><span lang=RU>), а также логический временной интервал </span><span
lang=EN-US>Lt</span><span lang=RU>•(</span><span lang=EN-US>C</span><span
lang=RU>) = [</span><span lang=EN-US>Lt</span><span lang=RU>−(</span><span
lang=EN-US>C</span><span lang=RU>),</span><span lang=EN-US>Lt</span><span
lang=RU>+(</span><span lang=EN-US>C</span><span lang=RU>)), мы всегда требуем,
чтобы</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:12.15pt;margin-left:0cm;text-align:left;text-indent:0cm;
line-height:107%'><span lang=RU style='font-size:11.0pt;line-height:107%'>                                                </span><span
lang=EN-US>Lt</span><span lang=RU>(</span><span lang=EN-US>C</span><span
lang=RU>) </span><span lang=RU style='font-family:"Cambria Math",serif'>∈</span><span
lang=RU> [</span><span lang=EN-US>Lt</span><span lang=RU>−(</span><span
lang=EN-US>C</span><span lang=RU>),</span><span lang=EN-US>Lt</span><span
lang=RU>+(</span><span lang=EN-US>C</span><span lang=RU>))</span><span lang=RU
style='font-family:"Cambria",serif'>                                           </span><span
lang=RU>(10)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.55pt;
margin-left:0cm;text-indent:0cm'><span lang=RU>или, эквивалентно,</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:8.75pt;margin-left:0cm;text-align:left;text-indent:0cm;
line-height:107%'><span lang=RU style='font-size:11.0pt;line-height:107%'>                                                </span><span
lang=EN-US>Lt</span><span lang=RU>−(</span><span lang=EN-US>C</span><span
lang=RU>) ≤ </span><span lang=EN-US>Lt</span><span lang=RU>(</span><span
lang=EN-US>C</span><span lang=RU>) </span><i><span lang=RU style='font-family:
"Cambria",serif'>&lt; </span></i><span lang=EN-US>Lt</span><span lang=RU>+(</span><span
lang=EN-US>C</span><span lang=RU>)</span><span lang=RU style='font-family:"Cambria",serif'>                                           </span><span
lang=RU>(11)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>В большинстве случаев мы выбираем </span><span
lang=EN-US>Lt</span><span lang=RU>(</span><span lang=EN-US>C</span><span
lang=RU>) = </span><span lang=EN-US>Lt</span><span lang=RU>−(</span><span
lang=EN-US>C</span><span lang=RU>).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.4.4. Требования к логическим временным
интервалам. Тремя основными требованиями к логическим временным интервалам
являются:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU style='font-family:"Cambria",serif'>0 ≤ </span><span
lang=EN-US>Lt</span><span lang=RU>−(</span><span lang=EN-US>C</span><span
lang=RU>) </span><i><span lang=RU style='font-family:"Cambria",serif'>&lt; </span></i><span
lang=EN-US>Lt</span><span lang=RU>+(</span><span lang=EN-US>C</span><span
lang=RU>) являются неотрицательными целыми числами для любой коллекции событий </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>C</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:12.4pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Если </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>e</span></i><i><span lang=RU style='font-family:"Cambria",serif'>’
</span></i><span lang=RU style='font-family:"Cambria",serif'>≺ </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>e</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>(т.е. если
атомное событие </span><i><span lang=EN-US style='font-family:"Cambria",serif'>e</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>логически
зависит от другого атомарного события </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>e</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’), то </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>Lt</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>•(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>e</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’) &lt; </span></i><span lang=EN-US>Lt</span><span
lang=RU>•(</span><span lang=EN-US>e</span><span lang=RU>) (т.е. </span><span
lang=EN-US>Lt</span><span lang=RU>+(</span><span lang=EN-US>e</span><span
lang=RU>’) ≤ </span><span lang=EN-US>Lt</span><span lang=RU>−(</span><span
lang=EN-US>e</span><span lang=RU>)).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:13.35pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Если </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>C</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU style='font-family:"Cambria",serif'>⊃ </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>D</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>(т.е. если
коллекция событий </span><i><span lang=EN-US style='font-family:"Cambria",serif'>C</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>содержит
другую коллекцию событий </span><i><span lang=EN-US style='font-family:"Cambria",serif'>D</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>), то </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>Lt</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>•(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>C</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU
style='font-family:"Cambria",serif'>⊃<i> </i></span><span lang=EN-US>Lt</span><span
lang=RU>•(</span><span lang=EN-US>D</span><span lang=RU>), т.е.</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:15.4pt;margin-left:0cm;text-align:left;text-indent:0cm;
line-height:107%'><span lang=RU style='font-size:11.0pt;line-height:107%'>                                             </span><span
lang=EN-US>Lt</span><span lang=RU>−(</span><span lang=EN-US>C</span><span
lang=RU>) ≤ </span><span lang=EN-US>Lt</span><span lang=RU>−(</span><span
lang=EN-US>D</span><span lang=RU>) </span><i><span lang=RU style='font-family:
"Cambria",serif'>&lt; </span></i><span lang=EN-US>Lt</span><span lang=RU>+(</span><span
lang=EN-US>D</span><span lang=RU>) ≤ </span><span lang=EN-US>Lt</span><span
lang=RU>+(</span><span lang=EN-US>C</span><span lang=RU>)</span><span lang=RU
style='font-family:"Cambria",serif'>                              </span><span
lang=RU>(12)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.75pt;line-height:125%'><span lang=RU>В частности, если </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>C</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>состоит из
атомных событий </span><i><span lang=EN-US style='font-family:"Cambria",serif'>e</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>1</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'>,..., </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>e<sub>n</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, то </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>Lt</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>−(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>C</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) ≤ </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>inf<sub>i</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=EN-US>Lt</span><span
lang=RU>−(</span><span lang=EN-US>e<sub>i</sub></span><span lang=RU>) ≤ </span><span
lang=EN-US>inf<sub>i</sub></span><span lang=EN-US> </span><span lang=EN-US>Lt</span><span
lang=RU>(</span><span lang=EN-US>e<sub>i</sub></span><span lang=RU>) и </span><span
lang=EN-US>Lt</span><span lang=RU>+(</span><span lang=EN-US>C</span><span
lang=RU>) ≥ </span><span lang=EN-US>sup<sub>i</sub></span><span lang=EN-US> </span><span
lang=EN-US>Lt</span><span lang=RU>+(</span><span lang=EN-US>e<sub>i</sub></span><span
lang=RU>) ≥ 1+</span><span lang=EN-US>sup<sub>i</sub></span><span lang=EN-US> </span><span
lang=EN-US>Lt</span><span lang=RU>(</span><span lang=EN-US>e<sub>i</sub></span><span
lang=RU>). </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.5pt;margin-bottom:3.35pt;
margin-left:-.25pt'><span lang=RU>1.4.5. Строгие, или минимальные, логические
временные интервалы. Любой конечной совокупности атомарных событий </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= {</span><span lang=EN-US style='font-family:"Cambria",serif'>e</span><span
lang=RU style='font-family:"Cambria",serif'>}, </span><span lang=RU>связанных
причинно-следственным отношением (частичным порядком) </span><span lang=RU
style='font-family:"Cambria",serif'>можно присвоить ≺, а всем подмножествам </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>C</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>⊂ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><i><span lang=RU>— </span></i><span
lang=RU>минимальные логические промежутки времени. То есть среди всех
присвоений логических временных интервалов, удовлетворяющих условиям,
перечисленным в 1.4.4, мы выбираем тот, который имеет все </span><span
lang=EN-US>Lt</span><span lang=RU>+(</span><span lang=EN-US>C</span><span
lang=RU>) − </span><span lang=EN-US>Lt</span><span lang=RU>−(</span><span
lang=EN-US>C</span><span lang=RU>) как можно меньше, а если существует
несколько назначений с этим свойством, то выбираем и ту, которая имеет
минимальный </span><span lang=EN-US>Lt</span><span lang=RU>−(</span><span
lang=EN-US>C</span><span lang=RU>).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.5pt;margin-bottom:0cm;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Такое присвоение может
быть достигнуто путем сначала присвоения логического времени </span><span
lang=EN-US>Lt</span><span lang=RU>(</span><span lang=EN-US>e</span><span
lang=RU>) всем атомарным событиям </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>e</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU style='font-family:"Cambria",serif'>∈ </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>,</span></i><span lang=RU> как описано в
1.4.1, а затем установки </span><span lang=EN-US>Lt</span><span lang=RU>−(</span><span
lang=EN-US>C</span><span lang=RU>) := </span><span lang=EN-US>inf<sub>e</sub></span><sub><span
lang=RU style='font-family:"Cambria Math",serif'>∈</span><span lang=EN-US>C</span></sub><span
lang=EN-US> </span><span lang=EN-US>Lt</span><span lang=RU>(</span><span
lang=EN-US>e</span><span lang=RU>) и</span><sup><span lang=RU style='font-size:
18.5pt;line-height:104%'> </span></sup><span lang=EN-US>Lt</span><span lang=RU>+(</span><span
lang=EN-US>C</span><span lang=RU>) := 1 + </span><span lang=EN-US>sup<sub>e</sub></span><sub><span
lang=RU style='font-family:"Cambria Math",serif'>∈</span><span lang=EN-US>C</span></sub><span
lang=EN-US> </span><span lang=EN-US>Lt</span><span lang=RU>(</span><span
lang=EN-US>e</span><span lang=RU>) для любого </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>C</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>⊂ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>В большинстве случаев,
когда нам нужно назначить логические временные интервалы, мы используем
минимальные логические временные интервалы, только что описанные.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>1.4.6. Логическое время в блокчейне </span><span
lang=EN-US>TON</span><span lang=RU>. Блокчейн </span><span lang=EN-US>TON</span><span
lang=RU> присваивает логическое время и логические временные интервалы
нескольким своим компонентам.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.5pt;margin-bottom:.1pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Например, каждому
исходящему сообщению, созданному в транзакции, присваивается <i>время
логического создания; для этого создание исходящего сообщения считается
атомарным событием, логически зависящим от предыдущего сообщения, созданного
той же транзакцией, а также от предыдущей транзакции той же учетной записи, от
входящего сообщения, обработанного той же транзакцией, и на всех событиях,
содержащихся в блоках, на которые ссылаются хэши, содержащиеся в блоке с той же
транзакцией. Как следствие, исходящие сообщения, созданные одним и тем же
смарт-контрактом, строго увеличивают время логического создания. </i>Сама
транзакция считается совокупностью атомарных событий, и ей присваивается
логический временной интервал (см. 4.2.1 для более точного описания).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.5pt;margin-bottom:21.4pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Каждый блок представляет
собой коллекцию событий создания транзакций и сообщений, поэтому ему
присваивается логический интервал времени, явно указанный в заголовке блока.</span></p>

<h2 style='margin-left:1.0cm;text-indent:-1.0cm'><a name="_Toc150761"><span
lang=EN-US>1.5<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>Общее состояние блокчейна</span></a></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.5pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>В этом разделе обсуждается общее состояние
блокчейна </span><span lang=EN-US>TON</span><span lang=RU>, а также состояния
отдельных шардчейнов и мастерчейнов. Например, точное определение состояния
соседних шардчейнов становится решающим для правильной формализации условия
непротиворечивости, утверждающего, что валидаторы для шардчейна должны
импортировать самые старые сообщения из союза </span><i><span lang=EN-US>OutMsgQueues</span></i><i><span
lang=RU>, взятые из состояний всех соседних шардчейнов (см. 2.2.5).</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.5pt;margin-bottom:0cm;
margin-left:.5pt;line-height:108%'><span lang=RU>1.5.1. Общее состояние,
определяемое блоком мастерчейна. Каждый блок мастерчейна содержит список всех
активных в данный момент сегментов и последних блоков для каждого из них. В
этом отношении <i>каждый блок мастерчейна определяет соответствующее общее
состояние блокчейна </i></span><i><span lang=EN-US>TON</span></i><i><span
lang=RU>, поскольку он фиксирует состояние каждого шардчейна, а также
мастерчейна.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.5pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Важное требование,
предъявляемое к этому списку последних блоков для всех блоков шардчейна,
заключается в том, что, если блок мастерчейна </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>B</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>перечисляет </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>S</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>как последний
блок некоторого шардчейна, а более новый блок мастерчейна </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>B</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’, с </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>B</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>в качестве одного
из его предшественников, перечисляет </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>S</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>как последний
блок того же шардчейна, то </span><i><span lang=EN-US style='font-family:"Cambria",serif'>S</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>должен
быть одним из предшественников </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>S</span></i><i><span lang=RU style='font-family:"Cambria",serif'>’.</span></i><a
href="#_ftn10" name="_ftnref10" title=""><sup><span lang=EN-US><sup><span
lang=EN-US style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'>[10]</span></sup></span></sup></a><sup><span lang=EN-US> </span></sup><span
lang=RU>Это условие делает общее состояние блокчейн </span><span lang=EN-US>TON</span><span
lang=RU> определяется последующим блоком мастерчейна </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>B</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’,</span></i><span lang=RU> совместимым с общим
состоянием, определенным предыдущим блоком </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>B</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.9pt;
margin-left:-.25pt'><span lang=RU>1.5.2. Общее состояние, определяемое блоком
шардчейна. Каждый блок </span><span lang=EN-US>shardchain</span><span lang=RU>
содержит хэш последнего блока </span><span lang=EN-US>masterchain</span><span
lang=RU> в своем заголовке. Следовательно, все блоки, упомянутые в этом блоке
мастерчейна, вместе с их предшественниками, считаются «известными» или
«видимыми» для блока шардчейна, и никакие другие блоки не видны ему, за
исключением его предшественников внутри его собственного шардчейна.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:21.3pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>В частности, когда мы
говорим, что блок <i>должен </i>импортировать в свой </span><i><span
lang=EN-US>InMsgDescr</span></i><i><span lang=EN-US> </span></i><span lang=RU>сообщения
из </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span lang=EN-US> </span></i><span
lang=RU>состояний всех соседних шардчейнов, это означает, что именно блоки
других шардчейнов, видимые этому блоку, должны быть приняты во внимание, и в то
же время блок не может содержать сообщения из «невидимых» блоков, даже если в
остальном они верны.</span></p>

</div>

<span lang=RU style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'><br clear=all style='page-break-before:always'>
</span>

<div class=WordSection6>

<h2 style='margin-left:35.2pt;text-indent:-35.2pt'><a name="_Toc150762"><span
lang=RU>1.6<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=RU>Настраиваемые параметры и смарт-контракты</span></a></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Напомним, что </span><span lang=EN-US>TON</span><span
lang=EN-US> </span><span lang=EN-US>Blockchain</span><span lang=RU> имеет
несколько так называемых «настраиваемых параметров» (ср. [3]), которые являются
либо определенными значениями, либо определенными смарт-контрактами,
находящимися в мастерчейне. В этом разделе описывается хранение и доступ к этим
настраиваемым параметрам.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.6.1. Примеры настраиваемых параметров. К
свойствам блокчейна, управляемым настраиваемыми параметрами, относятся:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=EN-US style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=EN-US>Минимальная ставка для валидаторов.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Максимальный размер группы избранных валидаторов.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Максимальное количество блоков, за которые отвечает
одна и та же группа валидаторов.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=EN-US style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=EN-US>Процесс выборов валидатора.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=EN-US style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=EN-US>Процесс наказания валидатора.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.5pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Текущий активный и следующий избранный набор
валидаторов.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Процесс изменения настраиваемых параметров и адрес
смарт-контракта </span><i><span lang=EN-US style='font-family:"Cambria",serif'>γ</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>ответственным
за хранение значений настраиваемых параметров и за изменение их значений.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.4pt;
margin-left:-.25pt'><span lang=RU>1.6.2. Расположение значений настраиваемых
параметров. Настраиваемые параметры хранятся в постоянных данных специальной
конфигурации смарт-контракта </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>γ</span></i><i><span lang=RU style='font-family:"Cambria",serif'>,</span></i><span
lang=RU> находящейся в мастерчейне блокчейна </span><span lang=EN-US>TON</span><span
lang=RU>. Точнее, первой ссылкой на корневую ячейку постоянных данных этого
смарт-контракта является словарь, отображающий 64-битные ключи (номера
параметров) со значениями соответствующих параметров; каждое значение
сериализуется в срез ячейки в соответствии с типом этого значения. Если
значение является «смарт-контрактом» (обязательно находящимся в мастерчейне),
вместо него используется 256-битный адрес учетной записи.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.4pt;
margin-left:-.25pt'><span lang=RU>1.6.3. Быстрый доступ через заголовок
мастерчейн блоков. Чтобы упростить доступ к текущим значениям настраиваемых
параметров, и сократить доказательства Меркла, содержащие ссылки на них,
заголовок каждого блока мастерчейна содержит адрес смарт-контракта </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>γ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>. Он также содержит прямую ячеистую ссылку
на словарь, содержащий все значения настраиваемых параметров, которая лежит в
постоянных данных </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>γ</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>. Дополнительные условия
согласованности гарантируют, что эта ссылка совпадает с той, которая получена
путем проверки конечного состояния смарт-контракта </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>γ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:7.85pt;
margin-left:-.25pt'><span lang=RU>1.6.4. Получение значений настраиваемых
параметров методами </span><span lang=EN-US>get</span><span lang=RU>.
Конфигурация смарт-контракта </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>γ</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>предоставляет доступ к некоторым настраиваемым
параметрам с помощью «методов </span><span lang=EN-US>get</span><span lang=RU>».
Эти специальные методы смарт-контракта не изменяют его состояние, а вместо
этого возвращают необходимые данные в стек </span><span lang=EN-US>TVM</span><span
lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:7.9pt;
margin-left:-.25pt'><span lang=RU>1.6.5. Получение значений настраиваемых
параметров путем получения сообщений. Аналогичным образом, конфигурация
смарт-контракта </span><i><span lang=EN-US style='font-family:"Cambria",serif'>γ</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>может
определять некоторые «обычные» методы (т.е. специальные входящие сообщения) для
запроса значений определенных параметров конфигурации, которые будут
отправляться в исходящих сообщениях, генерируемых транзакцией, обрабатывающей
такое входящее сообщение. Это может быть полезно для некоторых других
фундаментальных смарт-контрактов, которые должны знать значения определенных
параметров конфигурации.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.6.6. Значения, полученные методами </span><span
lang=EN-US>get</span><span lang=RU>, могут отличаться от значений, полученных
через заголовок блока. Обратите внимание, что состояние </span><span
lang=EN-US>γ</span><span lang=RU> смарт-контракта конфигурации,</span><i><span
lang=RU style='font-family:"Cambria",serif'> включая значения настраиваемых
параметров, может изменяться несколько раз внутри блока мастерчейна, если в
этом блоке несколько транзакций, обработанных </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>γ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i><span lang=RU> Как следствие,
значения, полученные путем вызова методов </span><span lang=EN-US>get</span><span
lang=EN-US> </span><i><span lang=EN-US style='font-family:"Cambria",serif'>γ</span></i><i><span
lang=RU style='font-family:"Cambria",serif'> или отправки </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>get</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> сообщений </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>γ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, могут отличаться от значений, полученных
при проверке ссылки в заголовке блока (см. 1.6.3), которая относится к
конечному </span></i><span lang=RU>состоянию настраиваемых параметров в блоке.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>1.6.7. Изменение значений настраиваемых
параметров. Процедура изменения значений настраиваемых параметров определена в
коде смарт-контракта </span><i><span lang=EN-US style='font-family:"Cambria",serif'>γ</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>. Для большинства настраиваемых
параметров, называемых </span></i><i><span lang=RU>обычными, любой валидатор
может предложить новое значение, отправив </span><span lang=EN-US>γ</span></i><i><span
lang=RU> специальное сообщение с номером параметра и его предлагаемым значением.</span></i><i><span
lang=RU style='font-family:"Cambria",serif'> Если предложенное значение
является допустимым, смарт-контракт собирает дальнейшие сообщения о голосовании
от валидаторов, и если более двух третей каждого из текущего и следующего наборов
валидаторов поддерживают предложение, значение изменяется.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Некоторые параметры,
такие как текущий набор валидаторов, не могут быть изменены таким образом.
Вместо этого текущая конфигурация содержит параметр с адресом смарт-контракта </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ν</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, </span></i><span lang=RU>ответственным за
выбор следующего набора валидаторов, а смарт-контракт </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>γ</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>принимает
сообщения только от этого смарт-контракта </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ν</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>для изменения
значения параметра конфигурации, содержащего текущий набор валидаторов.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.8pt;
margin-left:-.25pt'><span lang=RU>1.6.8. Изменение процедуры выборов
валидатора. Если процедура выбора валидатора когда-либо должна быть изменена,
это может быть достигнуто путем сначала фиксации нового смарт-контракта выбора
валидатора в мастерчейне, а затем изменения обычного настраиваемого параметра,
содержащего адрес </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ν</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>смарт-контракта
выбора валидатора. Для этого потребуется, чтобы две трети валидаторов приняли
предложение в ходе голосования, как описано выше в разделе 1.6.7.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.6.9. Изменение процедуры изменения
настраиваемых параметров. Аналогичным образом, адрес самого смарт-контракта
конфигурации является настраиваемым параметром и может быть изменен таким
образом. Таким образом, большинство фундаментальных параметров и
смарт-контрактов </span><span lang=EN-US>TON</span><span lang=EN-US> </span><span
lang=EN-US>Blockchain</span><span lang=RU> могут быть изменены в любом
направлении, согласованном квалифицированным большинством валидаторов.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.6.10. Начальные значения настраиваемых
параметров. Начальные значения большинства настраиваемых параметров
отображаются в нулевом блоке мастерчейна как часть начального состояния
мастерчейна, которое явно присутствует без упущения в этом блоке. Код всех фундаментальных
смарт-контрактов также присутствует в исходном состоянии. Таким образом,
оригинальная «конституция» и конфигурация блокчейна </span><span lang=EN-US>TON</span><span
lang=RU>, включая оригинальный набор валидаторов, становятся явными в нулевом
блоке.</span></p>

</div>

<span lang=RU style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'><br clear=all style='page-break-before:always'>
</span>

<div class=WordSection7>

<h2 style='margin-left:35.2pt;text-indent:-24.0pt'><a name="_Toc150763"><span
lang=RU>1.7<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
lang=RU>Новые смарт-контракты и их адреса</span></a></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.35pt;
margin-left:-.25pt'><span lang=RU>В этом разделе обсуждается создание и
инициализация новых смарт-контрактов, в частности, происхождение их исходного
кода, постоянные данные и баланс. В нем также обсуждается назначение адресов
учетных записей новым смарт-контрактам.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.7.1. Описание действительно только для
мастерчейна и базового рабочего цепя. Механизмы создания новых смарт-контрактов
и назначения их адресов, описанные в этом разделе, действительны только для
базовой рабочей цепи и мастерчейна. Другие рабочие цепи могут определять свои
собственные механизмы решения этих проблем.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.7.2. Перевод криптовалюты на
неинициализированные счета. Прежде всего, <i>можно отправлять сообщения, в том
числе значимые, на ранее не упоминавшиеся аккаунты. </i>Если входящее сообщение
поступает в </span><span lang=EN-US>shardchain</span><span lang=RU> с адресом
назначения </span><i><span lang=EN-US style='font-family:"Cambria",serif'>η</span></i><span
lang=RU>, соответствующим неопределенной учетной записи, оно обрабатывается
транзакцией, как если бы код смарт-контракта был пустым (т. Е. Состоящим из
неявного </span><span lang=EN-US>RET</span><span lang=RU>). Если сообщение
имеет ценность, это приводит к созданию «неинициализированного счета», который
может иметь ненулевой баланс (если на него были отправлены сообщения,
содержащие ценность), </span><a href="#_ftn11" name="_ftnref11" title=""><sup><span
lang=EN-US><sup><span lang=EN-US style='font-size:12.0pt;line-height:104%;
font-family:"Calibri",sans-serif;color:black'>[11]</span></sup></span></sup></a><sup><span
lang=EN-US> </span></sup><span lang=RU>но не имеет кода и данных. Поскольку
даже неинициализированная учетная запись занимает некоторое постоянное хранилище
(необходимое для хранения своего баланса), некоторые небольшие платежи по
постоянному хранению будут время от времени взиматься с баланса счета, пока он
не станет отрицательным.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.2pt;
margin-left:-.25pt'><span lang=RU>1.7.3. Инициализация смарт-контрактов по
сообщениям конструктора. Учетная запись, или смарт-контракт, создается путем
отправки специального <i>сообщения конструктора </i></span><i><span lang=EN-US
style='font-family:"Cambria",serif'>M</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>на его адрес </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>. Тело такого сообщения содержит дерево
ячеек с начальным кодом смарт-контракта (который в некоторых ситуациях может
быть заменен его хэшем), и </span></i><span lang=RU>исходные данные
смарт-контракта (возможно, пустые; его можно заменить его хэшем). Хэш кода и
данных, содержащихся в сообщении конструктора, должен совпадать с адресом </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>смарт-контракта;
в противном случае он отклоняется.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>После инициализации кода
и данных смарт-контракта из тела сообщения конструктора остальная часть
сообщения конструктора обрабатывается транзакцией (<i>транзакцией создания </i>для
смарт-контракта </span><i><span lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>) путем вызова </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>TVM</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> способом, аналогичным тому, который
используется для обработки обычных входящих сообщений.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.35pt;
margin-left:-.25pt'><span lang=RU>1.7.4. Начальный баланс смарт-контракта.
Обратите внимание, что сообщение конструктора обычно должно содержать некоторое
значение, которое будет передано на баланс вновь созданного смарт-контракта; в
противном случае новый смарт-контракт будет иметь нулевой баланс и не сможет
платить за хранение своего кода и данных в блокчейне. Минимальный баланс,
требуемый от вновь созданного смарт-контракта, является линейной (точнее,
аффинной) функцией хранилища, которое он использует. Коэффициенты этой функции
могут зависеть от рабочей цепи; в частности, они выше в мастерчейне, чем в
основной рабочей цепи.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.9pt;
margin-left:-.25pt'><span lang=RU>1.7.5. Создание смарт-контрактов внешними
сообщениями конструктора. В некоторых случаях необходимо создать смарт-контракт
с помощью сообщения конструктора, которое не может иметь никакого значения,
например, с помощью сообщения конструктора «из ниоткуда» (внешнего входящего
сообщения). Затем следует сначала перевести достаточное количество средств на
неинициализированный смарт-контракт, как описано в 1.7.2, и только потом
отправлять конструктору сообщение «из ниоткуда».</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.7.6. Пример: создание смарт-контракта
криптовалютного кошелька. Примером вышеописанной ситуации являются приложения
криптовалютного кошелька для пользователей-людей, которые должны создать
специальный смарт-контракт кошелька в блокчейне, в котором будут храниться
средства пользователя. </span><span lang=EN-US>Это может быть достигнуто
следующим образом:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Приложение криптовалютного кошелька генерирует
новую криптографическую пару открытого / закрытого ключей (обычно для
криптографии эллиптической кривой </span><span lang=EN-US>Ed</span><span
lang=RU>25519, поддерживаемой специальными примитивами </span><span lang=EN-US>TVM</span><span
lang=RU>) для подписания будущих транзакций пользователя.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Приложение криптовалютного кошелька знает код
создаваемого смарт-контракта (который обычно одинаков для всех пользователей),
а также данные, которые обычно состоят из открытого ключа кошелька (или его
хэша) и генерируются в самом начале. Хэш этой информации — это адрес </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>создаваемого
смарт-контракта кошелька.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Приложение кошелька может отображать адрес
пользователя </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, и пользователь может начать
получать средства на свой неинициализированный счет </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, например, купив криптовалюту на бирже или
попросив друга перевести небольшую сумму.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Приложение кошелька может проверить </span><span
lang=EN-US>shardchain</span><span lang=RU>, содержащий учетную запись </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>(в случае базовой
учетной записи </span><span lang=EN-US>workchain</span><span lang=RU>) или </span><span
lang=EN-US>masterchain</span><span lang=RU> (в случае учетной записи </span><span
lang=EN-US>masterchain</span><span lang=RU>), либо самостоятельно, либо с
помощью проводника блокчейна, и проверить баланс </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Если баланса достаточно, приложение кошелька может
создать и подписать (закрытым ключом пользователя) сообщение конструктора («из
ниоткуда») и отправить его для включения в валидаторы или коллаторы для
соответствующего блокчейна.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Как только сообщение конструктора включено в блок
блокчейна и обработано транзакцией, смарт-контракт кошелька наконец создается.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Когда пользователь хочет перевести некоторые
средства какому-либо другому пользователю или смарт-контракту,</span><i><span
lang=RU style='font-family:"Cambria",serif'> </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>η</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, или хочет отправить ценностное сообщение </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, он использует свое приложение кошелька
для создания сообщения </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, которое </span></i><span lang=RU>она
хочет, чтобы ее смарт-контракт кошелька </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>отправить </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, конверт </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>в специальное
«сообщение из ниоткуда» </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>с
назначением </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, и подписать </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>своим закрытым
ключом. Некоторые положения против повторных атак должны быть сделаны, как описано
в 2.2.1.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Смарт-контракт кошелька получает сообщение </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>и проверяет
действительность подписи с помощью открытого ключа, хранящегося в его
постоянных данных. Если подпись верна, она извлекает встроенное сообщение </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>из </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>и отправляет его
по назначению </span><i><span lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span
lang=RU style='font-family:"Cambria",serif'> с указанной суммой средств.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Если пользователю не нужно сразу начинать перевод
средств, а только хочет пассивно получать какие-то средства, он может держать
свой аккаунт неинициализированным столько, сколько захочет (при условии, что
постоянные платежи за хранилище не приводят к исчерпанию его баланса), тем
самым минимизируя профиль хранения и постоянные платежи за хранение учетной
записи.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:6.6pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Обратите внимание, что приложение кошелька может
создать для пользователя-человека иллюзию, что средства хранятся в самом
приложении, и предоставить интерфейс для перевода средств или отправки
произвольных сообщений «напрямую» со счета пользователя </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>. В реальности все эти операции будет
выполняться смарт-контрактом кошелька пользователя, который эффективно
выступает в качестве прокси для таких запросов. Мы видим, что криптовалютный
кошелек является простым примером смешанного </span></i><span lang=RU>приложения,
имеющего часть </span><span lang=EN-US>on</span><span lang=RU>-</span><span
lang=EN-US>chain</span><span lang=RU> (смарт-контракт кошелька, используемый в
качестве прокси для исходящих сообщений) и часть </span><span lang=EN-US>offchain</span><span
lang=RU> (приложение внешнего кошелька, работающее на устройстве пользователя и
хранящее закрытый ключ учетной записи).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:6.6pt;
margin-left:0cm;text-indent:0cm'><span lang=RU>Конечно, это всего лишь один из способов
борьбы с простейшими смарт-контрактами кошелька пользователя. Можно создать
смарт-контракты кошелька с несколькими подписями или создать общий кошелек с
внутренними балансами, хранящимися внутри него для каждого из его отдельных
пользователей, и так далее.</span></p>

</div>

<span lang=RU style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'><br clear=all style='page-break-before:always'>
</span>

<div class=WordSection8>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:7.05pt;
margin-left:-.25pt'><span lang=RU>1.7.7. Смарт-контракты могут быть созданы
другими смарт-контрактами. Обратите внимание, что смарт-контракт может
генерировать и отправлять сообщение конструктора при обработке любой
транзакции. Таким образом, смарт-контракты могут автоматически создавать новые
смарт-контракты, если это необходимо, без какого-либо вмешательства человека.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:21.2pt;
margin-left:-.25pt'><span lang=RU>1.7.8. Смарт-контракты могут быть созданы
смарт-контрактами кошелька. С другой стороны, пользователь может скомпилировать
код для своего нового смарт-контракта </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ν</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, сгенерировать соответствующее сообщение
конструктора </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=RU style='font-family:"Cambria",serif'> и использовать приложение
кошелька, чтобы заставить свой смарт-контракт кошелька </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>отправить
сообщение </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>в </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ν</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>с достаточным
количеством средств, тем самым создавая новый смарт-контракт </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ν</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i></p>

<h2 style='margin-left:35.2pt;text-indent:-35.2pt'><a name="_Toc150764"><span
lang=EN-US>1.8<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>Модификация и удаление смарт-контрактов</span></a></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.55pt;
margin-left:-.25pt'><span lang=RU>В этом разделе объясняется, как код и
состояние смарт-контракта могут быть изменены, а также как и когда
смарт-контракт может быть уничтожен.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.8.1. Изменение данных смарт-контракта.
Постоянные данные смарт-контракта обычно изменяются в результате выполнения
кода смарт-контракта в </span><span lang=EN-US>TVM</span><span lang=RU> при
обработке транзакции, вызванной входящим сообщением в смарт-контракт. Более
конкретно, код смарт-контракта имеет доступ к старому постоянному хранилищу
смарт-контракта через регистр управления </span><span lang=EN-US>TVM</span><span
lang=EN-US> </span><span lang=EN-US>c</span><span lang=RU>4 и может
модифицировать постоянное хранилище, сохраняя другое значение в </span><span
lang=EN-US>c</span><span lang=RU>4 до обычного прекращения.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Как правило, нет других
способов изменить данные существующего смарт-контракта. Если код
смарт-контракта не предоставляет никаких способов изменения постоянных данных
(например, если это простой смарт-контракт кошелька, как описано в 1.7.6,
который инициализирует постоянные данные открытым ключом пользователя и не
намерен когда-либо изменять их), то он будет фактически неизменяемым, если
только код смарт-контракта не будет изменен первым.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>1.8.2. Изменение кода смарт-контракта.
Аналогичным образом, код существующего смарт-контракта может быть изменен
только в том случае, если некоторые положения для такого обновления
присутствуют в текущем коде. Код изменяется путем вызова примитива </span><span
lang=EN-US>TVM</span><span lang=EN-US> </span><span lang=EN-US>SETCODE</span><span
lang=RU>, который устанавливает корень кода для текущего смарт-контракта из
верхнего значения в стеке </span><span lang=EN-US>TVM</span><span lang=RU>.
Изменение применяется только после обычного прекращения текущей транзакции.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.3pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Как правило, если
разработчик смарт-контракта хочет иметь возможность обновить свой код в
будущем, он предоставляет специальный «метод обновления кода» в исходном коде
смарт-контракта, который вызывает </span><span lang=EN-US>SETCODE</span><span
lang=RU> в ответ на определенные входящие сообщения «обновления кода»,
используя новый код, отправленный в самом сообщении в качестве аргумента </span><span
lang=EN-US>SETCODE</span><span lang=RU>. Некоторые положения должны быть
сделаны для защиты смарт-контракта от несанкционированной замены кода; в
противном случае контроль над смарт-контрактом и средствами на его балансе
может быть потерян. Например, сообщения об обновлении кода могут приниматься
только с надежного исходного адреса или могут быть защищены путем требования
действительной криптографической подписи и правильного порядкового номера.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>1.8.3. Хранение кода или данных
смарт-контракта вне блокчейна. Код или данные смарт-контракта могут храниться
вне блокчейна и быть представлены только их хэшами. В таких случаях могут
обрабатываться только пустые входящие сообщения, а также сообщения, содержащие
правильную копию кода смарт-контракта (или его часть, относящуюся к обработке
конкретного сообщения) и его данные внутри специальных полей. Примером такой
ситуации служат неинициализированные смарт-контракты и сообщения конструктора,
описанные в 1.7.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>1.8.4. Использование библиотек кода.
Некоторые смарт-контракты могут использовать один и тот же код, но использовать
разные данные. Одним из примеров этого являются смарт-контракты кошельков (см.
1.7.6), которые, вероятно, будут использовать один и тот же код (во всех
кошельках, созданных одним и тем же программным обеспечением), но с разными
данными (потому что каждый кошелек должен использовать свою собственную пару
криптографических ключей). В этом случае код для всех смарт-контрактов кошелька
лучше всего фиксировать разработчиком в общей <i>библиотеке; эта библиотека
будет находиться в мастерчейне и ссылаться на ее хэш с использованием
специальной «ссылки на ячейку внешней библиотеки» в качестве корня кода каждого
смарт-контракта кошелька (или в качестве поддерева внутри этого кода).</i></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Обратите внимание, что
даже если код библиотеки становится недоступным — например, потому, что его
разработчик перестает платить за его хранение в мастерчейне — все равно можно
использовать смарт-контракты, относящиеся к этой библиотеке, либо снова
зафиксировав библиотеку в мастерчейне, либо включив соответствующие части в
сообщение, отправленное смарт-контракту. Этот механизм разрешения внешних ячеек
более подробно рассматривается далее в разделе 4.4.3.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>1.8.5. Уничтожение смарт-контрактов. Обратите
внимание, что смарт-контракт не может быть действительно уничтожен, пока его
баланс не станет нулевым или отрицательным. Он может стать отрицательным в
результате сбора постоянных платежей за хранилище или после отправки исходящего
сообщения, несущего ценность, передающего почти весь свой предыдущий баланс.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Например, пользователь
может решить перевести все оставшиеся средства со своего кошелька на другой
кошелек или смарт-контракт. Это может быть полезно, например, если кто-то хочет
обновить кошелек, но смарт-контракт кошелька не имеет никаких положений для
будущих обновлений; тогда можно просто создать новый кошелек и перевести на
него все средства.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>1.8.6. Замороженные счета. Когда баланс счета
становится неположительным после транзакции или меньше определенного минимума,
зависящего от рабочей цепи, счет <i>замораживается </i>путем замены всего его
кода и данных одним 32-байтовым хэшем. Этот хэш хранится впоследствии в течение
некоторого времени (например, пару месяцев), чтобы предотвратить воссоздание
смарт-контракта путем его первоначальной транзакции создания (которая
по-прежнему имеет правильный хэш, равный адресу учетной записи), и позволить
его владельцу воссоздать учетную запись, переведя некоторые средства и отправив
сообщение, содержащее код и данные учетной записи, быть восстановленным в
блокчейне. В этом отношении замороженные счета аналогичны неинициализированным
счетам; однако хэш правильного кода и данных для замороженного счета не
обязательно равен адресу счета, а хранится отдельно.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Обратите внимание, что
замороженные счета могут иметь отрицательное сальдо, что указывает на
необходимость постоянных платежей по хранению. Счет не может быть разморожен до
тех пор, пока его баланс не станет положительным и не превысит установленное
минимальное значение.</span></p>

</div>

<span lang=RU style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'><br clear=all style='page-break-before:always'>
</span>

<div class=WordSection9>

<h1 style='margin-left:27.1pt;text-indent:-27.1pt'><a name="_Toc150765"><span
lang=EN-US>2<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>Гарантии пересылки и доставки сообщений</span></a></h1>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:21.4pt;
margin-left:-.25pt'><span lang=EN-US>В этой главе обсуждается пересылка
сообщений внутри блокчейна TON, включая протоколы Hypercube Routing (HR) и
Instant Hypercube Routing (IHR). </span><span lang=RU>В нем также описываются
положения, необходимые для реализации гарантий доставки сообщений и гарантии
заказа </span><span lang=EN-US>FIFO</span><span lang=RU>.</span></p>

<h2 style='margin-left:0cm;text-indent:0cm'><a name="_Toc150766"><span lang=RU>2.1<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=RU>Адреса сообщений и вычисления следующего прыжка</span></a></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>В этом разделе объясняется вычисление
транзитных адресов и адресов следующего прыжка по варианту алгоритма
маршрутизации гиперкубов, используемого в </span><span lang=EN-US>TON</span><span
lang=EN-US> </span><span lang=EN-US>Blockchain</span><span lang=RU>. Сам
протокол маршрутизации гиперкубов, который использует концепции и алгоритм
вычисления адресов следующего прыжка, представленные в этом разделе,
представлен в следующем разделе.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.9pt;
margin-left:-.25pt'><span lang=RU>2.1.1. Адреса учетных записей. Адрес <i>источника
</i>и <i>адрес назначения </i>всегда присутствуют в любом сообщении. Как
правило, это <i>(полные) адреса учетных записей. Полный адрес учетной записи
состоит из </i></span><i><span lang=EN-US>workchain</span></i><i><span lang=RU>_</span><span
lang=EN-US>id</span></i><i><span lang=EN-US> </span></i><span lang=RU>(подписанное
32-разрядное целое число с большим порядком байтов, определяющее рабочую
цепочку), за которым следует (обычно) 256-разрядный <i>внутренний адрес </i>или
<i>идентификатор учетной записи </i></span><i><span lang=EN-US>account</span></i><i><span
lang=RU>_</span><span lang=EN-US>id</span></i><i><span lang=EN-US> </span></i><span
lang=RU>(который также может быть интерпретирован как целое число без знака с
большим порядком байтов), определяющий учетную запись в выбранной рабочей
цепочке.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.45pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Различные рабочие цепи
могут использовать идентификаторы учетных записей, которые короче или длиннее,
чем «стандартные» 256 бит, используемые в мастерчейне (</span><span lang=EN-US>workchain</span><span
lang=RU>_</span><span lang=EN-US>id</span><span lang=EN-US> </span><span
lang=RU style='font-family:"Cambria",serif'>= −1) и в базовой рабочей цепочке (</span><span
lang=EN-US style='font-family:"Cambria",serif'>workchain</span><span lang=RU
style='font-family:"Cambria",serif'>_</span><span lang=EN-US style='font-family:
"Cambria",serif'>id</span><span lang=RU style='font-family:"Cambria",serif'> =
0). С этой целью состояние мастерчейн содержит список всех рабочих цепей,
определенных до сих пор, а также длину идентификатора их учетной записи. Важным
ограничением является то, что </span><i><span lang=EN-US>account</span></i><i><span
lang=RU>_</span><span lang=EN-US>id</span></i><i><span lang=EN-US> </span></i><span
lang=RU>для любой рабочей цепи, должна быть длиной не менее 64 бит.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>В дальнейшем мы часто
рассматриваем только случай 256-битных адресов учетных записей для простоты.
Только первые 64 бита </span><i><span lang=EN-US>account</span></i><i><span
lang=RU>_</span><span lang=EN-US>id</span></i><i><span lang=EN-US> </span></i><span
lang=RU>актуальны для целей маршрутизации сообщений и разделения шардчейнов.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>2.1.2. Адреса источника и назначения
сообщения. Любое сообщение имеет как исходный <i>адрес, так </i>и <i>адрес
назначения. Его исходным адресом является адрес учетной записи
(смарт-контракта), которая создала сообщение при обработке какой-либо
транзакции; адрес источника не может быть изменен или задан произвольно, и
смарт-контракты в значительной степени зависят от этого свойства. Напротив, при
создании сообщения </i>может быть выбран любой правильно сформированный адрес
назначения; после этого адрес назначения не может быть изменен.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>2.1.3. Внешние сообщения без адреса источника
или назначения. Некоторые сообщения могут не иметь адреса источника или адреса
назначения (хотя хотя один из них должен присутствовать), о чем свидетельствуют
специальные флаги в заголовке сообщения. Такие сообщения — это <i>внешние
сообщения,</i> предназначенные для взаимодействия блокчейна </span><span
lang=EN-US>TON</span><span lang=RU> с внешним миром — пользователями-людьми и
их приложениями для криптокошельков, внецепочными и смешанными приложениями и
сервисами, другими блокчейнами и так далее.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:1.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Внешние сообщения никогда
не маршрутизируются внутри блокчейна </span><span lang=EN-US>TON</span><span
lang=RU>. Вместо этого «сообщения из ниоткуда» (т.е. без адреса источника)
напрямую включаются в </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>целевого блока </span><span lang=EN-US>shardchain</span><span
lang=RU> (при условии соблюдения некоторых условий) и обрабатываются транзакцией
в этом самом блоке. Аналогичным образом, «сообщения в никуда» (то есть без
адреса назначения </span><span lang=EN-US>TON</span><span lang=EN-US> </span><span
lang=EN-US>Blockchain</span><span lang=RU>), также известные как <i>сообщения
журнала, также присутствуют только в блоке, содержащем транзакцию, которая
сгенерировала такое сообщение.</i></span><a href="#_ftn12" name="_ftnref12"
title=""><sup><span lang=EN-US><sup><span lang=EN-US style='font-size:12.0pt;
line-height:104%;font-family:"Calibri",sans-serif;color:black'>[12]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:1.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Поэтому внешние сообщения
практически не имеют отношения к обсуждению маршрутизации сообщений и гарантий
доставки сообщений. Фактически, гарантии доставки сообщений для исходящих
внешних сообщений тривиальны (в лучшем случае сообщение должно быть включено в <i>часть
блока </i></span><i><span lang=EN-US>LogMsg</span></i><span lang=RU>), а для
входящих внешних сообщений их нет, поскольку валидаторы блока </span><span
lang=EN-US>shardchain</span><span lang=RU> могут свободно включать или
игнорировать предлагаемые входящие внешние сообщения по своему усмотрению
(например, в соответствии с платой за обработку, предлагаемой сообщением).</span><a
href="#_ftn13" name="_ftnref13" title=""><sup><span lang=EN-US><sup><span
lang=EN-US style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'>[13]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>В дальнейшем мы
сосредоточимся на «обычных» или «внутренних» сообщениях, которые имеют как
источник, так и адрес назначения.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.15pt;
margin-left:-.25pt'><span lang=RU>2.1.4. Транзитные и последующие адреса. Когда
сообщение должно быть перенаправлено через промежуточные цепочки сегментов до
достижения предполагаемого пункта назначения, ему назначается <i>транзитный
адрес и адрес </i>следующего <i>прыжка </i>в дополнение к (неизменяемым)
адресам источника и назначения. Когда копия сообщения находится внутри
транзитного шардчейна, ожидающего его ретрансляции до следующего прыжка,
транзитный <i>адрес </i>является его промежуточным адресом, лежащим в
транзитном шардчейне, как будто принадлежащим специальному смарт-контракту
ретрансляции сообщений, единственной задачей которого является передача
неизмененного сообщения следующему шардчейну на маршруте. Адрес <i>следующего
прыжка </i>— это адрес в соседнем шардчейне (или, в некоторых редких случаях, в
той же шардчейне), на который необходимо передать сообщение. После ретрансляции
сообщения адрес следующего прыжка обычно становится транзитным адресом копии
сообщения, включенной в следующую цепочку.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Сразу после создания
исходящего сообщения в цепочке </span><span lang=EN-US>shardchain</span><span
lang=RU> (или в мастерчейне) его транзитный адрес устанавливается на исходный
адрес.</span><a href="#_ftn14" name="_ftnref14" title=""><sup><span lang=EN-US><sup><span
lang=EN-US style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'>[14]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:13.85pt;
margin-left:-.25pt'><span lang=RU>2.1.5. Вычисление адреса следующего прыжка
для маршрутизации гиперкубов. Блокчейн </span><span lang=EN-US>TON</span><span
lang=RU> использует вариант маршрутизации гиперкубов. Это означает, что адрес
следующего прыжка вычисляется из транзитного адреса (первоначально равного
исходному адресу) следующим образом:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.25pt;text-indent:-14.95pt'><span lang=RU style='line-height:
104%'>А.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
lang=RU>с подписью биг-эндиана) разбиваются на группы <i>32-битные </i></span><i><span
lang=EN-US>workchain</span></i><i><span lang=RU>_</span><span lang=EN-US>id</span></i><i><span
lang=EN-US> </span></i><span lang=RU>компоненты как транзитного адреса, так и
адреса назначения (</span><i><span lang=RU style='font-family:"Cambria",serif'>из
</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>1</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU>бит (в настоящее
время </span><i><span lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>1</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 32), и они сканируются слева (т. Е. Наиболее значимые биты)
справа. Если одна из групп в транзитном адресе отличается от соответствующей
группы в адресе назначения, то значение этой группы в транзитном адресе
заменяется ее значением в адресе назначения для вычисления адреса следующего
прыжка.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.25pt;text-indent:-14.95pt'><span lang=RU style='line-height:
104%'>Б.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
lang=RU>Если </span><i><span lang=EN-US>workchain</span></i><i><span lang=RU>_</span><span
lang=EN-US>id</span></i><i><span lang=EN-US> </span></i><span lang=RU>части
транзитного и целевого адресов совпадают, то аналогичный процесс применяется к </span><i><span
lang=EN-US>account</span></i><i><span lang=RU>_</span><span lang=EN-US>id</span></i><i><span
lang=EN-US> </span></i><span lang=RU>частям адресов: </span><i><span
lang=EN-US>account</span></i><i><span lang=RU>_</span><span lang=EN-US>id</span></i><i><span
lang=EN-US> </span></i><span lang=RU>части, а точнее их первые (наиболее
значимые) 64 бита, разбиваются на группы </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>n</span></i><i><sub><span lang=RU
style='font-family:"Cambria",serif'>2</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU>бит (в настоящее
время </span><i><span lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>2</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 4 </span><span lang=RU>используются битовые группы,
соответствующие шестнадцатеричным цифрам адреса), начиная с наиболее значимого
бита, и сравниваются, начиная с левого. Первая группа, которая отличается,
заменяется в транзитном адресе ее значением в адресе назначения для вычисления
адреса следующего прыжка.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:14.1pt;
margin-left:29.25pt;text-indent:-14.95pt'><span lang=EN-US style='line-height:
104%'>В.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
lang=RU>Если первые 64 бита </span><i><span lang=EN-US>account</span></i><i><span
lang=RU>_</span><span lang=EN-US>id</span></i><i><span lang=EN-US> </span></i><span
lang=RU>частей транзитного и целевого адресов также совпадают, то учетная
запись назначения принадлежит текущему </span><span lang=EN-US>shardchain</span><span
lang=RU>, и сообщение вообще не должно пересылаться за пределы текущей </span><span
lang=EN-US>shardchain</span><span lang=RU>. </span><span lang=EN-US>Вместо
этого он должен быть обработан транзакцией внутри него.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:12.25pt;
margin-left:-.25pt;line-height:110%'><span lang=EN-US>2.1.6. Обозначение адреса
следующего прыжка. Обозначаем</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:-.7pt;
margin-bottom:12.45pt;margin-left:0cm;text-align:left;text-indent:0cm;
line-height:107%'><span lang=EN-US style='font-size:11.0pt;line-height:107%'>                                                      </span><span
lang=EN-US>NextHop(ξ,η)</span><span lang=EN-US style='font-family:"Cambria",serif'>                                               </span><span
lang=EN-US>(13)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>адрес следующего прыжка, вычисляемый для
текущего (исходного или транзитного) адреса </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>и адреса
назначения </span><i><span lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.85pt;
margin-left:-.25pt'><span lang=RU>2.1.7. Поддержка адресов </span><span
lang=EN-US>anycast</span><span lang=RU>. «Большие» смарт-контракты, которые
могут иметь отдельные экземпляры в разных шардчейнах, могут быть достигнуты с
использованием <i>адресов назначения </i></span><i><span lang=EN-US>anycast</span></i><i><span
lang=RU>. Эти адреса поддерживаются следующим образом.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Адрес </span><span
lang=EN-US>anycast</span><span lang=EN-US> </span><span lang=RU
style='font-family:"Cambria",serif'>(</span><span lang=EN-US style='font-family:
"Cambria",serif'>η</span><span lang=RU style='font-family:"Cambria",serif'>,</span><span
lang=EN-US style='font-family:"Cambria",serif'>d</span><span lang=RU
style='font-family:"Cambria",serif'>) </span><span lang=RU>состоит из обычного
адреса </span><i><span lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>вместе
с его «глубиной разделения» </span><i><span lang=EN-US style='font-family:"Cambria",serif'>d</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>≤ 31. Идея состоит в том, что сообщение
может быть доставлено на любой адрес, отличающийся от </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>только в первых </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>d</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>битах части
внутреннего адреса (т.е. без учета идентификатора рабочей цепи, который должен
точно совпадать). </span><span lang=EN-US>Это достигается следующим образом:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Эффективный адрес назначения </span><span
lang=EN-US>η</span><span lang=RU> ̃</span><i><span lang=RU style='font-family:
"Cambria",serif'> </span></i><span lang=RU>вычисляется из </span><span lang=RU
style='font-family:"Cambria",serif'>(</span><span lang=EN-US style='font-family:
"Cambria",serif'>η</span><span lang=RU style='font-family:"Cambria",serif'>,</span><span
lang=EN-US style='font-family:"Cambria",serif'>d</span><span lang=RU
style='font-family:"Cambria",serif'>) </span><span lang=RU>путем замены первых </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>d</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>битов внутренней
адресной части </span><i><span lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>соответствующими
битами, взятыми из исходного адреса </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Все вычисления </span><span lang=EN-US>NextHop</span><span
lang=RU>(</span><span lang=EN-US>ν</span><span lang=RU>,</span><span
lang=EN-US>η</span><span lang=RU>) заменяются на </span><span lang=EN-US>NextHop</span><span
lang=RU>(</span><span lang=EN-US>ν</span><span lang=RU>,</span><span
lang=EN-US>η</span><span lang=RU> ̃), для </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ν</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>,</span></i><span lang=RU> а также
для всех других промежуточных адресов </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ν</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>. Таким образом, </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>Hypercube</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>Routing</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> или </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>Instant</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>Hypercube</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>Routing</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> в конечном итоге доставит сообщение в </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>shardchain</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, содержащий </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> ̃.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.5pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Когда сообщение обрабатывается в целевой </span><span
lang=EN-US>shardchain</span><span lang=RU> (содержащей адрес </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> ̃), оно может быть обработано учетной
записью </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>0 </span></i><span lang=RU>того же </span><span
lang=EN-US>shardchain</span><span lang=RU>, отличающегося от </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> ̃ </span></i><span lang=RU>только в первых
</span><span lang=EN-US>d</span><span lang=RU> битах внутренней адресной части.
Точнее, если общий префикс адреса сегмента равен </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>s</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, так что только внутренние адреса,
начинающиеся с двоичной строки </span></i><i><span lang=EN-US style='font-family:
"Cambria",serif'>s</span></i><span lang=RU>, принадлежат целевому сегменту, то </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>вычисляется из </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>путем замены
первого </span><span lang=EN-US style='font-family:"Cambria",serif'>min</span><span
lang=RU style='font-family:"Cambria",serif'>(</span><span lang=EN-US
style='font-family:"Cambria",serif'>d</span><span lang=RU style='font-family:
"Cambria",serif'>,|</span><span lang=EN-US style='font-family:"Cambria",serif'>s</span><span
lang=RU style='font-family:"Cambria",serif'>|) </span><span lang=RU>биты
внутренней адресной части </span><i><span lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>с
соответствующими битами </span><i><span lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Тем не менее, мы молчаливо игнорируем
существование адресов </span><span lang=EN-US>anycast</span><span lang=RU> и
дополнительную обработку, которую они требуют в следующих обсуждениях.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.8pt;
margin-left:-.25pt'><span lang=RU>2.1.8. Хэмминговская оптимальность алгоритма
адреса следующего прыжка. Обратите внимание, что конкретный алгоритм вычисления
следующего прыжка маршрутизации гиперкубов, описанный в 2.1.5, потенциально
может быть заменен другим алгоритмом при условии, что он удовлетворяет
определенным свойствам. Одним из этих свойств является <i>оптимальность
Хэмминга, означающая, что расстояние Хэмминга (</i></span><i><span lang=EN-US>L</span></i><i><sub><span
lang=RU>1</span></sub></i><i><span lang=RU>) от </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>до </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>равно сумме
расстояний Хэмминга от </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>до </span><span
lang=EN-US>NextHop</span><span lang=RU>(</span><span lang=EN-US>ξ</span><span
lang=RU>,</span><span lang=EN-US>η</span><span lang=RU>) и от </span><span
lang=EN-US>NextHop</span><span lang=RU>(</span><span lang=EN-US>ξ</span><span
lang=RU>,</span><span lang=EN-US>η</span><span lang=RU>) до </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>:</span></i></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:-.7pt;
margin-bottom:9.1pt;margin-left:0cm;text-align:left;text-indent:0cm;line-height:
107%'><span lang=RU style='font-size:11.0pt;line-height:107%'>         </span><span
lang=RU><img width=81 height=15 id="Picture 148331"
src="tblkch_convertio_ru_done.fld/image005.jpg"></span><span lang=RU> </span><span
lang=EN-US>Next</span><span lang=RU>Хоп</span><span lang=RU><img width=56
height=16 id="Picture 148329" src="tblkch_convertio_ru_done.fld/image006.jpg"></span><span
lang=RU>СледующийХоп</span><span lang=RU><img width=57 height=16
id="Picture 148330" src="tblkch_convertio_ru_done.fld/image007.jpg"></span><span
lang=RU>        (14)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:13.95pt;
margin-left:-.25pt;line-height:125%'><span lang=RU>Здесь </span><span
lang=EN-US style='font-family:"Cambria",serif'>kξ</span><span lang=RU
style='font-family:"Cambria",serif'> − </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ηk</span></i><i><sub><span lang=RU
style='font-family:"Cambria",serif'>1</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU>— <i>расстояние
Хэмминга </i>между </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, равное числу битовых позиций, в которых </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>отличаются:</span><a
href="#_ftn15" name="_ftnref15" title=""><sup><span lang=EN-US><sup><span
lang=EN-US style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'>[15]</span></sup></span></sup></a></p>

<p class=MsoNormal align=right style='margin:0cm;text-align:right;text-indent:
0cm;line-height:107%'><span lang=RU style='font-size:11.0pt;line-height:107%'>                      </span><span
lang=RU style='font-family:"Cambria",serif'>||</span><span lang=EN-US
style='font-family:"Cambria",serif'>ξ</span><span lang=EN-US style='font-family:
"Cambria",serif'> </span><span lang=RU style='font-family:"Cambria",serif'>– </span><span
lang=EN-US style='font-family:"Cambria",serif'>η</span><span lang=RU
style='font-family:"Cambria",serif'>||<sub>1</sub><i> </i></span><span lang=RU
style='line-height:107%;font-family:"Cambria",serif'>= </span><span
lang=EN-US style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black;position:relative;top:4.0pt'><img width=18 height=15
src="tblkch_convertio_ru_done.fld/image008.jpg"></span><span lang=EN-US
style='font-family:"Cambria",serif'>ξ<sub>i</sub></span><span lang=RU
style='font-family:"Cambria",serif'> – </span><span lang=EN-US
style='font-family:"Cambria",serif'>η<sub>i</sub></span><span lang=RU
style='font-family:"Cambria",serif'>|</span><i><sup><span lang=EN-US
style='font-family:"Cambria",serif'>    </span></sup></i><span lang=EN-US>  </span><span
lang=EN-US>                                             </span><span lang=RU>(15)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Обратите внимание, что в
целом следует ожидать только неравенства в (14), вытекающего из неравенства
треугольника для </span><i><span lang=EN-US style='font-family:"Cambria",serif'>L</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>1</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'>-метрики. Оптимальность Хэмминга по
существу означает, что </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>NextHop</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>,</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>η</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU>лежит на одном
из кратчайших путей (Хэмминга) от </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>ξ</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>до </span><i><span lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>. Это также можно выразить, сказав,
что </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>ν</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= </span><span lang=EN-US>NextHop</span><span
lang=RU>(</span><span lang=EN-US>ξ</span><span lang=RU>,</span><span
lang=EN-US>η</span><span lang=RU>) всегда получается из </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>путем изменения
значений битов в некоторых позициях на их значения в </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>: для любой битовой позиции </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>i</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> мы имеем </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>ν<sub>i</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ<sub>i</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>или </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ν<sub>i</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>η<sub>i</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i><a href="#_ftn16"
name="_ftnref16" title=""><sup><span lang=EN-US><sup><span lang=EN-US
style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'>[16]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:1.0pt;
margin-left:-.25pt'><span lang=RU>2.1.9. Остановка </span><span lang=EN-US>NextHop</span><span
lang=RU>. Другим важным свойством </span><span lang=EN-US>NextHop</span><span
lang=RU> является его <i>остановка, означающая, что </i></span><i><span
lang=EN-US>NextHop</span></i><i><span lang=RU>(</span><span lang=EN-US>ξ</span></i><i><span
lang=RU>,</span><span lang=EN-US>η</span></i><i><span lang=RU>) = </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>возможен только
тогда, когда </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>η</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>. Другими словами, если мы еще не достигли </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, следующий прыжок не может совпадать с
нашей нынешней позицией.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:11.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Это свойство подразумевает,
что путь от </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>до </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, т. е. последовательность промежуточных
адресов </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><sup><span
lang=RU style='font-family:"Cambria",serif'>(0)</span></sup></i><i><span
lang=RU style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>:= </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ</span></i><i><sup><span lang=RU
style='font-family:"Cambria",serif'>(</span></sup></i><i><sup><span lang=EN-US
style='font-family:"Cambria",serif'>n</span></sup></i><i><sup><span lang=RU
style='font-family:"Cambria",serif'>)</span></sup></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>:= </span><span lang=EN-US>NextHop</span><span lang=RU>(</span><span
lang=EN-US>ξ</span><sup><span lang=RU>(</span><span lang=EN-US>n</span></sup><sup><span
lang=RU>−1)</span></sup><span lang=RU>,</span><span lang=EN-US>η</span><span
lang=RU>), будет постепенно стабилизироваться при </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>η</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>: для некоторого </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>N</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>≥ 0 мы имеем </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>ξ</span></i><i><sup><span lang=RU style='font-family:"Cambria",serif'>(</span></sup></i><i><sup><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></sup></i><i><sup><span
lang=RU style='font-family:"Cambria",serif'>)</span></sup></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= </span><i><span lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>для
всех </span><i><span lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>≥ </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>N</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>. Действительно, всегда можно взять </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>N</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>:=||</span><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span><span
lang=EN-US style='font-family:"Cambria",serif'> </span><span lang=RU
style='font-family:"Cambria",serif'>– </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>η</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>||<sub>1</sub>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:1.45pt;
margin-left:-.25pt'><span lang=RU>2.1.10. Выпуклость пути </span><span
lang=EN-US>HR</span><span lang=RU> по отношению к шардингу. Следствием свойства
оптимальности Хэмминга (14) является то, что мы называем <i>выпуклостью </i>пути
от </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>к </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>относительно
шардинга. А именно, если </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><sup><span
lang=RU style='font-family:"Cambria",serif'>(0)</span></sup></i><i><span
lang=RU style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>:= </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ</span></i><i><sup><span lang=RU
style='font-family:"Cambria",serif'>(</span></sup></i><i><sup><span lang=EN-US
style='font-family:"Cambria",serif'>n</span></sup></i><i><sup><span lang=RU
style='font-family:"Cambria",serif'>)</span></sup></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>:= </span><span lang=EN-US>NextHop</span><span lang=RU>(</span><span
lang=EN-US>ξ</span><sup><span lang=RU>(</span><span lang=EN-US>n</span></sup><sup><span
lang=RU>−1)</span></sup><span lang=RU>,</span><span lang=EN-US>η</span><span
lang=RU>) — вычисляемый путь от </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>ξ</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>до </span><i><span lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, а </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>N</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>— первый индекс,
такой, что </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><sup><span
lang=RU style='font-family:"Cambria",serif'>(</span></sup></i><i><sup><span
lang=EN-US style='font-family:"Cambria",serif'>N</span></sup></i><i><sup><span
lang=RU style='font-family:"Cambria",serif'>)</span></sup></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= </span><i><span lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, а </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>S</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>— осколок
некоторой рабочей цепи в любой конфигурации сегмента, то индексы </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>i</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>с </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><sup><span
lang=RU style='font-family:"Cambria",serif'>(</span></sup></i><i><sup><span
lang=EN-US style='font-family:"Cambria",serif'>i</span></sup></i><i><sup><span
lang=RU style='font-family:"Cambria",serif'>)</span></sup></i><i><span lang=RU
style='font-family:"Cambria",serif'>, </span></i><span lang=RU>находящиеся в
сегменте </span><i><span lang=EN-US style='font-family:"Cambria",serif'>S</span></i><span
lang=RU>, составляют подинтервал в </span><span lang=RU style='font-family:
"Cambria",serif'>[0,Н]. Другими словами, если целые числа 0 ≤ </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>i</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>≤ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>j</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>≤ </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>k</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>≤ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>N</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>таковы,
что </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><sup><span
lang=RU style='font-family:"Cambria",serif'>(</span></sup></i><i><sup><span
lang=EN-US style='font-family:"Cambria",serif'>i</span></sup></i><i><sup><span
lang=RU style='font-family:"Cambria",serif'>)</span></sup></i><i><span lang=RU
style='font-family:"Cambria",serif'>, </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ</span></i><i><sup><span lang=RU
style='font-family:"Cambria",serif'>(</span></sup></i><i><sup><span lang=EN-US
style='font-family:"Cambria",serif'>k</span></sup></i><i><sup><span lang=RU
style='font-family:"Cambria",serif'>)</span></sup></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>∈ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>S</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, то </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><sup><span
lang=RU style='font-family:"Cambria",serif'>(</span></sup></i><i><sup><span
lang=EN-US style='font-family:"Cambria",serif'>j</span></sup></i><i><sup><span
lang=RU style='font-family:"Cambria",serif'>)</span></sup></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>также ∈ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>S</span></i><span
lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Это свойство выпуклости
важно для некоторых доказательств, связанных с пересылкой сообщений при наличии
динамического сегментирования.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>2.1.11. Внутренняя маршрутизация. Обратите
внимание, что адрес следующего прыжка, вычисляемый в соответствии с правилами,
определенными в разделе 2.1.5, может принадлежать к той же цепочке шардчейна,
что и текущий (т.е. тот, который содержит транзитный адрес). В этом случае
«внутренняя маршрутизация» происходит немедленно, транзитный адрес заменяется
значением вычисляемого адреса следующего прыжка, а шаг вычисления адреса
следующего прыжка повторяется до тех пор, пока не будет получен адрес
следующего прыжка, лежащий за пределами текущей шардчейна. Затем сообщение
хранится в выходной очереди транзита в соответствии с его вычисляемым адресом
следующего прыжка, причем его последний вычисляемый транзитный адрес является
«промежуточным владельцем» транзитного сообщения. Если текущий </span><span
lang=EN-US>shardchain</span><span lang=RU> разделяется на две </span><span
lang=EN-US>shardchains</span><span lang=RU> перед дальнейшей пересылкой
сообщения, то именно </span><span lang=EN-US>shardchain</span><span lang=RU>,
содержащий промежуточный владелец, наследует это транзитное сообщение.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Кроме того, мы можем
продолжить вычисление адресов следующего прыжка только для того, чтобы узнать,
что адрес назначения уже принадлежит текущему шардчейну. В этом случае
сообщение будет обработано (транзакцией) внутри этого шардчейна, а не
перенаправлено дальше.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>2.1.12. Соседние шардчейны. Два сегмента в
конфигурации сегмента — или два соответствующих шардчейна — считаются <i>соседями
или соседними шардчейнами, если один из них содержит адрес следующего прыжка по
крайней мере для одной комбинации разрешенных адресов источника и назначения, а
другой содержит транзитный адрес для той же комбинации. Другими словами, две
шардчейны являются соседями, если сообщение может быть перенаправлено
непосредственно из одного из них в другой через </i></span><i><span lang=EN-US>Hypercube</span></i><i><span
lang=EN-US> </span><span lang=EN-US>Routing</span></i><i><span lang=RU>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Мастерчейн также включен
в это определение, как если бы это был единственный шардчейн рабочей цепи с </span><i><span
lang=EN-US>workchain</span></i><i><span lang=RU>_</span><span lang=EN-US>id</span></i><i><span
lang=EN-US> </span></i><span lang=RU style='font-family:"Cambria",serif'>= −1.
В этом отношении он является соседом всех остальных шардчейнов.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.6pt;
margin-left:-.25pt'><span lang=RU>2.1.13. Любой осколок является соседом самого
себя. Обратите внимание, что шардчейн всегда считается соседом самого себя. Это
может показаться излишним, потому что мы всегда повторяем вычисления следующего
прыжка, описанные в 2.1.5, пока не получим адрес следующего прыжка за пределами
текущего шардчейна (см. 2.1.11). Однако есть, по крайней мере, две причины для
такой договоренности:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:13.15pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Некоторые сообщения имеют адрес источника и
назначения внутри одной и той же цепочки сегментов, по крайней мере, при
создании сообщения. Однако, если такое сообщение не обрабатывается сразу в том
же блоке, где оно было создано, оно должно быть добавлено в очередь исходящих
сообщений его </span><span lang=EN-US>shardchain</span><span lang=RU> и
импортировано как входящее сообщение (с записью в </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=RU>) в один из последующих блоков того же </span><span lang=EN-US>shardchain</span></i><i><span
lang=RU>.</span></i><a href="#_ftn17" name="_ftnref17" title=""><sup><span
lang=EN-US><sup><span lang=EN-US style='font-size:12.0pt;line-height:104%;
font-family:"Calibri",sans-serif;color:black'>[17]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.45pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Кроме того, адрес следующего прыжка может
первоначально находиться в какой-то другой шардчейне, которая позже
объединяется с текущей шардчейн, так что следующий прыжок становится внутри той
же цепочки. Затем сообщение должно быть импортировано из очереди исходящих
сообщений объединенной </span><span lang=EN-US>shardchain</span><span lang=RU>
и перенаправлено или обработано в соответствии с его адресом </span><span
lang=EN-US>nexthop</span><span lang=RU>, даже если они теперь находятся внутри
одной и той же цепочки сегментов.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>2.1.14. Гиперкубовая маршрутизация и
интернет-провайдер. В конечном счете, здесь применима парадигма бесконечного
шардинга (</span><span lang=EN-US>ISP</span><span lang=RU>): шардчейн следует
рассматривать как временное объединение цепей счетов, сгруппированных вместе
исключительно для минимизации генерации блоков и накладных расходов на
передачу.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Пересылка сообщения проходит
через несколько промежуточных цепей учетных записей, некоторые из которых могут
лежать в одном и том же сегменте. В этом случае, как только сообщение достигает
цепочки учетных записей, лежащей в этом сегменте, оно немедленно («внутренне»)
направляется внутрь этого сегмента до тех пор, пока не будет достигнута
последняя цепочка учетных записей, лежащая в том же сегменте (см. 2.1.11).
Затем сообщение помещается в очередь вывода этой последней цепочки учетных
записей.</span><a href="#_ftn18" name="_ftnref18" title=""><sup><span
lang=EN-US><sup><span lang=EN-US style='font-size:12.0pt;line-height:104%;
font-family:"Calibri",sans-serif;color:black'>[18]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>2.1.15. Представление транзитных и
последующих адресов. Обратите внимание, что адреса транзита и следующего прыжка
отличаются от адреса источника только в </span><i><span lang=EN-US>workchain</span></i><i><span
lang=RU>_</span><span lang=EN-US>id</span></i><i><span lang=EN-US> </span></i><span
lang=RU>и в первых (наиболее значимых) 64 битах адреса учетной записи. Поэтому
они могут быть представлены 96-битными строками. Кроме того их </span><i><span
lang=EN-US>workchain</span></i><i><span lang=RU>_</span><span lang=EN-US>id</span></i><i><span
lang=EN-US> </span></i><span lang=RU>обычно совпадает с </span><i><span
lang=EN-US>workchain</span></i><i><span lang=RU>_</span><span lang=EN-US>id</span></i><i><span
lang=EN-US> </span></i><span lang=RU>либо адреса источника, либо адреса
назначения; для обозначения этой ситуации может использоваться пара бит, что
еще больше сокращает пространство, необходимое для представления транзитных и
следующих адресов.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:1.35pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Фактически, требуемое
хранилище может быть сокращено еще больше, если заметить, что конкретный
алгоритм маршрутизации гиперкубов, описанный в 2.1.5, всегда генерирует
промежуточные (т.е. транзитные и следующие) адреса, которые совпадают с адресом
назначения в их первых </span><i><span lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>битах
и с адресом источника в их оставшихся битах. Поэтому можно использовать только
значения </span><span lang=RU style='font-family:"Cambria",serif'>0 ≤ </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ktr</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>knh</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>≤ 96,</span><span lang=RU> чтобы полностью указать адреса
транзита и следующего прыжка. Можно также заметить, что </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ </span></i><span lang=RU
style='font-family:"Cambria",serif'>:= </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>k<sub>nh</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>оказывается
фиксированной функцией </span><i><span lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>:= </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>k<sub>tr</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>(например,
</span><i><span lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>’ </span></i><span lang=RU
style='font-family:"Cambria",serif'>= </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>k</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>+</span><span lang=EN-US style='font-family:"Cambria",serif'>n</span><sub><span
lang=RU style='font-family:"Cambria",serif'>2</span></sub><span lang=RU
style='font-family:"Cambria",serif'> = </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>k</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>+4 </span><span lang=RU>для </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>k</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>≥ 32), и поэтому включать в сериализацию только одно 7-битное
значение </span><i><span lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Такие оптимизации имеют
очевидный недостаток, заключающийся в том, что они слишком полагаются на
конкретный используемый алгоритм маршрутизации, который может быть изменен в
будущем, поэтому они используются в 3.1.15 с положением о том, чтобы при
необходимости указать более общие промежуточные адреса.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.1pt;
margin-left:-.25pt'><span lang=RU>2.1.16. Конверты с сообщениями. Адреса
транзита и следующего прыжка пересылаемого сообщения не включаются в само
сообщение, а хранятся в специальном конверте <i>сообщения, который представляет
собой ячейку (или фрагмент ячейки), содержащую адреса транзита и следующего
прыжка с вышеуказанными оптимизациями, некоторую другую информацию, относящуюся
к пересылке и обработке, и ссылку на ячейку, содержащую неизмененное исходное
сообщение. Таким образом, сообщение может быть легко «извлечено» из исходного
конверта (например, того, который присутствует в </i></span><i><span
lang=EN-US>InMsgDescr</span></i><i><span lang=RU>) и помещено в другой конверт
(например, перед включением в </span><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=RU>).</span></i></p>

</div>

<span lang=RU style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'><br clear=all style='page-break-before:always'>
</span>

<div class=WordSection10>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:21.4pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>При представлении блока в
виде дерева, или, скорее, группы обеспечения доступности баз данных, двух
различных конвертов будут содержать ссылки на общую ячейку с исходным
сообщением. Если сообщение большое, такое расположение позволяет избежать
необходимости хранить более одной копии сообщения в блоке.</span></p>

<h2 style='margin-left:35.2pt;text-indent:-36.0pt'><a name="_Toc150767"><span
lang=EN-US>2.2<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>Протокол маршрутизации Hypercube</span></a></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.55pt;
margin-left:-.25pt'><span lang=RU>В этом разделе раскрываются подробности
протокола маршрутизации гиперкубов, используемого блокчейном </span><span
lang=EN-US>TON</span><span lang=RU> для обеспечения гарантированной доставки
сообщений между смарт-контрактами, находящимися в произвольных шардчейнах. Для
целей этого документа мы будем ссылаться на вариант маршрутизации гиперкубов,
используемый блокчейном </span><span lang=EN-US>TON</span><span lang=RU>, как </span><span
lang=EN-US>Hypercube</span><span lang=EN-US> </span><span lang=EN-US>Routing</span><span
lang=RU> (</span><span lang=EN-US>HR</span><span lang=RU>).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.25pt;
margin-left:-.25pt'><span lang=RU>2.2.1. Уникальность сообщения. Прежде чем
продолжить, давайте заметим, что любое (внутреннее) сообщение <i>уникально.
Напомним, что сообщение содержит полный адрес источника вместе со временем
логического создания, а все исходящие сообщения, созданные одним и тем же
смарт-контрактом, имеют строго увеличенное время логического создания (см.
1.4.6); поэтому сочетание полного адреса источника и логического времени
создания однозначно определяет сообщение. Поскольку мы предполагаем, что
выбранная хэш-функция </i></span><i><span lang=EN-US>sha</span></i><i><span
lang=RU>256 устойчива к коллизиям, сообщение однозначно определяется его хэшем,
поэтому мы можем идентифицировать два сообщения, если знаем, что их хэши
совпадают.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Это не распространяется
на внешние сообщения «из ниоткуда», которые не имеют исходных адресов. Особое внимание
следует уделять предотвращению повторных атак, связанных с такими сообщениями,
особенно со стороны разработчиков смарт-контрактов кошельков пользователей.
Одним из возможных решений является включение порядкового номера в тело таких
сообщений и сохранение количества внешних сообщений, уже обработанных внутри
постоянных данных смарт-контракта, отказываясь обрабатывать внешнее сообщение,
если его порядковый номер отличается от этого количества.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.85pt;
margin-left:-.25pt'><span lang=RU>2.2.2. Идентификация сообщений с равными
хэшами. Блокчейн </span><span lang=EN-US>TON</span><span lang=RU> предполагает,
что два сообщения с одинаковыми хэшами совпадают, и рассматривает любое из них
как избыточную копию другого. Как объяснялось выше в разделе 2.2.1, это не
приводит к каким-либо неожиданным последствиям для внутренних сообщений.
Однако, если отправить два совпадающих «сообщения из ниоткуда» на
смарт-контракт, может случиться так, что будет доставлено только одно из них —
или оба. Если их действие не должно быть идемпотентным (т.е. если обработка
сообщения дважды имеет эффект, отличный от его обработки один раз), следует
предусмотреть некоторые положения для различения этих двух сообщений, например,
путем включения в них порядкового номера.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>В частности, </span><i><span
lang=EN-US>InMsgDescr</span></i><i><span lang=EN-US> </span></i><span lang=RU>и
</span><i><span lang=EN-US>OutMsgDescr</span></i><i><span lang=EN-US> </span></i><span
lang=RU>используют хэш (непробеленного) сообщения в качестве ключа, молчаливо
предполагая, что отдельные сообщения имеют разные хэши. Таким образом, можно
проследить путь и судьбу сообщения через разные цепочки шардов, посмотрев хэш
сообщения в </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>и </span><i><span lang=EN-US>OutMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>разных блоков.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.15pt;
margin-left:-.25pt'><span lang=RU>2.2.3. Структура </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=RU>. Напомним, что исходящие сообщения — как созданные внутри </span><span
lang=EN-US>shardchain</span></i><i><span lang=RU>, так и транзитные сообщения,
ранее </span></i><span lang=RU>импортированные из соседнего </span><span
lang=EN-US>shardchain</span><span lang=RU> для ретрансляции в шардчейн </span><span
lang=EN-US>nexthop</span><span lang=RU>, — накапливаются в </span><i><span
lang=EN-US>OutMsgQueue</span></i><i><span lang=RU>, который является частью
состояния </span></i><span lang=EN-US>shardchain</span><span lang=RU> (см.
1.2.7). В отличие от </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>и </span><i><span lang=EN-US>OutMsgDescr</span></i><i><span
lang=RU>, ключом в </span><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=EN-US> </span></i><span lang=RU>является не хэш сообщения, а его адрес
следующего прыжка — или, по крайней мере, его первые 96 бит — сцепленные с
хэшем сообщения.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Кроме того, </span><i><span
lang=EN-US>OutMsgQueue</span></i><i><span lang=EN-US> </span></i><span lang=RU>-
это не просто словарь (</span><span lang=EN-US>hashmap</span><span lang=RU>),
отображающий свои ключи в (конвертированные) сообщения. Скорее, это минимальный
расширенный <i>словарь в отношении логического времени создания, означающий,
что каждый узел дерева </i></span><i><span lang=EN-US>Patricia</span></i><i><span
lang=RU>, представляющий </span><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=RU>,</span></i><span lang=RU> имеет дополнительное значение (в данном
случае беззнаковое 64-битное целое число), и что это значение дополнения в
каждом узле форка установлено равным минимальному значению дополнений его
дочерних элементов. Значение дополнения листа равно логическому времени
создания сообщения, содержащегося в этом листе; его не обязательно хранить
явно.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>2.2.4. Осмотр </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=EN-US> </span></i><span lang=RU>соседа. Такая структура для </span><i><span
lang=EN-US>OutMsgQueue</span></i><i><span lang=EN-US> </span></i><span lang=RU>позволяет
валидаторам соседнего шардчейна проверять его, чтобы найти его часть (поддерево
</span><span lang=EN-US>Patricia</span><span lang=RU>), относящуюся к ним (т.
е. состоящую из сообщений с адресом следующего прыжка, принадлежащим соседнему
сегменту, о котором идет речь, или имеющему адрес следующего прыжка с заданным
двоичным префиксом), а также быстро вычислить «самый старый» (т.е. с минимальным
логическим временем создания) сообщение в этой части.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.8pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Кроме того, валидаторам
сегментов даже не нужно отслеживать общее состояние всех соседних цепей шардов
— им нужно только сохранить и обновить копию своего </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=RU> или даже его поддерева, связанного с ними.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>2.2.5. Логическое время монотонности: импорт
самого старого сообщения от соседей. Первое фундаментальное локальное условие
пересылки сообщений, называемое <i>(импорт сообщения) (логическое время)
условием монотонности, можно резюмировать следующим образом:</i></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:29.25pt;margin-bottom:
9.25pt;margin-left:29.75pt'><span lang=RU>При импорте сообщений в </span><i><span
lang=EN-US>InMsgDescr</span></i><i><span lang=EN-US> </span></i><span lang=RU>блока
</span><span lang=EN-US>shardchain</span><span lang=RU> из </span><i><span
lang=EN-US>OutMsgQueues</span></i><i><span lang=RU> соседних </span><span
lang=EN-US>shardchains</span></i><i><span lang=RU> валидаторы должны
импортировать сообщения в порядке возрастания их логического времени; в случае
привязки сообщение с меньшим хэшем импортируется первым.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.8pt;
margin-left:-.25pt'><span lang=RU>Точнее, каждый блок </span><span lang=EN-US>shardchain</span><span
lang=RU> содержит хэш блока </span><span lang=EN-US>masterchain</span><span
lang=RU> (считается «последним» блоком </span><span lang=EN-US>masterchain</span><span
lang=RU> на момент создания блока </span><span lang=EN-US>shardchain</span><span
lang=RU>), который, в свою очередь, содержит хэши самых последних блоков </span><span
lang=EN-US>shardchain</span><span lang=RU>. Таким образом, каждый блок шардчейнов
косвенно «знает» самое последнее состояние всех других шардчейнов, и особенно
соседних с ним шардчейнов, включая их </span><i><span lang=EN-US>OutMsgQueues</span></i><i><span
lang=RU>.</span></i><a href="#_ftn19" name="_ftnref19" title=""><sup><span
lang=EN-US><sup><span lang=EN-US style='font-size:12.0pt;line-height:104%;
font-family:"Calibri",sans-serif;color:black'>[19]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Теперь альтернативная
эквивалентная формулировка условия монотонности выглядит следующим образом:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:29.25pt;margin-bottom:
9.2pt;margin-left:29.75pt'><span lang=RU>Если сообщение импортируется в </span><i><span
lang=EN-US>InMsgDescr</span></i><i><span lang=EN-US> </span></i><span lang=RU>нового
блока, время его логического создания не может быть больше, чем время любого
сообщения, оставшегося неимпортированным в </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=EN-US> </span></i><span lang=RU>самого последнего состояния любого из
соседних сегментов.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.35pt;
margin-left:-.25pt'><span lang=RU>Именно эта форма условия монотонности появляется
в локальных условиях согласованности блоков </span><span lang=EN-US>TON</span><span
lang=EN-US> </span><span lang=EN-US>Blockchain</span><span lang=RU> и
обеспечивается валидаторами.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>2.2.6. Свидетели нарушений сообщения
импортируют условие монотонности логического времени. Обратите внимание, что
если это условие не выполняется, может быть построено небольшое доказательство
Меркла, свидетельствующее о его сбое. </span><span lang=EN-US>Такое
доказательство будет содержать:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Путь в </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=EN-US> </span></i><span lang=RU>соседа от корня к определенному сообщению </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>с небольшим
временем логического создания.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Путь в </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>рассматриваемого блока, показывающий, что
ключ, равный </span><span lang=EN-US>Hash</span><span lang=RU>(</span><span
lang=EN-US>m</span><span lang=RU>), отсутствует в </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>(т.е. что </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>не был включен в
текущий блок).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Доказательство того, что </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>не было включено
в предыдущий блок того же шардчейна, используя информацию заголовка блока, содержащую
наименьшее и наибольшее логическое время всех сообщений, импортированных в блок
(см. 2.3.4–2.3.7 для получения дополнительной информации).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Путь в </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>к другому включенному сообщению </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>0, такой, что либо </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>Lt</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’) &gt; </span></i><span lang=EN-US>Lt</span><span
lang=RU>(</span><span lang=EN-US>m</span><span lang=RU>), либо </span><span
lang=EN-US>Lt</span><span lang=RU>(</span><span lang=EN-US>m</span><span
lang=RU>’) = </span><span lang=EN-US>Lt</span><span lang=RU>(</span><span
lang=EN-US>m</span><span lang=RU>) и </span><span lang=EN-US>Hash</span><span
lang=RU>(</span><span lang=EN-US>m</span><span lang=RU>’) </span><i><span
lang=RU style='font-family:"Cambria",serif'>&gt; </span></i><span lang=EN-US>Hash</span><span
lang=RU>(</span><span lang=EN-US>m</span><span lang=RU>).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>2.2.7. Удаление сообщения из </span><i><span
lang=EN-US>OutMsgQueue</span></i><i><span lang=RU>. Рано или поздно сообщение
должно быть удалено из </span><span lang=EN-US>OutMsgQueue</span></i><span
lang=RU>; в противном случае хранилище, используемое </span><i><span
lang=EN-US>OutMsgQueue</span></i><span lang=RU>, вырастет до бесконечности. С
этой целью вводится несколько «правил сбора мусора». Они позволяют удалять
сообщение из </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=EN-US> </span></i><span lang=RU>во время оценки блока только в том случае,
если в </span><i><span lang=EN-US>OutMsgDescr</span></i><i><span lang=EN-US> </span></i><span
lang=RU>этого блока присутствует явная специальная «запись доставки». Эта
запись содержит либо ссылку на соседний блок </span><span lang=EN-US>shardchain</span><span
lang=RU>, который включил сообщение в свой </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>(хэш блока достаточен, но собранный
материал для блока может содержать соответствующее доказательство Меркла), либо
доказательство Меркла о том, что сообщение было доставлено в конечный пункт
назначения через </span><span lang=EN-US>instant</span><span lang=EN-US> </span><span
lang=EN-US>Hypercube</span><span lang=EN-US> </span><span lang=EN-US>Routing</span><span
lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>2.2.8. Гарантированная доставка сообщений по </span><span
lang=EN-US>Hypercube</span><span lang=EN-US> </span><span lang=EN-US>Routing</span><span
lang=RU>. Таким образом, сообщение не может быть удалено из очереди исходящих
сообщений, если оно не было либо ретранслировано в шардчейн следующего прыжка,
либо доставлено в конечный пункт назначения (см. 2.2.7). Между тем, условие
монотонности импорта сообщений (см. 2.2.5) гарантирует, что любое сообщение рано
или поздно будет ретранслировано в следующую цепочку шардчейнов, принимая во
внимание другие условия, которые требуют, чтобы валидаторы использовали не
менее половины пространства блока или ограничения газа для импорта входящих
внутренних сообщений (в противном случае валидаторы могут создать пустые блоки
или импортировать только внешние сообщения даже при наличии непустых очередей
исходящих сообщений у своих соседей).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>2.2.9. Порядок обработки сообщений. Когда
несколько импортированных сообщений обрабатываются транзакциями внутри блока, <i>условия
порядка обработки сообщений </i>гарантируют, что старые сообщения
обрабатываются первыми. Точнее, если блок содержит две транзакции </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>одного и того же
аккаунта, которые обрабатывают входящие сообщения </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>0 соответственно и </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>Lt</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) &lt; </span></i><span lang=EN-US>Lt</span><span
lang=RU>(</span><span lang=EN-US>m</span><span lang=RU>’), то у нас должны быть
</span><span lang=EN-US>Lt</span><span lang=RU>(</span><span lang=EN-US>t</span><span
lang=RU>) </span><i><span lang=RU style='font-family:"Cambria",serif'>&lt; </span></i><span
lang=EN-US>Lt</span><span lang=RU>(</span><span lang=EN-US>t</span><span
lang=RU>’).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>2.2.10. </span><span lang=EN-US>FIFO</span><span
lang=RU> гарантирует маршрутизацию </span><span lang=EN-US>Hypercube</span><span
lang=RU>. Условия заказа на обработку сообщений (см. 2.2.9), наряду с условиями
монотонности импорта сообщений (см. 2.2.5), подразумевают <i>гарантии </i></span><i><span
lang=EN-US>FIFO</span></i><i><span lang=RU> для маршрутизации </span><span
lang=EN-US>Hypercube</span></i><i><span lang=RU>. А именно, если смарт-контракт
</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>создает
два сообщения </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>с одинаковым </span><i><span
lang=RU style='font-family:"Cambria",serif'>назначением </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, а </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>генерируется
позже </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>(имеется
в виду, что </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>≺ </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’, следовательно, </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>Lt</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) &lt; </span></i><span lang=EN-US>Lt</span><span
lang=RU>(</span><span lang=EN-US>m</span><span lang=RU>’)), то </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>будет обработан </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>перед </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’. Это связано с тем, что оба сообщения
будут следовать </span></i><span lang=RU>одним и тем же шагам маршрутизации по
пути от </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>к </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>(алгоритм
маршрутизации </span><span lang=EN-US>Hypercube</span><span lang=RU>, описанный
в 2.1.5, является детерминированным), и во всех исходящих очередях и описаниях
входящих сообщений </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>будет
отображаться «после» </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>.</span></i><a href="#_ftn20"
name="_ftnref20" title=""><sup><span lang=EN-US><sup><span lang=EN-US
style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'>[20]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.15pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Если сообщение </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>может быть
доставлено в </span><i><span lang=EN-US style='font-family:"Cambria",serif'>B</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>через
мгновенную маршрутизацию </span><span lang=EN-US>Hypercube</span><span lang=RU>,
это уже не обязательно так. Таким образом, простой способ обеспечения
дисциплины доставки сообщений </span><span lang=EN-US>FIFO</span><span lang=RU>
между парой смарт-контрактов заключается в установке специального бита в
заголовке сообщения, предотвращающего его доставку через ММСП.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.05pt;
margin-left:-.25pt'><span lang=RU>2.2.11. Гарантия уникальности доставки </span><span
lang=EN-US>Hypercube</span><span lang=EN-US> </span><span lang=EN-US>Routing</span><span
lang=RU>. Обратите внимание, что условия монотонности импорта сообщений также
подразумевают <i>уникальность </i>доставки любого сообщения через </span><span
lang=EN-US>Hypercube</span><span lang=EN-US> </span><span lang=EN-US>Routing</span><span
lang=RU>, то есть то, что оно не может быть импортировано и обработано
смарт-контрактом назначения более одного раза. Позже в 2.3 мы увидим, что
обеспечение уникальности доставки, когда активны как </span><span lang=EN-US>Hypercube</span><span
lang=EN-US> </span><span lang=EN-US>Routing</span><span lang=RU>, так и </span><span
lang=EN-US>Instant</span><span lang=EN-US> </span><span lang=EN-US>Hypercube</span><span
lang=EN-US> </span><span lang=EN-US>Routing</span><span lang=RU>, сложнее.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.2pt;
margin-left:-.25pt'><span lang=RU>2.2.12. Обзор маршрутизации </span><span
lang=EN-US>Hypercube</span><span lang=RU>. Давайте суммируем все шаги маршрутизации,
выполненные для доставки внутреннего сообщения </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><span lang=RU>, созданного
исходной учетной записью </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>0</span></sub></i><span lang=RU>, в
целевую учетную запись </span><i><span lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>. Обозначаем </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ<sub>k</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+1</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>:= </span><span lang=EN-US>NextHop</span><span
lang=RU>(</span><span lang=EN-US>ξ<sub>k</sub></span><span lang=RU>,</span><span
lang=EN-US>η</span><span lang=RU>), </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>k</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 0,1,2,... </span><span lang=RU>промежуточные адреса,
продиктованные </span><span lang=EN-US>HR</span><span lang=RU> для пересылки
сообщения </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>в
конечный пункт назначения </span><i><span lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>. Пусть </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>S<sub>k</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>—
осколок, содержащий </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ<sub>k</sub></span></i><i><span
lang=RU style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.35pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>[Рождение] — Сообщение </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>с </span><i><span
lang=RU style='font-family:"Cambria",serif'>целевым </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>создается
транзакцией </span><i><span lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>,</span></i><span lang=RU>
принадлежащей учетной записи </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>ξ</span></i><i><sub><span lang=RU style='font-family:"Cambria",serif'>0</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'>,</span></i><span lang=RU>
находящейся в какой-то </span><span lang=EN-US>shardchain</span><span
lang=EN-US> </span><i><span lang=EN-US style='font-family:"Cambria",serif'>S</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>0</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'>. Время логического создания </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>Lt</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU>фиксируется в
этой точке и включается в сообщение </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=EN-US style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>[</span><span lang=EN-US>ImmediateProcessing</span><span
lang=RU>?] — Если </span><i><span lang=RU style='font-family:"Cambria",serif'>целевой
</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>находится
в той же цепочке </span><span lang=EN-US>S</span><sub><span lang=RU>0</span></sub><i><span
lang=RU style='font-family:"Cambria",serif'>, сообщение может быть обработано в
том же блоке, в котором оно было сгенерировано. В этом случае </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>включается в </span><i><span
lang=EN-US>OutMsgDescr</span></i><i><span lang=EN-US> </span></i><span lang=RU>с
флагом, указывающим, что он был обработан в этом самом блоке и не нуждается в
дальнейшей пересылке. Другая копия </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>m</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>включена в </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=RU> вместе с обычными данными, описывающими обработку входящих сообщений. </span><span
lang=EN-US>(Обратите внимание, что </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>m </span></i><span lang=EN-US>не входит в <i>OutMsgQueue
</i></span><i><span lang=EN-US style='font-family:"Cambria",serif'>S<sub>0</sub>.)</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:.2pt;
margin-left:-.75pt;text-indent:9.95pt;line-height:109%'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:2.25pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>[</span><span lang=EN-US>InitialInternalRouting</span><span
lang=RU>] — Если </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>либо
имеет назначение вне </span><i><span lang=EN-US style='font-family:"Cambria",serif'>S</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>0</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'>, либо не обрабатывается в том же блоке,
где он был сгенерирован, применяется внутренняя процедура маршрутизации,
описанная в 2.1.11, до тех пор, пока не будет найден индекс </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>,</span></i><span lang=RU> такой, что </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ<sub>k</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>лежит
в </span><i><span lang=EN-US style='font-family:"Cambria",serif'>S</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>0</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'>, но </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ<sub>k</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+1</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= </span><span lang=EN-US>NextHop</span><span
lang=RU>(</span><span lang=EN-US>ξk</span><span lang=RU>,</span><span
lang=EN-US>η</span><span lang=RU>) этого не делает (т.е. </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>S<sub>k</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>S</span></i><i><sub><span lang=RU
style='font-family:"Cambria",serif'>0</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'>, но   </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>S<sub>k</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+1</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>≠ </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>S</span></i><i><sub><span lang=RU
style='font-family:"Cambria",serif'>0</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'>). Кроме того, этот процесс
останавливается, если </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ<sub>k</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>η</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>или </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ<sub>k</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>совпадает
с </span><i><span lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>в его
первых 96 битах.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>[</span><span lang=EN-US>OutboundQueuing</span><span
lang=RU>] — Сообщение </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>включено
в </span><i><span lang=EN-US>OutMsgDescr</span></i><i><span lang=EN-US> </span></i><span
lang=RU>(с ключом, равным его хэшу), с конвертом, содержащим его транзитный
адрес </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ<sub>k</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>и
адрес следующего прыжка </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ<sub>k</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+1</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'>,</span></i><span lang=RU> как
описано в 2.1.16 и 2.1.15. Это же сообщение в оболочке также включено в </span><i><span
lang=EN-US>OutMsgQueue</span></i><i><span lang=EN-US> </span></i><span lang=RU>состояния
</span><i><span lang=EN-US style='font-family:"Cambria",serif'>S<sub>k</sub></span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, с ключом, равным сцеплению первых
96 бит его адреса следующего прыжка </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ<sub>k</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+1</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'> </span></i><span lang=RU>(который
может быть равен </span><i><span lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>если </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>принадлежит </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>S<sub>k</sub></span></i><i><span
lang=RU style='font-family:"Cambria",serif'>) и хэша сообщения </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>Hash</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>).</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>[</span><span lang=EN-US>QueueWait</span><span
lang=RU>] — Сообщение </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>ожидает
дальнейшей пересылки в </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=EN-US> </span></i><span lang=EN-US>shardchain</span><span lang=EN-US> </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>S<sub>k</sub></span></i><span
lang=RU>. В то же время </span><span lang=EN-US>shardchain</span><span
lang=EN-US> </span><i><span lang=EN-US style='font-family:"Cambria",serif'>S<sub>k</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>может</span></p>

<p class=MsoNormal align=left style='margin-bottom:4.3pt;text-align:left;
line-height:107%'><span lang=RU><img width=156 height=1 id="Group 123501"
src="tblkch_convertio_ru_done.fld/image009.jpg"></span></p>

<p class=MsoNormal style='margin-bottom:.2pt;line-height:109%'><span lang=RU
style='font-size:10.0pt;line-height:109%'>вовлеченные могут разделяться или
объединяться во время маршрутизации. Правильное доказательство может быть
получено путем принятия точки зрения </span><span lang=EN-US style='font-size:
10.0pt;line-height:109%'>ISP</span><span lang=RU style='font-size:10.0pt;
line-height:109%'> для </span><span lang=EN-US style='font-size:10.0pt;
line-height:109%'>HR</span><span lang=RU style='font-size:10.0pt;line-height:
109%'>, как описано в 2.1.14, и наблюдения за тем, что </span><i><span
lang=EN-US style='font-size:10.0pt;line-height:109%;font-family:"Cambria",serif'>m</span></i><i><span
lang=RU style='font-size:10.0pt;line-height:109%;font-family:"Cambria",serif'>0
</span></i><span lang=RU style='font-size:10.0pt;line-height:109%'>всегда будет
отставать от </span><i><span lang=EN-US style='font-size:10.0pt;line-height:
109%;font-family:"Cambria",serif'>m</span></i><i><span lang=RU
style='font-size:10.0pt;line-height:109%;font-family:"Cambria",serif'>, либо с
точки зрения достигнутой промежуточной цепочки счетов, либо, если они окажутся
в одной и той же цепочке счетов, с точки зрения логического времени создания.</span></i></p>

<p class=MsoNormal style='margin-bottom:.2pt;line-height:109%'><span lang=RU
style='font-size:10.0pt;line-height:109%'>Важным наблюдением является то, что
«в любой заданный момент времени» (логически; более точным описанием было бы «в
общем состоянии, полученном после обработки любого причинно замкнутого
подмножества </span><i><span lang=EN-US style='font-size:10.0pt;line-height:
109%'>F</span></i><i><span lang=EN-US style='font-size:10.0pt;line-height:109%'>
</span></i><span lang=RU style='font-size:10.0pt;line-height:109%'>блоков»),
промежуточные цепочки счетов, принадлежащие одному и тому же осколку, являются
смежными на пути от </span><i><span lang=EN-US style='font-size:10.0pt;
line-height:109%;font-family:"Cambria",serif'>ξ</span></i><i><span lang=EN-US
style='font-size:10.0pt;line-height:109%;font-family:"Cambria",serif'> </span></i><span
lang=RU style='font-size:10.0pt;line-height:109%'>до </span><i><span
lang=EN-US style='font-size:10.0pt;line-height:109%;font-family:"Cambria",serif'>η</span></i><i><span
lang=EN-US style='font-size:10.0pt;line-height:109%;font-family:"Cambria",serif'>
</span></i><span lang=RU style='font-size:10.0pt;line-height:109%'>(т.е. не
может иметь связей счетов, принадлежащих какому-то другому осколку между ними).
Это «свойство выпуклости» (ср. 2.1.10) алгоритма маршрутизации </span><span
lang=EN-US style='font-size:10.0pt;line-height:109%'>Hypercube</span><span
lang=RU style='font-size:10.0pt;line-height:109%'>, описанного в 2.1.5.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:0cm'><span lang=RU>&nbsp;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:0cm'><span lang=RU>разделяться или сливаться с
другими </span><span lang=EN-US>shardchains</span><span lang=RU>; в этом случае
новый сегмент </span><i><span lang=EN-US style='font-family:"Cambria",serif'>S</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>’</span></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>k</span></sub></i><span lang=RU>,
содержащий транзитный адрес </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ<sub>k</sub></span></i><span
lang=RU>, наследует </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>в
своем </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span lang=RU>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>[</span><span lang=EN-US>ImportInbound</span><span
lang=RU>] — В какой-то момент в будущем валидаторы для </span><span lang=EN-US>shardchain</span><span
lang=EN-US> </span><i><span lang=EN-US style='font-family:"Cambria",serif'>S<sub>k</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+1</span></sub></i><span lang=RU>,
содержащего адрес следующего прыжка </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ<sub>k</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+1</span></sub></i><span lang=RU>,
сканируют </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span lang=EN-US>
</span></i><span lang=RU>в состоянии </span><span lang=EN-US>shardchain</span><span
lang=EN-US> </span><i><span lang=EN-US style='font-family:"Cambria",serif'>S<sub>k</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>и
решают импортировать сообщение </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>m</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>в соответствии с условием монотонности (см. 2.2.5) и
другими условиями. Генерируется новый блок для </span><span lang=EN-US>shardchain</span><span
lang=EN-US> </span><i><span lang=EN-US style='font-family:"Cambria",serif'>S<sub>k</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+1</span></sub></i><span lang=RU>,
с конвертированной копией </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, </span></i><span lang=RU>включенной
в его </span><i><span lang=EN-US>InMsgDescr</span></i><i><span lang=RU>. Запись
в </span><span lang=EN-US>InMsgDescr</span></i><i><span lang=EN-US> </span></i><span
lang=RU>содержит также причину импорта </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>в этот блок, с
хэшем самого последнего блока </span><span lang=EN-US>shardchain</span><span
lang=EN-US> </span><i><span lang=EN-US style='font-family:"Cambria",serif'>S</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>’</span></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>k</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'>,</span></i><span lang=RU> и
предыдущими адресами следующего прыжка и транзита </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ<sub>k</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ<sub>k</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+1</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'>, так что соответствующая запись в </span><span
lang=EN-US>OutMsgQueue</span></i><i><span lang=EN-US> </span></i><span lang=RU>из</span><span
lang=RU><img width=11 height=12 id="Picture 148332"
src="tblkch_convertio_ru_done.fld/image010.jpg"></span><span lang=RU> может
быть легко найдена.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>[Подтверждение] — Эта запись в </span><i><span
lang=EN-US>InMsgDescr</span></i><i><span lang=EN-US> </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>S<sub>k</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+1</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'> </span></i><span lang=RU>также
служит подтверждением для </span><i><span lang=EN-US style='font-family:"Cambria",serif'>S</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>’</span></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>k</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'>.</span></i><span lang=RU> В более
позднем блоке </span><i><span lang=EN-US style='font-family:"Cambria",serif'>S</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>’</span></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>k</span></sub></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>сообщение
</span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>должно
быть удалено из </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=EN-US> </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>S</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>’</span></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>k</span></sub></i><span lang=RU>;
это изменение отражается в специальной записи в </span><i><span lang=EN-US>OutMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>блока </span><span lang=RU><img width=11
height=12 id="Picture 148333" src="tblkch_convertio_ru_done.fld/image011.jpg"></span><span
lang=RU>, который выполняет это изменение состояния.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.75pt'><span lang=RU>[</span><span lang=EN-US>Forwarding</span><span
lang=RU>?] — Если конечный пункт назначения </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>η</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>не находится в </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>S<sub>k</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+1</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'>, сообщение </span></i><i><span
lang=RU>пересылается. Маршрутизация гиперкубов применяется до тех пор, пока</span></i><span
lang=RU> получаются некоторые </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>ξ<sub>l</sub></span></i><i><span lang=RU style='font-family:
"Cambria",serif'>, </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>l</span></i><i><span
lang=RU style='font-family:"Cambria",serif'> &gt; </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> и </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ<sub>l</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+1</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= </span><span lang=EN-US>NextHop</span><span
lang=RU>(</span><span lang=EN-US>ξ<sub>l</sub></span><span lang=RU>,</span><span
lang=EN-US>η</span><span lang=RU>), так что </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ<sub>l</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>лежит
в </span><i><span lang=EN-US style='font-family:"Cambria",serif'>S<sub>k</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+1</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'>, а </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ<sub>l</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+1</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'> </span></i><span lang=RU>— нет (см.
2.1.11). После этого недавно разработанная копия </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>с транзитным
адресом, установленным на </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ<sub>l</sub></span></i><span
lang=RU>, и адресом следующего прыжка </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ<sub>l</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+1</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'> </span></i><span lang=RU>включается
как в </span><i><span lang=EN-US>OutMsgDescr</span></i><i><span lang=EN-US> </span></i><span
lang=RU>текущего блока </span><i><span lang=EN-US style='font-family:"Cambria",serif'>S<sub>k</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+1</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'>, </span></i><span lang=RU>так и в </span><i><span
lang=EN-US>OutMsgQueue</span></i><i><span lang=EN-US> </span></i><span lang=RU>нового
состояния </span><i><span lang=EN-US style='font-family:"Cambria",serif'>S<sub>k</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+1</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'>. Запись </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>в </span><i><span
lang=EN-US>InMsgDescr</span></i><i><span lang=EN-US> </span></i><span lang=RU>содержит
флаг, указывающий, что сообщение было переслано; запись в </span><i><span
lang=EN-US>OutMsgDescr</span></i><i><span lang=EN-US> </span></i><span lang=RU>содержит
сообщение с новым конвертом и флаг, указывающий, что это пересылаемое
сообщение. Затем все шаги, начинающиеся с [</span><span lang=EN-US>OutboundQueueing</span><span
lang=RU>], повторяются, для </span><i><span lang=EN-US style='font-family:"Cambria",serif'>l</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>вместо
</span><i><span lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>.</span></i></p>

</div>

<span lang=RU style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'><br clear=all style='page-break-before:always'>
</span>

<div class=WordSection11>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.95pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU> [</span><span lang=EN-US>Processing</span><span
lang=RU>?] — Если конечный пункт назначения </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>η</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=EN-US>m</span><span
lang=EN-US> </span><span lang=RU>находится в </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>S<sub>k</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+1</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'>, то блок </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>S<sub>k</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+1</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'>, </span></i><span lang=RU>импортировавший
сообщение, должен обработать его транзакцией </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>t</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>,</span></i><span lang=RU> включенной в тот
же блок. В этом случае </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>содержит ссылку на </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>по своему
логическому времени </span><span lang=EN-US>Lt</span><span lang=RU>(</span><span
lang=EN-US>t</span><span lang=RU>) и флаг, указывающий, что сообщение было
обработано.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:21.25pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Приведенный выше алгоритм
маршрутизации сообщений не учитывает некоторые дополнительные изменения,
необходимые для реализации мгновенной гиперкубической маршрутизации (</span><span
lang=EN-US>IHR</span><span lang=RU>). Например, сообщение может быть <i>отброшено
</i>после импорта (перечисленного в </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=RU>) в его конечный или промежуточный блок шардчейна, поскольку
представлено доказательство доставки через ММСП в конечный пункт назначения. В
этом случае такое доказательство должно быть включено в </span><span
lang=EN-US>InMsgDescr</span></i><i><span lang=RU>, </span></i><span lang=RU>чтобы
объяснить, почему сообщение не было отправлено дальше или обработано.</span></p>

<h2 style='margin-left:35.2pt;text-indent:-36.0pt'><a name="_Toc150768"><span
lang=RU>2.3<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=RU>Мгновенная маршрутизация </span><span lang=EN-US>Hypercube</span></a><span
lang=RU> и комбинированные гарантии доставки</span></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>В этом разделе описывается протокол
мгновенной гиперкубовой маршрутизации, обычно применяемый </span><span
lang=EN-US>TON</span><span lang=EN-US> </span><span lang=EN-US>Blockchain</span><span
lang=RU> параллельно с ранее обсуждавшимся протоколом маршрутизации </span><span
lang=EN-US>Hypercube</span><span lang=RU> для достижения более быстрой доставки
сообщений. Однако, когда и </span><span lang=EN-US>Hypercube</span><span
lang=EN-US> </span><span lang=EN-US>Routing</span><span lang=RU>, и </span><span
lang=EN-US>Instant</span><span lang=EN-US> </span><span lang=EN-US>Hypercube</span><span
lang=EN-US> </span><span lang=EN-US>Routing</span><span lang=RU> применяются к
одному и тому же сообщению параллельно, достижение доставки и уникальных
гарантий доставки сложнее. Эта тема также обсуждается в этом разделе.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:1.15pt;
margin-left:-.25pt'><span lang=RU>2.3.1. Обзор мгновенной маршрутизации
гиперкубов. Поясним основные шаги, применяемые при применении к сообщению
механизма мгновенной гиперкубической маршрутизации (ММСП). (Обратите внимание,
что обычно и обычные </span><span lang=EN-US>HR</span><span lang=RU>, и ММСП
работают параллельно для одного и того же сообщения; некоторые положения должны
быть приняты, чтобы гарантировать уникальность доставки любого сообщения.)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.75pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Рассмотрим маршрутизацию
и доставку одного и того же сообщения </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>с источником </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><span
lang=EN-US>η</span><span lang=RU> назначения </span><i><span lang=RU
style='font-family:"Cambria",serif'>,</span></i><span lang=RU> как описано в
2.2.12:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>[</span><span lang=EN-US>NetworkSend</span><span
lang=RU>] — После того, как валидаторы </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>S</span></i><i><sub><span lang=RU
style='font-family:"Cambria",serif'>0</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU>согласовали и
подписали блок, содержащий создающую транзакцию </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>t</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>для </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, и заметили, что </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><i><span lang=RU
style='font-family:"Cambria",serif'>назначения </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>не находится
внутри </span><i><span lang=EN-US style='font-family:"Cambria",serif'>S</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>0</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'>, они могут отправить дейтаграмму
(зашифрованное сетевое сообщение), содержащую сообщение </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>вместе с доказательством
</span><span lang=EN-US>Merkle</span><span lang=RU> о его включении в </span><i><span
lang=EN-US>OutMsgDescr</span></i><i><span lang=EN-US> </span></i><span lang=RU>только
что сгенерированного блока в группу валидаторов </span><span lang=EN-US>shardchain</span><span
lang=EN-US> </span><i><span lang=EN-US style='font-family:"Cambria",serif'>T</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, </span></i><span lang=RU>в
настоящее время владеющего целевым </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>η</span></i><i><span lang=RU style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>[</span><span lang=EN-US>NetworkReceive</span><span
lang=RU>] — Если валидаторы </span><span lang=EN-US>shardchain</span><span
lang=EN-US> </span><i><span lang=EN-US style='font-family:"Cambria",serif'>T</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>получают
такое сообщение, они проверяют его действительность, начиная с самого
последнего блока </span><span lang=EN-US>masterchain</span><span lang=RU> и
перечисленных в нем хэшей блока </span><span lang=EN-US>shardchain</span><span
lang=RU>, включая самый последний «канонический» блок </span><span lang=EN-US>shardchain</span><span
lang=EN-US> </span><i><span lang=EN-US style='font-family:"Cambria",serif'>S</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>0</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i><span lang=RU> Если сообщение
недопустимо, они молча отбрасывают его. Если этот блок </span><span lang=EN-US>shardchain</span><span
lang=EN-US> </span><i><span lang=EN-US style='font-family:"Cambria",serif'>S</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>0</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU>имеет больший
порядковый номер, чем тот, который указан в последнем блоке </span><span
lang=EN-US>masterchain</span><span lang=RU>, они могут либо отбросить его, либо
отложить проверку до появления следующего блока </span><span lang=EN-US>masterchain</span><span
lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>[</span><span lang=EN-US>InclusionConditions</span><span
lang=RU>] — Валидаторы проверяют условия включения сообщения </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>. В частности, они должны проверить, что
это сообщение не было доставлено ранее, и что </span><span lang=EN-US>OutMsgQueues</span></i><i><span
lang=RU> соседей не имеют необработанных исходящих сообщений с назначениями в </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>T</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>с меньшим
временем логического создания, чем </span><span lang=EN-US>Lt</span><span
lang=RU>(</span><span lang=EN-US>m</span><span lang=RU>).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>[</span><span lang=EN-US>Deliver</span><span
lang=RU>] — Валидаторы доставляют и обрабатывают сообщение, включая его в </span><i><span
lang=EN-US>InMsgDescr</span></i><i><span lang=EN-US> </span></i><span lang=RU>текущего
блока </span><span lang=EN-US>shardchain</span><span lang=RU> вместе с битом,
указывающим, что это сообщение </span><span lang=EN-US>IHR</span><span lang=RU>,
доказательство Меркла о его включении в </span><i><span lang=EN-US>OutMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>исходного блока и логическое время
транзакции </span><i><span lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>’,</span></i><span lang=RU>
обрабатывающей это входящее сообщение в текущий сгенерированный блок.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>[</span><span lang=EN-US>Confirm</span><span
lang=RU>] — Наконец, валидаторы отправляют зашифрованные дейтаграммы всем
группам валидаторов промежуточных шардчейнов на пути от </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>до </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, содержащие доказательство Меркла о
включении сообщения </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>в </span><i><span
lang=EN-US>InMsgDescr</span></i><i><span lang=EN-US> </span></i><span lang=RU>его
конечного назначения. Валидаторы промежуточной цепочки сегментов могут
использовать это доказательство для <i>удаления </i>копии сообщения </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>путешествует по
правилам </span><span lang=EN-US>HR</span><span lang=RU>, импортируя сообщение
в свой </span><i><span lang=EN-US>InMsgDescr</span></i><i><span lang=EN-US> </span></i><span
lang=RU>вместе с доказательством Окончательной доставки </span><span
lang=EN-US>Merkle</span><span lang=RU> и устанавливая флаг, указывающий, что
сообщение было отброшено.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Общая процедура еще
проще, чем для </span><span lang=EN-US>Hypercube</span><span lang=EN-US> </span><span
lang=EN-US>Routing</span><span lang=RU>. Обратите внимание, однако, что ММСП
поставляются без доставки или гарантий </span><span lang=EN-US>FIFO</span><span
lang=RU>: сетевая датаграмма может быть потеряна при передаче, или валидаторы
целевого шардчейна могут решить не действовать по ней, или они могут отклонить
ее из-за переполнения буфера. Именно по этой причине ММСП используются в
качестве дополнения к ЛР, а не в качестве замены.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>2.3.2. Общие гарантии возможной поставки.
Обратите внимание, что сочетание </span><span lang=EN-US>HR</span><span
lang=RU> и </span><span lang=EN-US>IHR</span><span lang=RU> гарантирует
конечную доставку любого внутреннего сообщения в конечный пункт назначения.
Действительно, </span><span lang=EN-US>HR</span><span lang=RU> сам по себе гарантированно
доставит любое сообщение в конечном итоге, и </span><span lang=EN-US>HR</span><span
lang=RU> для сообщения </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>может
быть отменен на промежуточном этапе только доказательством </span><span
lang=EN-US>Merkle</span><span lang=RU> о доставке </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>в конечный пункт
назначения (через </span><span lang=EN-US>IHR</span><span lang=RU>).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>2.3.3. Общие уникальные гарантии доставки.
Однако <i>уникальность </i>доставки сообщений для сочетания </span><span
lang=EN-US>HR</span><span lang=RU> и ММСП труднее достичь. В частности,
необходимо проверить следующие условия, и, при необходимости, иметь возможность
предоставить краткие доказательства Меркла, что они содержатся или не
содержатся:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Когда сообщение </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>импортируется в
следующий промежуточный блок </span><span lang=EN-US>shardchain</span><span
lang=RU> через </span><span lang=EN-US>HR</span><span lang=RU>, мы должны
проверить, что </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>еще не
был импортирован через </span><span lang=EN-US>HR</span><span lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.7pt;
margin-left:29.3pt;text-indent:-11.85pt;line-height:103%'><span lang=EN-US
style='line-height:103%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Когда </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>m</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>импортируется и обрабатывается в конечном пункте
назначения </span><span lang=EN-US>shardchain</span><span lang=RU>, мы должны
проверить, что </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>еще не
был обработан. </span><span lang=EN-US>Если да, то есть три подкафайла:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:5.8pt;
margin-left:55.05pt;text-indent:-12.6pt'><span lang=RU style='line-height:104%'>–<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span><span
lang=RU>Если </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>рассматривается
для импорта через </span><span lang=EN-US>HR</span><span lang=RU>, и он уже был
импортирован через </span><span lang=EN-US>HR</span><span lang=RU>, он не
должен быть импортирован вообще.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:55.05pt;text-indent:-12.6pt'><span lang=RU style='line-height:104%'>–<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span><span
lang=RU>Если </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>рассматривается
для импорта через </span><span lang=EN-US>HR</span><span lang=RU>, и он уже был
импортирован через ММСП (но не </span><span lang=EN-US>HR</span><span lang=RU>),
то он должен быть импортирован и немедленно выброшен (без обработки
транзакцией). Это необходимо для удаления </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>из </span><i><span
lang=EN-US>OutMsgQueue</span></i><i><span lang=EN-US> </span></i><span lang=RU>его
предыдущего промежуточного шардчейна.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.3pt;
margin-left:55.05pt;text-indent:-12.6pt'><span lang=RU style='line-height:104%'>–<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span><span
lang=RU>Если </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>рассматривается
для импорта через ММСП и он уже был импортирован либо через ММСП, либо через </span><span
lang=EN-US>HR</span><span lang=RU>, он не должен быть импортирован вообще.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.7pt;
margin-left:-.25pt'><span lang=RU>2.3.4. Проверка того, было ли сообщение уже
доставлено в конечный пункт назначения. Рассмотрим следующий общий алгоритм
проверки того, было ли сообщение </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>m</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>уже доставлено в конечный пункт назначения </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>η</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>: Можно просто отсканировать последние
несколько блоков, принадлежащих </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>shardchain</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, содержащих адрес назначения, начиная с
последнего блока и работая в обратном направлении через предыдущие ссылки на
блок. (Если есть два предыдущих блока, т. е. если в какой-то момент произошло
событие слияния </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>shardchain</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, вы будете следовать по цепочке,
содержащей адрес назначения.) </span><span lang=EN-US>InMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>каждого из этих блоков можно проверить на
наличие записи с ключом </span><span lang=EN-US>Hash</span><span lang=RU>(</span><span
lang=EN-US>m</span><span lang=RU>). Если такая запись найдена, сообщение </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>уже доставлено, и
мы можем легко построить доказательство Меркла этого факта. Если мы не найдем
такую запись до прибытия в блок </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>B</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>с </span><span lang=EN-US>Lt</span><span lang=RU>+(</span><span
lang=EN-US>B</span><span lang=RU>) </span><i><span lang=RU style='font-family:
"Cambria",serif'>&lt; </span></i><span lang=EN-US>Lt</span><span lang=RU>(</span><span
lang=EN-US>m</span><span lang=RU>), подразумевая, что </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>не может быть
доставлен в </span><i><span lang=EN-US style='font-family:"Cambria",serif'>B</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>или
любом из его предшественников, то сообщение </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>определенно еще
не доставлено.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.2pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Очевидным недостатком
этого алгоритма является то, что, если сообщение </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>очень старое (и,
скорее всего, доставленное давным-давно), что означает, что оно имеет небольшое
значение </span><span lang=EN-US>Lt</span><span lang=RU>(</span><span
lang=EN-US>m</span><span lang=RU>), то перед выдачей ответа необходимо будет
отсканировать большое количество блоков. Кроме того, если ответ отрицательный,
размер доказательства Меркла этого факта будет линейно увеличиваться с
количеством сканируемых блоков.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.2pt;
margin-left:-.25pt'><span lang=RU>2.3.5. Проверка того, было ли сообщение ММСП
уже доставлено в конечный пункт назначения. Чтобы проверить, было ли сообщение
ММСП </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>уже
доставлено в шардчейн назначения, мы можем применить общий алгоритм, описанный
выше (см. 2.3.4), модифицированный для проверки только последних блоков </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>c</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>на наличие
некоторой небольшой константы </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>c</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>(скажем, </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>c</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU style='font-family:"Cambria",serif'>= 8). Если после
проверки этих блоков не удается прийти к какому-либо выводу, то валидаторы для
целевого шардчейна могут просто отбросить сообщение ММСП вместо того, чтобы
тратить больше ресурсов на эту проверку.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.65pt;
margin-left:-.25pt'><span lang=RU>2.3.6. Проверка того, было ли </span><span
lang=EN-US>hr</span><span lang=RU>-сообщение уже доставлено через </span><span
lang=EN-US>HR</span><span lang=RU> в конечный пункт назначения или
промежуточный шардчейн. Чтобы проверить, было ли уже импортировано через </span><span
lang=EN-US>HR</span><span lang=RU> полученное сообщение </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>(или, скорее,
сообщение </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>,</span></i><span lang=RU>
рассматриваемое для импорта через </span><span lang=EN-US>HR</span><span
lang=RU>), мы можем использовать следующий алгоритм: Пусть </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ<sub>k</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>—
транзитный адрес </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>(принадлежащий
соседнему </span><span lang=EN-US>shardchain</span><span lang=EN-US> </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>Sk</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>), а </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ<sub>k</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+1</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'> </span></i><span lang=RU>— его
адрес следующего прыжка (принадлежащий рассматриваемому шардчейну). Поскольку
мы рассматриваем возможность включения </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>должно
присутствовать в </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=EN-US> </span></i><span lang=RU>самого последнего состояния </span><span
lang=EN-US>shardchain</span><span lang=EN-US> </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>S<sub>k</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, причем </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ<sub>k</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ<sub>k</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'> +1</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'> </span></i><span lang=RU>указаны в
его конверте. В частности, (</span><span lang=EN-US>a</span><span lang=RU>)
сообщение было включено в </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=RU>, и мы можем даже знать, когда, потому что запись в </span><span
lang=EN-US>OutMsgQueue</span></i><i><span lang=EN-US> </span></i><span lang=RU>иногда
содержит логическое время блока, в который оно было добавлено, и (</span><span
lang=EN-US>b</span><span lang=RU>) оно еще не было удалено из </span><i><span
lang=EN-US>OutMsgQueue</span></i><i><span lang=RU>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.15pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Теперь валидаторы
соседнего шардчейна должны удалить сообщение из </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=RU>, </span></i><span lang=RU>как только они заметят, что сообщение (с
адресами транзита и следующего прыжка </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ<sub>k</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ<sub>k</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+1</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'> </span></i><span lang=RU>в
конверте) было импортировано в </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>шардчейна следующего прыжка сообщения.
Таким образом, (</span><span lang=EN-US>b</span><span lang=RU>) подразумевает, что
сообщение могло быть импортировано в </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>предыдущего блока только в том случае,
если этот предыдущий блок является очень новым (т. е. еще не известен самому
последнему соседнему блоку </span><span lang=EN-US>shardchain</span><span
lang=RU>). Поэтому только очень ограниченное количество предшествующих блоков
(обычно один или два, самое большее) должно быть проверено алгоритмом,
описанным в 2.3.4, чтобы сделать вывод о том, что сообщение еще не было
импортировано.</span><a href="#_ftn21" name="_ftnref21" title=""><sup><span
lang=EN-US><sup><span lang=EN-US style='font-size:12.0pt;line-height:104%;
font-family:"Calibri",sans-serif;color:black'>[21]</span></sup></span></sup></a><sup><span
lang=EN-US> </span></sup><span lang=RU>Фактически, если эта проверка
выполняется самими валидаторами или коллаторами для текущего шардчейна, ее
можно оптимизировать, сохранив в памяти </span><i><span lang=EN-US>InMsgDescrs</span></i><i><span
lang=RU> нескольких последних блоков.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>2.3.7. Проверка того, было ли сообщение </span><span
lang=EN-US>HR</span><span lang=RU> уже доставлено через ММСП в конечный пункт
назначения. Наконец, чтобы проверить, было ли сообщение </span><span
lang=EN-US>HR</span><span lang=RU> уже доставлено в конечный пункт назначения с
помощью ММСП, можно использовать общий алгоритм, описанный в 2.3.4. В отличие
от 2.3.5, мы не можем прервать процесс проверки после сканирования
фиксированного количества последних блоков в целевой </span><span lang=EN-US>shardchain</span><span
lang=RU>, потому что </span><span lang=EN-US>HR</span><span lang=RU>-сообщения
не могут быть удалены без причины.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:1.4pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Вместо этого мы косвенно
ограничили количество проверяемых блоков, запретив включение сообщения ММСП </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>в блок </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>B</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>его целевой
шардчейна, если в шардчейне назначения уже больше, чем, скажем, </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>c</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 8 </span><span lang=RU>блоков </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>B</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>с </span><span
lang=EN-US>Lt</span><span lang=RU>+(</span><span lang=EN-US>B</span><span
lang=RU>’) ≥ </span><span lang=EN-US>Lt</span><span lang=RU>(</span><span
lang=EN-US>m</span><span lang=RU>).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.9pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Такое условие фактически
ограничивает временной интервал после создания сообщения </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>,</span></i><span lang=RU> в течение
которого оно могло бы быть доставлено с помощью ММСП, так что потребуется
проверить лишь небольшое количество блоков шардчейна назначения (не более </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>c</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>).</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.55pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Обратите внимание, что
это условие хорошо согласуется с модифицированным алгоритмом, описанным в
2.3.5, фактически запрещая валидаторам импортировать вновь полученное сообщение
ММСП, если </span><i><span lang=RU style='font-family:"Cambria",serif'>более </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>c</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 8 шагов.</span><span lang=RU>для проверки того, что оно еще
не было импортировано, требуется</span></p>

</div>

<span lang=RU style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'><br clear=all style='page-break-before:always'>
</span>

<div class=WordSection12>

<h1 style='margin-left:27.1pt;text-indent:-18.0pt'><a name="_Toc150769"><span
lang=EN-US>3<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>Сообщения, дескрипторы сообщений и очереди</span></a></h1>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:.9pt;
margin-left:-.25pt'><span lang=RU>В этой главе представлен внутренний макет
отдельных сообщений, дескрипторов сообщений (таких как </span><i><span
lang=EN-US>InMsgDescr</span></i><i><span lang=EN-US> </span></i><span lang=RU>или
</span><i><span lang=EN-US>OutMsgDescr</span></i><i><span lang=RU>) и очередей
сообщений (например, </span><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=RU>). Здесь также обсуждаются сообщения в конвертах (см. 2.1.16).</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:20.6pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Обратите внимание, что
большинство общих соглашений, связанных с сообщениями, должны соблюдаться всеми
шардчейнами, даже если они не принадлежат к основной цепочке; в противном
случае обмен сообщениями и взаимодействие между различными рабочими цепочками были
бы невозможны. Именно <i>интерпретация </i>содержимого сообщения и <i>обработка
</i>сообщений, обычно некоторыми транзакциями, различаются между рабочими
цепочками.</span></p>

<h2 style='margin-left:35.2pt;text-indent:-36.0pt'><a name="_Toc150770"><span
lang=EN-US>3.1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>Адрес, валюта и макет сообщения</span></a></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:7.75pt;
margin-left:-.25pt'><span lang=RU>Эта глава начинается с некоторых общих
определений, за которыми следует точное расположение адресов, используемых для
сериализации адресов источника и назначения в сообщении.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:4.9pt;
margin-left:-.3pt;text-indent:-.55pt'><span lang=RU>3.1.1. Некоторые
стандартные определения. Для удобства читателя мы воспроизводим здесь несколько
общих определений </span><span lang=EN-US>TL</span><span lang=RU>-</span><span
lang=EN-US>B</span><span lang=RU>.</span><a href="#_ftn22" name="_ftnref22"
title=""><sup><span lang=EN-US><sup><span lang=EN-US style='font-size:12.0pt;
line-height:104%;font-family:"Calibri",sans-serif;color:black'>[22]</span></sup></span></sup></a><sup><span
lang=EN-US> </span></sup><span lang=RU>Эти определения используются ниже при
обсуждении адреса и макета сообщения, но в остальном не связаны с блокчейном </span><span
lang=EN-US>TON</span><span lang=RU>.</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:67.75pt;
margin-bottom:1.8pt;margin-left:-.3pt;text-align:left;text-indent:-.55pt'><span
lang=EN-US>unit$_ = Unit; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:67.75pt;
margin-bottom:1.8pt;margin-left:-.3pt;text-align:left;text-indent:-.55pt'><span
lang=EN-US>true$_ = True; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:67.75pt;
margin-bottom:1.8pt;margin-left:-.3pt;text-align:left;text-indent:-.55pt'><span
lang=EN-US>//  EMPTY False; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:67.75pt;
margin-bottom:1.8pt;margin-left:-.3pt;text-align:left;text-indent:-.55pt'><span
lang=EN-US>bool_false$0 = Bool; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:67.65pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>bool_true$1
= Bool; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:67.65pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>nothing$0
{X:Type} = Maybe X; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:67.65pt;
margin-bottom:1.8pt;margin-left:-.3pt;text-align:left;text-indent:-.55pt'><span
lang=EN-US>just$1 {X:Type} value:X = Maybe X; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:67.65pt;
margin-bottom:1.8pt;margin-left:-.3pt;text-align:left;text-indent:-.55pt'><span
lang=EN-US>left$0 {X:Type} {Y:Type} value:X = Either X Y; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:67.65pt;
margin-bottom:1.8pt;margin-left:-.3pt;text-align:left;text-indent:-.55pt'><span
lang=EN-US>right$1 {X:Type} {Y:Type} value:Y = Either X Y; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:67.65pt;
margin-bottom:1.8pt;margin-left:-.3pt;text-align:left;text-indent:-.55pt'><span
lang=EN-US>pair$_ {X:Type} {Y:Type} first:X second:Y = Both X Y;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:67.65pt;
margin-bottom:1.8pt;margin-left:-.3pt;text-align:left;text-indent:-.55pt'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.3pt;text-align:left;text-indent:-.55pt'><span
lang=EN-US>bit</span><span lang=RU>$_  _:(## 1) = </span><span lang=EN-US>Bit</span><span
lang=RU>;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>3.1.2. Схема </span><span lang=EN-US>TL</span><span
lang=RU>-</span><span lang=EN-US>B</span><span lang=RU> для адресов.
Сериализация адресов источника и назначения определяется следующей схемой </span><span
lang=EN-US>TL</span><span lang=RU>-</span><span lang=EN-US>B</span><span
lang=RU>:</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:61.5pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>addr_none$00
= MsgAddressExt; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:61.5pt;
margin-bottom:1.8pt;margin-left:-.3pt;text-align:left;text-indent:-.55pt'><span
lang=EN-US>addr_extern$01 len:(## 8) external_address:(len * Bit)</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:79.95pt'><span
lang=EN-US>= MsgAddressExt; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:0cm'><span
lang=EN-US>anycast_info$_  depth:(## 5) rewrite_pfx:(depth * Bit) = Anycast; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:0cm'><span
lang=EN-US>addr_std$10 anycast:(Maybe Anycast) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:0cm'><span
lang=EN-US>     workchain_id:int8 address:uint256 = MsgAddressInt;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.8pt;margin-left:17.7pt;text-align:left;text-indent:-18.45pt'><span
lang=EN-US>addr_var$11 anycast:(Maybe Anycast) addr_len:(## 9) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.8pt;margin-left:17.7pt;text-align:left;text-indent:-18.45pt'><span
lang=EN-US>      workchain_id:int32 address:(addr_len * Bit) = MsgAddressInt;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>_
MsgAddressInt = MsgAddress;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>_
MsgAddressExt = MsgAddress;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Две последние строки определяют тип </span><span
lang=EN-US>MsgAddress</span><span lang=RU> как внутреннее объединение типов </span><span
lang=EN-US>MsgAddressInt</span><span lang=RU> и </span><span lang=EN-US>MsgAddressExt</span><span
lang=RU> (не путать с их внешним объединением </span><span lang=EN-US>Either</span><span
lang=EN-US> </span><span lang=EN-US>MsgAddressInt</span><span lang=EN-US> </span><span
lang=EN-US>MsgAddressExt</span><span lang=RU>, как определено в 3.1.1), как если
бы предыдущие четыре строки были повторены с правой стороной, замененной на </span><span
lang=EN-US>MsgAddress</span><span lang=RU>. Таким образом, тип </span><span
lang=EN-US>MsgAddress</span><span lang=RU> имеет четыре конструктора, а типы </span><span
lang=EN-US>MsgAddressInt</span><span lang=RU> и </span><span lang=EN-US>MsgAddressExt</span><span
lang=RU> являются подтипами </span><span lang=EN-US>MsgAddress</span><span
lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>3.1.3. Внешние адреса. Первые два конструктора,
</span><span lang=EN-US>addr</span><span lang=RU>_</span><span lang=EN-US>none</span><span
lang=RU> и </span><span lang=EN-US>addr</span><span lang=RU>_</span><span
lang=EN-US>extern</span><span lang=RU>, используются для исходных адресов
«сообщений из ниоткуда» (входящих внешних сообщений) и для адресов назначения
«сообщений в никуда» (исходящих внешних сообщений). Конструктор </span><span
lang=EN-US>addr</span><span lang=RU>_</span><span lang=EN-US>extern</span><span
lang=RU> определяет «внешний адрес», который полностью игнорируется программным
обеспечением </span><span lang=EN-US>TON</span><span lang=EN-US> </span><span
lang=EN-US>Blockchain</span><span lang=RU> (которое рассматривает </span><span
lang=EN-US>addr</span><span lang=RU>_</span><span lang=EN-US>extern</span><span
lang=RU> как более длинный вариант </span><span lang=EN-US>addr</span><span
lang=RU>_</span><span lang=EN-US>none</span><span lang=RU>), но может
использоваться внешним программным обеспечением для своих целей. Например,
специальный внешний сервис может проверить адрес назначения всех исходящих
внешних сообщений, найденных во всех блоках блокчейна </span><span lang=EN-US>TON</span><span
lang=RU>, и, если в поле </span><span lang=EN-US>external</span><span lang=RU>_</span><span
lang=EN-US>address</span><span lang=RU> присутствует специальное магическое
число, проанализировать оставшуюся часть как </span><span lang=EN-US>IP</span><span
lang=RU>-адрес и </span><span lang=EN-US>UDP</span><span lang=RU>-порт или
адрес </span><span lang=EN-US>ADNL</span><span lang=RU> (</span><span
lang=EN-US>TON</span><span lang=EN-US> </span><span lang=EN-US>Network</span><span
lang=RU>) и отправить дейтаграмму с копией сообщения на полученный таким
образом сетевой адрес.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:3.7pt;
margin-left:-.25pt'><span lang=RU>3.1.4. Внутренние адреса. Два оставшихся конструктора,
</span><span lang=EN-US>addr</span><span lang=RU>_</span><span lang=EN-US>std</span><span
lang=RU> и </span><span lang=EN-US>addr</span><span lang=RU>_</span><span
lang=EN-US>var</span><span lang=RU>, представляют внутренние адреса. Первый из
них, </span><span lang=EN-US>addr</span><span lang=RU>_</span><span lang=EN-US>std</span><span
lang=RU>, представляет собой подписанный 8-битный </span><i><span lang=EN-US>workchain</span></i><i><span
lang=RU>_</span><span lang=EN-US>id</span></i><i><span lang=EN-US> </span></i><span
lang=RU>(достаточный для мастерчейна и для базовой рабочей цепочки) и
256-битный внутренний адрес в выбранной рабочей цепочке. Второй из них, </span><span
lang=EN-US>addr</span><span lang=RU>_</span><span lang=EN-US>var</span><span
lang=RU>, представляет собой адреса в рабочих цепочках с «большой» </span><i><span
lang=EN-US>workchain</span></i><i><span lang=RU>_</span><span lang=EN-US>id</span></i><i><span
lang=RU>, или внутренние адреса длиной, не равной 256. Оба этих конструктора </span></i><span
lang=RU>имеют необязательное значение </span><span lang=EN-US>anycast</span><span
lang=RU>, отсутствующее по умолчанию, которое позволяет «перезаписать адреса»
при наличии.</span><a href="#_ftn23" name="_ftnref23" title=""><sup><span
lang=EN-US><sup><span lang=EN-US style='font-size:12.0pt;line-height:104%;
font-family:"Calibri",sans-serif;color:black'>[23]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>По возможности средства
проверки должны использовать </span><span lang=EN-US>addr</span><span lang=RU>_</span><span
lang=EN-US>std</span><span lang=RU> вместо </span><span lang=EN-US>addr</span><span
lang=RU>_</span><span lang=EN-US>var</span><span lang=RU>, но должны быть
готовы принять </span><span lang=EN-US>addr</span><span lang=RU>_</span><span
lang=EN-US>var</span><span lang=RU> во входящих сообщениях. Конструктор </span><span
lang=EN-US>addr</span><span lang=RU>_</span><span lang=EN-US>var</span><span
lang=RU> предназначен для будущих расширений.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:9.15pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Обратите внимание, что </span><i><span
lang=EN-US>workchain</span></i><i><span lang=RU>_</span><span lang=EN-US>id</span></i><i><span
lang=EN-US> </span></i><span lang=RU>должен быть допустимым идентификатором
рабочей цепи, включенным в текущей конфигурации мастерчейна, а длина
внутреннего адреса должна находиться в диапазоне, разрешенном для указанной
рабочей цепочки. Например, нельзя использовать </span><i><span lang=EN-US>workchain</span></i><i><span
lang=RU>_</span><span lang=EN-US>id</span></i><i><span lang=EN-US> </span></i><span
lang=RU style='font-family:"Cambria",serif'>= 0 </span><span lang=RU>(базовая
рабочая цепочка) или </span><i><span lang=EN-US>workchain</span></i><i><span
lang=RU>_</span><span lang=EN-US>id</span></i><i><span lang=EN-US> </span></i><span
lang=RU style='font-family:"Cambria",serif'>= −1 </span><span lang=RU>(мастерчейн)
с адресами длиной не совсем 256 бит.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:8.15pt;
margin-left:-.25pt'><span lang=RU>3.1.5. Представление сумм в валюте Грамм.
Количества граммов выражаются с помощью двух типов, представляющих целые числа
без знака переменной длины или знаки, плюс тип граммов, явно предназначенный
для представления неотрицательных количеств нанограммов, следующим образом:</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>var_uint$_
{n:#} len:(#&lt; n) value:(uint (len * 8))</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:98.4pt;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:55.35pt'><span
lang=EN-US>= VarUInteger n; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:98.4pt;
margin-bottom:1.8pt;margin-left:.5pt;text-align:left'><span lang=EN-US>var_int$_
{n:#} len:(#&lt; n) value:(int (len * 8))</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:123.0pt;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:49.2pt'><span
lang=RU>= </span><span lang=EN-US>VarInteger</span><span lang=EN-US> </span><span
lang=EN-US>n</span><span lang=RU>; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:123.0pt;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:0cm'><span
lang=EN-US>nanograms</span><span lang=RU>$_ </span><span lang=EN-US>amount</span><span
lang=RU>:(</span><span lang=EN-US>VarUInteger</span><span lang=RU> 16) = </span><span
lang=EN-US>Grams</span><span lang=RU>;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:.75pt;
margin-left:-.25pt'><span lang=RU>Если кто-то хочет представить </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>нанограмм, он
выбирает целое число </span><i><span lang=EN-US>e</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> &lt; </span></i><span lang=RU
style='font-family:"Cambria",serif'>16</span><span lang=RU>, так что </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><i><span lang=RU
style='font-family:"Cambria",serif'>&lt; </span></i><span lang=RU
style='font-family:"Cambria",serif'>2<sup>8</sup></span><i><sup><span
lang=EN-US style='font-family:"Cambria",serif'>e</span></sup></i><span lang=RU
style='font-family:"Cambria",serif'>, и сериализует сначала </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>e</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>как беззнаковое
4-битное целое число, а затем </span><i><span lang=RU style='font-family:"Cambria",serif'>само
</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>как
беззнаковое </span><span lang=RU style='font-family:"Cambria",serif'>8</span><i><span
lang=EN-US style='font-family:"Cambria",serif'>e</span></i><span lang=RU
style='font-family:"Cambria",serif'>-битное целое число. Обратите внимание, что
четыре нулевых бита представляют собой нулевое количество граммов.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:9.25pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Напомним (см. [3, А]),
что первоначальный общий запас граммов зафиксирован на уровне пяти миллиардов
(т. е. </span><span lang=RU style='font-family:"Cambria",serif'>5 · 1018 <i>&lt;
</i>263 </span><span lang=RU>нанограмма) и, как ожидается, будет расти очень
медленно. Поэтому все количества граммов, встречающиеся на практике, будут
умещаться в беззнаковых или даже подписанных 64-битных целых числах. Валидаторы
могут использовать 64-разрядное целочисленное представление граммов в своих
внутренних вычислениях; Однако сериализация этих значений блокчейном — другое
дело.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>3.1.6. Представление коллекций произвольных
валют. Напомним, что </span><span lang=EN-US>TON</span><span lang=EN-US> </span><span
lang=EN-US>Blockchain</span><span lang=RU> позволяет своим пользователям
определять произвольные криптовалюты или токены отдельно от </span><span
lang=EN-US>Gram</span><span lang=RU>, при условии соблюдения некоторых условий.
Такие дополнительные криптовалюты идентифицируются 32-битными </span><i><span
lang=EN-US>currency</span></i><i><span lang=RU>_</span><span lang=EN-US>ids</span></i><i><span
lang=RU>. Список определенных дополнительных криптовалют является частью
конфигурации блокчейна, хранящейся в мастерчейне.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:9.4pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Когда необходимо
представить несколько количеств одной или нескольких таких криптовалют,
используется словарь (см. [4, 3.3]) с 32-битными </span><i><span lang=EN-US>currency</span></i><i><span
lang=RU>_</span><span lang=EN-US>ids</span></i><i><span lang=RU> в качестве
ключей и значениями </span><span lang=EN-US>VarUInteger</span></i><i><span
lang=RU> 32:</span></i></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>extra_currencies$_
dict:(HashmapE 32 (VarUInteger 32))</span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:24.6pt;
margin-bottom:1.8pt;margin-left:0cm;text-align:center;text-indent:0cm'><span
lang=EN-US>= ExtraCurrencyCollection;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:55.35pt;
margin-bottom:1.8pt;margin-left:66.9pt;text-align:left;text-indent:-67.65pt'><span
lang=EN-US>currencies$_ grams:Grams other:ExtraCurrencyCollection                         
 = CurrencyCollection;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Значение, прикрепленное к внутреннему
сообщению, представлено значением типа </span><span lang=EN-US>CurrencyCollection</span><span
lang=RU>, которое может описывать определенное (неотрицательное) количество
(нано)граммов, а также некоторые дополнительные валюты, если это необходимо.
Обратите внимание, что если дополнительные валюты не требуются, другие
уменьшаются до одного нулевого бита.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:9.2pt;
margin-left:-.25pt'><span lang=RU>3.1.7. Макет сообщения. Сообщение состоит из
заголовка <i>, </i>за которым следует его <i>тело или полезная нагрузка. Тело
по существу произвольно, чтобы интерпретироваться смарт-контрактом назначения.
Заголовок сообщения является стандартным и организован следующим образом:</i></span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>int_msg_info$0
ihr_disabled:Bool bounce:Bool</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>src:MsgAddressInt
dest:MsgAddressInt </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>value:CurrencyCollection
ihr_fee:Grams fwd_fee:Grams </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>created_lt:uint64
created_at:uint32 = CommonMsgInfo;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:-12.3pt'><span
lang=EN-US>ext_in_msg_info$10 src:MsgAddressExt dest:MsgAddressInt
import_fee:Grams = CommonMsgInfo;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>ext_out_msg_info$11
src:MsgAddressInt dest:MsgAddressExt</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:12.3pt'><span
lang=EN-US>created_lt:uint64 created_at:uint32 = CommonMsgInfo; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:.5pt;text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:.5pt;text-align:left'><span lang=EN-US>tick_tock$_
tick:Bool tock:Bool = TickTock;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:.5pt;text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:67.65pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:-12.3pt'><span
lang=EN-US>_ split_depth:(Maybe (## 5)) special:(Maybe TickTock) code:(Maybe
^Cell) data:(Maybe ^Cell) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:67.65pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:2.65pt'><span
lang=EN-US>library:(Maybe ^Cell) library:(Maybe ^Cell) = StateInit;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>message$_
{X:Type} info:CommonMsgInfo</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:49.2pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>init:(Maybe
(Either StateInit ^StateInit)) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:49.2pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>body:(Either
X ^X) = Message X;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.8pt;
margin-left:-.25pt'><span lang=RU>Смысл этой схемы заключается в следующем.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:8.2pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Тип </span><span
lang=EN-US>Message</span><span lang=EN-US> </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>X</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>описывает
сообщение с телом (или полезной нагрузкой) типа </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>X</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>. Его сериализация начинается с информации
типа </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>CommonMsgInfo</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, которая поставляется в трех
вариантах: для внутренних сообщений, входящих внешних сообщений и исходящих
внешних сообщений соответственно. Все они имеют исходный адрес </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>src</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> и адрес назначения </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>dest</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, которые являются внешними или внутренними
в соответствии с выбранным конструктором. Кроме того, внутреннее сообщение
может иметь некоторую ценность в граммах и других определенных валютах (ср.
3.1.6), и все сообщения, генерируемые внутри блокчейна </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>TON</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, имеют логическое время создания </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>created</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>_</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>lt</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> (см. 1.4.6) и </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>created</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>_</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>at</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> создания </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>unixtime</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, оба автоматически устанавливаются
генерирующей транзакцией. Создание </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>unixtime</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> равно созданию </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>unixtime</span></i><i><span
lang=RU style='font-family:"Cambria",serif'> блока, содержащего генерирующую
транзакцию.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>3.1.8. Экспедиторские сборы и сборы за ММСП.
Общая стоимость внутреннего сообщения. Внутренние сообщения определяют </span><span
lang=EN-US>ihr</span><span lang=RU>_</span><span lang=EN-US>fee</span><span
lang=RU> в граммах, которое вычитается из значения, придаваемого сообщению, и
присуждается валидаторам целевой цепочки, если они включают сообщение
механизмом ММСП. </span><span lang=EN-US>Fwd</span><span lang=RU>_</span><span
lang=EN-US>fee</span><span lang=RU> является первоначальная общая
экспедиторская плата, уплаченная с использованием механизма </span><span
lang=EN-US>HR</span><span lang=RU>; он автоматически вычисляется из некоторых
параметров конфигурации и размера сообщения на момент создания сообщения.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:9.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Обратите внимание, что
общее значение, переносимое вновь созданным внутренним исходящим сообщением,
равно сумме значений, </span><span lang=EN-US>ihr</span><span lang=RU>_</span><span
lang=EN-US>fee</span><span lang=RU> и </span><span lang=EN-US>fwd</span><span
lang=RU>_</span><span lang=EN-US>fee</span><span lang=RU>. Эта сумма вычитается
из остатка на счете источника. Из этих компонентов только значение всегда
зачисляется на целевой счет при доставке сообщений. </span><span lang=EN-US>Fwd</span><span
lang=RU>_</span><span lang=EN-US>fee</span><span lang=RU> собирается
валидаторами на пути </span><span lang=EN-US>HR</span><span lang=RU> от
источника до места назначения, а </span><span lang=EN-US>ihr</span><span
lang=RU>_</span><span lang=EN-US>fee</span><span lang=RU> либо собирается
валидаторами целевого шардчейна (если сообщение доставляется через ММСП), либо
зачисляется на целевой счет.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:14.75pt;
margin-left:-.25pt'><span lang=RU>3.1.9. Части кода и данных, содержащиеся в
сообщении. Помимо общей информации о сообщении, хранящейся в информации,
сообщение может содержать части кода и данных смарт-контракта назначения. Эта
функция используется, например, в так называемых <i>сообщениях конструктора </i>(см.
1.7.3), которые являются просто внутренними или входящими внешними сообщениями
с кодом и, возможно, полями данных, определенными в их инициализированных
частях. Если хэш этих полей правильный, а конечный смарт-контракт не имеет кода
или данных, вместо него используются значения из сообщения.</span><a
href="#_ftn24" name="_ftnref24" title=""><sup><span lang=EN-US><sup><span
lang=EN-US style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'>[24]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>3.1.10. Использование кода и данных для
других целей. Рабочие цепочки, отличные от мастерчейна и основной рабочей цепи,
могут свободно использовать деревья ячеек, упомянутые в коде, данных и полях
библиотеки, для своих собственных целей. Сама система обмена сообщениями не
делает никаких предположений относительно их содержания; они становятся
актуальными только тогда, когда сообщение обрабатывается транзакцией.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>3.1.11. Отсутствие явной цены на газ и лимита
газа. Обратите внимание, что в сообщениях нет четкой цены на газ и лимита газа.
Вместо этого цена на газ устанавливается глобально валидаторами для каждой
рабочей цепи (это специальный настраиваемый параметр), а лимит газа для каждой
транзакции также имеет значение по умолчанию, которое является настраиваемым
параметром; сам смарт-контракт может снизить лимит газа во время его
исполнения, если это необходимо.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Для внутренних сообщений
начальный лимит газа не может превышать значение </span><span lang=EN-US>Gram</span><span
lang=RU> сообщения, деленное на текущую цену газа. Для входящих внешних
сообщений начальный предел газа очень мал, а истинный предел газа
устанавливается самим принимающим смарт-контрактом, когда он <i>принимает </i>входящее
сообщение соответствующим примитивом </span><span lang=EN-US>TVM</span><span
lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>3.1.12. Десериализация полезной нагрузки
сообщения. Полезная нагрузка или тело сообщения десериализуется принимающим
смарт-контрактом при выполнении </span><span lang=EN-US>TVM</span><span
lang=RU>. Сама система обмена сообщениями не делает никаких предположений о
внутреннем формате полезной нагрузки. Однако имеет смысл описать сериализацию
поддерживаемых входящих сообщений по схемам </span><span lang=EN-US>TL</span><span
lang=RU> или </span><span lang=EN-US>TL</span><span lang=RU>-</span><span
lang=EN-US>B</span><span lang=RU> с 32-битными тегами конструктора, чтобы
разработчики других смарт-контрактов знали интерфейс, поддерживаемый конкретным
смарт-контрактом.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Сообщение всегда
сериализуется внутри блокчейна как последнее поле в ячейке. Таким образом,
программное обеспечение блокчейна может предположить, что любые биты и ссылки,
оставшиеся неразобранными после разбора полей </span><span lang=EN-US>Message</span><span
lang=RU>, предшествующего </span><span lang=EN-US>body</span><span lang=RU>,
принадлежат к полезной нагрузке </span><span lang=EN-US>body</span><span
lang=EN-US> </span><span lang=RU style='font-family:"Cambria",serif'>: </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>X</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, ничего не зная о сериализации типа </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>X</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>3.1.13. Сообщения с пустыми полезными
нагрузками. Полезная нагрузка сообщения может оказаться фрагментом пустой
ячейки, не имеющим битов данных и ссылок. По соглашению, такие сообщения
используются для простой передачи ценностей. Обычно ожидается, что принимающий
смарт-контракт будет обрабатывать такие сообщения тихо и успешно завершать
работу (с нулевым кодом выхода), хотя некоторые смарт-контракты могут выполнять
нетривиальные действия даже при получении сообщения с пустой полезной
нагрузкой. Например, смарт-контракт может проверить полученный баланс, и, если
его станет достаточно для ранее отложенного действия, запустить это действие. В
качестве альтернативы, смарт-контракт может захотеть запомнить в своем
постоянном хранилище полученную сумму и соответствующего отправителя, чтобы,
например, распределить некоторые токены позже каждому отправителю
пропорционально переведенным средствам.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:8.35pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Обратите внимание, что
даже если смарт-контракт не делает специальных положений для сообщений с пустой
полезной нагрузкой и выдает исключение при обработке таких сообщений,
полученное значение (за вычетом платы за газ) все равно будет добавлено к
балансу смарт-контракта.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>3.1.14. Адрес источника сообщения и время
логического создания определяют его генерирующий блок. Обратите внимание, что <i>исходный
адрес и время логического создания внутреннего или исходящего внешнего
сообщения однозначно определяют блок, в котором было создано сообщение.
Действительно, адрес источника определяет исходный шардчейн, а блокам этого
шардчейна присваиваются непересекающиеся логические временные интервалы,
поэтому только один из них может содержать указанное время логического
создания. Именно по этой причине в сообщениях не требуется явного упоминания о
генерирующем блоке.</i></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:5.1pt;margin-bottom:9.25pt;
margin-left:-.25pt'><span lang=RU>3.1.15. Сообщения в конвертах. <i>Конверты
сообщений </i>используются для прикрепления информации о маршрутизации, такой
как текущий (транзитный) адрес и адрес следующего прыжка, к входящим,
транзитным и исходящим сообщениям (см. 2.1.16). Само сообщение хранится в
отдельной ячейке и ссылается из конверта сообщения ссылкой на ячейку.</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>interm_addr_regular$0
use_src_bits:(#&lt;= 96)</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:30.75pt;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:12.3pt'><span
lang=EN-US>= IntermediateAddress; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:30.75pt;
margin-bottom:1.8pt;margin-left:.5pt;text-align:left'><span lang=EN-US>interm_addr_simple$10
workchain_id:int8 addr_pfx:(64 * Bit)</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:43.05pt;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:12.3pt'><span
lang=EN-US>= IntermediateAddress; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:43.05pt;
margin-bottom:1.8pt;margin-left:.5pt;text-align:left'><span lang=EN-US>interm_addr_ext$11
workchain_id:int32 addr_pfx:(64 * Bit)</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:141.45pt;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:12.3pt'><span
lang=EN-US>= IntermediateAddress; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:141.45pt;
margin-bottom:1.8pt;margin-left:.5pt;text-align:left'><span lang=EN-US>msg_envelope
cur_addr: IntermediateAddress</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>next_addr:
IntermediateAddress fwd_fee_remaining:Grams</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>msg</span><span
lang=RU>:^(</span><span lang=EN-US>Message</span><span lang=EN-US> </span><span
lang=EN-US>Any</span><span lang=RU>) = </span><span lang=EN-US>MsgEnvelope</span><span
lang=RU>;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:21.25pt;
margin-left:-.25pt'><span lang=RU>Тип </span><span lang=EN-US>IntermediateAddress</span><span
lang=RU> используется для описания промежуточных адресов сообщения, то есть его
текущего (или транзитного) адреса </span><span lang=EN-US>cur</span><span
lang=RU>_</span><span lang=EN-US>addr</span><span lang=RU> и адреса следующего
прыжка </span><span lang=EN-US>next</span><span lang=RU>_</span><span
lang=EN-US>addr</span><span lang=RU>. Первый конструктор </span><span
lang=EN-US>interm</span><span lang=RU>_</span><span lang=EN-US>addr</span><span
lang=RU>_</span><span lang=EN-US>regular</span><span lang=RU> представляет
промежуточный адрес с использованием оптимизации, описанной в 2.1.15, путем
сохранения количества первых битов промежуточного адреса, которые совпадают с
исходным адресом; два других явно хранят идентификатор рабочей цепочки и первые
64 бита адреса внутри этой рабочей цепи (остальные биты могут быть взяты из
исходного адреса). Поле </span><span lang=EN-US>fwd</span><span lang=RU>_</span><span
lang=EN-US>fee</span><span lang=RU>_</span><span lang=EN-US>remaining</span><span
lang=RU> используется для явного представления максимальной суммы платы за
пересылку сообщений, которая может быть вычтена из значения сообщения на
оставшихся этапах управления персоналом; он не может превышать значение </span><span
lang=EN-US>fwd</span><span lang=RU>_</span><span lang=EN-US>fee</span><span
lang=RU>, указанное в самом сообщении.</span></p>

</div>

<span lang=RU style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'><br clear=all style='page-break-before:always'>
</span>

<div class=WordSection13>

<h2 style='margin-top:0cm;margin-right:0cm;margin-bottom:5.6pt;margin-left:
35.2pt;text-indent:-36.0pt'><a name="_Toc150771"><span lang=EN-US>3.2<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>Дескрипторы входящих сообщений</span></a></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:12.25pt;
margin-left:-.25pt'><span lang=RU>В этом разделе обсуждается </span><i><span
lang=EN-US>InMsgDescr</span></i><i><span lang=RU>, структура, содержащая
описание всех входящих сообщений, импортированных в блок.</span></i><a
href="#_ftn25" name="_ftnref25" title=""><sup><span lang=EN-US><sup><span
lang=EN-US style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'>[25]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.25pt;margin-bottom:
10.65pt;margin-left:-.25pt'><span lang=RU>3.2.1. Типы и источники входящих
сообщений. Каждое входящее сообщение, упомянутое в </span><i><span lang=EN-US>InMsgDescr</span></i><span
lang=RU>, описывается значением типа </span><i><span lang=EN-US>InMsg</span></i><i><span
lang=EN-US> </span></i><span lang=RU>(«дескриптор входящего сообщения»), в
котором указывается источник сообщения, причина его импорта в этот блок и
некоторая информация о его «судьбе» — его обработка транзакцией или пересылка
внутри блока. </span><span lang=EN-US>Входящие сообщения можно классифицировать
следующим образом:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.25pt;margin-bottom:
10.65pt;margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU
style='line-height:104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Входящие внешние сообщения </span></i><span
lang=RU>— не нуждаются в дополнительной причине для импорта в блок, но должны
быть немедленно обработаны транзакцией в том же блоке.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.25pt;margin-bottom:
10.65pt;margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU
style='line-height:104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Внутренние сообщения ММСП с адресами назначения
в этом блоке </span></i><span lang=RU>— Причина их импорта в блок включает в
себя доказательство Меркла их генерации (т. е. их включение в </span><i><span
lang=EN-US>OutMsgDescr</span></i><i><span lang=EN-US> </span></i><span lang=RU>их
исходного блока). Такое сообщение должно быть немедленно доставлено в конечный
пункт назначения и обработано транзакцией.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.25pt;margin-bottom:
10.65pt;margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU
style='line-height:104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Внутренние сообщения с местами назначения в этом
блоке </span></i><span lang=RU>— Причиной их включения является их присутствие
в </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span lang=EN-US> </span></i><span
lang=RU>самого последнего состояния соседнего шардчейна </span><a href="#_ftn26"
name="_ftnref26" title=""><sup><span lang=EN-US><sup><span lang=EN-US
style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'>[26]</span></sup></span></sup></a><sup><span lang=EN-US> </span></sup><span
lang=RU>или их присутствие в </span><i><span lang=EN-US>OutMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>этого самого блока. Этот соседний шардчейн
полностью определяется транзитным адресом, указанным в конверте пересылаемого
сообщения, который также реплицируется в </span><i><span lang=EN-US>InMsg</span></i><span
lang=RU>. «Судьба» этого сообщения снова описывается ссылкой на транзакцию
обработки внутри текущего блока.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.25pt;margin-bottom:
10.65pt;margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU
style='line-height:104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Немедленно маршрутизируемые внутренние сообщения
</span></i><span lang=RU>— по существу подкласс предыдущего класса сообщений. В
этом случае импортированное сообщение является одним из исходящих сообщений,
сгенерированных в этом самом блоке.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.25pt;margin-bottom:
10.65pt;margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU
style='line-height:104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Транзитные внутренние сообщения </span></i><span
lang=RU>— имеют ту же причину включения, что и предыдущий класс сообщений.
Однако они не обрабатываются внутри блока, а внутренне перенаправляются в </span><i><span
lang=EN-US>OutMsgDescr</span></i><i><span lang=EN-US> </span></i><span lang=RU>и
</span><i><span lang=EN-US>OutMsgQueue</span></i><i><span lang=RU>. Этот факт,
наряду со ссылкой на новый конверт транзитного сообщения, должен быть зарегистрирован
в </span><span lang=EN-US>InMsg</span></i><i><span lang=RU>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.25pt;margin-bottom:
10.65pt;margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU
style='line-height:104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Отклоненные внутренние сообщения с местами
назначения в этом блоке </span></i><span lang=RU>— Внутреннее сообщение с
назначением в этом блоке может быть импортировано и немедленно отброшено вместо
обработки транзакцией, если оно уже было получено и обработано через ММСП в
предыдущем блоке этого шардчейна. В этом случае должна быть предоставлена
ссылка на предыдущую транзакцию обработки.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.25pt;margin-bottom:
10.65pt;margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU
style='line-height:104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Отклоненные транзитные внутренние сообщения </span></i><span
lang=RU>— Аналогичным образом, транзитное сообщение может быть отброшено сразу
после импорта, если оно уже было доставлено с помощью ММСП в конечный пункт
назначения. В этом случае требуется доказательство Меркла о его обработке в
конечном блоке (в виде сообщения ММСП).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.25pt;margin-bottom:
9.55pt;margin-left:-.25pt'><span lang=RU>3.2.2. Дескриптор входящего сообщения.
Каждое входящее сообщение описывается экземпляром типа </span><span lang=EN-US>InMsg</span><span
lang=RU>, который имеет шесть конструкторов, соответствующих случаям,
перечисленным выше в 3.2.1:</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>msg_import_ext$000
msg:^( Message Any) transaction:^ Transaction</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:86.6pt;text-align:left'><span lang=RU>= </span><span
lang=EN-US>InMsg</span><span lang=RU>;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>msg_import_ihr$010
msg:^(Message Any) transaction:^ Transaction</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left;text-indent:28.6pt'><span
lang=EN-US>ihr_fee:Grams proof_created:^Cell = InMsg;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:23.85pt;text-align:left;text-indent:-24.6pt'><span
lang=EN-US>msg_import_imm$011 in_msg:^MsgEnvelope </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:23.85pt;text-align:left;text-indent:4.5pt'><span
lang=EN-US>transaction:^ Transaction fwd_fee:Grams = InMsg;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:23.85pt;text-align:left;text-indent:-24.6pt'><span
lang=EN-US>msg_import_fin$100 in_msg:^MsgEnvelope </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:23.85pt;text-align:left;text-indent:4.5pt'><span
lang=EN-US>transaction:^ Transaction fwd_fee:Grams = InMsg;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:23.85pt;text-align:left;text-indent:-24.6pt'><span
lang=EN-US>msg_import_tr$101 in_msg:^MsgEnvelope out_msg:^MsgEnvelope
transit_fee:Grams = InMsg;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:23.85pt;text-align:left;text-indent:-24.6pt'><span
lang=EN-US>msg_discard_fin$110 in_msg:^MsgEnvelope transaction_id:uint64
fwd_fee:Grams = InMsg;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:23.85pt;text-align:left;text-indent:-24.6pt'><span
lang=EN-US>msg_discard_tr$111 in_msg:^MsgEnvelope transaction_id:uint64
fwd_fee:Grams proof_delivered:^Cell = InMsg;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.25pt;margin-bottom:
1.55pt;margin-left:-.25pt'><span lang=RU>Обратите внимание, что транзакция
обработки ссылается в первых четырех конструкторах непосредственно на ячейку,
ссылающуюся на Транзакцию, хотя для этой цели достаточно логического времени
транзакции </span><span lang=EN-US>transaction</span><span lang=RU>_</span><span
lang=EN-US>lt</span><span lang=RU>:</span><span lang=EN-US>uint</span><span
lang=RU>64. Внутренние условия согласованности гарантируют, что транзакция, о
которой идет речь, действительно принадлежит смарт-контракту назначения,
указанному в сообщении, и что входящее сообщение, обработанное этой
транзакцией, действительно описывается в данном <i>экземпляре </i></span><i><span
lang=EN-US>InMsg</span></i><i><span lang=RU>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.25pt;margin-bottom:
8.2pt;margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Кроме того,
обратите внимание, что </span><span lang=EN-US>msg</span><span lang=RU>_</span><span
lang=EN-US>import</span><span lang=RU>_</span><span lang=EN-US>imm</span><span
lang=RU> можно отличить от </span><span lang=EN-US>msg</span><span lang=RU>_</span><span
lang=EN-US>import</span><span lang=RU>_</span><span lang=EN-US>fin</span><span
lang=RU>, заметив, что это единственный случай, когда время логического
создания обрабатываемого сообщения больше или равно (минимальному) логическому
времени блока, импортирующего сообщение.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.25pt;margin-bottom:
10.65pt;margin-left:-.25pt'><span lang=RU>3.2.3. Взимание экспедиторских и
транзитных сборов с ввозимых сообщений. Структура </span><i><span lang=EN-US>InMsg</span></i><i><span
lang=EN-US> </span></i><span lang=RU>также используется для указания платы за
пересылку и транзит, взимаемую с входящих сообщений. Сама плата указывается в
полях </span><span lang=EN-US>ihr</span><span lang=RU>_</span><span lang=EN-US>fee</span><span
lang=RU>, </span><span lang=EN-US>fwd</span><span lang=RU>_</span><span
lang=EN-US>fee</span><span lang=RU> или </span><span lang=EN-US>transit</span><span
lang=RU>_</span><span lang=EN-US>fee</span><span lang=RU>; он отсутствует
только во входящих внешних сообщениях, которые используют другие механизмы для
вознаграждения валидаторов за их импорт. </span><span lang=EN-US>Сборы должны
удовлетворять следующим внутренним условиям согласованности:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:11.35pt;
margin-left:29.3pt;text-indent:-11.85pt;line-height:103%'><span lang=RU
style='line-height:103%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Для внешних сообщений (</span><span lang=EN-US>msg</span><span
lang=RU>_</span><span lang=EN-US>import</span><span lang=RU>_</span><span
lang=EN-US>ext</span><span lang=RU>) плата за пересылку не взимается.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Для импортированных ММСП внутренних сообщений (</span><span
lang=EN-US>msg</span><span lang=RU>_</span><span lang=EN-US>import</span><span
lang=RU>_</span><span lang=EN-US>ihr</span><span lang=RU>) плата равна </span><span
lang=EN-US>ihr</span><span lang=RU>_</span><span lang=EN-US>fee</span><span
lang=RU>, которая должна совпадать со значением </span><span lang=EN-US>ihr</span><span
lang=RU>_</span><span lang=EN-US>fee</span><span lang=RU>, указанным в самом
сообщении. Обратите внимание, что </span><span lang=EN-US>fwd</span><span
lang=RU>_</span><span lang=EN-US>fee</span><span lang=RU> или </span><span
lang=EN-US>fwd</span><span lang=RU>_</span><span lang=EN-US>fee</span><span
lang=RU>_</span><span lang=EN-US>remaining</span><span lang=RU> никогда не
собираются из сообщений, импортированных ММСП.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>За внутренние сообщения, доставленные в пункт
назначения (</span><span lang=EN-US>msg</span><span lang=RU>_</span><span
lang=EN-US>import</span><span lang=RU>_</span><span lang=EN-US>fin</span><span
lang=RU> и </span><span lang=EN-US>msg</span><span lang=RU>_</span><span
lang=EN-US>import</span><span lang=RU>_</span><span lang=EN-US>imm</span><span
lang=RU>), плата равна </span><span lang=EN-US>fwd</span><span lang=RU>_</span><span
lang=EN-US>fee</span><span lang=RU>_</span><span lang=EN-US>remaining</span><span
lang=EN-US> </span><span lang=EN-US>in</span><span lang=RU>_</span><span
lang=EN-US>msg</span><span lang=RU> входящих сообщений в оболочке. Обратите
внимание, что он не может превышать значение </span><span lang=EN-US>fwd</span><span
lang=RU>_</span><span lang=EN-US>fee</span><span lang=RU>, указанное в самом
сообщении.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Для транзитных сообщений (</span><span lang=EN-US>msg</span><span
lang=RU>_</span><span lang=EN-US>import</span><span lang=RU>_</span><span
lang=EN-US>tr</span><span lang=RU>) плата равна разнице между </span><span
lang=EN-US>fwd</span><span lang=RU>_</span><span lang=EN-US>fee</span><span
lang=RU>_</span><span lang=EN-US>remaining</span><span lang=RU> значениями,
указанными в конвертах </span><span lang=EN-US>in</span><span lang=RU>_</span><span
lang=EN-US>msg</span><span lang=RU> и </span><span lang=EN-US>out</span><span
lang=RU>_</span><span lang=EN-US>msg</span><span lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>За отклоненные сообщения плата также равна </span><span
lang=EN-US>fwd</span><span lang=RU>_</span><span lang=EN-US>fee</span><span
lang=RU>_</span><span lang=EN-US>remaining</span><span lang=RU>, указанной в </span><span
lang=EN-US>in</span><span lang=RU>_</span><span lang=EN-US>msg</span><span
lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.25pt;margin-bottom:
10.65pt;margin-left:-.25pt'><span lang=RU>3.2.4. Импортированное значение
входящего сообщения. Каждое импортированное сообщение импортирует в блок
некоторое значение — определенное количество одной или нескольких криптовалют.
Это импортированное значение вычисляется следующим образом:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Внешнее сообщение не импортирует значение.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Импортированное ММСП сообщение импортирует свою
стоимость плюс </span><span lang=EN-US>ihr</span><span lang=RU>_</span><span
lang=EN-US>fee</span><span lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Доставленное или транзитное внутреннее сообщение
импортирует свою стоимость плюс </span><span lang=EN-US>ihr</span><span
lang=RU>_</span><span lang=EN-US>fee</span><span lang=RU> плюс стоимость </span><span
lang=EN-US>fwd</span><span lang=RU>_</span><span lang=EN-US>fee</span><span
lang=RU>_</span><span lang=EN-US>remaining</span><span lang=RU> своего </span><span
lang=EN-US>in</span><span lang=RU>_</span><span lang=EN-US>msg</span><span
lang=RU> конверта.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.9pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Отброшенное сообщение импортирует </span><span
lang=EN-US>fwd</span><span lang=RU>_</span><span lang=EN-US>fee</span><span
lang=RU>_</span><span lang=EN-US>remaining</span><span lang=RU> своего </span><span
lang=EN-US>in</span><span lang=RU>_</span><span lang=EN-US>msg</span><span
lang=RU> конверта.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Обратите внимание, что сборы за пересылку и
транзит, взимаемые с импортированного сообщения, не превышают его
импортированную стоимость.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:1.15pt;
margin-left:-.25pt'><span lang=RU>3.2.5. Дополненные хэш-карты, или словари.
Прежде чем продолжить, давайте обсудим сериализацию дополненных хэш-карт, или
словарей.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.25pt;margin-bottom:
1.25pt;margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Дополненные
хэш-карты представляют собой структуры хранения ключ-значение с </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>-битными ключами и значениями некоторого
типа </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>X</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, аналогичные обычным хэш-картам,
описанным в [4, 3.3]. Однако каждый промежуточный узел дерева Патрисии, представляющий
дополненную хэш-карту</span></i><i><span lang=RU>, дополняется </span></i><span
lang=RU>значением типа </span><i><span lang=EN-US style='font-family:"Cambria",serif'>Y</span></i><span
lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.25pt;margin-bottom:
10.65pt;margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Эти значения
увеличения должны удовлетворять определенным <i>условиям агрегирования. Как
правило, </i></span><i><span lang=EN-US style='font-family:"Cambria",serif'>Y</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>является
целочисленным типом, и условием агрегирования является то, что значение
дополнения форка должно равняться сумме значений аугментации двух его дочерних
элементов. В общем, вместо <i>суммы используется функция оценки форка </i></span><i><span
lang=EN-US style='font-family:"Cambria",serif'>S</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>:  </span><i><span lang=EN-US style='font-family:"Cambria",serif'>Y</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>× </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>Y</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>→ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>Y</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>или </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>S</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>: </span><i><span lang=EN-US style='font-family:"Cambria",serif'>Y</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>→ </span><span lang=EN-US style='font-family:
"Cambria",serif'>Y</span><span lang=RU style='font-family:"Cambria",serif'> → </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>Y</span></i><span lang=RU>.
Значение увеличения листа обычно вычисляется из значения, хранящегося в этом
листе, с помощью функции <i>оценки листа </i></span><i><span lang=EN-US
style='font-family:"Cambria",serif'>L</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>: </span><i><span lang=EN-US style='font-family:"Cambria",serif'>X</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>→ </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>Y</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i><span lang=RU> Значение
увеличения листа может быть явно сохранено в листе вместе со значением; однако
в большинстве случаев в этом нет необходимости, поскольку функция оценки листа </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>L</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>очень проста.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.25pt;margin-bottom:
8.8pt;margin-left:-.25pt'><span lang=RU>3.2.6. Сериализация дополненных
хэш-карт. Сериализация дополненных хэш-карт с </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>n</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>-битными ключами, значениями типа </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>X</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> и значениями аугментации типа </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>Y</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>задается
следующей схемой </span><span lang=EN-US>TL</span><span lang=RU>-</span><span
lang=EN-US>B</span><span lang=RU>, которая является расширением схемы,
приведенной в [4, 3.3.3]:</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:45.2pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:-12.3pt'><span
lang=EN-US>ahm</span><span lang=RU>_</span><span lang=EN-US>edge</span><span
lang=RU>#_ {</span><span lang=EN-US>n</span><span lang=RU>:#} {</span><span
lang=EN-US>X</span><span lang=RU>:</span><span lang=EN-US>Type</span><span
lang=RU>} {</span><span lang=EN-US>Y</span><span lang=RU>:</span><span
lang=EN-US>Type</span><span lang=RU>} {</span><span lang=EN-US>l</span><span
lang=RU>:#} {</span><span lang=EN-US>m</span><span lang=RU>:#} </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:45.2pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:9.75pt'><span
lang=EN-US>label</span><span lang=RU>:(</span><span lang=EN-US>HmLabel</span><span
lang=RU> ~</span><span lang=EN-US>l</span><span lang=EN-US> </span><span
lang=EN-US>n</span><span lang=RU>) {</span><span lang=EN-US>n</span><span
lang=RU> = (~</span><span lang=EN-US>m</span><span lang=RU>) + </span><span
lang=EN-US>l</span><span lang=RU>} </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:45.2pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:9.75pt'><span
lang=EN-US>node:(HashmapAugNode m X Y) = HashmapAug n X Y;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>ahmn_leaf#_
{X:Type} {Y:Type} extra:Y value:X</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:12.3pt'><span
lang=RU>= </span><span lang=EN-US>HashmapAugNode</span><span lang=RU> 0 </span><span
lang=EN-US>X</span><span lang=EN-US> </span><span lang=EN-US>Y</span><span
lang=RU>; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:0cm'><span
lang=EN-US>ahmn_fork#_ {n:#} {X:Type} {Y:Type} </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:22.05pt'><span
lang=EN-US>left:^(HashmapAug n X Y) right:^(HashmapAug n X Y) extra:Y</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=RU>= </span><span
lang=EN-US>HashmapAugNode</span><span lang=RU> (</span><span lang=EN-US>n</span><span
lang=RU> + 1) </span><span lang=EN-US>X</span><span lang=EN-US> </span><span
lang=EN-US>Y</span><span lang=RU>;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>ahme_empty$0
{n:#} {X:Type} {Y:Type} extra:Y</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:26.75pt;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:61.5pt'><span
lang=RU>= </span><span lang=EN-US>HashmapAugE</span><span lang=EN-US> </span><span
lang=EN-US>n</span><span lang=EN-US> </span><span lang=EN-US>X</span><span
lang=EN-US> </span><span lang=EN-US>Y</span><span lang=RU>; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:26.75pt;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:0cm'><span
lang=EN-US>ahme_root$1 {n:#} {X:Type} {Y:Type} root:^(HashmapAug n X Y) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:26.75pt;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:14.95pt'><span
lang=EN-US>extra:Y = HashmapAugE n X Y;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.25pt;margin-bottom:
9.05pt;margin-left:-.25pt'><span lang=RU>3.2.7. Аугментация </span><i><span
lang=EN-US>InMsgDescr</span></i><i><span lang=RU>. Коллекция дескрипторов
входящих сообщений дополняется вектором из двух валютных значений,
представляющих импортированную стоимость и сборы за пересылку и транзит,
взимаемые с сообщения или коллекции сообщений:</span></i></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:-.6pt'><span
lang=EN-US>import_fees$_ fees_collected:Grams</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:13.55pt'><span
lang=EN-US>value_imported:CurrencyColection = ImportFees;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:13.55pt'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:7.25pt;margin-bottom:
9.3pt;margin-left:-.25pt'><span lang=RU>3.2.8. Структура </span><i><span
lang=EN-US>InMsgDescr</span></i><i><span lang=RU>. Теперь сам </span><span
lang=EN-US>InMsgDescr</span></i><i><span lang=EN-US> </span></i><span lang=RU>определяется
как дополненная хэш-карта, с 256-битными ключами (равными хэшам представления
импортированных сообщений), значениями типа </span><span lang=EN-US>InMsg</span><span
lang=RU> (ср. 3.2.2) и значениями дополнения типа </span><span lang=EN-US>ImportFees</span><span
lang=RU> (ср. 3.2.7):</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:10.6pt;margin-left:-.25pt;text-align:left;line-height:103%'><span
lang=RU>_ (</span><span lang=EN-US>HashmapAugE</span><span lang=RU> 256 </span><span
lang=EN-US>InMsg</span><span lang=EN-US> </span><span lang=EN-US>ImportFees</span><span
lang=RU>) = </span><span lang=EN-US>InMsgDescr</span><span lang=RU>;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Эта нотация </span><span lang=EN-US>TL</span><span
lang=RU>-</span><span lang=EN-US>B</span><span lang=RU> использует анонимный
конструктор _ для определения </span><span lang=EN-US>InMsgDescr</span><span
lang=RU> как синонима другого типа.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:21.2pt;
margin-left:-.25pt'><span lang=RU>3.2.9. Правила агрегации для </span><i><span
lang=EN-US>InMsgDescr</span></i><i><span lang=RU>. Функции оценки вилки и
оценки листа (см. 3.2.5) явно не включены в приведенную выше нотацию, поскольку
зависимые типы </span><span lang=EN-US>TL</span></i><i><span lang=RU>-</span><span
lang=EN-US>B</span></i><i><span lang=RU> недостаточно выразительны для этой
цели. Другими словами, функция оценки форка — это просто компонентное
добавление двух экземпляров </span><span lang=EN-US>ImportFees</span></i><i><span
lang=RU>, а функция конечной оценки определяется правилами, перечисленными в
разделах 3.2.3 и 3.2.4. Таким образом, корень дерева </span><span lang=EN-US>Patricia</span></i><i><span
lang=RU>, представляющий экземпляр </span><span lang=EN-US>InMsgDescr</span></i><i><span
lang=RU>, </span></i><span lang=RU>содержит экземпляр </span><i><span
lang=EN-US>ImportFees</span></i><i><span lang=EN-US> </span></i><span lang=RU>с
общим значением, импортированным всеми входящими сообщениями, и с общей платой
за пересылку, взимаемой с них.</span></p>

</div>

<span lang=RU style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'><br clear=all style='page-break-before:always'>
</span>

<div class=WordSection14>

<h2 style='margin-top:0cm;margin-right:0cm;margin-bottom:5.6pt;margin-left:
35.2pt;text-indent:-36.0pt'><a name="_Toc150772"><span lang=RU>3.3<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=RU>Очередь исходящих сообщений и дескрипторы</span></a></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>В этом разделе обсуждается </span><i><span
lang=EN-US>OutMsgDescr</span></i><i><span lang=RU>, структура, представляющая
все исходящие сообщения блока, а также их конверты и краткие описания причин их
включения в </span><span lang=EN-US>OutMsgDescr</span></i><i><span lang=RU>.
Эта структура также описывает все модификации </span><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=RU>, который является частью состояния </span><span lang=EN-US>shardchain</span></i><i><span
lang=RU>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>3.3.1. Типы исходящих сообщений. Исходящие
сообщения можно классифицировать следующим образом:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Внешние исходящие сообщения, или «сообщения в
никуда» — генерируются транзакцией внутри этого блока. Причиной включения
такого сообщения в </span><span lang=EN-US>OutMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>является просто ссылка на его генерирующую
транзакцию.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Немедленно обрабатываются внутренние исходящие
сообщения </span></i><span lang=RU>— генерируются и обрабатываются именно в
этом блоке, а не включаются в </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=RU>. Причиной включения такого сообщения является ссылка на его
генерирующую транзакцию, а его «судьба» описывается ссылкой на соответствующую
запись в </span><span lang=EN-US>InMsgDescr</span></i><i><span lang=RU>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.6pt;
margin-left:29.3pt;text-indent:-11.85pt;line-height:108%'><span lang=RU
style='line-height:108%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Обычные (внутренние) исходящие сообщения </span></i><span
lang=RU>— генерируются в этом блоке и включаются в </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=RU>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Транзитные (внутренние) исходящие сообщения </span></i><span
lang=RU>— импортируются в </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>того же блока и маршрутизируются через </span><span
lang=EN-US>HR</span><span lang=RU> до тех пор, пока не будет получен адрес
следующего прыжка за пределами текущего сегмента.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:1.15pt;
margin-left:-.25pt'><span lang=RU>3.3.2. Записи о списании сообщений. Помимо
вышеуказанных типов исходящих сообщений, </span><i><span lang=EN-US>OutMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>может содержать специальные «записи о
списании сообщений», которые указывают на то, что сообщение было удалено из </span><i><span
lang=EN-US>OutMsgQueue</span></i><i><span lang=EN-US> </span></i><span lang=RU>в
этом блоке. Причина этого удаления указана в записи об удалении сообщения; он
состоит из ссылки на удаляемое сообщение в оболочке и на логическое время
соседнего блока </span><span lang=EN-US>shardchain</span><span lang=RU>, в
котором это оболваненное сообщение находится в его </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=RU>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Обратите внимание, что в
некоторых случаях сообщение может быть импортировано из </span><i><span
lang=EN-US>OutMsgQueue</span></i><i><span lang=EN-US> </span></i><span lang=RU>текущей
цепочки сегментов, внутренне маршрутизировано, а затем снова включено в </span><i><span
lang=EN-US>OutMsgDescr</span></i><i><span lang=EN-US> </span></i><span lang=RU>и
</span><i><span lang=EN-US>OutMsgQueue</span></i><i><span lang=EN-US> </span></i><span
lang=RU>с другим конвертом. </span><a href="#_ftn27" name="_ftnref27" title=""><sup><span
lang=EN-US><sup><span lang=EN-US style='font-size:12.0pt;line-height:104%;
font-family:"Calibri",sans-serif;color:black'>[27]</span></sup></span></sup></a><sup><span
lang=EN-US> </span></sup><span lang=RU>В этом случае используется вариант
описания транзитного исходящего сообщения, который удваивается как запись
вывода сообщения из очереди.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.55pt;
margin-left:-.25pt'><span lang=RU>3.3.3. Дескриптор исходящего сообщения.
Каждое исходящее сообщение описывается экземпляром </span><i><span lang=EN-US>OutMsg</span></i><i><span
lang=RU>:</span></i></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:23.8pt;text-align:left;text-indent:-24.6pt'><span
lang=EN-US>msg_export_ext$000 msg:^(Message Any) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:23.8pt;text-align:left;text-indent:4.5pt'><span
lang=EN-US>transaction:^ Transaction = OutMsg;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:23.8pt;text-align:left;text-indent:-24.6pt'><span
lang=EN-US>msg_export_imm$010 out_msg:^MsgEnvelope </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:23.8pt;text-align:left;text-indent:4.5pt'><span
lang=EN-US>transaction:^Transaction reimport:^InMsg = OutMsg;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:23.8pt;text-align:left;text-indent:-24.6pt'><span
lang=EN-US>msg_export_new$001 out_msg:^MsgEnvelope </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:23.8pt;text-align:left;text-indent:4.5pt'><span
lang=EN-US>transaction:^ Transaction = OutMsg;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:56.85pt;
margin-bottom:1.8pt;margin-left:23.8pt;text-align:left;text-indent:-24.6pt'><span
lang=EN-US>msg_export_tr$011 out_msg:^MsgEnvelope </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:56.85pt;
margin-bottom:1.8pt;margin-left:23.8pt;text-align:left;text-indent:4.5pt'><span
lang=EN-US>imported:^InMsg = OutMsg;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:23.8pt;text-align:left;text-indent:-24.6pt'><span
lang=EN-US>msg_export_deq$110 out_msg:^MsgEnvelope </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:23.8pt;text-align:left;text-indent:4.5pt'><span
lang=EN-US>import_block_lt:uint64 = OutMsg;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:38.4pt;
margin-bottom:1.8pt;margin-left:23.8pt;text-align:left;text-indent:-24.6pt'><span
lang=EN-US>msg_export_tr_req$111 out_msg:^MsgEnvelope </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:38.4pt;
margin-bottom:1.8pt;margin-left:23.8pt;text-align:left;text-indent:4.5pt'><span
lang=EN-US>imported</span><span lang=RU>:^</span><span lang=EN-US>InMsg</span><span
lang=RU> = </span><span lang=EN-US>OutMsg</span><span lang=RU>;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Последние два описания приводят к удалению
(снятию) сообщения из </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=EN-US> </span></i><span lang=RU>вместо его вставки. Последний повторно
вставляет сообщение в </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=EN-US> </span></i><span lang=RU>с новым конвертом после выполнения внутренней
маршрутизации (см. 2.1.11).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>3.3.4. Экспортированное значение исходящего
сообщения. Каждое исходящее сообщение, описанное </span><i><span lang=EN-US>OutMsg</span></i><i><span
lang=RU>,</span></i><span lang=RU> экспортирует некоторую ценность —
определенное количество одной или нескольких криптовалют — из блока. Это
экспортированное значение вычисляется следующим образом:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Внешнее исходящее сообщение не экспортирует
значения.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Внутреннее сообщение, генерируемое в этом блоке,
экспортирует свою стоимость плюс </span><span lang=EN-US>ihr</span><span
lang=RU>_</span><span lang=EN-US>fee</span><span lang=RU> плюс </span><span
lang=EN-US>fwd</span><span lang=RU>_</span><span lang=EN-US>fee</span><span
lang=RU>. Обратите внимание, что </span><span lang=EN-US>fwd</span><span
lang=RU>_</span><span lang=EN-US>fee</span><span lang=RU> должен быть равен </span><span
lang=EN-US>fwd</span><span lang=RU>_</span><span lang=EN-US>fee</span><span
lang=RU>_</span><span lang=EN-US>remaining</span><span lang=RU>, указанному в </span><span
lang=EN-US>out</span><span lang=RU>_</span><span lang=EN-US>msg</span><span
lang=RU> конверте.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Транзитное сообщение экспортирует свою стоимость
плюс </span><span lang=EN-US>ihr</span><span lang=RU>_</span><span lang=EN-US>fee</span><span
lang=RU> плюс стоимость </span><span lang=EN-US>fwd</span><span lang=RU>_</span><span
lang=EN-US>fee</span><span lang=RU>_</span><span lang=EN-US>remaining</span><span
lang=RU> своего </span><span lang=EN-US>out</span><span lang=RU>_</span><span
lang=EN-US>msg</span><span lang=RU> конверта.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>То же самое относится и к </span><span lang=EN-US>msg</span><span
lang=RU>_</span><span lang=EN-US>export</span><span lang=RU>_</span><span
lang=EN-US>tr</span><span lang=RU>_</span><span lang=EN-US>req</span><span
lang=RU>, конструктору </span><i><span lang=EN-US>OutMsg</span></i><i><span
lang=RU>, </span></i><span lang=RU>используемому для повторно вставленных
сообщений, освобожденных от очереди.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Запись о выселении сообщения (</span><span
lang=EN-US>msg</span><span lang=RU>_</span><span lang=EN-US>export</span><span
lang=RU>_</span><span lang=EN-US>deq</span><span lang=RU>; см. 3.3.2) не
экспортирует ценность.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.55pt;
margin-left:-.25pt'><span lang=RU>3.3.5. Структура </span><i><span lang=EN-US>OutMsgDescr</span></i><i><span
lang=RU>. Сам </span><span lang=EN-US>OutMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>представляет собой просто дополненную
хэш-карту (ср. 3.2.5), с 256-битными ключами (равными хэшу представления
сообщения), значениями типа </span><i><span lang=EN-US>OutMsg</span></i><i><span
lang=RU> и значениями дополнения типа </span><span lang=EN-US>CurrencyCollection</span></i><i><span
lang=RU>:</span></i></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:10.7pt;margin-left:-.25pt;text-align:left;line-height:103%'><span
lang=RU>_ (</span><span lang=EN-US>HashmapAugE</span><span lang=RU> 256 </span><span
lang=EN-US>OutMsg</span><span lang=EN-US> </span><span lang=EN-US>CurrencyCollection</span><span
lang=RU>) = </span><span lang=EN-US>OutMsgDescr</span><span lang=RU>;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:1.25pt;
margin-left:-.25pt'><span lang=RU>Увеличение представляет собой <i>экспортируемую
стоимость </i>соответствующего сообщения, агрегированную с помощью суммы и
рассчитанную на листьях, как описано в разделе 3.3.4. Таким образом, общая
экспортируемая стоимость отображается рядом с корнем дерева Патрисии,
представляющего </span><i><span lang=EN-US>OutMsgDescr</span></i><i><span
lang=RU>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Наиболее важным условием
согласованности для </span><i><span lang=EN-US>OutMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>является то, что его запись с ключом </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>должна быть </span><i><span
lang=EN-US>OutMsg</span></i><i><span lang=RU>,</span></i><span lang=RU>
описывающей сообщение </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>с
хэшем представления </span><span lang=EN-US>Hash<sup>b</sup></span><span
lang=RU>(</span><span lang=EN-US>m</span><span lang=RU>) = </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.85pt;
margin-left:-.25pt'><span lang=RU>3.3.6. Структура </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=RU>. Напомним (ср. 1.2.7), что </span><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=EN-US> </span></i><span lang=RU>является частью состояния блокчейна, а не
блока. Поэтому блок содержит только хэш-ссылки на начальное и конечное
состояние, а также вновь созданные ячейки.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.55pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Структура </span><i><span
lang=EN-US>OutMsgQueue</span></i><i><span lang=EN-US> </span></i><span lang=RU>проста:
это просто дополненная хэш-карта с 352-битными ключами и значениями типа </span><i><span
lang=EN-US>OutMsg</span></i><i><span lang=RU>:</span></i></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:10.7pt;margin-left:-.25pt;text-align:left;line-height:103%'><span
lang=RU>_ (</span><span lang=EN-US>HashmapAugE</span><span lang=RU> 352 </span><span
lang=EN-US>OutMsg</span><span lang=EN-US> </span><span lang=EN-US>uint</span><span
lang=RU>64) = </span><span lang=EN-US>OutMsgQueue</span><span lang=RU>;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Ключом, используемым для исходящего сообщения
</span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><span
lang=RU>, является объединение его 32-разрядного </span><span lang=EN-US>workchain</span><span
lang=RU>_</span><span lang=EN-US>id</span><span lang=RU> следующего прыжка<i>,
первых 64 бит адреса следующего прыжка внутри этой рабочей цепочки и хэша
представления </i></span><i><span lang=EN-US>Hash</span></i><i><span lang=RU>[(</span><span
lang=EN-US>m</span></i><i><span lang=RU>) самого </span></i><span lang=RU>сообщения
</span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><span
lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.85pt;
margin-left:-.25pt'><span lang=RU>Аугментация происходит по логическому времени
создания </span><span lang=EN-US>Lt</span><span lang=RU>(</span><span
lang=EN-US>m</span><span lang=RU>) сообщения </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>на листьях и по
минимуму значений аугментации детей на развилках.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Наиболее важным условием
согласованности для </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=EN-US> </span></i><span lang=RU>является то, что значение в ключе </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>действительно
должно содержать сообщение в оболочке с ожидаемым адресом следующего прыжка и
хэшем представления.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>3.3.7. Условия согласованности для </span><i><span
lang=EN-US>OutMsg</span></i><i><span lang=RU>. Несколько внутренних условий
согласованности накладываются на экземпляры </span><span lang=EN-US>OutMsg</span></i><i><span
lang=RU>,</span></i><span lang=RU> присутствующие в </span><i><span lang=EN-US>OutMsgDescr</span></i><i><span
lang=RU>. К ним относятся следующие:</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Каждый из первых трех конструкторов описаний
исходящих сообщений содержит ссылку на генерирующую транзакцию. Эта транзакция
должна принадлежать исходной учетной записи сообщения, она должна содержать
ссылку на указанное сообщение в качестве одного из исходящих сообщений и должна
быть восстановлена путем поиска ее по </span><span lang=EN-US>account</span><span
lang=RU>_</span><span lang=EN-US>id</span><span lang=RU> и </span><span
lang=EN-US>transaction</span><span lang=RU>_</span><span lang=EN-US>id</span><span
lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=EN-US>msg</span><span lang=RU>_</span><span
lang=EN-US>export</span><span lang=RU>_</span><span lang=EN-US>tr</span><span
lang=RU> и </span><span lang=EN-US>msg</span><span lang=RU>_</span><span
lang=EN-US>export</span><span lang=RU>_</span><span lang=EN-US>tr</span><span
lang=RU>_</span><span lang=EN-US>req</span><span lang=RU> должны ссылаться на <i>экземпляр
</i></span><i><span lang=EN-US>InMsg</span></i><span lang=RU>, описывающий одно
и то же сообщение (в другом исходном конверте).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Если используется один из первых четырех
конструкторов, сообщение должно отсутствовать в начальном </span><i><span
lang=EN-US>OutMsgQueue</span></i><i><span lang=EN-US> </span></i><span lang=RU>блока;
в противном случае оно должно присутствовать.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Если используется </span><span lang=EN-US>msg</span><span
lang=RU>_</span><span lang=EN-US>export</span><span lang=RU>_</span><span
lang=EN-US>deq</span><span lang=RU>, сообщение должно отсутствовать в
окончательном </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=EN-US> </span></i><span lang=RU>блока; в противном случае оно должно присутствовать.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Если сообщение не упоминается в </span><i><span
lang=EN-US>OutMsgDescr</span></i><i><span lang=RU>, оно должно совпадать в
начальном и конечном </span><span lang=EN-US>OutMsgQueues</span></i><i><span
lang=RU> блока.</span></i></p>

</div>

<span lang=RU style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'><br clear=all style='page-break-before:always'>
</span>

<div class=WordSection15>

<h1 style='margin-top:0cm;margin-right:0cm;margin-bottom:5.95pt;margin-left:
27.1pt;text-indent:-18.0pt'><a name="_Toc150773"><span lang=EN-US>4<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span
lang=EN-US>Счета и операции</span></a></h1>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.3pt;margin-bottom:21.25pt;
margin-left:-.25pt'><span lang=RU>В этой главе обсуждается расположение учетных
записей (или <i>смарт-контрактов) и их состояние </i>в блокчейне </span><span
lang=EN-US>TON</span><span lang=RU>. Он также рассматривает <i>транзакции,
которые являются единственным способом изменения состояния учетной записи, а
также обработки входящих сообщений и создания новых исходящих сообщений.</i></span></p>

<h2 style='margin-top:0cm;margin-right:0cm;margin-bottom:5.6pt;margin-left:
35.2pt;text-indent:-36.0pt'><a name="_Toc150774"><span lang=EN-US>4.1<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>Счета и их состояния</span></a></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.25pt;margin-bottom:
.8pt;margin-left:-.25pt'><span lang=RU>Напомним, что <i>смарт-контракт </i>и
учетная <i>запись </i>— это одно и то же в контексте блокчейна </span><span
lang=EN-US>TON</span><span lang=RU>, и что эти термины могут использоваться
взаимозаменяемо, по крайней мере, до тех пор, пока рассматриваются только
небольшие (или «обычные») смарт-контракты. Большой смарт-контракт может
использовать несколько учетных записей, лежащих в разных цепочках одной и той
же рабочей цепи для целей балансировки нагрузки.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.25pt;margin-bottom:
10.65pt;margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Учетная запись
идентифицируется по ее полному адресу и <i>полностью описывается </i>ее
состоянием. Другими словами, в аккаунте нет ничего другого, кроме его адреса и
состояния.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.25pt;margin-bottom:
9.6pt;margin-left:-.25pt'><span lang=RU>4.1.1. Адреса учетных записей. Как
правило, учетная запись полностью идентифицируется по ее <i>полному адресу,
состоящему из 32-разрядной </i></span><i><span lang=EN-US>workchain</span></i><i><span
lang=RU>_</span><span lang=EN-US>id</span></i><i><span lang=RU>, и (обычно
256-битного) внутреннего адреса </span></i><span lang=RU>или <i>идентификатора
учетной записи, </i></span><i><span lang=EN-US>account</span></i><i><span
lang=RU>_</span><span lang=EN-US>id</span></i><i><span lang=EN-US> </span></i><span
lang=RU>внутри выбранной рабочей цепочки. В базовой рабочей цепочке (</span><span
lang=EN-US>workchain</span><span lang=RU>_</span><span lang=EN-US>id</span><span
lang=EN-US> </span><span lang=RU style='font-family:"Cambria",serif'>= 0) и в
мастерчейне (</span><span lang=EN-US style='font-family:"Cambria",serif'>workchain</span><span
lang=RU style='font-family:"Cambria",serif'>_</span><span lang=EN-US
style='font-family:"Cambria",serif'>id</span><span lang=RU style='font-family:
"Cambria",serif'> = −1) внутренний адрес всегда 256-битный. В этих рабочих
цепочках </span><a href="#_ftn28" name="_ftnref28" title=""><sup><span
lang=EN-US><sup><span lang=EN-US style='font-size:12.0pt;line-height:104%;
font-family:"Calibri",sans-serif;color:black'>[28]</span></sup></span></sup></a><sup><span
lang=EN-US> </span></sup><i><span lang=EN-US>account</span></i><i><span
lang=RU>_</span><span lang=EN-US>id</span></i><i><span lang=EN-US> </span></i><span
lang=RU>не может быть выбран произвольно, но должен быть равен хэшу исходного
кода и данных смарт-контракта; в противном случае будет невозможно
инициализировать счет предполагаемым кодом и данными (см. 1.7.3), а также
что-либо сделать с накопленными средствами на балансе счета.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.25pt;margin-bottom:
10.65pt;margin-left:-.25pt'><span lang=RU>4.1.2. Нулевой счет. По соглашению, <i>нулевой
счет </i>или <i>счет с нулевым адресом </i>накапливает сборы за обработку,
пересылку и транзит, а также любые другие платежи, собираемые валидаторами
мастерчейна или рабочей цепи. Кроме того, нулевой счет является «большим смарт-контрактом»,
что означает, что каждый шардчейн имеет свой экземпляр нулевой учетной записи,
причем наиболее значимые биты адреса скорректированы, чтобы лежать в сегменте.
Любые средства, переведенные на нулевой счет, намеренно или случайно, фактически
являются подарком для валидаторов. Например, смарт-контракт может уничтожить
себя, отправив все свои средства на нулевой счет.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.25pt;margin-bottom:
.7pt;margin-left:-.25pt'><span lang=RU>4.1.3. Малые и большие смарт-контракты.
По умолчанию смарт-контракты являются «маленькими», что означает, что у них
есть один адрес учетной записи, принадлежащий ровно одному шардчейну в любой
момент времени. Тем не менее, можно создать «большой смарт-контракт с глубиной
разделения </span><i><span lang=EN-US style='font-family:"Cambria",serif'>d</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>», что означает, что </span></i><span
lang=RU style='font-family:"Cambria",serif'> </span><span lang=RU>может быть
создано до 2</span><span lang=EN-US>D</span><span lang=RU>-экземпляров
смарт-контракта, причем первые </span><span lang=EN-US>d</span><span lang=RU>
биты исходного адреса смарт-контракта заменяются произвольными битовыми
последовательностями.</span><a href="#_ftn29" name="_ftnref29" title=""><sup><span
lang=EN-US><sup><span lang=EN-US style='font-size:12.0pt;line-height:104%;
font-family:"Calibri",sans-serif;color:black'>[29]</span></sup></span></sup></a><sup><span
lang=EN-US> </span></sup><span lang=RU>На такие смарт-контракты можно
отправлять сообщения, используя внутренние адреса </span><span lang=EN-US>anycast</span><span
lang=RU> с любой трансляцией, установленной в </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>d</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>(см. 3.1.2).
Кроме того, экземплярам большого смарт-контракта разрешено использовать этот
адрес </span><span lang=EN-US>anycast</span><span lang=RU> в качестве исходного
адреса своих сгенерированных сообщений.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Экземпляром большого
смарт-контракта является счет с ненулевой <i>максимальной глубиной расщепления </i></span><i><span
lang=EN-US style='font-family:"Cambria",serif'>d</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:10.4pt;
margin-left:-.25pt;line-height:110%'><span lang=RU>4.1.4. Три вида счетов.
Существует три типа учетных записей:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Неинициализированный </span></i><span lang=RU>—
счет имеет только баланс; его код и данные еще не инициализированы.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:11.35pt;
margin-left:29.3pt;text-indent:-11.85pt;line-height:103%'><span lang=RU
style='line-height:103%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Активный </span></i><span lang=RU>— код и данные
учетной записи также были инициализированы.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Заморожено </span></i><span lang=RU>— код и
данные учетной записи были заменены хэшем, но баланс по-прежнему хранится явно.
Остаток на замороженном счете может фактически стать отрицательным, отражая
причитающиеся платежи за хранение.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.25pt;margin-bottom:
9.35pt;margin-left:-.25pt'><span lang=RU>4.1.5. Профиль хранения учетной
записи. Профиль <i>хранения </i>учетной записи — это структура данных, описывающая
объем постоянного хранилища состояния блокчейна, используемого этой учетной
записью. Он описывает общее количество используемых ячеек, битов данных, а
также внутренних и внешних ссылок на ячейки.</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:-.6pt'><span
lang=EN-US>storage_used$_ cells:(VarUInteger 7) bits:(VarUInteger 7)</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:13.55pt'><span
lang=EN-US>ext_refs:(VarUInteger 7) int_refs:(VarUInteger 7) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:13.55pt'><span
lang=EN-US>public</span><span lang=RU>_</span><span lang=EN-US>cells</span><span
lang=RU>:(</span><span lang=EN-US>VarUInteger</span><span lang=RU> 7) = </span><span
lang=EN-US>StorageUsed</span><span lang=RU>;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.25pt;margin-bottom:
9.2pt;margin-left:-.25pt'><span lang=RU>Тот же тип </span><span lang=EN-US>StorageUsed</span><span
lang=RU> может представлять профиль хранения сообщения, как это требуется,
например, для вычисления </span><span lang=EN-US>fwd</span><span lang=RU>_</span><span
lang=EN-US>fee</span><span lang=RU>, общей платы за пересылку для маршрутизации
</span><span lang=EN-US>Hypercube</span><span lang=RU>. Профиль хранения
учетной записи имеет несколько дополнительных полей, указывающих на последний
раз, когда взималась плата за хранение:</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:85.35pt;text-align:left;text-indent:-86.1pt'><span
lang=EN-US>storage_info$_ used:StorageUsed last_paid:uint32 </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:85.35pt;text-align:left;text-indent:-7.35pt'><span
lang=EN-US>due_payment:(Maybe Grams) = StorageInfo;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.25pt;margin-bottom:
10.65pt;margin-left:-.25pt'><span lang=RU>Поле </span><span lang=EN-US>last</span><span
lang=RU>_</span><span lang=EN-US>paid</span><span lang=RU> содержит либо </span><span
lang=EN-US>unixtime</span><span lang=RU> последнего собранного платежа за
хранилище (обычно это </span><span lang=EN-US>unixtime</span><span lang=RU>
самой последней транзакции), либо </span><span lang=EN-US>unixtime</span><span
lang=RU>, когда была создана учетная запись (опять же, транзакцией). Поле </span><span
lang=EN-US>due</span><span lang=RU>_</span><span lang=EN-US>payment</span><span
lang=RU>, если оно присутствует, аккумулирует платежи за хранение, которые не
могли быть взысканы с баланса счета, представленные строго положительным
количеством нанограммов; он может присутствовать только для
неинициализированных или замороженных счетов, которые имеют баланс ноль граммов
(но могут иметь ненулевые балансы в других криптовалютах). Когда </span><span
lang=EN-US>due</span><span lang=RU>_</span><span lang=EN-US>payment</span><span
lang=RU> становится больше значения настраиваемого параметра блокчейна, аккаунт
полностью уничтожается, а его баланс, если таковой имеется, переводится на
нулевой счет.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>4.1.6. Описание учетной записи. Состояние
учетной записи представлено экземпляром типа </span><i><span lang=EN-US>Account</span></i><i><span
lang=RU>, описанным следующей схемой </span><span lang=EN-US>TL</span></i><i><span
lang=RU>-</span><span lang=EN-US>B</span></i><i><span lang=RU>:</span></i><a
href="#_ftn30" name="_ftnref30" title=""><sup><span lang=EN-US><sup><span
lang=EN-US style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'>[30]</span></sup></span></sup></a></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:66.85pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>account_none$0
= Account; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:66.85pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>account$1
addr:MsgAddressInt storage_stat:StorageInfo</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:66.85pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left;text-indent:56.95pt'><span
lang=EN-US>storage:AccountStorage = Account;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:66.85pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left;text-indent:56.95pt'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:23.85pt;text-align:left;text-indent:-24.6pt'><span
lang=EN-US>account_storage$_ last_trans_lt:uint64 </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:23.85pt;text-align:left;text-indent:-2.55pt'><span
lang=EN-US>balance:CurrencyCollection state:AccountState</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US> = AccountStorage;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:73.0pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>account_uninit$00
= AccountState; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:73.0pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>account_active$1
_:StateInit = AccountState; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:73.0pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>account_frozen$01
state_hash:uint256 = AccountState;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:54.55pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:54.55pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>acc_state_uninit$00
= AccountStatus; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:54.55pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>acc_state_frozen$01
= AccountStatus; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:54.55pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>acc_state_active$10
= AccountStatus; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:54.55pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>acc_state_nonexist$11
= AccountStatus; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:54.55pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:54.55pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>tick_tock$_
tick:Bool tock:Bool = TickTock;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:54.55pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:66.85pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:-12.3pt'><span
lang=EN-US>_ split_depth:(Maybe (## 5)) special:(Maybe TickTock) code:(Maybe
^Cell) data:(Maybe ^Cell) library:(Maybe ^Cell) library:(Maybe ^Cell) =
StateInit;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:66.85pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:-12.3pt'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.8pt;
margin-left:-.25pt'><span lang=RU>Обратите внимание, что </span><span
lang=EN-US>account</span><span lang=RU>_</span><span lang=EN-US>frozen</span><span
lang=RU> содержит хэш представления экземпляра </span><i><span lang=EN-US>StateInit</span></i><i><span
lang=RU>, а не самого этого экземпляра, который в противном случае содержался
бы в </span><span lang=EN-US>account</span></i><i><span lang=RU>_</span><span
lang=EN-US>active</span></i><i><span lang=RU>; </span><span lang=EN-US>account</span></i><i><span
lang=RU>_</span><span lang=EN-US>uninit</span></i><i><span lang=RU> похож на </span><span
lang=EN-US>account</span></i><i><span lang=RU>_</span><span lang=EN-US>frozen</span></i><i><span
lang=RU>, но не содержит явного </span><span lang=EN-US>state</span></i><i><span
lang=RU>_</span><span lang=EN-US>hash</span></i><i><span lang=RU>, поскольку
предполагается, что он равен внутреннему адресу учетной записи (</span><span
lang=EN-US>account</span></i><i><span lang=RU>_</span><span lang=EN-US>id</span></i><i><span
lang=RU>), уже присутствует в поле </span><span lang=EN-US>addr</span></i><i><span
lang=RU>. Поле </span><span lang=EN-US>split</span></i><i><span lang=RU>_</span><span
lang=EN-US>depth</span></i><i><span lang=RU> присутствует и ненулевое только в
случаях крупных смарт-контрактов. Специальное поле может присутствовать только
в мастерчейне — и внутри мастерчейна, только в некоторых фундаментальных
смарт-контрактах, необходимых </span></i><span lang=RU>для функционирования
всей системы.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.25pt;margin-bottom:
1.35pt;margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Статистика
хранилища, хранящаяся в </span><span lang=EN-US>storage</span><span lang=RU>_</span><span
lang=EN-US>stat</span><span lang=RU> отражает общее использование хранилища
среза ячейки. В частности, биты и ячейки, используемые для хранения баланса,
также отражаются в </span><span lang=EN-US>storage</span><span lang=RU>_</span><span
lang=EN-US>stat</span><span lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.3pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Когда необходимо
представить несуществующую учетную запись, используется конструктор </span><span
lang=EN-US>account</span><span lang=RU>_</span><span lang=EN-US>none</span><span
lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.3pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>4.1.7. Состояние учетной записи как сообщение
от учетной записи к ее будущему я. Обратите внимание, что состояние учетной
записи очень похоже на сообщение, отправленное со счета его будущему участию в
следующей транзакции, по следующим причинам:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.25pt;margin-bottom:
10.65pt;margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU
style='line-height:104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Состояние счета не меняется между двумя
последовательными транзакциями одного и того же счета, поэтому оно полностью
похоже в этом отношении на сообщение, отправленное с более ранней транзакции на
более позднюю.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.25pt;margin-bottom:
10.65pt;margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU
style='line-height:104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Когда транзакция обрабатывается, ее входными
данными являются входящее сообщение и предыдущее состояние учетной записи; его
выходными данными являются генерируемые исходящие сообщения и состояние
следующей учетной записи. Если рассматривать состояние как особый вид
сообщения, то мы увидим, что каждая транзакция имеет ровно два входа (состояние
учетной записи и входящее сообщение) и по крайней мере один выход.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.25pt;margin-bottom:
10.65pt;margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU
style='line-height:104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Как сообщение, так и состояние учетной записи могут
содержать код и данные в экземпляре </span><i><span lang=EN-US>StateInit</span></i><i><span
lang=RU>, а также некоторое значение в их балансе.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.25pt;margin-bottom:
10.65pt;margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU
style='line-height:104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Учетная запись инициализируется сообщением <i>конструктора,
которое по существу несет будущее состояние и баланс счета.</i></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.25pt;margin-bottom:
10.65pt;margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU
style='line-height:104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>В некоторых случаях сообщения преобразуются в
состояния учета, и наоборот. Например, когда происходит событие слияния </span><span
lang=EN-US>shardchain</span><span lang=RU>, и необходимо объединить две учетные
записи, которые являются экземплярами одного и того же большого контракта, одна
из них преобразуется в сообщение, отправленное другому (см. 4.2.11).
Аналогично, когда происходит событие разделения </span><span lang=EN-US>shardchain</span><span
lang=RU>, и экземпляр большого смарт-контракта должен быть разделен на две
части, это достигается специальной транзакцией, которая создает новый экземпляр
с помощью сообщения конструктора, отправленного из ранее существующего
экземпляра в новый (см. 4.2.10).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.25pt;margin-bottom:
10.65pt;margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU
style='line-height:104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Можно сказать, что сообщение связано с передачей
некоторой информации <i>через пространство </i>(между различными шардчейнами
или, по крайней мере, связками счетов), в то время как состояние учетной записи
передает информацию <i>во времени </i>(из прошлого в будущее одной и той же
учетной записи).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>4.1.8. Различия между сообщениями и
состояниями аккаунта. Конечно, есть и важные отличия. </span><span lang=EN-US>Например:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.25pt;margin-bottom:
10.65pt;margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU
style='line-height:104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Состояние аккаунта передается только «во времени»
(для блока шардчейна его преемнику), но никогда «в пространстве» (от одного
шардчейна к другому). Как следствие, эта передача осуществляется неявно, без
создания полных копий состояния учетной записи в любом месте блокчейна.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.25pt;margin-bottom:
10.65pt;margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU
style='line-height:104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Платежи за хранилище, собираемые валидаторами для
поддержания состояния учетной записи, обычно значительно меньше, чем плата за
пересылку сообщений для того же объема данных.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.25pt;margin-bottom:
10.65pt;margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU
style='line-height:104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Когда входящее сообщение доставляется в учетную
запись, вызывается код из учетной записи, а не код из сообщения.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:8.75pt;
margin-left:-.25pt;line-height:110%'><span lang=RU>4.1.9. Совокупное состояние
всех счетов в сегменте. Разделенная часть состояния шардчейна (см. 1.2.1 и
1.2.2) задается формулой</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>_ (</span><span lang=EN-US>HashmapAugE</span><span
lang=RU> 256 </span><span lang=EN-US>Account</span><span lang=EN-US> </span><span
lang=EN-US>CurrencyCollection</span><span lang=RU>) = </span><span lang=EN-US>ShardAccounts</span><span
lang=RU>; </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>Это просто словарь с 256-битными </span><i><span
lang=EN-US>account</span></i><i><span lang=RU>_</span><span lang=EN-US>ids</span></i><i><span
lang=RU> в качестве ключей и соответствующими состояниями счета в виде
значений, увеличенных суммой остатков на счетах. Таким образом, вычисляется
сумма остатков всех счетов в шардчейне, так что можно легко проверить общее
количество криптовалюты, «хранящейся» в осколке.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.3pt;margin-bottom:8.4pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Внутренние условия
согласованности гарантируют, что адрес учетной записи, на которую ссылается
ключ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>в </span><i><span
lang=EN-US>SmartAccounts</span></i><i><span lang=RU>,</span></i><span lang=RU>
действительно равен </span><i><span lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>. Дополнительное условие внутренней
согласованности требует, чтобы все клавиши </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>k</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>начинались с
префикса сегмента </span><i><span lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.25pt;margin-bottom:
0cm;margin-left:-.25pt'><span lang=RU>4.1.10. Описание владельца аккаунта и
интерфейса. Можно включить некоторую дополнительную информацию в контролируемый
счет. Например, отдельный пользователь или компания могут захотеть добавить
текстовое поле описания в свою учетную запись кошелька с именем или адресом
пользователя или компании (или их хэшем, если информация не должна быть
общедоступной). В качестве альтернативы, смарт-контракт может предлагать
машиночитаемое или читаемое человеком описание поддерживаемых им методов и их
предполагаемого применения, которое может использоваться продвинутыми
приложениями кошелька для создания раскрывающихся меню и форм, помогающих
пользователю-человеку создавать действительные сообщения для отправки на этот
смарт-контракт.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.25pt;margin-bottom:
.85pt;margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Одним из способов
включения такой информации является резервирование, скажем, второй ссылки в
ячейке данных состояния счета для словаря с 64-битными ключами
(соответствующими некоторым идентификаторам стандартных типов дополнительных
данных, которые можно было бы захотеть сохранить) и соответствующими
значениями. Тогда исследователь блокчейна сможет извлечь требуемое значение
вместе с доказательством Меркла, если это необходимо.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.05pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Лучший способ сделать это
– определить некоторые <i>методы получения </i>в смарт-контракте.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.25pt;margin-bottom:
0cm;margin-left:-.25pt'><span lang=RU>4.1.11. Получение методов
смарт-контракта. <i>Методы </i></span><i><span lang=EN-US>Get</span></i><i><span
lang=EN-US> </span></i><span lang=RU>выполняются автономным экземпляром </span><span
lang=EN-US>TVM</span><span lang=RU> с кодом учетной записи и загруженными в нее
данными. Требуемые параметры передаются в стек (скажем, магическое число,
указывающее на извлекаемое поле или конкретный метод </span><span lang=EN-US>get</span><span
lang=RU>, который необходимо вызвать), а результаты также возвращаются в стек </span><span
lang=EN-US>TVM</span><span lang=RU> (скажем, фрагмент ячейки, содержащий
сериализацию строки с именем владельца учетной записи).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.25pt;margin-bottom:
0cm;margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>В качестве бонуса
методы </span><span lang=EN-US>get</span><span lang=RU> могут использоваться
для получения ответов на более сложные запросы, чем просто получение
постоянного объекта. Например, смарт-контракты реестра </span><span lang=EN-US>TON</span><span
lang=EN-US> </span><span lang=EN-US>DNS</span><span lang=RU> предоставляют
методы </span><span lang=EN-US>get</span><span lang=RU> для поиска строки
домена в реестре и возврата соответствующей записи, если она найдена.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:21.1pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>По соглашению, методы
получения используют большие <i>отрицательные </i>32-битные или 64-битные
индексы или магические числа, а внутренние функции смарт-контракта используют
последовательные положительные индексы, которые будут использоваться в
инструкции </span><span lang=EN-US>TVM</span><span lang=EN-US> </span><span
lang=EN-US>CALLDICT</span><span lang=RU>. Функция </span><span lang=EN-US>main</span><span
lang=RU>() смарт-контракта, используемая для обработки входящих сообщений в
обычных транзакциях, всегда имеет нулевой индекс.</span></p>

</div>

<span lang=RU style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'><br clear=all style='page-break-before:always'>
</span>

<div class=WordSection16>

<h2 style='margin-left:35.2pt;text-indent:-36.0pt'><a name="_Toc150775"><span
lang=EN-US>4.2<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>Операций</span></a></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:.55pt;
margin-left:-.25pt'><span lang=RU>Согласно парадигме бесконечного шардинга и
модели актора, тремя основными компонентами блокчейна </span><span lang=EN-US>TON</span><span
lang=RU> являются <i>учетные записи </i>(вместе с их состояниями), <i>сообщения
</i>и <i>транзакции. В предыдущих разделах уже обсуждались первые два; в этом
разделе рассматриваются транзакции.</i></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.3pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>В отличие от сообщений,
которые имеют по существу одинаковые заголовки во всех рабочих цепочках </span><span
lang=EN-US>TON</span><span lang=EN-US> </span><span lang=EN-US>Blockchain</span><span
lang=RU>, и учетных записей, которые имеют по крайней мере некоторые общие
части (адрес и баланс), наше обсуждение транзакций обязательно ограничивается
мастерчейном и основным рабочим цепью. Другие рабочие цепочки могут определять
совершенно другие виды транзакций.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:2.25pt;
margin-left:-.25pt'><span lang=RU>4.2.1. Логическое время транзакции. Каждой
транзакции </span><i><span lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>присвоен
логический временной интервал </span><span lang=EN-US>Lt</span><span lang=RU>•(</span><span
lang=EN-US>t</span><span lang=RU>) = [</span><span lang=EN-US>Lt</span><span
lang=RU>−(</span><span lang=EN-US>t</span><span lang=RU>),</span><span
lang=EN-US>Lt</span><span lang=RU>+(</span><span lang=EN-US>t</span><span
lang=RU>)) (ср. 1.4.6 и 1.4.3).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:11.7pt;
margin-left:-.25pt'><span lang=RU>По соглашению, транзакции </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, </span></i><span lang=RU>генерирующей </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>исходящих
сообщений </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>1,..., </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>mn</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, </span></i><span lang=RU>присваивается
логический интервал времени длиной </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>n</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU style='font-family:"Cambria",serif'>+ 1, так что</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:13.2pt;margin-left:0cm;text-align:left;text-indent:0cm;
line-height:107%'><span lang=RU style='font-size:11.0pt;line-height:107%'>                                              </span><span
lang=EN-US>Lt</span><span lang=RU>+(</span><span lang=EN-US>t</span><span
lang=RU>) = </span><span lang=EN-US>Lt</span><span lang=RU>−(</span><span
lang=EN-US>t</span><span lang=RU>) + </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>n</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>+ 1        <i>.                                     </i></span><span
lang=RU>(16)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:12.2pt;
margin-left:-.25pt'><span lang=RU>Мы также устанавливаем </span><span
lang=EN-US>Lt</span><span lang=RU>(</span><span lang=EN-US>t</span><span
lang=RU>) := </span><span lang=EN-US>Lt</span><span lang=RU>−(</span><span
lang=EN-US>t</span><span lang=RU>) и присваиваем время логического создания
сообщения </span><i><span lang=EN-US style='font-family:"Cambria",serif'>mi</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, где </span></i><span lang=RU
style='font-family:"Cambria",serif'>1 ≤ </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>i</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>≤ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, по</span></i></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:10.9pt;margin-left:0cm;text-align:left;text-indent:0cm;
line-height:107%'><span lang=RU style='font-size:11.0pt;line-height:107%'>            </span><span
lang=EN-US>Lt(mi) = Lt−(mi) := Lt−(t) + </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>i,Lt               </span></i><span
lang=EN-US>+(mi) := Lt−(mi) + 1</span><span lang=EN-US style='font-family:"Cambria",serif'>          <i>.
         </i></span><span lang=RU>(17)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.5pt;
margin-left:-.25pt'><span lang=RU>Таким образом, каждому сгенерированному
исходящему сообщению присваивается свой собственный единичный интервал внутри
логического временного интервала </span><span lang=EN-US>Lt</span><span
lang=RU>•(</span><span lang=EN-US>t</span><span lang=RU>) транзакции </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:2.1pt;
margin-left:-.25pt'><span lang=RU>4.2.2. Логическое время однозначно
идентифицирует транзакции и исходящие сообщения счета. Напомним, что условия,
налагаемые на логическое время, подразумевают, что </span><span lang=EN-US>Lt</span><span
lang=RU>−(</span><span lang=EN-US>t</span><span lang=RU>) ≥ </span><span
lang=EN-US>Lt</span><span lang=RU>+(</span><span lang=EN-US>t</span><span
lang=RU>’) для любой предшествующей транзакции </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>t</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>того же счета </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, и что </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>Lt</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>−(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>t</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) &gt; </span></i><span lang=EN-US>Lt</span><span
lang=RU>(</span><span lang=EN-US>m</span><span lang=RU>), если </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>является входящим
сообщением, обрабатываемым транзакцией </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>t</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>. Таким образом, логические временные </span></i><span
lang=RU>интервалы транзакций одного и того же счета не пересекаются друг с
другом, и, как следствие, логические временные интервалы всех исходящих
сообщений, генерируемых учетной записью, также не пересекаются друг с другом.
Другими словами, все </span><span lang=EN-US>Lt</span><span lang=RU>(</span><span
lang=EN-US>m</span><span lang=RU>) различны, когда </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>проходит через
все исходящие сообщения одной учетной записи </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Таким образом, </span><span
lang=EN-US>Lt</span><span lang=RU>(</span><span lang=EN-US>t</span><span
lang=RU>) и </span><span lang=EN-US>Lt</span><span lang=RU>(</span><span
lang=EN-US>m</span><span lang=RU>) в сочетании с идентификатором учетной записи
</span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span
lang=RU style='font-family:"Cambria",serif'> однозначно определяют транзакцию </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>или исходящее
сообщение </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>этой
учетной записи. Кроме того, если у вас есть упорядоченный список всех
транзакций счета вместе с их логическим временем, легко найти транзакцию,
которая сгенерировала данное исходящее сообщение </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, просто посмотрев транзакцию </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>с логическим
временем </span><span lang=EN-US>Lt</span><span lang=RU>(</span><span
lang=EN-US>t</span><span lang=RU>), ближайшим к </span><span lang=EN-US>Lt</span><span
lang=RU>(</span><span lang=EN-US>m</span><span lang=RU>) снизу.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>4.2.3. Родовые компоненты транзакции. Каждая
транзакция </span><i><span lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>содержит
или косвенно ссылается на следующие данные:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:12.5pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Счет </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>ξ</span></i><i><span lang=RU style='font-family:"Cambria",serif'>,</span></i><span
lang=RU> к которому принадлежит транзакция.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Логическое время </span><span lang=EN-US>Lt</span><span
lang=RU>(</span><span lang=EN-US>t</span><span lang=RU>) транзакции.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Одно или ноль входящих сообщений </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>обрабатывается
транзакцией.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:11.75pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Количество сгенерированных исходящих сообщений </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>≥ 0.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=EN-US style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=EN-US>Исходящие сообщения </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>m<sub>1</sub>,..., m<sub>n</sub>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Начальное состояние счета </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>(включая его
баланс).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Конечное состояние счета </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>(включая его
баланс).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Общая сумма сборов, взимаемых валидаторами.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:9.1pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Подробное описание транзакции, содержащее все или
некоторые данные, необходимые для ее проверки, включая вид транзакции (см.
4.2.4) и некоторые из выполненных промежуточных шагов.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Из этих компонентов все, кроме самого
последнего, являются довольно общими и могут появляться и в других рабочих
цепочках.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>4.2.4. Виды сделок. Существуют различные виды
транзакций, разрешенных в мастерчейне и шардчейнах. <i>Обычные транзакции </i>заключаются
в доставке одного входящего сообщения на счет и его обработке кодом этого
счета; это наиболее распространенный вид транзакции. Кроме того, существует
несколько видов экзотических транзакций. Всего существует шесть видов сделок:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Обычные транзакции </span></i><span lang=RU>—
принадлежать счету </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>. Они обрабатывают ровно одно
входящее сообщение </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>(описанное
в </span><i><span lang=EN-US>InMsgDescr</span></i><i><span lang=EN-US> </span></i><span
lang=RU>охватывающего блока) с назначением </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, вычисляют новое состояние учетной записи
и генерируют несколько исходящих сообщений (зарегистрированных в </span><span
lang=EN-US>OutMsgDescr</span></i><i><span lang=RU>) с исходным кодом </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Транзакции хранения </span></i><span lang=RU>—
могут быть вставлены валидаторами по своему усмотрению. Они не обрабатывают
входящие сообщения и не вызывают код. Их единственным эффектом является сбор
платежей за хранение со счета, влияя на его статистику хранения и его баланс.
Если полученный </span><span lang=EN-US>Gram</span><span lang=RU> баланс счета
становится меньше определенной суммы, счет может быть заморожен, а его код и
данные заменены их комбинированным хэшем.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Тиковые транзакции </span></i><span lang=RU>—
автоматически вызываются для определенных специальных счетов (смарт-контрактов)
в мастерчейне, в состоянии которых установлен флаг тика, как самые первые
транзакции в каждом блоке мастерчейна. Они не имеют входящих сообщений, но
могут генерировать исходящие сообщения и изменять состояние учетной записи.
Например, <i>выборы валидатора </i>выполняются путем тиковых транзакций
специальных смарт-контрактов в мастерчейне.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Транзакции </span><span lang=EN-US>Tock</span></i><i><span
lang=EN-US> </span></i><span lang=RU>— аналогично автоматически вызываются как
самые последние транзакции в каждом блоке мастерчейна для определенных
специальных учетных записей.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Разделенные транзакции </span></i><span lang=RU>—
вызываются как последние транзакции блоков </span><span lang=EN-US>shardchain</span><span
lang=RU>, непосредственно предшествующие событию разделения </span><span
lang=EN-US>shardchain</span><span lang=RU>. Они запускаются автоматически для
экземпляров крупных смарт-контрактов, которые должны создать новый экземпляр
после разделения.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:9.35pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Транзакции слияния </span></i><span lang=RU>—
аналогично вызываются как первые транзакции блоков </span><span lang=EN-US>shardchain</span><span
lang=RU> сразу после события слияния </span><span lang=EN-US>shardchain</span><span
lang=RU>, если экземпляр большого смарт-контракта необходимо объединить с
другим экземпляром того же смарт-контракта.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Обратите внимание, что из этих шести видов
транзакций только четыре могут происходить в мастерчейне, а еще одно
подмножество из четырех может происходить в основной рабочей цепочке.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>4.2.5. Этапы обычной сделки. Обычная
транзакция выполняется в несколько <i>этапов, которые можно рассматривать как
несколько «субтранзакций», тесно связанных в одну:</i></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Этап хранения </span></i><span lang=RU>—
собирает причитающиеся платежи за состояние учетной записи (включая код
смарт-контракта и данные, если таковые имеются) до настоящего времени. В
результате смарт-контракт может быть <i>заморожен.</i> Если смарт-контракт не
существовал раньше, фаза хранения отсутствует.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Кредитный этап </span></i><span lang=RU>— на
счет зачисляется значение полученного входящего сообщения.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Этап вычисления </span></i><span lang=RU>— код
смарт-контракта вызывается внутри экземпляра </span><span lang=EN-US>TVM</span><span
lang=RU> с адекватными параметрами, включая копию входящего сообщения и
постоянных данных, и завершается кодом выхода, новыми постоянными данными и
списком действий (который включает, например, исходящие сообщения для
отправки). Этап обработки может привести к созданию новой учетной записи
(неинициализированной или активной) или к активации ранее неинициализированной
или замороженной учетной записи. Плата <i>за газ, равная произведению цены на
газ и потребленного газа, взимается с остатка на счете.</i></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Фаза действия </span></i><span lang=RU>— если
смарт-контракт успешно расторгнут (с кодом выхода 0 или 1), выполняются
действия из списка. Если невозможно выполнить их все — например, из-за
недостаточности средств для перевода с исходящим сообщением — то транзакция
прерывается, а состояние счета откатывается. Транзакция также прерывается, если
смарт-контракт не был успешно расторгнут, или если не было возможности вызвать
смарт-контракт вообще, потому что он не инициализирован или заморожен.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=RU>Фаза отказа </span></i><span lang=RU>— если
транзакция была прервана, а для входящего сообщения установлен флаг </span><span
lang=EN-US>bounce</span><span lang=RU>, то оно «отскакивает» путем
автоматического создания исходящего сообщения (с четким флагом </span><span
lang=EN-US>bounce</span><span lang=RU>) его первоначальному отправителю. Почти
вся стоимость исходного входящего сообщения (за вычетом платежей за газ и платы
за пересылку) передается в сгенерированное сообщение, которое в противном
случае имеет пустой текст.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:12.0pt;
margin-left:-.25pt'><span lang=RU>4.2.6. Передача входящих сообщений на
несуществующие учетные записи. Обратите внимание, что если входящее сообщение с
установленным флагом </span><span lang=EN-US>bounce</span><span lang=RU>
отправляется на ранее несуществующую учетную запись, а транзакция прерывается
(например, из-за того, что во входящем сообщении нет кода и данных с правильным
хэшем, поэтому виртуальная машина вообще не может быть вызвана), то учетная
запись не создается даже как неинициализированная учетная запись, так как он
будет иметь нулевой баланс и никакого кода и данных в любом случае.</span><a
href="#_ftn31" name="_ftnref31" title=""><sup><span lang=EN-US><sup><span
lang=EN-US style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'>[31]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:8.2pt;
margin-left:-.25pt'><span lang=RU>4.2.7. Обработка входящего сообщения
разделена между этапами вычислений и действий. Обратите внимание, что обработка
входящего сообщения фактически разделена на две фазы: фазу <i>вычисления </i>и
фазу <i>действия.</i> На этапе вычисления вызывается виртуальная машина и
выполняются необходимые вычисления, но никакие действия за пределами
виртуальной машины не выполняются. Другими словами, <i>исполнение смарт-контракта
в </i></span><i><span lang=EN-US>TVM</span></i><i><span lang=RU> не имеет
побочных эффектов; у смарт-контракта нет возможности взаимодействовать с
блокчейном непосредственно во время его исполнения. Вместо этого </span><span
lang=EN-US>tvM</span></i><i><span lang=RU>-примитивы, такие как </span><span
lang=EN-US>SENDMSG</span></i><i><span lang=RU>, просто сохраняют требуемое
действие (например, исходящее сообщение, которое должно быть отправлено) в
списке действий, постепенно накапливаемом в управляющем регистре </span><span
lang=EN-US>TVM</span></i><i><span lang=EN-US> </span><span lang=EN-US>c</span></i><i><span
lang=RU>5. Сами действия откладываются до фазы действия, во время которой
смарт-контракт пользователя вообще не вызывается.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:10.4pt;
margin-left:-.25pt;line-height:110%'><span lang=RU>4.2.8. Причины разделения
обработки на этапы вычислений и действий. </span><span lang=EN-US>Некоторые
причины такой договоренности:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Проще прервать транзакцию, если смарт-контракт в
конечном итоге прекращается с кодом выхода, отличным от 0 или 1.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=EN-US style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Правила обработки выходных действий могут быть
изменены без изменения виртуальной машины. </span><span lang=EN-US>(Например,
могут быть введены новые выходные действия.)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Сама виртуальная машина может быть модифицирована
или даже заменена другой (например, в новой рабочей цепочке) без изменения
правил обработки выходных действий.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Выполнение смарт-контракта внутри виртуальной
машины полностью изолировано от блокчейна и является <i>чистым вычислением. Как
следствие, это выполнение может быть виртуализировано </i>внутри самой
виртуальной машины с помощью примитива </span><span lang=EN-US>RUNVM</span><span
lang=RU> от </span><span lang=EN-US>TVM</span><span lang=RU>, полезной функции
для смарт-контрактов валидатора и для смарт-контрактов, контролирующих
платежные каналы и другие сайдчейны. Кроме того, виртуальная машина может <i>эмулироваться
</i>внутри себя или урезанной версией себя, что является полезной функцией для
проверки выполнения смарт-контрактов внутри </span><span lang=EN-US>TVM</span><span
lang=RU>.</span><a href="#_ftn32" name="_ftnref32" title=""><sup><span
lang=EN-US><sup><span lang=EN-US style='font-size:12.0pt;line-height:104%;
font-family:"Calibri",sans-serif;color:black'>[32]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:7.8pt;
margin-left:-.25pt'><span lang=RU>4.2.9. Хранение, тик и такт транзакций.
Транзакции хранилища очень похожи на фазу автономного хранения обычной
транзакции. Транзакции </span><span lang=EN-US>Tick</span><span lang=RU> и </span><span
lang=EN-US>tock</span><span lang=RU> похожи на обычные транзакции без фаз
кредитования и отскока, потому что нет входящего сообщения.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:7.35pt;
margin-left:-.25pt'><span lang=RU>4.2.10. Сплит-транзакции. Разделенные
транзакции фактически состоят из двух транзакций. Если учетную запись </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>необходимо
разделить на две учетные записи </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>ξ</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>и </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>’:</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Сначала <i>транзакция </i></span><i><span
lang=EN-US>split</span></i><i><span lang=EN-US> </span><span lang=EN-US>prepare</span></i><i><span
lang=RU>, похожая на транзакцию </span><span lang=EN-US>tock</span></i><i><span
lang=RU> (но в </span><span lang=EN-US>shardchain</span></i><i><span lang=RU>
вместо </span><span lang=EN-US>masterchain</span></i><i><span lang=RU>),
выдается для счета </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>. Это должна быть последняя
транзакция для </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>в
блоке </span><span lang=EN-US>shardchain</span><span lang=RU>. Выход этапа
обработки транзакции </span><span lang=EN-US>split</span><span lang=EN-US> </span><span
lang=EN-US>prepare</span><span lang=RU> состоит не только из нового состояния
счета </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, но и из нового состояния счета </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’, представленного сообщением конструктора
к </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>(см.
4.1.7).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:6.6pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Затем добавляется <i>транзакция </i></span><i><span
lang=EN-US>split</span></i><i><span lang=EN-US> </span><span lang=EN-US>install</span></i><i><span
lang=EN-US> </span></i><span lang=RU>для учетной записи </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ со ссылкой на соответствующую транзакцию </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>split</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>prepare</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>. Транзакция </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>split</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>install</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> должна быть единственной транзакцией для
ранее несуществующей учетной записи </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>в блоке. Он
эффективно задает состояние </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>’</span></i><span lang=RU>, как
определено транзакцией </span><span lang=EN-US>split</span><span lang=EN-US> </span><span
lang=EN-US>prepare</span><span lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.15pt;
margin-left:-.25pt'><span lang=RU>4.2.11. Объединение транзакций. Транзакции
слияния также состоят из двух транзакций каждая. Если учетная запись </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>должна быть
объединена в учетную запись </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>:</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Сначала <i>транзакция </i></span><i><span
lang=EN-US>merge</span></i><i><span lang=EN-US> </span><span lang=EN-US>prepare</span></i><i><span
lang=EN-US> </span></i><span lang=RU>выдается </span><i><span lang=RU
style='font-family:"Cambria",serif'>для </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’, которая преобразует все свое постоянное
состояние и баланс в специальное сообщение конструктора с назначением </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>(см. 4.1.7).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Затем <i>транзакция </i></span><i><span lang=EN-US>merge</span></i><i><span
lang=EN-US> </span><span lang=EN-US>install</span></i><i><span lang=EN-US> </span></i><span
lang=RU>для </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, относящаяся к соответствующей
транзакции </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>merge</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>prepare</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, обрабатывает сообщение конструктора.
Транзакция </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>merge</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>install</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> похожа на транзакцию </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>tick</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> в том, что она должна быть первой
транзакцией для </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>в
блоке, но она находится в блоке </span><span lang=EN-US>shardchain</span><span
lang=RU>, а не в </span><span lang=EN-US>masterchain</span><span lang=RU>, и
имеет специальное входящее сообщение.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:9.1pt;
margin-left:-.25pt'><span lang=RU>4.2.12. Сериализация общей транзакции. Любая
транзакция содержит поля, перечисленные в 4.2.3. Как следствие, во всех
транзакциях есть некоторые общие компоненты:</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>transaction$_
account_addr:uint256 lt:uint64 outmsg_cnt:uint15</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:52.3pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>orig_status:AccountStatus
end_status:AccountStatus in_msg:(Maybe ^(Message Any)) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:52.3pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>out_msgs:(HashmapE
15 ^(Message Any)) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:52.3pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>total_fees:Grams
state_update:^(MERKLE_UPDATE Account) description:^TransactionDescr = Transaction;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:52.3pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:-12.3pt'><span
lang=EN-US>!merkle_update#02 {X:Type} old_hash:uint256 new_hash:uint256 </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:2.65pt'><span
lang=EN-US>old:^X new:^X = MERKLE_UPDATE X;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:2.65pt'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:.25pt;
margin-left:-.25pt'><span lang=RU>Восклицательный знак в декларации </span><span
lang=EN-US>TL</span><span lang=RU>-</span><span lang=EN-US>B</span><span
lang=EN-US> </span><span lang=EN-US>merkle</span><span lang=RU>_</span><span
lang=EN-US>update</span><span lang=RU> указывает на специальную обработку,
необходимую для таких значений. В частности, они должны храниться в отдельной
ячейке, которая должна быть помечена как <i>экзотическая </i>битом в ее
заголовке.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.7pt;
margin-left:-.25pt'><span lang=RU>(ср. [4, 3.1]).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:8.6pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Полное объяснение
сериализации </span><i><span lang=EN-US>TransactionDescr</span></i><i><span
lang=RU>, которая описывает одну транзакцию в соответствии с ее видом,
перечисленным в 4.2.4, можно найти в 4.3.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:.1pt;
margin-left:-.25pt'><span lang=RU>4.2.13. Представление исходящих сообщений,
генерируемых транзакцией. Исходящие сообщения, генерируемые транзакцией </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>,</span></i><span lang=RU> хранятся в
словаре </span><span lang=EN-US>out</span><span lang=RU>_</span><span
lang=EN-US>msgs</span><span lang=RU> с 15-битными ключами, равными 0, 1,..., </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>− 1, где </span><i><span lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= </span><span lang=EN-US>outmsg</span><span
lang=RU>_</span><span lang=EN-US>cnt</span><span lang=RU> — количество
сгенерированных исходящих сообщений. Сообщение </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>m<sub>i</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+1</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'> </span></i><span lang=RU>с
индексом </span><span lang=RU style='font-family:"Cambria",serif'>0 ≤ </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>i</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> &lt; </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>n</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='line-height:
104%'>должно иметь</span><sup><span lang=RU style='font-size:18.5pt;line-height:
104%'> </span></sup><span lang=EN-US>Lt</span><span lang=RU>(</span><span
lang=EN-US>m<sub>i</sub></span><sub><span lang=RU>+1</span></sub><span lang=RU>)
= </span><span lang=EN-US>Lt</span><span lang=RU>(</span><span lang=EN-US>t</span><span
lang=RU>) + </span><i><span lang=EN-US style='font-family:"Cambria",serif'>i</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>+ 1, и</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=EN-US>Lt</span><span lang=RU>(</span><span
lang=EN-US>t</span><span lang=RU>) = </span><span lang=EN-US>Lt</span><span
lang=RU>−(</span><span lang=EN-US>t</span><span lang=RU>) явно хранится в поле </span><span
lang=EN-US>lt</span><span lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>4.2.14. Условия согласованности сделок. Общая
сериализация полей, присутствующих в <i>Транзакции, независимо от ее типа и
описания, позволяет нам наложить несколько «внешних» условий согласованности на
любую транзакцию. Наиболее важный из них включает в себя поток значений </i>внутри
транзакции: сумма всех входных данных (значение импорта входящего сообщения
плюс исходный баланс счета) должна равняться сумме всех выходов (итоговый
баланс счета, плюс сумма экспортных значений всех исходящих сообщений, плюс все
хранилище, сборы за обработку и пересылку, взимаемые валидаторами). Таким
образом, поверхностная проверка транзакции, которая обрабатывает входящее
сообщение со значением импорта 1 грамм, полученное учетной записью с начальным
балансом 10 граммов, генерируя исходящее сообщение со стоимостью экспорта 100
граммов в процессе, выявит его недействительность еще до проверки всех деталей
выполнения </span><span lang=EN-US>TVM</span><span lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:9.3pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Другие условия
согласованности могут незначительно зависеть от описания транзакции. Например,
входящее сообщение, обрабатываемое обычной транзакцией, должно быть
зарегистрировано в </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>охватывающего блока, а соответствующая
запись должна содержать ссылку на эту транзакцию. Аналогичным образом, все
исходящие сообщения, генерируемые всеми транзакциями (за исключением одного
специального сообщения, сгенерированного разделенной транзакцией подготовки или
подготовки слияния), должны быть зарегистрированы в </span><i><span lang=EN-US>OutMsgDescr</span></i><i><span
lang=RU>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:6.95pt;
margin-left:-.25pt'><span lang=RU>4.2.15. Сбор всех операций по счету. Все
транзакции в блоке, принадлежащем одному и тому же счету </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>,</span></i><span lang=RU> собираются в
«блок связей счетов» </span><i><span lang=EN-US>AccountBlock</span></i><i><span
lang=RU>, </span></i><span lang=RU>который по сути представляет собой словарные
транзакции с 64-битными ключами, каждая из которых равна логическому времени
соответствующей транзакции:</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:33.85pt;
margin-bottom:1.8pt;margin-left:73.05pt;text-align:left;text-indent:-73.8pt'><span
lang=EN-US>acc_trans$_ account_addr:uint256 </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:33.85pt;
margin-bottom:1.8pt;margin-left:73.05pt;text-align:left;text-indent:-73.8pt'><span
lang=EN-US>transactions:(HashmapAug 64 ^Transaction Grams)
state_update:^(MERKLE_UPDATE Account)</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:62.0pt;text-align:left'><span lang=RU>= </span><span
lang=EN-US>AccountBlock</span><span lang=RU>;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:.85pt;
margin-left:-.25pt'><span lang=RU>Словарь транзакций дополняется значением <i>граммов,</i>
которое агрегирует общие сборы, собранные с этих транзакций.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.2pt;margin-bottom:9.1pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>В дополнение к этому
словарю </span><span lang=EN-US>AccountBlock</span><span lang=EN-US> </span><span
lang=RU>содержит обновление </span><span lang=EN-US>Merkle</span><span lang=RU>
(см. [4, 3.1]) общего состояния учетной записи. Если аккаунт до блокировки не
существовал, его состояние представлено </span><span lang=EN-US>account</span><span
lang=RU>_</span><span lang=EN-US>none</span><span lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.15pt;
margin-left:-.25pt'><span lang=RU>4.2.16. Условия согласованности для </span><i><span
lang=EN-US>AccountBlocks</span></i><i><span lang=RU>. Существует несколько
общих условий согласованности, налагаемых на </span><span lang=EN-US>AccountBlock</span></i><i><span
lang=RU>. </span><span lang=EN-US>В частности:</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Транзакция, отображаемая как значение в расширенном
словаре транзакций, должна иметь значение </span><span lang=EN-US>lt</span><span
lang=RU>, равное ее ключу.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Все транзакции должны принадлежать учетной записи,
адрес </span><span lang=EN-US>account</span><span lang=RU>_</span><span
lang=EN-US>addr</span><span lang=RU> которой указан в </span><i><span
lang=EN-US>AccountBlock</span></i><i><span lang=RU>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Если </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>t</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>и </span><i><span lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>являются
двумя транзакциями с </span><span lang=EN-US>Lt</span><span lang=RU>(</span><span
lang=EN-US>t</span><span lang=RU>) </span><i><span lang=RU style='font-family:
"Cambria",serif'>&lt; </span></i><span lang=EN-US>Lt</span><span lang=RU>(</span><span
lang=EN-US>t</span><span lang=RU>’), и их ключи последовательны в транзакциях,
что означает, что нет транзакции </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>t</span></i><i><span lang=RU style='font-family:"Cambria",serif'>’’
</span></i><span lang=RU>с </span><span lang=EN-US>Lt</span><span lang=RU>(</span><span
lang=EN-US>t</span><span lang=RU>) </span><i><span lang=RU style='font-family:
"Cambria",serif'>&lt; </span></i><span lang=EN-US>Lt</span><span lang=RU>(</span><span
lang=EN-US>t</span><span lang=RU>’’) </span><i><span lang=RU style='font-family:
"Cambria",serif'>&lt; </span></i><span lang=EN-US>Lt</span><span lang=RU>(</span><span
lang=EN-US>t</span><span lang=RU>’), то конечное состояние </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>должно
соответствовать начальному состоянию </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>t</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>(их хэши, явно
указанные в обновлениях Меркла, должны быть равны).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:12.3pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Если </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>t</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>является транзакцией с минимальным </span><span
lang=EN-US>Lt</span><span lang=RU>(</span><span lang=EN-US>t</span><span
lang=RU>), ее начальное состояние должно совпадать с начальным состоянием, как
указано в </span><span lang=EN-US>state</span><span lang=RU>_</span><span
lang=EN-US>update</span><span lang=EN-US> </span><i><span lang=EN-US>AccountBlock</span></i><i><span
lang=RU>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:3.4pt;
margin-left:29.3pt;text-indent:-11.85pt;line-height:147%'><span lang=RU
style='line-height:147%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Если </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>t</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>является транзакцией с максимальным </span><span
lang=EN-US>Lt</span><span lang=RU>(</span><span lang=EN-US>t</span><span
lang=RU>), ее конечное состояние должно совпадать с конечным состоянием,
указанным в </span><span lang=EN-US>state</span><span lang=RU>_</span><span
lang=EN-US>update</span><span lang=EN-US> </span><i><span lang=EN-US>AccountBlock</span></i><i><span
lang=RU>. </span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:3.4pt;
margin-left:29.3pt;text-indent:-11.85pt;line-height:147%'><span lang=RU
style='line-height:147%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Список транзакций должен быть непустым.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Эти условия просто выражают тот факт, что
состояние счета может измениться только в результате выполнения транзакции.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:8.75pt;
margin-left:-.25pt;line-height:110%'><span lang=RU>4.2.17. Сбор всех транзакций
в блоке. Все транзакции в блоке представлены (см. 1.2.1):</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:9.15pt;margin-left:-.25pt;text-align:left;line-height:103%'><span
lang=RU>_ (</span><span lang=EN-US>HashmapAugE</span><span lang=RU> 256 </span><span
lang=EN-US>AccountBlock</span><span lang=EN-US> </span><span lang=EN-US>Grams</span><span
lang=RU>) = </span><span lang=EN-US>ShardAccountBlocks</span><span lang=RU>;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>4.2.18. Условия согласованности сбора всех
транзакций. Опять же, на эту структуру накладываются условия согласованности,
требующие, чтобы значение в ключе </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>ξ</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>было </span><i><span lang=EN-US>AccountBlock</span></i><i><span
lang=EN-US> </span></i><span lang=RU>с адресом, равным </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>. Дальнейшие условия согласованности
связывают эту структуру с начальным и конечным состояниями шардчейна,
указанными в блоке, требуя, чтобы:</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Если </span><i><span lang=EN-US>ShardAccountBlock</span></i><i><span
lang=EN-US> </span></i><span lang=RU>не имеет ключа </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, то состояние счета </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>в начальном и
конечном состоянии блока должно совпадать (или оно должно отсутствовать у
обоих).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.55pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Если </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>ξ</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>присутствует в </span><i><span lang=EN-US>ShardAccountBlock</span></i><i><span
lang=RU>, его начальное и конечное состояния, указанные в </span><span
lang=EN-US>AccountBlock</span></i><i><span lang=RU>, </span></i><span lang=RU>должны
совпадать с состояниями, указанными в начальном и конечном состояниях блока </span><span
lang=EN-US>shardchain</span><span lang=RU>, выраженных экземплярами </span><i><span
lang=EN-US>ShardAccounts</span></i><i><span lang=EN-US> </span></i><span
lang=RU>(см. 4.1.9).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:21.4pt;
margin-left:-.25pt'><span lang=RU>Эти условия выражают, что состояние шардчейна
действительно состоит из состояний отдельных счетов.</span></p>

</div>

<span lang=RU style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'><br clear=all style='page-break-before:always'>
</span>

<div class=WordSection17>

<h2 style='margin-left:35.2pt;text-indent:-36.0pt'><a name="_Toc150776"><span
lang=EN-US>4.3<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>Описание транзакций</span></a></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>В этом разделе представлены конкретные схемы </span><span
lang=EN-US>TL</span><span lang=RU>-</span><span lang=EN-US>B</span><span
lang=RU> для описания транзакций в соответствии с классификацией, приведенной в
разделе 4.2.4.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>4.3.1. Причины исключения данных из описания
транзакции. Описание транзакции для блокчейна с полной виртуальной машиной
Тьюринга для выполнения смарт-контрактов обязательно является неполным.
Действительно, действительно полное описание будет содержать все промежуточные
состояния виртуальной машины после выполнения каждой инструкции, что не может
поместиться в блок блокчейна разумного размера. Поэтому описание такой
транзакции, скорее всего, будет содержать только общее количество шагов и хэши
начального и конечного состояний виртуальной машины. Проверка такой транзакции
обязательно будет включать в себя выполнение смарт-контракта для
воспроизведения всех промежуточных шагов и конечного результата.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:6.05pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Если сжать
последовательность всех промежуточных шагов виртуальной машины в только хэши
начального и конечного состояний, то никаких деталей транзакции включать вообще
не нужно: проверяющий, способный самостоятельно проверять выполнение
виртуальной машины, также сможет проверить все остальные действия транзакции,
начиная с ее исходных данных без этих деталей.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:6.3pt;
margin-left:-.25pt'><span lang=RU>4.3.2. Причины включения данных в описание
транзакции. Несмотря на вышеизложенные соображения, есть еще несколько причин
для включения некоторых деталей в описание транзакции:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.25pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Мы хотим наложить на транзакцию внешние условия
согласованности, чтобы по крайней мере валидность потока значений внутри
транзакции и валидность входящих и исходящих сообщений можно было быстро
проверить без вызова виртуальной машины (см. 4.2.14). Это как минимум
гарантирует инвариантность общего количества каждой криптовалюты в блокчейне,
даже если не гарантирует правильность ее распределения.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.3pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Мы хотим иметь возможность отслеживать основные
изменения состояния учетной записи (например, ее создание, активацию или
замораживание), проверяя данные, хранящиеся в описании транзакции, не выясняя
недостающие детали транзакции. Это упрощает проверку условий согласованности
между состояниями </span><span lang=EN-US>accountchain</span><span lang=RU> и </span><span
lang=EN-US>shardchain</span><span lang=RU> в блоке.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=EN-US style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Наконец, определенная информация, такая как общие
шаги виртуальной машины, хэши ее начального и конечного состояний, общее
потребление газа и код выхода, может значительно упростить отладку и реализацию
программного обеспечения </span><span lang=EN-US>TON</span><span lang=EN-US> </span><span
lang=EN-US>Blockchain</span><span lang=RU>. </span><span lang=EN-US>(Эта
информация поможет программисту-человеку понять, что произошло.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.75pt'><span lang=EN-US>в определенном блоке блокчейна.)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>С другой стороны, мы хотим минимизировать
размер каждой транзакции, потому что мы хотим максимизировать количество
транзакций, которые могут поместиться в каждый (ограниченный размер) блок.
Поэтому вся информация, не требующаяся по одной из вышеуказанных причин,
опускается.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.3pt;
margin-left:-.25pt'><span lang=RU>4.3.3. Описание этапа хранения. Фаза хранения
присутствует в нескольких видах транзакций, поэтому для этой фазы используется
общее представление:</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:-.6pt'><span
lang=EN-US>tr_phase_storage$_ storage_fees_collected:Grams</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:13.55pt'><span
lang=EN-US>storage_fees_due:(Maybe Grams) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:13.55pt'><span
lang=EN-US>status_change:AccStatusChange</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:13.55pt'><span
lang=EN-US>= TrStoragePhase;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:19.5pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:-.6pt'><span
lang=EN-US>acst_unchanged$0 = AccStatusChange;   // x -&gt; x </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:19.5pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:-.6pt'><span
lang=EN-US>acst_frozen$10 = AccStatusChange;        // init -&gt; frozen </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:19.5pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:-.6pt'><span
lang=EN-US>acst_deleted$11 = AccStatusChange;      // frozen -&gt; deleted</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.25pt;
margin-left:-.25pt'><span lang=EN-US>4.3.4. </span><span lang=RU>Описание
кредитного этапа. Кредитный этап может привести к сбору некоторых причитающихся
платежей:</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:-.6pt'><span
lang=EN-US>tr_phase_credit$_ due_fees_collected:(Maybe Garms)</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:6.5pt'><span
lang=EN-US>credit</span><span lang=RU>:</span><span lang=EN-US>CurrencyCollection</span><span
lang=RU>= </span><span lang=EN-US>TrCreditPhase</span><span lang=RU>;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Сумма </span><span lang=EN-US>due</span><span
lang=RU>_</span><span lang=EN-US>fees</span><span lang=RU>_</span><span
lang=EN-US>collected</span><span lang=RU> и кредита должна равна стоимости
полученного сообщения плюс его </span><span lang=EN-US>ihr</span><span lang=RU>_</span><span
lang=EN-US>fee</span><span lang=RU>, если сообщение не было получено с помощью
ММСП (в противном случае </span><span lang=EN-US>ihr</span><span lang=RU>_</span><span
lang=EN-US>fee</span><span lang=RU> присуждается валидаторам).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.35pt;
margin-left:-.25pt'><span lang=RU>4.3.5. Описание этапа вычисления.
Вычислительная фаза заключается в вызове </span><span lang=EN-US>TVM</span><span
lang=RU> с правильными входами. В некоторых случаях </span><span lang=EN-US>TVM</span><span
lang=RU> вообще не может быть вызван (например, если учетная запись отсутствует,
не инициализирована или заморожена, а обрабатываемое входящее сообщение не
имеет кода или полей данных или эти поля имеют неправильный хэш); это
отражается соответствующими конструкторами.</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>tr_phase_compute_skipped$0
reason:ComputeSkipReason</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:56.4pt;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:12.3pt'><span
lang=EN-US>= TrComputePhase; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:56.4pt;
margin-bottom:1.8pt;margin-left:.5pt;text-align:left'><span lang=EN-US>tr_phase_compute_vm$1
success:Bool msg_state_used:Bool</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:7.25pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>account_activated:Bool
gas_fees:Grams </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:7.25pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>_:^[
gas_used:(VarUInteger 7) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:7.25pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>gas_limit:(VarUInteger
7) gas_credit:(Maybe (VarUInteger 3)) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:7.25pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>mode:int8
exit_code:int32 exit_arg:(Maybe int32) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:7.25pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>vm_steps:uint32
</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:7.25pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>vm_init_state_hash:uint256
vm_final_state_hash:uint256 ]</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:148.7pt;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:12.3pt'><span
lang=EN-US>= TrComputePhase; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:148.7pt;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:0cm'><span
lang=EN-US>cskip_no_state$00 = ComputeSkipReason; cskip_bad_state$01 =
ComputeSkipReason; cskip_no_gas$10 = ComputeSkipReason;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.85pt;
margin-left:-.25pt'><span lang=RU>Конструкция </span><span lang=EN-US>TL</span><span
lang=RU>-</span><span lang=EN-US>B</span><span lang=RU> _:ˆ[...] описывает
ссылку на ячейку, содержащую поля, перечисленные в квадратных скобках. Таким
образом, несколько полей могут быть перемещены из ячейки, содержащей большую
запись, в отдельную подячейку.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.8pt;
margin-left:-.25pt'><span lang=RU>4.3.6. Пропущенная фаза вычислений. Если этап
вычисления был пропущен, возможны следующие причины:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Отсутствие средств на покупку газа.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Отсутствие состояния (т.е. кода смарт-контракта и
данных) как в учетной записи (несуществующей, неинициализированной или
замороженной), так и в сообщении.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.85pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Недопустимое состояние, переданное в сообщении (т.
е. хэш состояния отличается от ожидаемого значения) в замороженную или
неинициализированную учетную запись.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.15pt;
margin-left:-.25pt'><span lang=RU>4.3.7. Допустимый этап вычисления. Если нет
причин пропускать этап вычисления, вызывается </span><span lang=EN-US>TVM</span><span
lang=RU> и результаты вычислений записываются в журнал. </span><span
lang=EN-US>Возможны следующие параметры:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Флаг успеха устанавливается тогда и только тогда,
когда </span><span lang=EN-US>exit</span><span lang=RU>_</span><span
lang=EN-US>code</span><span lang=RU> равно 0 или 1.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Параметр </span><span lang=EN-US>msg</span><span
lang=RU>_</span><span lang=EN-US>state</span><span lang=RU>_</span><span
lang=EN-US>used</span><span lang=RU> отражает, использовалось ли состояние,
переданное в сообщении. Если он установлен, флаг </span><span lang=EN-US>account</span><span
lang=RU>_</span><span lang=EN-US>activated</span><span lang=RU> отражает,
привело ли это к активации ранее замороженной, неинициализированной или
несуществующей учетной записи.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Параметр </span><span lang=EN-US>gas</span><span
lang=RU>_</span><span lang=EN-US>fees</span><span lang=RU> отражает общую плату
за газ, взимаемую валидаторами за выполнение этой транзакции. Он должен быть
равен произведению </span><span lang=EN-US>gas</span><span lang=RU>_</span><span
lang=EN-US>used</span><span lang=RU> и </span><span lang=EN-US>gas</span><span
lang=RU>_</span><span lang=EN-US>price</span><span lang=RU> от текущего
заголовка блока.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Параметр </span><span lang=EN-US>gas</span><span
lang=RU>_</span><span lang=EN-US>limit</span><span lang=RU> отражает предел
газа для данного экземпляра </span><span lang=EN-US>TVM</span><span lang=RU>.
Он равен меньшему из граммов, зачисленных на кредитном этапе, от стоимости
входящего сообщения, деленного на текущую цену газа, либо к глобальному лимиту
газа на транзакцию.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Параметр </span><span lang=EN-US>gas</span><span
lang=RU>_</span><span lang=EN-US>credit</span><span lang=RU> может быть
ненулевым только для внешних входящих сообщений. Это меньшее количество газа,
которое может быть оплачено с баланса счета, либо максимальный газовый кредит.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Параметры </span><span lang=EN-US>exit</span><span
lang=RU>_</span><span lang=EN-US>code</span><span lang=RU> и </span><span
lang=EN-US>exit</span><span lang=RU>_</span><span lang=EN-US>args</span><span
lang=RU> представляют значения состояния, возвращаемые </span><span lang=EN-US>TVM</span><span
lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:12.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Параметры </span><span lang=EN-US>vm</span><span
lang=RU>_</span><span lang=EN-US>init</span><span lang=RU>_</span><span
lang=EN-US>state</span><span lang=RU>_</span><span lang=EN-US>hash</span><span
lang=RU> и </span><span lang=EN-US>vm</span><span lang=RU>_</span><span
lang=EN-US>final</span><span lang=RU>_</span><span lang=EN-US>state</span><span
lang=RU>_</span><span lang=EN-US>hash</span><span lang=RU> представляют собой
хэши представления исходного и результирующего состояний </span><span
lang=EN-US>TVM</span><span lang=RU>, а </span><span lang=EN-US>vm</span><span
lang=RU>_</span><span lang=EN-US>steps</span><span lang=RU> — общее количество
шагов, выполняемых </span><span lang=EN-US>TVM</span><span lang=RU> (обычно
равное двум плюс количество выполняемых инструкций, включая неявные </span><span
lang=EN-US>RET</span><span lang=RU>).</span><a href="#_ftn33" name="_ftnref33"
title=""><sup><span lang=EN-US><sup><span lang=EN-US style='font-size:12.0pt;
line-height:104%;font-family:"Calibri",sans-serif;color:black'>[33]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.25pt;
margin-left:-.25pt'><span lang=RU>4.3.8. Описание фазы действия. Фаза действия
происходит после допустимого этапа вычисления. Он пытается выполнить действия,
сохраненные </span><span lang=EN-US>TVM</span><span lang=RU> на этапе
вычисления, в <i>список действий. Он может завершиться ошибкой, поскольку
список действий может оказаться слишком длинным, содержать недопустимые действия
или действия, которые не могут быть выполнены (например, из-за нехватки средств
для создания исходящего сообщения с требуемым значением).</i></span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:-.6pt'><span
lang=EN-US>tr_phase_action$_ success:Bool valid:Bool no_funds:Bool</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:7.2pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:6.5pt'><span
lang=EN-US>status_change:AccStatusChange </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:7.2pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:6.5pt'><span
lang=EN-US>total_fwd_fees:(Maybe Grams) total_action_fees:(Maybe Grams)</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:7.2pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:6.5pt'><span
lang=EN-US>result_code:int32 result_arg:(Maybe int32) tot_actions:int16</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:7.2pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:6.5pt'><span
lang=EN-US>spec_actions:int16 msgs_created:int16 </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:7.2pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:6.5pt'><span
lang=EN-US>action_list_hash:uint256 tot_msg_size:StorageUsed</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:6.5pt'><span
lang=EN-US>= TrActionPhase;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:8.3pt;
margin-left:-.25pt;line-height:110%'><span lang=EN-US>4.3.9. Описание фазы
отскока.</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>tr_phase_bounce_negfunds$00
= TrBouncePhase; tr_phase_bounce_nofunds$01 msg_size:StorageUsed</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>req_fwd_fees:Grams=
TrBouncePhase;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:50.3pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:-12.3pt'><span
lang=EN-US>tr_phase_bounce_ok$1 msg_size:StorageUsed </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:50.3pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:2.65pt'><span
lang=EN-US>msg_fees:Grams fwd_fees:Grams= TrBouncePhase;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:50.3pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:-12.3pt'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:.25pt;
margin-left:-.25pt;line-height:110%'><span lang=EN-US>4.3.10. Описание обычной сделки.</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:-.6pt'><span
lang=EN-US>trans_ord$0000 storage_ph:(Maybe TrStoragePhase)</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:37.95pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:6.5pt'><span
lang=EN-US>credit_ph:(Maybe TrCreditPhase) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:37.95pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:6.5pt'><span
lang=EN-US>compute_ph:TrComputePhase action:(Maybe ^TrActionPhase)</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:37.95pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:6.5pt'><span
lang=EN-US>aborted:Bool bounce:(Maybe TrBouncePhase) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:37.95pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:6.5pt'><span
lang=EN-US>destroyed</span><span lang=RU>:</span><span lang=EN-US>Bool</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:6.5pt'><span
lang=RU>= </span><span lang=EN-US>TransactionDescr</span><span lang=RU>;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:6.5pt'><span
lang=RU>&nbsp;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>На эту структуру накладывается несколько
условий согласованности:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.5pt;
margin-left:29.3pt;text-indent:-11.85pt;line-height:110%'><span lang=RU
style='line-height:110%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>действие отсутствует тогда и только тогда, когда
этап вычисления был неудачным.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Прерванный флаг устанавливается либо в том случае,
если фаза действия отсутствует, либо если фаза действия была неудачной.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Фаза возврата происходит только в том случае, если
установлен флаг прерванного действия и входящее сообщение было отклонено.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.25pt;
margin-left:-.25pt'><span lang=RU>4.3.11. Описание транзакции хранения.
Транзакция хранилища состоит только из одного этапа автономного хранилища:</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:111.7pt;
margin-bottom:1.8pt;margin-left:11.35pt;text-align:left;text-indent:-12.2pt'><span
lang=EN-US>trans_storage$0001 storage_ph:TrStoragePhase </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:111.7pt;
margin-bottom:1.8pt;margin-left:11.35pt;text-align:left;text-indent:-4.25pt'><span
lang=EN-US>= TransactionDescr;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:111.7pt;
margin-bottom:1.8pt;margin-left:11.35pt;text-align:left;text-indent:-4.25pt'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.3pt;
margin-left:-.25pt'><span lang=RU>4.3.12. Описание тиковых и так-транзакций.
Транзакции </span><span lang=EN-US>Tick</span><span lang=RU> и </span><span
lang=EN-US>tock</span><span lang=RU> похожи на обычные транзакции без входящего
сообщения, поэтому нет фаз кредитования или отказа:</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:-.6pt'><span
lang=EN-US>trans_tick_tock$001 is_tock:Bool storage:TrStoragePhase</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:6.5pt'><span
lang=EN-US>compute_ph:TrComputePhase action:(Maybe ^TrActionPhase) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:6.5pt'><span
lang=EN-US>aborted:Bool destroyed:Bool = TransactionDescr;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:-.6pt'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.35pt;
margin-left:-.25pt'><span lang=RU>4.3.13. Сплит подготавливает и устанавливает
транзакции. Транзакция </span><span lang=EN-US>split</span><span lang=EN-US> </span><span
lang=EN-US>prepare</span><span lang=RU> аналогична транзакции </span><span
lang=EN-US>tock</span><span lang=RU> в мастерчейне, но она должна генерировать
ровно одно специальное сообщение конструктора; в противном случае фаза действия
прерывается.</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>split_merge_info$_
cur_shard_pfx_len:(## 6)</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>acc_split_depth:(##
6) this_addr:uint256 sibling_addr:uint256</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:81.05pt;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:12.3pt'><span
lang=EN-US>= SplitMergeInfo; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:81.05pt;
margin-bottom:1.8pt;margin-left:.5pt;text-align:left'><span lang=EN-US>trans_split_prepare$0100
split_info:SplitMergeInfo</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>compute_ph:TrComputePhase
action:(Maybe^ TrActionPhase)</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>aborted:Bool
destroyed:Bool</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:82.95pt;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:12.3pt'><span
lang=EN-US>= TransactionDescr; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:82.95pt;
margin-bottom:1.8pt;margin-left:.5pt;text-align:left'><span lang=EN-US>trans_split_install$0101
split_info:SplitMergeInfo</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:95.25pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>prepare_transaction:^Transaction</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:95.25pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>installed:Bool
= TransactionDescr;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.35pt;
margin-left:-.25pt'><span lang=RU>Обратите</span><span lang=RU> </span><span
lang=RU>внимание</span><span lang=EN-US>, </span><span lang=RU>что</span><span
lang=RU> </span><span lang=RU>транзакция</span><span lang=RU> </span><span
lang=EN-US>split install </span><span lang=RU>для</span><span lang=RU> </span><span
lang=RU>новой</span><span lang=RU> </span><span lang=RU>учетной</span><span
lang=RU> </span><span lang=RU>записи</span><span lang=RU> </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ’ </span></i><span lang=RU>относится</span><span
lang=RU> </span><span lang=RU>к</span><span lang=RU> </span><span lang=RU>соответствующей</span><span
lang=RU> </span><span lang=RU>транзакции</span><span lang=RU> </span><span
lang=EN-US>split prepare </span><span lang=RU>ранее</span><span lang=RU> </span><span
lang=RU>существующей</span><span lang=RU> </span><span lang=RU>учетной</span><span
lang=RU> </span><span lang=RU>записи</span><span lang=RU> </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.65pt;
margin-left:-.25pt'><span lang=RU>4.3.14. Слияние подготавливает и
устанавливает транзакции. Транзакция подготовки слияния преобразует состояние и
баланс учетной записи в сообщение, а последующая транзакция установки слияния
обрабатывает следующее состояние:</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>trans_merge_prepare$0110
split_info:SplitMergeInfo</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>storage_ph:TrStoragePhase
aborted:Bool</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:82.95pt;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:12.3pt'><span
lang=EN-US>= TransactionDescr; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:82.95pt;
margin-bottom:1.8pt;margin-left:.5pt;text-align:left'><span lang=EN-US>trans_merge_install$0111
split_info:SplitMergeInfo</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:39.9pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>prepare_transaction:^Transaction
</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:39.9pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>credit_ph:(Maybe
TrCreditPhase) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:39.9pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>compute_ph:TrComputePhase
action:(Maybe^TrActionPhase) aborted:Bool destroyed:Bool</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>= Transaction
Descr;</span></p>

</div>

<span lang=EN-US style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'><br clear=all style='page-break-before:always'>
</span>

<div class=WordSection18>

<h2 style='margin-left:35.2pt;text-indent:-36.0pt'><a name="_Toc150777"><span
lang=RU>4.4<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=RU>Вызов смарт-контрактов в </span><span lang=EN-US>TVM</span></a></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.55pt;
margin-left:-.25pt'><span lang=RU>В этом разделе описываются точные параметры,
с которыми </span><span lang=EN-US>TVM</span><span lang=RU> вызывается на этапе
вычислений обычных и других транзакций.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>4.4.1. Код смарт-контракта. <i>Код </i>смарт-контракта
обычно является частью постоянного состояния учетной записи, по крайней мере,
если учетная запись активна (см. 4.1.6). Однако замороженный или
неинициализированный (или несуществующий) счет не имеет постоянного состояния,
за исключением, возможно, баланса счета и хэша его предполагаемого состояния
(равного адресу счета для неинициализированных счетов). В этом случае код
должен быть указан в поле </span><span lang=EN-US>init</span><span lang=RU>
входящего сообщения, обрабатываемого транзакцией (см. 3.1.7).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>4.4.2. Постоянные данные смарт-контракта.
Постоянные <i>данные </i>смарт-контракта хранятся вместе с его кодом, и
применяются замечания, аналогичные тем, которые сделаны выше в 4.4.1. В этом
отношении код и постоянные данные смарт-контракта являются лишь двумя частями
его постоянного состояния, которые отличаются только тем, как они
обрабатываются </span><span lang=EN-US>TVM</span><span lang=RU> во время
выполнения смарт-контракта.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>4.4.3. Среда библиотеки смарт-контрактов.
Библиотечная <i>среда </i>смарт-контракта представляет собой хэш-карту,
отображающую 256-битные хэши ячеек (представления) в сами соответствующие
ячейки. При доступе к внешней ссылке ячейки во время выполнения смарт-контракта
ячейка, на которую ссылается ячейка, просматривается в среде библиотеки, и
внешняя ссылка ячейки прозрачно заменяется найденной ячейкой.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.35pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Библиотечная среда для
вызова смарт-контракта вычисляется следующим образом:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:11.85pt;
margin-left:29.25pt;text-indent:-14.95pt'><span lang=RU style='line-height:
104%'>А.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
lang=RU>Глобальная библиотечная среда для рассматриваемой рабочей цепи взята из
текущего состояния мастерчейна.</span><a href="#_ftn34" name="_ftnref34"
title=""><sup><span lang=EN-US><sup><span lang=EN-US style='font-size:12.0pt;
line-height:104%;font-family:"Calibri",sans-serif;color:black'>[34]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.25pt;text-indent:-14.95pt'><span lang=RU style='line-height:
104%'>Б.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
lang=RU>Далее он дополняется локальной библиотечной средой смарт-контракта,
хранящейся в библиотечном поле состояния смарт-контракта. Учитываются только
256-битные ключи, равные хэшам соответствующих значений ячеек. Если ключ
присутствует как в глобальной, так и в локальной библиотечной средах, локальная
среда имеет приоритет при объединении двух библиотечных сред.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.25pt;text-indent:-14.95pt'><span lang=RU style='line-height:
104%'>В.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
lang=RU>Наконец, библиотека сообщений, хранящаяся в поле библиотеки поля </span><span
lang=EN-US>init</span><span lang=RU> входящего сообщения, также учитывается.
Обратите внимание, однако, что если учетная запись заморожена или не
инициализирована, поле библиотеки сообщения является частью предлагаемого
состояния учетной записи и используется вместо локальной среды библиотеки на
предыдущем шаге. Библиотека сообщений имеет более низкий приоритет, чем
локальная и глобальная библиотечные среды.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>4.4.4. Исходное состояние ТВМ. Новый
экземпляр </span><span lang=EN-US>TVM</span><span lang=RU> инициализируется
перед выполнением смарт-контракта следующим образом:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Исходный </span><span lang=EN-US>cc</span><span
lang=RU> (текущее продолжение) инициализируется с помощью среза ячейки,
созданного из кода ячейки, содержащего код смарт-контракта, вычисляемого, как
описано в 4.4.1.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Значение </span><span lang=EN-US>cp</span><span
lang=RU> (кодовая страница </span><span lang=EN-US>TVM</span><span lang=RU>)
равно нулю. Если смарт-контракт хочет использовать другую кодовую страницу </span><span
lang=EN-US>TVM</span><span lang=EN-US> </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>x</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, он должен переключиться на нее, используя
</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>SETCODEPAGE</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>x</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>в качестве первой
инструкции своего кода.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Регистр управления </span><span lang=EN-US>c</span><span
lang=RU>0 (возвращаемое продолжение) инициализируется экстраординарным
продолжением </span><span lang=EN-US>ec</span><span lang=RU>_</span><span
lang=EN-US>quit</span><span lang=RU> с параметром 0. При выполнении это
продолжение приводит к окончанию </span><span lang=EN-US>TVM</span><span
lang=RU> с кодом выхода 0.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Регистр управления </span><span lang=EN-US>c</span><span
lang=RU>1 (альтернативное возвращаемое продолжение) инициализируется
экстраординарным продолжением </span><span lang=EN-US>ec</span><span lang=RU>_</span><span
lang=EN-US>quit</span><span lang=RU> с параметром 1. При вызове это приводит к
завершению </span><span lang=EN-US>TVM</span><span lang=RU> с кодом выхода 1.
(Обратите внимание, что завершение с кодом выхода 0 или 1 считается успешным
прекращением.)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Регистр управления </span><span lang=EN-US>c</span><span
lang=RU>2 (обработчик исключений) инициализируется экстраординарным
продолжением </span><span lang=EN-US>ec</span><span lang=RU>_</span><span
lang=EN-US>quit</span><span lang=RU>_</span><span lang=EN-US>exc</span><span
lang=RU>. При вызове он берет верхнее целое число из стека (равное номеру
исключения) и завершает </span><span lang=EN-US>TVM</span><span lang=RU> кодом
выхода, равным этому целому числу. Таким образом, по умолчанию все исключения
прекращают выполнение смарт-контракта с кодом выхода, равным номеру исключения.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=EN-US style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Регистр управления </span><span lang=EN-US>c</span><span
lang=RU>3 (словарь кода) инициализируется ячейкой с кодом смарт-контракта,
аналогично начальному текущему продолжению </span><span lang=EN-US>(cc).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:13.35pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Регистр управления </span><span lang=EN-US>c</span><span
lang=RU>4 (корень постоянных данных) инициализируется постоянными данными
смарт-контракта.</span><a href="#_ftn35" name="_ftnref35" title=""><sup><span
lang=EN-US><sup><span lang=EN-US style='font-size:12.0pt;line-height:104%;
font-family:"Calibri",sans-serif;color:black'>[35]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Регистр управления </span><span lang=EN-US>c</span><span
lang=RU>5 (корень действий) инициализируется пустой ячейкой. Примитивы
«выходного действия» </span><span lang=EN-US>TVM</span><span lang=RU>, такие
как </span><span lang=EN-US>SENDMSG</span><span lang=RU>, используют </span><span
lang=EN-US>c</span><span lang=RU>5 для накопления списка действий (например,
исходящих сообщений), которые должны быть выполнены после успешного прекращения
смарт-контракта (см. 4.2.7 и 4.2.8).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Регистр управления </span><span lang=EN-US>c</span><span
lang=RU>7 (корень временных данных) инициализируется одноэлементным <i>кортежем,
единственным компонентом которого является Кортеж, </i>содержащий экземпляр </span><i><span
lang=EN-US>SmartContractInfo</span></i><i><span lang=EN-US> </span></i><span
lang=RU>со смарт-контрактным балансом и другой полезной информацией (см.
4.4.10). Смарт-контракт может заменить временные данные, особенно все
компоненты <i>Кортежа </i>в </span><span lang=EN-US>c</span><span lang=RU>7,
кроме первого, любыми другими временными данными, которые ему могут
потребоваться. Однако исходное содержимое </span><i><span lang=EN-US>SmartContractInfo</span></i><i><span
lang=EN-US> </span></i><span lang=RU>в первом компоненте <i>Кортежа, </i>хранящемся
в </span><span lang=EN-US>c</span><span lang=RU>7, проверяется и иногда
модифицируется примитивами </span><span lang=EN-US>SENDMSG</span><span
lang=EN-US> </span><span lang=EN-US>TVM</span><span lang=RU> и другими
примитивами «выходного действия» </span><span lang=EN-US>TVM</span><span
lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:11.7pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Газовые пределы </span><i><span lang=EN-US>gas</span></i><span
lang=EN-US> </span><span lang=RU style='font-family:"Cambria",serif'>= (</span><span
lang=EN-US style='font-family:"Cambria",serif'>g<sub>m</sub></span><span
lang=RU style='font-family:"Cambria",serif'>,</span><span lang=EN-US
style='font-family:"Cambria",serif'>g<sub>l</sub></span><span lang=RU
style='font-family:"Cambria",serif'>,</span><span lang=EN-US style='font-family:
"Cambria",serif'>g<sub>c</sub></span><span lang=RU style='font-family:"Cambria",serif'>,</span><span
lang=EN-US style='font-family:"Cambria",serif'>g<sub>r</sub></span><span
lang=RU style='font-family:"Cambria",serif'>) </span><span lang=RU>инициализируются
следующим образом:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.6pt;
margin-left:55.05pt;text-indent:-12.6pt'><span lang=RU style='line-height:104%'>–<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span><span
lang=RU>Максимальный <i>лимит газа </i></span><i><span lang=EN-US
style='font-family:"Cambria",serif'>gm</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>устанавливается
на меньший из общего баланса </span><span lang=EN-US>Gram</span><span lang=RU>
смарт-контракта (после кредитной фазы, то есть в сочетании со значением
входящего сообщения), деленный на текущую цену газа, либо глобальный лимит газа
на исполнение.</span><a href="#_ftn36" name="_ftnref36" title=""><sup><span
lang=EN-US><sup><span lang=EN-US style='font-size:12.0pt;line-height:104%;
font-family:"Calibri",sans-serif;color:black'>[36]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:6.0pt;
margin-left:55.05pt;text-indent:-12.6pt'><span lang=RU style='line-height:104%'>–<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span><span
lang=RU>Текущий <i>предел газа </i></span><i><span lang=EN-US style='font-family:
"Cambria",serif'>g<sub>l</sub></span></i><i><span lang=EN-US style='font-family:
"Cambria",serif'> </span></i><span lang=RU>устанавливается на меньшее значение
либо Грамма входящего сообщения, деленное на цену газа, либо глобального
предела газа на исполнение. Таким образом, всегда </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>g<sub>l</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'> ≤ </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>g<sub>m</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>. Для входящих внешних сообщений </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>g<sub>l</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= 0, так как они не могут нести никакого
значения.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:6.05pt;
margin-left:55.05pt;text-indent:-12.6pt'><span lang=RU style='line-height:104%'>–<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span><span
lang=RU>Газовый <i>кредит </i></span><i><span lang=EN-US style='font-family:
"Cambria",serif'>g<sub>c</sub></span></i><i><span lang=EN-US style='font-family:
"Cambria",serif'> </span></i><span lang=RU>устанавливается равным нулю для
входящих внутренних сообщений и меньшим из </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>gm</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>или фиксированным
малым значением (по умолчанию внешнее сообщение </span><span lang=EN-US>gas</span><span
lang=EN-US> </span><span lang=EN-US>credit</span><span lang=RU>, настраиваемый
параметр) для входящих внешних сообщений.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:6.35pt;
margin-left:55.05pt;text-indent:-12.6pt;line-height:127%'><span lang=RU
style='line-height:127%'>–<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;
</span></span><span lang=RU>Наконец, оставшийся <i>предел газа </i></span><i><span
lang=EN-US style='font-family:"Cambria",serif'>g<sub>r</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>автоматически
инициализируется </span><i><span lang=EN-US style='font-family:"Cambria",serif'>g<sub>l</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>+ </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>g<sub>c</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>4.4.5. Исходный стек </span><span lang=EN-US>TVM</span><span
lang=RU> для обработки внутреннего сообщения. После инициализации </span><span
lang=EN-US>TVM</span><span lang=RU>, как описано в 4.4.4, его стек
инициализируется путем отправки аргументов в функцию </span><span lang=EN-US>main</span><span
lang=RU>() смарт-контракта следующим образом:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Граммовый баланс </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>b</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>смарт-контракта
(после зачисления значения входящего сообщения) передается как <i>целое </i>количество
нанограммов.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Грамм баланса </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>b<sub>m</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>входящего
сообщения </span><i><span lang=EN-US style='font-family:"Cambria",serif'>m</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>передается
как <i>целое количество </i>нанограммов.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Входящее сообщение </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>передается в виде
ячейки, содержащей сериализованное значение типа </span><i><span lang=EN-US>Message</span></i><i><span
lang=EN-US> </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>X</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, где </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>X</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>— тип тела
сообщения.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Тело </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>m<sub>b</sub></span></i><i><span lang=EN-US style='font-family:
"Cambria",serif'> </span></i><span lang=RU style='font-family:"Cambria",serif'>:
</span><i><span lang=EN-US style='font-family:"Cambria",serif'>X</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>входящего
сообщения, равное значению тела поля </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, передается как срез ячейки.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.3pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Наконец, <i>селектор функций </i></span><i><span
lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, целое </span></i><i><span lang=RU>число</span></i><span
lang=RU>, обычно равное нулю, помещается в стек.</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:9.15pt;margin-left:-.25pt;text-align:left;line-height:103%'><span
lang=RU>После этого выполняется код смарт-контракта, равный его начальному
значению </span><span lang=EN-US>c</span><span lang=RU>3. Он выбирает
правильную функцию в соответствии с </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>s</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, которая, как ожидается, обработает
оставшиеся аргументы функции и завершится впоследствии.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.1pt;
margin-left:-.25pt'><span lang=RU>4.4.6. Обработка входящего внешнего
сообщения. Входящее внешнее сообщение обрабатывается аналогично разделам 4.4.4
и 4.4.5 со следующими изменениями:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Селектору функций </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>s</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>присвоено
значение </span><span lang=RU style='font-family:"Cambria",serif'>−1, а не 0.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Баланс </span><span lang=EN-US>Gram</span><span
lang=EN-US> </span><i><span lang=EN-US style='font-family:"Cambria",serif'>b<sub>m</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>входящего
сообщения всегда равен 0.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Начальный предел тока газа </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>g<sub>l</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>всегда
равен 0. Однако первоначальный газовый кредит </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>g<sub>c</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'> &gt; </span></i><span lang=RU
style='font-family:"Cambria",serif'>0.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.1pt;
margin-left:-.25pt'><span lang=RU>Смарт-контракт должен расторгнуться с </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>g<sub>c</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= 0 </span><span lang=RU>или </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>g<sub>r</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>≥ </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>g<sub>c</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>; в противном случае транзакция и блок,
содержащий ее, являются недействительными. Валидаторы или коллаторы,
предполагающие кандидат на блок, никогда не должны включать транзакции,
обрабатывающие входящие внешние сообщения, которые являются недопустимыми.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.15pt;
margin-left:-.25pt'><span lang=RU>4.4.7. Обработка тиковых и такковых
транзакций. Стек </span><span lang=EN-US>TVM</span><span lang=RU> для обработки
тиковых и так-транзакций (см. 4.2.4) инициализируется нажатием следующих
значений:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Граммовый баланс </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>b</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>текущего счета в
нанограммах (<i>целое число).</i></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>256-битный адрес </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>текущего счета
внутри мастерчейна, представленный целым числом без знака.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Целое число, равное </span><span lang=RU
style='font-family:"Cambria",serif'>0 </span><span lang=RU>для тиковых
транзакций и </span><span lang=RU style='font-family:"Cambria",serif'>−1 </span><span
lang=RU>для транзакций </span><span lang=EN-US>tock</span><span lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=EN-US style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=EN-US>Селектор функций </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>s, равный </span></i><span lang=EN-US
style='font-family:"Cambria",serif'>−2.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>4.4.8. Обработка сплит-подготовки транзакций.
Для обработки транзакций </span><span lang=EN-US>split</span><span lang=EN-US> </span><span
lang=EN-US>prepare</span><span lang=RU> (см. 4.3.13) стек </span><span
lang=EN-US>TVM</span><span lang=RU> инициализируется нажатием следующих
значений:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Граммовый остаток </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>b</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>текущего счета.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.6pt;
margin-left:29.3pt;text-indent:-11.85pt;line-height:108%'><span lang=EN-US
style='line-height:108%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=EN-US>Фрагмент <i>,</i> содержащий <i>SplitMergeInfo </i>(см.
4.3.13).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:13.5pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>256-битный адрес </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>текущего счета.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:4.35pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>256-разрядный адрес </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> ̃ </span></i><span lang=RU>учетной записи
брата или сестры.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:6.55pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Целое число </span><span lang=RU style='font-family:
"Cambria",serif'>0 ≤ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>d</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>≤ 63, равное положению единственного бита,
в котором </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> ̃ </span></i><span lang=RU>отличаются.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=EN-US style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=EN-US>Селектор функций </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>s, равный </span></i><span lang=EN-US
style='font-family:"Cambria",serif'>−3.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>4.4.9. Обработка слияний установочных
транзакций. Для обработки транзакций </span><span lang=EN-US>merge</span><span
lang=EN-US> </span><span lang=EN-US>install</span><span lang=RU> (см. 4.3.14)
стек </span><span lang=EN-US>TVM</span><span lang=RU> инициализируется путем
отправки следующих значений:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Граммовый остаток </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>b</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>текущего счета
(уже в сочетании с Граммовым балансом счета брата или сестры).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Граммовый баланс </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>b</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>счета братьев и
сестер, взятый из входящего сообщения </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:13.6pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=EN-US style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Сообщение </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>m</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>из родительской
учетной записи, автоматически генерируемое транзакцией подготовки слияния. </span><span
lang=EN-US>Поле init содержит конечное состояние </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>S ̃ </span></i><span lang=EN-US>родительского
счета.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:3.9pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Положение </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>S</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> ̃ </span></i><span lang=RU
style='font-family:"Cambria",serif'>родственной учетной записи</span><span
lang=RU>, представленное </span><i><span lang=EN-US>StateInit</span></i><i><span
lang=EN-US> </span></i><span lang=RU>(см. 3.1.7).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.6pt;
margin-left:29.3pt;text-indent:-11.85pt;line-height:108%'><span lang=EN-US
style='line-height:108%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=EN-US>Фрагмент <i>,</i> содержащий <i>SplitMergeInfo </i>(см.
4.3.13).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:13.45pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>256-битный адрес </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>текущего счета.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:4.35pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>256-разрядный адрес </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> ̃ </span></i><span lang=RU>учетной записи
брата или сестры.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:6.55pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Целое число </span><span lang=RU style='font-family:
"Cambria",serif'>0 ≤ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>d</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>≤ 63, равное положению единственного бита,
в котором </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> ̃ </span></i><span lang=RU>отличаются.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=EN-US style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=EN-US>Селектор функций </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>s, равный </span></i><span lang=EN-US
style='font-family:"Cambria",serif'>−4.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>4.4.10. Информация о смарт-контракте.
Информационная структура смарт-контракта </span><i><span lang=EN-US>SmartContractInfo</span></i><i><span
lang=RU>, переданная в первом компоненте Кортежа, </span></i><span lang=RU>содержащемся
в управляющем регистре </span><span lang=EN-US>c</span><span lang=RU>7, также
является <i>Кортежем</i>, содержащим следующие данные:</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:-12.3pt'><span
lang=EN-US>[ magic:0x076ef1ea actions:Integer msgs_sent:Integer </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:-4.45pt'><span
lang=EN-US>unixtime:Integer block_lt:Integer trans_lt:Integer </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:-4.45pt'><span
lang=EN-US>rand_seed:Integer balance_remaining:[Integer (Maybe Cell)]</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:-4.45pt'><span
lang=EN-US>myself:MsgAddressInt global_config:(Maybe Cell)</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=RU>] = </span><span
lang=EN-US>SmartContractInfo</span><span lang=RU>;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:1.4pt;
margin-left:-.25pt'><span lang=RU>Другими словами, первый компонент этого кортежа
— это магия <i>целочисленного числа</i>, всегда равная 0</span><span
lang=EN-US>x</span><span lang=RU>076</span><span lang=EN-US>ef</span><span
lang=RU>1</span><span lang=EN-US>ea</span><span lang=RU>, второй компонент — <i>целочисленные
</i>действия, первоначально инициализированные нулем, но приращенные на единицу
всякий раз, когда выходное действие устанавливается примитивом выходного
действия </span><span lang=EN-US>TVM</span><span lang=RU>, отличным от </span><span
lang=EN-US>RAW</span><span lang=RU>, и так далее. Оставшийся баланс представлен
парой, т.е. двухкомпонентным <i>кортежем: первый компонент представляет собой
нанограммовый баланс, а второй компонент представляет собой словарь с
32-битными ключами, представляющими все остальные валюты, если таковые имеются
(см. 3.1.6).</i></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Поле </span><span
lang=EN-US>rand</span><span lang=RU>_</span><span lang=EN-US>seed</span><span
lang=RU> (256-битное целое число без знака) здесь инициализируется
детерминированно, начиная с </span><span lang=EN-US>rand</span><span lang=RU>_</span><span
lang=EN-US>seed</span><span lang=RU> блока, адреса учетной записи, хэша
обрабатываемого входящего сообщения (если таковое имеется) и логического
времени транзакции </span><span lang=EN-US>trans</span><span lang=RU>_</span><span
lang=EN-US>lt</span><span lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.1pt;
margin-left:-.25pt'><span lang=RU>4.4.11. Сериализация выходных действий.
Выходные <i>действия </i>смарт-контракта аккумулируются в связанном списке,
хранящемся в управляющем регистре </span><span lang=EN-US>c</span><span
lang=RU>5. Список выходных действий сериализуется как значение типа </span><i><span
lang=EN-US>OutList</span></i><i><span lang=EN-US> </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, где </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>n</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>— длина списка:</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:76.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>out_list_empty$_
= OutList 0; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:76.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>out_list$_
{n:#} prev:^(OutList n) action:OutAction</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:21.45pt;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:12.3pt'><span
lang=EN-US>= OutList (n + 1); </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:21.45pt;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:0cm'><span
lang=EN-US>action_send_msg#0ec3c86d out_msg:^(Message Any) = OutAction;
action_set_code#ad4de08e new_code:^Cell = OutAction;</span></p>

</div>

<span lang=EN-US style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'><br clear=all style='page-break-before:always'>
</span>

<div class=WordSection19>

<h1 style='margin-left:27.1pt;text-indent:-18.0pt'><a name="_Toc150778"><span
lang=EN-US>5<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>Компоновка блоков</span></a></h1>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>В этой главе представлен макет блока,
используемый блокчейном </span><span lang=EN-US>TON</span><span lang=RU>,
объединяющий структуры данных, описанные отдельно в предыдущих главах, чтобы
получить полное описание блока </span><span lang=EN-US>shardchain</span><span
lang=RU>. В дополнение к схемам </span><span lang=EN-US>TL</span><span lang=RU>-</span><span
lang=EN-US>B</span><span lang=RU>, определяющим представление блока </span><span
lang=EN-US>shardchain</span><span lang=RU> деревом ячеек, в этой главе
описываются точные форматы сериализации для результирующих пакетов (коллекций)
ячеек, которые необходимы для представления блока </span><span lang=EN-US>shardchain</span><span
lang=RU> в виде файла.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:21.75pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Блоки </span><span
lang=EN-US>Masterchain</span><span lang=RU> похожи на блоки </span><span
lang=EN-US>shardchain</span><span lang=RU>, но имеют некоторые дополнительные
поля. </span><span lang=EN-US>Необходимые изменения рассматриваются отдельно в
разделе 5.2.</span></p>

<h2 style='margin-left:35.2pt;text-indent:-36.0pt'><a name="_Toc150779"><span
lang=EN-US>5.1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>Схема блока Шардчейн</span></a></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>В этом разделе перечислены структуры данных,
которые должны содержаться в блоке </span><span lang=EN-US>shardchain</span><span
lang=RU> и в состоянии </span><span lang=EN-US>shardchain</span><span lang=RU>,
и завершается представлением формальной схемы </span><span lang=EN-US>TL</span><span
lang=RU>-</span><span lang=EN-US>B</span><span lang=RU> для блока </span><span
lang=EN-US>shardchain</span><span lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:9.95pt;
margin-left:-.25pt;line-height:110%'><span lang=RU>5.1.1. Компоненты состояния
шардчейна. Штат шардчейн состоит из:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=EN-US>ShardAccounts</span></i><i><span lang=RU>,
разделенная часть состояния </span><span lang=EN-US>shardchain</span></i><i><span
lang=RU> (см. 1.2.2), содержащая состояние всех учетных записей, назначенных
этому сегменту (см. 4.1.9).</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=EN-US>OutMsgQueue</span></i><i><span lang=RU>,
очередь выходных сообщений </span><span lang=EN-US>shardchain</span></i><i><span
lang=RU> (см. 3.3.6).</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=EN-US>SharedLibraries</span></i><i><span lang=RU>,
описание всех разделяемых библиотек </span><span lang=EN-US>shardchain</span></i><i><span
lang=RU> (пока непустые только в мастерчейне).</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Логическое время и </span><span lang=EN-US>unixtime</span><span
lang=RU> последнего изменения состояния.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=EN-US style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=EN-US>Общий баланс сегмента.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Хэш-ссылка на самый последний блок мастерчейна,
косвенно описывающая состояние мастерчейна и, через него, состояние всех других
шардчейнов блокчейна </span><span lang=EN-US>TON</span><span lang=RU> (ср.
1.5.2).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:9.95pt;
margin-left:-.25pt;line-height:110%'><span lang=RU>5.1.2. Компоненты
шардчейного блока. Блок </span><span lang=EN-US>shardchain</span><span lang=RU>
должен содержать:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Список <i>проверяющих подписей </i>(см. 1.2.6),
который является внешним по отношению ко всему остальному содержимому блока.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=EN-US>BlockHeader</span></i><i><span lang=RU>,
содержащий общую информацию о блоке (см. 1.2.5)</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Хэш ссылается на непосредственно предшествующий
блок или блоки того же шардчейна, а также на самый последний блок мастерчейна.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=EN-US>InMsgDescr</span></i><i><span lang=EN-US> </span></i><span
lang=RU>и </span><i><span lang=EN-US>OutMsgDescr</span></i><i><span lang=RU>,
дескрипторы входящих и исходящих сообщений (см. 3.2.8 и 3.3.5).</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=EN-US style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=EN-US>ShardAccountBlocks</span></i><i><span
lang=RU>, сбор всех транзакций, обработанных в блоке (см. 4.2.17) вместе со
всеми обновлениями состояний учетных записей, назначенных сегменту. </span><span
lang=EN-US>Это разделенная </span></i><span lang=EN-US>часть блока шардчейна
(ср. 1.2.2).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Поток значений,<i> описывающий общее значение,
импортированное из предыдущих блоков одной и той же цепочки сегментов и из
входящих сообщений, общее значение, экспортируемое исходящим сообщением, общее
значение, собранное проверяющими, и общее значение, оставшееся в сегменте.</i></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:12.0pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Обновление <i>Меркла </i>(ср. [4, 3.1]) состояния
шардчейна. Такое обновление Меркла содержит хэши начального и конечного
состояний шардчейна относительно блока, а также все новые ячейки конечного
состояния, которые были созданы при обработке блока.</span><a href="#_ftn37"
name="_ftnref37" title=""><sup><span lang=EN-US><sup><span lang=EN-US
style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'>[37]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.65pt;
margin-left:-.25pt'><span lang=RU>5.1.3. Общие части блочной компоновки для
всех рабочих цепей. Напомним, что разные рабочие цепи могут определять
собственные правила обработки сообщений, другие типы транзакций, другие
компоненты состояния и другие способы сериализации всех этих данных. Однако
некоторые компоненты блока и его состояние должны быть общими для всех рабочих
цепей, чтобы поддерживать взаимодействие между различными рабочими цепочками. </span><span
lang=EN-US>К таким общим компонентам относятся:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=EN-US>OutMsgQueue</span></i><i><span lang=RU>,
очередь исходящих сообщений </span><span lang=EN-US>shardchain</span></i><i><span
lang=RU>, которая сканируется соседними </span><span lang=EN-US>shardchains</span></i><i><span
lang=RU> на наличие адресованных им сообщений.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Внешняя структура </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>в виде хэш-карты с 256-битными ключами,
равными хэшам импортированных сообщений. (Сами дескрипторы входящих сообщений
не обязательно должны иметь одинаковую структуру.)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Некоторые поля в заголовке блока, идентифицирующие </span><span
lang=EN-US>shardchain</span><span lang=RU> и блок, а также пути от заголовка
блока к другой информации, указанной в этом списке.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.35pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=EN-US style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=EN-US>Сведения о потоке значений.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:7.7pt;
margin-left:-.25pt'><span lang=RU>5.1.4. Схема </span><span lang=EN-US>TL</span><span
lang=RU>-</span><span lang=EN-US>B</span><span lang=RU> для состояния шардчейн.
Состояние шардчейна (см. 1.2.1 и 5.1.1) сериализуется по следующей схеме </span><span
lang=EN-US>TL</span><span lang=RU>-</span><span lang=EN-US>B</span><span
lang=RU>:</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left;line-height:103%'><span
lang=EN-US>ext_blk_ref$_ start_lt:uint64 end_lt:uint64</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:56.4pt;
margin-bottom:1.8pt;margin-left:-.75pt;text-align:left;text-indent:12.3pt;
line-height:197%'><span lang=EN-US>seq_no:uint32 хэш:uint256 = ExtBlkRef; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:56.4pt;
margin-bottom:1.8pt;margin-left:.5pt;text-align:left;line-height:197%'><span
lang=EN-US>master_info$_ master:ExtBlkRef = BlkMasterInfo;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left;line-height:103%'><span
lang=EN-US>shard_ident$00 shard_pfx_bits:(## 6)</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>workchain_id:int32 shard_prefix:uint64 = ShardIdent;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left;line-height:103%'><span
lang=EN-US>shard_state shard_id:ShardIdent</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:124.1pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>out_msg_queue:OutMsgQueue total_balance:CurrencyCollection
total_validator_fees:CurrencyCollection accounts:ShardAccounts </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:124.1pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>libraries:(HashmapE 256 LibDescr) master_ref:(Maybe BlkMasterInfo) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:124.1pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>custom</span><span lang=RU>:(</span><span lang=EN-US>Maybe</span><span
lang=RU> ^</span><span lang=EN-US>McStateExtra</span><span lang=RU>)</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=RU>= </span><span lang=EN-US>ShardState</span><span lang=RU>;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:9.15pt;margin-left:-.25pt;text-align:left;line-height:103%'><span
lang=RU>Пользовательское поле обычно присутствует только в мастерчейне и
содержит все данные, специфичные для мастерчейна. Однако другие рабочие цепи
могут использовать ту же ссылку на ячейку для ссылки на свои конкретные данные
о состоянии.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:7.95pt;
margin-left:-.25pt'><span lang=RU>5.1.5. Описание разделяемых библиотек.
Разделяемые библиотеки в настоящее время могут присутствовать только в блоках
мастерчейна. Они описываются экземпляром </span><i><span lang=EN-US>HashmapE</span></i><i><span
lang=RU>(256,</span><span lang=EN-US>LibDescr</span></i><i><span lang=RU>), где
256-битный ключ является хэшем представления библиотеки, а </span><span
lang=EN-US>LibDescr</span></i><i><span lang=EN-US> </span></i><span lang=RU>описывает
одну библиотеку:</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:19.55pt;
margin-bottom:1.8pt;margin-left:11.6pt;text-align:left;text-indent:-12.3pt'><span
lang=EN-US>shared_lib_descr$00 lib:^Cell publishers:(Hashmap 256 True) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:19.55pt;
margin-bottom:1.8pt;margin-left:11.6pt;text-align:left;text-indent:2.65pt'><span
lang=RU>= </span><span lang=EN-US>LibDescr</span><span lang=RU>;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Здесь </span><span lang=EN-US>publishers</span><span
lang=RU> представляет собой хэш-карту с ключами, равными адресам всех учетных
записей, опубликовавших соответствующую разделяемую библиотеку. Разделяемая
библиотека сохраняется до тех пор, пока хотя бы одна учетная запись хранит ее в
своей коллекции опубликованных библиотек.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.0pt;
margin-left:-.25pt'><span lang=RU>5.1.6. Схема </span><span lang=EN-US>TL</span><span
lang=RU>-</span><span lang=EN-US>B</span><span lang=RU> для блока
неподписанного шардчейна. Точный формат <i>беззнакового </i>(ср. 1.2.6) блока
шардчейна задается следующей схемой </span><span lang=EN-US>TL</span><span
lang=RU>-</span><span lang=EN-US>B</span><span lang=RU>:</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>block_info
версия:uint32</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:56.45pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>not_master:(##
1) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:56.45pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>after_merge:(##
1) before_split:(## 1) flags:(## 13) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:56.45pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>seq_no:#
vert_seq_no:# </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:56.45pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>shard:ShardIdent
gen_utime:uint32 </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:56.45pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>start_lt:uint64
end_lt:uint64 master_ref:not_master?^BlkMasterInfo
prev_ref:seq_no?^(BlkPrevInfo after_merge) prev_vert_ref:vert_seq_no?^(BlkPrevInfo
0)</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>= BlockInfo;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>prev_blk_info#_
{merged:#} prev:ExtBlkRef</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>prev_alt:merged?
ExtBlkRef = BlkPrevInfo merged;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>unsigned_block
info:^BlockInfo value_flow:^ValueFlow</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:25.65pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>state_update:^(MERKLE_UPDATE
ShardState) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:25.65pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>extra:^BlockExtra
= Block;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:25.65pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:68.7pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:-12.3pt'><span
lang=EN-US>block_extra in_msg_descr:^InMsgDescr</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:68.7pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:2.65pt'><span
lang=EN-US>out_msg_descr:^OutMsgDescr</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:68.7pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:2.65pt'><span
lang=EN-US>account_blocks:ShardAccountBlocks </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:68.7pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:2.65pt'><span
lang=EN-US>rand_seed:uint256</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:68.7pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:2.65pt'><span
lang=EN-US>custom</span><span lang=RU>:(</span><span lang=EN-US>Maybe</span><span
lang=RU> ^</span><span lang=EN-US>McBlockExtra</span><span lang=RU>) = </span><span
lang=EN-US>BlockExtra</span><span lang=RU>;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:9.15pt;margin-left:-.25pt;text-align:left;line-height:103%'><span
lang=RU>&nbsp;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:9.15pt;margin-left:-.25pt;text-align:left;line-height:103%'><span
lang=RU>Пользовательское поле обычно присутствует только в мастерчейне и
содержит все данные, специфичные для мастерчейна. Однако другие рабочие цепи
могут использовать ту же ссылку на ячейку для ссылки на свои конкретные блочные
данные.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.15pt;
margin-left:-.25pt'><span lang=RU>5.1.7. Описание общего значения потока через
блок. Общий поток значений через блок сериализуется по следующей схеме </span><span
lang=EN-US>TL</span><span lang=RU>-</span><span lang=EN-US>B</span><span
lang=RU>:</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:-.6pt'><span
lang=EN-US>value_flow _:^[ from_prev_blk:CurrencyCollection</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:13.55pt'><span
lang=EN-US>to_next_blk: CurrencyCollection</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:13.55pt'><span
lang=EN-US>imported: CurrencyCollection exported: CurrencyCollection ] </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:13.55pt'><span
lang=EN-US>fees_collected: CurrencyCollection</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:13.55pt'><span
lang=EN-US>_:^[ </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:13.55pt'><span
lang=EN-US>fees_imported: CurrencyCollection </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:13.55pt'><span
lang=EN-US>created: CurrencyCollection </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:13.55pt'><span
lang=EN-US>minted: CurrencyCollection</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:13.55pt'><span
lang=EN-US>] = ValueFlow;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:7.6pt;
margin-left:-.25pt'><span lang=RU>Напомним, что _:ˆ[...] — это конструкция </span><span
lang=EN-US>TL</span><span lang=RU>-</span><span lang=EN-US>B</span><span
lang=RU>, указывающая на то, что группа полей была перемещена в отдельную
ячейку. Последние три поля могут быть ненулевыми только в блоках мастерчейна.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:13.3pt;
margin-left:-.25pt'><span lang=RU>5.1.8. Подписанный шардчейн блок. Подписанный
блок </span><span lang=EN-US>shardchain</span><span lang=RU> — это просто
неподписанный блок, дополненный коллекцией подписей валидатора: </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:13.3pt;
margin-left:-.25pt'><span lang=EN-US>ed25519_signature#5 R:uint256 s:uint256 = CryptoSignature;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:.5pt;margin-left:-.25pt;text-align:left;line-height:103%'><span
lang=EN-US>signed_block block:^Block blk_serialize_hash:uint256</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>signatures:(HashmapE 64 CryptoSignature)</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:6.9pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>= SignedBlock;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:7.35pt;
margin-left:-.25pt'><span lang=EN-US> </span><i><span lang=RU>Хэш сериализации 
</span><span lang=EN-US>blk</span></i><i><span lang=RU>_</span><span
lang=EN-US>serialize</span></i><i><span lang=RU>_</span><span lang=EN-US>hash</span></i><i><span
lang=EN-US> </span></i><span lang=RU>неподписанного блока </span><i><span
lang=EN-US>block</span></i><i><span lang=EN-US> </span></i><span lang=EN-US> </span><span
lang=RU>по существу является хэшем конкретной сериализации блока в строку октета
(см. 5.3.12 для более подробного объяснения). Подписи, собранные в подписях,
представляют собой подписи </span><span lang=EN-US>Ed</span><span lang=RU>25519
(ср. </span><span lang=EN-US>A</span><span lang=RU>.3), сделанные с помощью
закрытых ключей валидатора </span><span lang=EN-US>sha</span><span lang=RU>256
объединения 256-битного хэша представления блока и его 256-битного хэш-</span><span
lang=EN-US>blk</span><span lang=RU>_</span><span lang=EN-US>serialize</span><span
lang=RU>_</span><span lang=EN-US>hash</span><span lang=RU> сериализации.
64-битные ключи в словарных сигнатурах представляют собой первые 64 бита
открытых ключей соответствующих валидаторов.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:6.35pt;
margin-left:-.25pt'><span lang=RU>5.1.9. Сериализация подписанного блока. Общая
процедура сериализации и подписания блока может быть описана следующим образом:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.25pt;
margin-left:29.25pt;text-indent:-14.95pt'><span lang=RU style='line-height:
104%'>А.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
lang=RU>Генерируется беззнаковый блок </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>B</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>,</span></i><span lang=RU> преобразуется в
полный мешок ячеек (см. 5.3.2) и сериализуется в строку октета </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>S<sub>B</sub></span></i><i><span
lang=RU style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:3.8pt;
margin-left:29.25pt;text-indent:-14.95pt'><span lang=EN-US style='line-height:
104%'>Б.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
lang=EN-US>Валидаторы подписывают 256-битный комбинированный хэш</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:-.7pt;
margin-bottom:6.15pt;margin-left:0cm;text-align:left;text-indent:0cm;
line-height:107%'><span lang=EN-US style='font-size:11.0pt;line-height:107%'>                                          </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>HB </span></i><span lang=EN-US
style='font-family:"Cambria",serif'>:= </span><span lang=EN-US>sha256 (Hash<sub>∞</sub>(B).
Hash<sub>M</sub>(S<sub>B</sub>))                       (18)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.75pt'><span lang=RU>хэша представления </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>B</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>и хэша Меркла его
сериализации </span><i><span lang=EN-US style='font-family:"Cambria",serif'>S<sub>B</sub></span></i><i><span
lang=RU style='font-family:"Cambria",serif'>.</span></i></p>

</div>

<span lang=RU style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'><br clear=all style='page-break-before:always'>
</span>

<div class=WordSection20>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:13.1pt;
margin-left:29.25pt;text-indent:-14.95pt'><span lang=RU style='line-height:
104%'>В.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
lang=RU>Подписанный шардчейн блок </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>B</span></i><i><span lang=RU style='font-family:"Cambria",serif'>
̃ </span></i><span lang=RU>генерируется из </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>B</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>и этих сигнатур
валидатора, как описано выше (см. 5.1.8).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.25pt;
margin-left:29.25pt;text-indent:-14.95pt'><span lang=RU style='line-height:
104%'>Г.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
lang=RU>Этот знаковый блок </span><i><span lang=EN-US style='font-family:"Cambria",serif'>B</span></i><i><span
lang=RU style='font-family:"Cambria",serif'> ̃ </span></i><span lang=RU>преобразуется
в неполный мешок ячеек, который содержит только сигнатуры валидатора, но сам
неподписанный блок отсутствует в этом мешке ячеек, являясь его единственной
отсутствующей ячейкой.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.35pt;
margin-left:29.25pt;text-indent:-14.95pt'><span lang=RU style='line-height:
104%'>Д.<span style='font:7.0pt "Times New Roman"'>&nbsp; </span></span><span
lang=RU>Этот неполный мешок ячеек сериализуется, и его сериализация
предшествует ранее построенной сериализации беззнакового блока.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:21.4pt;
margin-left:-.25pt'><span lang=RU>Результатом является сериализация знакового
блока в строку октета. Он может распространяться по сети или храниться в файле
диска.</span></p>

<h2 style='margin-left:35.2pt;text-indent:-36.0pt'><a name="_Toc150780"><span
lang=EN-US>5.2<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>Макет блока Мастерчейн</span></a></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.15pt;margin-bottom:
10.65pt;margin-left:-.25pt'><span lang=RU>Блоки </span><span lang=EN-US>Masterchain</span><span
lang=RU> очень похожи на блоки </span><span lang=EN-US>shardchain</span><span
lang=RU> основной рабочей цепи. В этом разделе перечислены некоторые изменения,
необходимые для получения описания блока мастерчейна из описания блока </span><span
lang=EN-US>shardchain</span><span lang=RU>, приведенного в 5.1.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.15pt;margin-bottom:
10.65pt;margin-left:-.25pt'><span lang=RU>5.2.1. Дополнительные компоненты,
присутствующие в состоянии мастерчейна. В дополнение к компонентам,
перечисленным в 5.1.1, состояние мастерчейна должно содержать:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=EN-US>ShardHashes</span></i><i><span lang=EN-US> </span></i><span
lang=RU>— описывает текущую конфигурацию сегментов и содержит хэши последних
блоков соответствующих цепей сегментов.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=EN-US>ShardFees</span></i><i><span lang=EN-US> </span></i><span
lang=RU>— описывает общую сумму сборов, собираемых валидаторами каждого
шардчейна.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=EN-US style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=EN-US>ShardSplitMerge</span></i><i><span
lang=EN-US> </span></i><span lang=RU>— описывает будущие события
разделения/слияния сегментов. </span><span lang=EN-US>Он сериализуется как
часть <i>ShardHashes.</i></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=EN-US>ConfigParams</span></i><i><span lang=EN-US> </span></i><span
lang=RU>— Описывает значения всех настраиваемых параметров блокчейна </span><span
lang=EN-US>TON</span><span lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.15pt;margin-bottom:
10.65pt;margin-left:-.25pt'><span lang=RU>5.2.2. Дополнительные компоненты,
присутствующие в блоках мастерчейна. </span><span lang=EN-US>Помимо
компонентов, перечисленных в 5.1.2, каждый блок мастерчейна должен содержать:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.6pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=EN-US>ShardHashes</span></i><i><span lang=EN-US> </span></i><span
lang=RU>— описывает текущую конфигурацию сегментов и содержит хэши последних
блоков соответствующих цепей сегментов. (Обратите внимание, что этот компонент
также присутствует в состоянии мастерчейна.)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.15pt;margin-bottom:
8.35pt;margin-left:-.25pt'><span lang=RU>5.2.3. Описание </span><i><span
lang=EN-US>ShardHashes</span></i><i><span lang=RU>. </span><span lang=EN-US>ShardHashes</span></i><i><span
lang=EN-US> </span></i><span lang=RU>представлен словарем с 32-битными </span><i><span
lang=EN-US>workchain</span></i><i><span lang=RU>_</span><span lang=EN-US>ids</span></i><i><span
lang=RU> в качестве ключей и «двоичными деревьями сегментов», представленными </span><span
lang=EN-US>TL</span></i><i><span lang=RU>-</span><span lang=EN-US>B</span></i><i><span
lang=RU> типа </span><span lang=EN-US>BinTree</span></i><i><span lang=EN-US> </span><span
lang=EN-US>ShardDescr</span></i><i><span lang=RU>, в качестве значений. Каждый
лист этого двоичного дерева сегментов содержит значение типа </span><span
lang=EN-US>ShardDescr</span></i><i><span lang=RU>, которое описывает один
сегмент, указывая порядковый номер </span><span lang=EN-US>seq</span></i><i><span
lang=RU>_</span><span lang=EN-US>no</span></i><i><span lang=RU>, логический
литр времени и хэш-хэш последнего (подписанного) блока соответствующего
шардчейна.</span></i></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:58.4pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>bt_leaf$0
{X:Type} leaf:X = BinTree X; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:58.4pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>bt_fork$1
{X:Type} left:^(BinTree X) right:^(BinTree X)</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:62.0pt;text-align:left'><span lang=EN-US>= BinTree
X;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:101.45pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>fsm_none$0
= FutureSplitMerge; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:101.45pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>fsm_split$10
mc_seqno:uint32 = FutureSplitMerge; fsm_merge$11 mc_seqno:uint32 =
FutureSplitMerge;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:101.45pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:-12.3pt'><span
lang=EN-US>shard_descr$_ seq_no:uint32 lt:uint64 hash:uint256
split_merge_at:FutureSplitMerge = ShardDescr;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:11.55pt;text-align:left;text-indent:-12.3pt'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left'><span lang=EN-US>_
(HashmapE 32 ^(BinTree ShardDescr)) = ShardHashes;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.15pt;margin-bottom:
.8pt;margin-left:-.25pt'><span lang=EN-US>Поля mc_seqno fsm_split и fsm_merge
используются для обозначения будущих событий слияния или разделения сегментов. </span><span
lang=RU>Блоки Шардчейна, относящиеся к блокам мастерчейна с порядковыми
номерами до, но не включая, указанные в </span><span lang=EN-US>mc</span><span
lang=RU>_</span><span lang=EN-US>seqno</span><span lang=RU> генерируются
обычным способом. После достижения указанного порядкового номера должно
произойти событие слияния или разделения сегментов.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.5pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Обратите внимание, что
сам мастерчейн опущен из </span><i><span lang=EN-US>ShardHashes</span></i><i><span
lang=EN-US> </span></i><span lang=RU>(т.е. 32-битный индекс </span><span
lang=RU style='font-family:"Cambria",serif'>−1 </span><span lang=RU>отсутствует
в этом словаре).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.15pt;margin-bottom:
8.15pt;margin-left:-.25pt'><span lang=RU>5.2.4. Описание </span><i><span
lang=EN-US>ShardFees</span></i><i><span lang=RU>. </span><span lang=EN-US>ShardFees</span></i><i><span
lang=EN-US> </span></i><span lang=RU>- это структура мастерчейна, используемая
для отражения общих сборов, собранных до сих пор валидаторами шардчейна. Общие
комиссии, отраженные в этой структуре, накапливаются в мастерчейне путем
зачисления их на специальный счет, адрес которого является настраиваемым
параметром. Обычно эта учетная запись представляет собой смарт-контракт,
который вычисляет и распределяет вознаграждения среди всех валидаторов.</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:-.6pt'><span
lang=EN-US>bta_leaf$0 {X:Type} {Y:Type} leaf:X extra:Y = BinTreeAug X Y; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:-.6pt'><span
lang=EN-US>bta_fork$1 {X:Type} {Y:Type} left:^(BinTreeAug X Y) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:56.05pt'><span
lang=EN-US>right:^(BinTreeAug X Y) extra:Y = BinTreeAug X Y;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:-.6pt'><span
lang=EN-US>_ (HashmapAugE 32 ^(BinTreeAug True CurrencyCollection)</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.9pt;
margin-bottom:1.8pt;margin-left:.6pt;text-align:left;text-indent:13.55pt'><span
lang=EN-US>CurrencyCollection) = ShardFees;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.15pt;margin-bottom:
9.6pt;margin-left:-.25pt'><span lang=EN-US> </span><i><span lang=RU>Структура </span><span
lang=EN-US>ShardFees</span></i><i><span lang=EN-US> </span></i><span lang=RU>аналогична
структуре </span><i><span lang=EN-US>ShardHashes</span></i><i><span lang=EN-US>
</span></i><span lang=RU>(ср. 5.2.3), но словарные и двоичные деревья дополнены
значениями валют, равными значениям </span><span lang=EN-US>total</span><span
lang=RU>_</span><span lang=EN-US>validator</span><span lang=RU>_</span><span
lang=EN-US>fees</span><span lang=RU> конечных состояний соответствующих блоков </span><span
lang=EN-US>shardchain</span><span lang=RU>. Значение, агрегированное в корне </span><i><span
lang=EN-US>ShardFees</span></i><span lang=RU>, добавляется вместе с </span><span
lang=EN-US>total</span><span lang=RU>_</span><span lang=EN-US>validator</span><span
lang=RU>_</span><span lang=EN-US>fees</span><span lang=RU> состояния
мастерчейна, что дает общую плату за валидатор </span><span lang=EN-US>TON</span><span
lang=EN-US> </span><span lang=EN-US>Blockchain</span><span lang=RU>. Увеличение
значения, агрегированного в корне </span><i><span lang=EN-US>ShardFees</span></i><i><span
lang=EN-US> </span></i><span lang=RU>от начального до конечного состояния блока
мастерчейна, отражается в </span><span lang=EN-US>fees</span><span lang=RU>_</span><span
lang=EN-US>imported</span><span lang=RU> в потоке значений этого блока
мастерчейна.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:8.15pt;margin-bottom:
10.65pt;margin-left:-.25pt'><span lang=RU>5.2.5. Описание </span><i><span
lang=EN-US>ConfigParams</span></i><i><span lang=RU>. Напомним, что
настраиваемые параметры </span></i><span lang=RU>или <i>конфигурационный словарь
</i>представляет собой конфигурацию словаря с 32-битными ключами, хранящимися
внутри первой ячейки ссылки на постоянные данные конфигурационного
смарт-контракта </span><i><span lang=EN-US style='font-family:"Cambria",serif'>γ</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>(см.
1.6). Адресная </span><i><span lang=EN-US style='font-family:"Cambria",serif'>γ</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>смарт-контракта
конфигурации и копия конфигурационного словаря дублируются в полях </span><span
lang=EN-US>config</span><span lang=RU>_</span><span lang=EN-US>addr</span><span
lang=RU> и конфигурации <i>структуры </i></span><i><span lang=EN-US>ConfigParams</span></i><i><span
lang=RU>,</span></i><span lang=RU> явно включенных в состояние мастерчейна для
облегчения доступа к текущим значениям настраиваемых параметров (см. 1.6.3):</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:-.25pt;text-align:left;line-height:103%'><span
lang=EN-US>_ config_addr:uint256 config:^(Hashmap 32 ^Cell)</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:10.95pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=RU>= </span><span lang=EN-US>ConfigParams</span><span lang=RU>;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.55pt;
margin-left:-.25pt'><span lang=RU>5.2.6. Данные о состоянии Мастерчейна.
Данные, специфичные для состояния мастерчейна, собираются в </span><i><span
lang=EN-US>McStateExtra</span></i><i><span lang=RU>, уже упомянутом в 5.1.4:</span></i></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:.5pt;margin-left:-.25pt;text-align:left;line-height:103%'><span
lang=EN-US>masterchain_state_extra#cc1f</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:144.5pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>shard_hashes:ShardHashes shard_fees:ShardFees </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:144.5pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>config:ConfigParams</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:10.95pt;margin-left:-.25pt;text-align:left;line-height:103%'><span
lang=EN-US>= McStateExtra;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=EN-US>5.2.7. </span><span lang=RU>Данные</span><span
lang=RU> </span><span lang=RU>блока</span><span lang=RU> </span><span
lang=EN-US>Masterchain. </span><span lang=RU>Аналогично, данные, специфичные
для блоков мастерчейна, собираются в </span><i><span lang=EN-US>McBlockExtra</span></i><i><span
lang=RU>:</span></i></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:.5pt;margin-left:-.25pt;text-align:left;line-height:103%'><span
lang=EN-US>masterchain_block_extra#cc9f</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>shard_hashes:ShardHashes</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:21.5pt;margin-left:-.25pt;text-align:left;line-height:103%'><span
lang=EN-US>= McBlockExtra;</span></p>

</div>

<span lang=RU style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'><br clear=all style='page-break-before:always'>
</span>

<div class=WordSection21>

<h2 style='margin-left:35.2pt;text-indent:-36.0pt'><a name="_Toc150781"><span
lang=EN-US>5.3<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>Сериализация мешка ячеек</span></a></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Описание, приведенное в предыдущем разделе,
определяет способ представления блока </span><span lang=EN-US>shardchain</span><span
lang=RU> в виде дерева ячеек. Однако это дерево ячеек должно быть сериализовано
в файл, подходящий для дискового хранения или передачи по сети. В этом разделе
обсуждаются стандартные способы сериализации дерева, группы обеспечения
доступности баз данных или пакета ячеек в строку октета.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>5.3.1. Превращение дерева клеток в мешок
клеток. Напомним, что значения произвольных (зависимых) алгебраических типов
данных представлены в блокчейне </span><span lang=EN-US>TON</span><span
lang=RU> деревьями <i>ячеек. Такое дерево клеток преобразуется в направленный
ациклический граф, или </i></span><i><span lang=EN-US>DAG</span></i><i><span
lang=RU>, клеток, путем идентификации идентичных клеток в дереве. После этого
мы могли бы заменить каждую из ссылок каждой ячейки 32-байтным хэшем
представления упомянутой ячейки и получить мешок ячеек. По соглашению, корень
исходного дерева клеток является отмеченным элементом результирующего мешка
клеток, так что любой, кто получает этот мешок клеток и знает помеченный
элемент, может реконструировать исходный </span><span lang=EN-US>DAG</span></i><i><span
lang=RU> клеток, следовательно, также оригинальное дерево клеток.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>5.3.2. Полные мешки ячеек. Предположим, что
мешок клеток является <i>полным,</i> если он содержит все клетки, на которые
ссылается любая из его клеток. Другими словами, полный мешок клеток не имеет
каких-либо «нерешенных» хэш-ссылок на ячейки за пределами этого мешка клеток. В
большинстве случаев нам нужно сериализовать только полные мешки клеток.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>5.3.3. Внутренние ссылки внутри ячейки.
Предположим, что ссылка на ячейку </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>c</span></i><span lang=RU>, принадлежащую мешку клеток </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>B</span></i><span lang=RU>,
является <i>внутренней (по отношению к </i></span><i><span lang=EN-US
style='font-family:"Cambria",serif'>B</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>), </span></i><span lang=RU>если ячейка </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>ci</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, </span></i><span lang=RU>на которую
ссылается эта ссылка, также принадлежит </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>B</span></i><span lang=RU>. В противном
случае ссылка называется <i>внешней. Мешок клеток является полным тогда и
только тогда, когда все ссылки на составляющие его клетки являются внутренними.</i></span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>5.3.4. Присвоение индексов клеткам из мешка
клеток. Пусть </span><i><span lang=EN-US style='font-family:"Cambria",serif'>c</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>0</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'>,..., </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>c<sub>n</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>−1</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'> — </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>n</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>различных клеток,
принадлежащих мешку клеток </span><i><span lang=EN-US style='font-family:"Cambria",serif'>B</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>. Мы можем перечислить эти ячейки в
некотором порядке, </span></i><span lang=RU>а затем присвоить индексы от </span><span
lang=RU style='font-family:"Cambria",serif'>0 </span><span lang=RU>до </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>− 1, так что ячейка </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>c<sub>i</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>получает
индекс </span><i><span lang=EN-US style='font-family:"Cambria",serif'>i</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>. Некоторые варианты заказа ячеек:</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Упорядочивайте ячейки по хэшу их представления.
Затем </span><span lang=EN-US>Hash</span><span lang=RU>(</span><span
lang=EN-US>c<sub>i</sub></span><span lang=RU>) </span><i><span lang=RU
style='font-family:"Cambria",serif'>&lt; </span></i><span lang=EN-US>Hash</span><span
lang=RU>(</span><span lang=EN-US>c<sub>j</sub></span><span lang=RU>) всякий
раз, когда </span><i><span lang=EN-US style='font-family:"Cambria",serif'>i</span></i><i><span
lang=RU style='font-family:"Cambria",serif'> &lt; </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>j</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=EN-US style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Топологический порядок: если ячейка </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>c<sub>i</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>относится
к ячейке </span><i><span lang=EN-US style='font-family:"Cambria",serif'>c<sub>j</sub></span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, то </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>i</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> &lt; </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>j</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>. В общем, существует более одного
топологического порядка для одного и того же мешка ячеек. </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>Существует два стандартных
способа построения топологических порядков:</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:5.85pt;
margin-left:55.05pt;text-indent:-12.6pt'><span lang=RU style='line-height:104%'>–<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span><span
lang=RU>Порядок «глубина-первый»: примените поиск по глубине к направленному
ациклическому графу ячеек, начиная с его корня (т. е. помеченной ячейки), и
перечислите ячейки в том порядке, в котором они посещены.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:55.05pt;text-indent:-12.6pt'><span lang=RU style='line-height:104%'>–<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp; </span></span><span
lang=RU>Первый порядок ширины: такой же, как и выше, но с применением поиска по
ширине.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>Обратите внимание, что топологический порядок
всегда присваивает индекс </span><span lang=RU style='font-family:"Cambria",serif'>0
</span><span lang=RU>корневой ячейке пакета клеток, построенного из дерева
клеток. В большинстве случаев мы предпочитаем использовать топологический
порядок или порядок глубины, если мы хотим быть более конкретными.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Если клетки перечислены в
топологическом порядке, то проверка того, что в мешке клеток нет циклических
ссылок, является немедленной. С другой стороны, упорядочивание ячеек по хэшу их
представления упрощает проверку отсутствия дубликатов в сериализованном пакете
ячеек.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:11.9pt;
margin-left:-.25pt'><span lang=RU>5.3.5. Схема процесса сериализации. Процесс
сериализации мешка клеток </span><i><span lang=EN-US style='font-family:"Cambria",serif'>B</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>,</span></i><span lang=RU>
состоящего из </span><i><span lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>ячеек,
можно очертить следующим образом:</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:.25pt;margin-bottom:
10.65pt;margin-left:29.25pt'><span lang=RU style='line-height:104%'>1.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=RU>Перечислите ячейки из </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>B</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>в топологическом
порядке: </span><i><span lang=EN-US style='font-family:"Cambria",serif'>c</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>0</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'>, </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>c</span></i><i><sub><span lang=RU
style='font-family:"Cambria",serif'>1</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'>,..., </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>c<sub>n</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>−1</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'>. Тогда </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>c</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>0</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU>является корневой
клеткой </span><i><span lang=EN-US style='font-family:"Cambria",serif'>B</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:11.95pt;
margin-left:29.25pt;text-indent:-14.95pt'><span lang=RU style='line-height:
104%'>2.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
lang=RU>Выберите целое число </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>s</span></i><i><span lang=RU style='font-family:"Cambria",serif'>,
такое, чтобы </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>≤ 2</span><sup><span lang=EN-US
style='font-family:"Cambria",serif'>s</span></sup><span lang=RU
style='font-family:"Cambria",serif'>. Представьте каждую ячейку </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>c<sub>i</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>интегральным
числом октетов стандартным способом (ср. 1.1.3 или [4, 3.1.4]), но используя
беззнаковое большое порядковое </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>s</span></i><i><span lang=RU style='font-family:"Cambria",serif'>-битное
целое число </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>j</span></i><i><span
lang=RU style='font-family:"Cambria",serif'> вместо </span></i><span lang=RU>хэш-</span><span
lang=EN-US>Hash</span><span lang=RU>(</span><span lang=EN-US>c<sub>j</sub></span><span
lang=RU>) для представления внутренних ссылок на ячейку </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>c<sub>j</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>(см.
5.3.6 ниже).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.25pt;text-indent:-14.95pt'><span lang=RU style='line-height:
104%'>3.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
lang=RU>Сцепляйте представления клеток </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>c<sub>i</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>,</span></i><span lang=RU> полученные таким
образом в порядке возрастания </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>i</span></i><i><span lang=RU style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.25pt;text-indent:-14.95pt'><span lang=RU style='line-height:
104%'>4.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
lang=RU>Опционально может быть построен индекс, состоящий из </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>+ 1 </span><i><span lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>-бит целых записей </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>L</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>0</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'>,..., </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>L<sub>n</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, где </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>L<sub>i</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>—
общая длина (в октетах) представлений ячеек </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>c<sub>j</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>с </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>j</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>≤ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>i</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, а целое число </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>≥ 0 </span><span lang=RU>выбрано так, что </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>L<sub>n</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>≤ 2</span><sup><span lang=EN-US
style='font-family:"Cambria",serif'>t</span></sup><span lang=RU
style='font-family:"Cambria",serif'>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.25pt;text-indent:-14.95pt'><span lang=RU style='line-height:
104%'>5.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
lang=RU>Сериализация мешка ячеек теперь состоит из магического числа,
обозначающего точный формат сериализации, за которым следуют целые числа </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>≥ 0, </span><i><span lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>≥ 0, </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>n</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>≤ 2</span><sup><span lang=EN-US style='font-family:"Cambria",serif'>s</span></sup><span
lang=RU style='font-family:"Cambria",serif'>, необязательный индекс, состоящий
из </span><span lang=RU style='font-family:"Cambria",serif'><img width=58
height=16 id="Рисунок 5" src="tblkch_convertio_ru_done.fld/image012.jpg"></span><span
lang=RU style='font-family:"Cambria",serif'> </span><span lang=RU>октетов, и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>L<sub>n</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>октетов
с представлениями ячеек.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.25pt;text-indent:-14.95pt'><span lang=RU style='line-height:
104%'>6.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
lang=RU>Дополнительный </span><span lang=EN-US>CRC</span><span lang=RU>32 может
быть добавлен к сериализации в целях проверки целостности.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.6pt;
margin-left:-.25pt'><span lang=RU>Если индекс включен, любая ячейка </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>c<sub>i</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>в
сериализованном мешке ячеек может быть легко доступна по ее индексу </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>i</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>без
десериализации всех других ячеек или даже без загрузки всего сериализованного
мешка ячеек в памяти.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:11.7pt;
margin-left:-.25pt'><span lang=RU>5.3.6. Сериализация одной ячейки из мешка
ячеек. Точнее, каждая отдельная ячейка </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>c</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= </span><i><span lang=EN-US style='font-family:"Cambria",serif'>c<sub>i</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>сериализуется
следующим образом, при условии, </span><i><span lang=RU style='font-family:
"Cambria",serif'>что </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>кратна
восьми (обычно </span><i><span lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= 8, 16, 24 или 32):</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:.25pt;margin-bottom:
10.65pt;margin-left:29.25pt'><span lang=RU style='line-height:104%'>1.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=RU>Два дескрипторных байта </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>d</span></i><i><sub><span lang=RU
style='font-family:"Cambria",serif'>1</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>d</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>2</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU>вычисляются
аналогично [4, 3.1.4] путем установки </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>d</span></i><i><sub><span lang=RU
style='font-family:"Cambria",serif'>1</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= </span><i><span lang=EN-US style='font-family:"Cambria",serif'>r</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>+ 8</span><span lang=EN-US
style='font-family:"Cambria",serif'>s</span><span lang=RU style='font-family:
"Cambria",serif'> + 16</span><span lang=EN-US style='font-family:"Cambria",serif'>h</span><span
lang=RU style='font-family:"Cambria",serif'> + 32</span><span lang=EN-US
style='font-family:"Cambria",serif'>l</span><span lang=EN-US style='font-family:
"Cambria",serif'> </span><span lang=RU>и </span><span lang=RU style='font-family:
"Cambria",serif'><img width=99 height=16 id="Рисунок 3"
src="tblkch_convertio_ru_done.fld/image013.jpg"></span><span lang=RU
style='font-family:"Cambria",serif'>, где:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:7.2pt;
margin-left:55.05pt;text-indent:-11.85pt'><span lang=RU style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU style='font-family:"Cambria",serif'>0 ≤ </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>r</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>≤ 4 </span><span lang=RU>— количество клеточных ссылок,
присутствующих в </span><i><span lang=RU style='font-family:"Cambria",serif'>ячейке
</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>c</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>; если </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>c</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>отсутствует в
пакете сериализуемых ячеек и представлен только его хэшами, то </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>r</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 7.</span><a href="#_ftn38" name="_ftnref38" title=""><sup><span
lang=EN-US><sup><span lang=EN-US style='font-size:12.0pt;line-height:104%;
font-family:"Calibri",sans-serif;color:black'>[38]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:6.15pt;
margin-left:55.05pt;text-indent:-11.85pt'><span lang=RU style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU style='font-family:"Cambria",serif'>0 ≤ </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>b</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>≤ 1023 </span><span lang=RU>— количество битов данных в ячейке
</span><i><span lang=EN-US style='font-family:"Cambria",serif'>c</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:6.2pt;
margin-left:55.05pt;text-indent:-11.85pt'><span lang=RU style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU style='font-family:"Cambria",serif'>0 ≤ </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>l</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>≤ 3 </span><span lang=RU>— уровень клетки </span><i><span
lang=RU style='font-family:"Cambria",serif'>с </span></i><span lang=RU>(см. [4,
3.1.3]).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:6.25pt;
margin-left:55.05pt;text-indent:-11.85pt'><span lang=RU style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= 1 </span><span lang=RU>для экзотических
клеток и </span><i><span lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= 0 </span><span lang=RU>для обычных
клеток.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:11.75pt;
margin-left:55.05pt;text-indent:-11.85pt'><span lang=EN-US style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=EN-US style='font-family:"Cambria",serif'>h</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= 1</span><span lang=RU>, если хэши ячейки
явно включены в сериализацию; в противном случае </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>h</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 0. </span><span lang=EN-US style='font-family:"Cambria",serif'>(Когда<i>
r </i>= 7, мы всегда должны иметь <i>h </i>= 1.)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.75pt'><span lang=RU>Для отсутствующих ячеек (т.е. внешних
ссылок) присутствует только </span><i><span lang=EN-US style='font-family:"Cambria",serif'>d</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>1</span></sub></i><span lang=RU>,
всегда равный </span><span lang=RU style='font-family:"Cambria",serif'>23 + 32</span><span
lang=EN-US style='font-family:"Cambria",serif'>l</span><span lang=RU
style='font-family:"Cambria",serif'>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.25pt;text-indent:-14.95pt'><span lang=RU style='line-height:
104%'>2.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
lang=RU>Два байта </span><i><span lang=EN-US style='font-family:"Cambria",serif'>d</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>1</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>d</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>2</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU>(если </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>r</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> &lt; </span></i><span lang=RU
style='font-family:"Cambria",serif'>7) или один байт </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>d</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>1</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU>(если </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>r</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 7) начинают сериализацию ячейки </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>c</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.25pt;text-indent:-14.95pt'><span lang=RU style='line-height:
104%'>3.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
lang=RU>Если </span><i><span lang=EN-US style='font-family:"Cambria",serif'>h</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= 1, сериализация продолжается </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>l</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>+ 1 </span><span lang=RU>32-байтовыми более высокими хэшами </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>c</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>(см. [4, 3.1.6]):
</span><span lang=EN-US>Hash</span><sub><span lang=RU>1</span></sub><span
lang=RU>(</span><span lang=EN-US>c</span><span lang=RU>),..., </span><span
lang=EN-US>Hash<sub>l</sub></span><sub><span lang=RU>+1</span></sub><span
lang=RU>(</span><span lang=EN-US>c</span><span lang=RU>) = </span><span
lang=EN-US>Hash</span><sub><span lang=RU>∞</span></sub><span lang=RU>(</span><span
lang=EN-US>c</span><span lang=RU>).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:13.55pt;
margin-left:29.25pt;text-indent:-14.95pt'><span lang=RU style='line-height:
104%'>4.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
lang=RU>После этого байты данных </span><span lang=RU><img width=29 height=15
id="Рисунок 4" src="tblkch_convertio_ru_done.fld/image014.jpg"></span><span
lang=RU> сериализуются, путем разделения битов данных </span><span lang=EN-US>b</span><span
lang=RU> на 8-битные группы и интерпретации каждой группы как целое число с
большим порядком байтов в диапазоне </span><span lang=RU style='font-family:
"Cambria",serif'>0...255. Если </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>b</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>не делится на </span><span lang=RU style='font-family:
"Cambria",serif'>8, то биты данных сначала дополняются одним двоичным файлом 1
и до шести двоичных 0, чтобы число битов данных делилось на восемь.</span><a
href="#_ftn39" name="_ftnref39" title=""><sup><span lang=EN-US><sup><span
lang=EN-US style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'>[39]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.25pt;text-indent:-14.95pt'><span lang=RU style='line-height:
104%'>5.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
lang=RU>Наконец, ссылки </span><span lang=EN-US>r</span><span lang=RU>-ячеек на
ячейки </span><i><span lang=EN-US style='font-family:"Cambria",serif'>c<sub>j</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>1</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'>,..., </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>c<sub>jr</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>кодируются
с помощью </span><i><span lang=EN-US style='font-family:"Cambria",serif'>r</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>s</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>-бит больших порядковых чисел </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>j</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>1</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'>,..., </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>j<sub>r</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i><a href="#_ftn40"
name="_ftnref40" title=""><sup><span lang=EN-US><sup><span lang=EN-US
style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'>[40]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:6.2pt;
margin-left:-.25pt;line-height:136%'><span lang=RU>5.3.7. Классификация схем
сериализации для мешков ячеек. Схема сериализации для пакета ячеек должна
указывать следующие параметры:</span></p>

<p class=MsoListParagraph style='margin-top:0cm;margin-right:.25pt;margin-bottom:
6.2pt;margin-left:1.0cm;text-indent:-10.35pt;line-height:136%'><span lang=RU
style='line-height:136%'>•<span style='font:7.0pt "Times New Roman"'>&nbsp; </span></span><span
lang=RU>4-байтовое магическое число, предшествующее сериализации.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Количество битов,</span><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU>используемых для
представления индексов ячеек. Обычно </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>s</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>кратно восьми
(например, </span><span lang=RU style='font-family:"Cambria",serif'>8, 16, 24
или 32).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=EN-US style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Число битов </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>t</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, </span></i><span lang=RU>используемых для
представления смещений сериализаций ячеек (см. 5.3.5). </span><span lang=EN-US>Обычно
</span><i><span lang=EN-US style='font-family:"Cambria",serif'>t </span></i><span
lang=EN-US>также кратно восьми.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Флаг, указывающий, присутствует ли индекс со
смещениями </span><i><span lang=EN-US style='font-family:"Cambria",serif'>L</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>0</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'>,..., </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>L<sub>n</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>сериализаций
ячеек. Этот флаг можно комбинировать с </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>t</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>,</span></i><span lang=RU> установив </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 0 </span><span lang=RU>при отсутствии индекса.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.6pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Флаг, указывающий, добавляется ли к нему </span><span
lang=EN-US>CRC</span><span lang=RU>32-</span><span lang=EN-US>C</span><span
lang=RU> всей сериализации в целях проверки целостности.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.5pt;
margin-left:-.25pt'><span lang=RU>5.3.8. Поля, присутствующие при сериализации
мешка ячеек. Помимо значений, перечисленных в разделе 5.3.7, фиксированных
выбором схемы сериализации для мешков ячеек, сериализация конкретного мешка
ячеек должна указывать следующие параметры:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Общее количество ячеек </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>n</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>,</span></i><span lang=RU> присутствующих в
сериализации.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Количество «корневых клеток» </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>≤ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>,</span></i><span lang=RU>
присутствующих в сериализации. Сами корневые клетки </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>c</span></i><i><sub><span lang=RU
style='font-family:"Cambria",serif'>0</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'>,..., </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>c<sub>k</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>−1</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'>. Ожидается, что все другие клетки,
присутствующие в мешке клеток, будут доступны с помощью цепочек ссылок, начиная
с корневых клеток.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Число «отсутствующих клеток» </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>l</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>≤ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>− </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>k</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, которые представляют собой клетки,
которые фактически отсутствуют в этом мешке клеток, но относятся к нему. Сами
отсутствующие клетки представлены </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>c<sub>n</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>−</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>l</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'>,..., </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>c<sub>n</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>−1</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'>, и только эти клетки могут (и тоже
должны) иметь </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>r</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= 7. Полные мешки клеток имеют </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>l</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 0.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Общая длина в байтах </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>L<sub>n</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>сериализации
всех ячеек. Если индекс присутствует, </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>L<sub>n</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>может
не храниться явно, так как он может быть восстановлен в качестве последней
записи индекса.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.3pt;
margin-left:-.25pt'><span lang=RU>5.3.9. Схема </span><span lang=EN-US>TL</span><span
lang=RU>-</span><span lang=EN-US>B</span><span lang=RU> для сериализации мешков
ячеек. Несколько конструкторов </span><span lang=EN-US>TL</span><span lang=RU>-</span><span
lang=EN-US>B</span><span lang=RU> могут быть использованы для сериализации
пакетов ячеек в октетные (т.е. 8-битные байтовые) последовательности.
Единственный, который в настоящее время используется для сериализации новых
пакетов клеток, это</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:.5pt;margin-left:-.25pt;text-align:left;line-height:103%'><span
lang=EN-US>serialized_boc#b5ee9c72 has_idx:(## 1) has_crc32c:(## 1)</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:74.9pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>has_cache_bits:(## 1) flags:(## 2) { flags = 0 } </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:74.9pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>size:(## 3) { size &lt;= 4 } </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:74.9pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>off_bytes:(## 8) { off_bytes &lt;= 8 } </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:74.9pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>cells:(##(size * 8)) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:74.9pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>roots:(##(size * 8)) { roots &gt;= 1 } </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:74.9pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>absent:(##(size * 8)) { roots + absent &lt;= cells }
tot_cells_size:(##(off_bytes * 8)) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:74.9pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>root_list:(roots * ##(size * 8)) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:74.9pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>index:has_idx? (ячейки * ##(off_bytes * 8))
cell_data:(tot_cells_size * [ uint8 ]) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:74.9pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>crc32c:has_crc32c?uint32</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:11.6pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>= BagOfCells;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Полевые ячейки — </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>n</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, корни — </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>k</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, отсутствующие — </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>l</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, а </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>tot</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>_</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>cells</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>_</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>size</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> — </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>L<sub>n</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>(суммарный
размер сериализации всех ячеек в байтах). При наличии индекса параметры </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>/8 </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>/8 </span></i><span lang=RU>сериализуются
отдельно как размер и </span><span lang=EN-US>off</span><span lang=RU>_</span><span
lang=EN-US>bytes</span><span lang=RU> соответственно, и устанавливается флаг </span><span
lang=EN-US>has</span><span lang=RU>_</span><span lang=EN-US>idx</span><span
lang=RU>. Сам индекс содержится в индексе, присутствует только в том случае, если
задан </span><span lang=EN-US>has</span><span lang=RU>_</span><span lang=EN-US>idx</span><span
lang=RU>. Поле </span><span lang=EN-US>root</span><span lang=RU>_</span><span
lang=EN-US>list</span><span lang=RU> содержит (отсчитываемые от нуля) индексы
корневых узлов ячейки.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.35pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Два старых конструктора
по-прежнему поддерживаются в функциях десериализации </span><span lang=EN-US>bag</span><span
lang=RU>-</span><span lang=EN-US>of</span><span lang=RU>-</span><span
lang=EN-US>cells</span><span lang=RU>:</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:.5pt;margin-left:-.25pt;text-align:left;line-height:103%'><span
lang=EN-US>serialized_boc_idx#68ff65f3 size:(## 8) { size &lt;= 4 }</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:74.9pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>off_bytes:(## 8) { off_bytes &lt;= 8 } </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:74.9pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>cells:(##(size * 8)) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:74.9pt;
margin-bottom:1.8pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>roots:(##(size * 8)) { roots = 1 } </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:74.85pt;
margin-bottom:1.8pt;margin-left:12.75pt;text-align:left;text-indent:-.55pt'><span
lang=EN-US>absent:(##(size * 8)) { roots + absent &lt;= cells }
tot_cells_size:(##(off_bytes * 8)) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:74.85pt;
margin-bottom:1.8pt;margin-left:12.75pt;text-align:left;text-indent:-.55pt'><span
lang=EN-US>index:(cells * ##(off_bytes * 8)) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:74.85pt;
margin-bottom:1.8pt;margin-left:12.75pt;text-align:left;text-indent:-.55pt'><span
lang=EN-US>cell_data:(tot_cells_size * [ uint8 ])</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:13.9pt;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>= BagOfCells;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:.5pt;margin-left:-.25pt;text-align:left;line-height:103%'><span
lang=EN-US>serialized_boc_idx_crc32c#acc3a728 size:(## 8) { size &lt;= 4 }</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:74.85pt;
margin-bottom:1.8pt;margin-left:12.75pt;text-align:left;text-indent:-.55pt'><span
lang=EN-US>off_bytes:(## 8) { off_bytes &lt;= 8 } </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:74.85pt;
margin-bottom:1.8pt;margin-left:12.75pt;text-align:left;text-indent:-.55pt'><span
lang=EN-US>cells:(##(size * 8)) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:74.85pt;
margin-bottom:1.8pt;margin-left:12.75pt;text-align:left;text-indent:-.55pt'><span
lang=EN-US>roots:(##(size * 8)) { roots = 1 } </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:74.85pt;
margin-bottom:1.8pt;margin-left:12.75pt;text-align:left;text-indent:-.55pt'><span
lang=EN-US>absent:(##(size * 8)) { roots + absent &lt;= cells }
tot_cells_size:(##(off_bytes * 8)) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:74.85pt;
margin-bottom:1.8pt;margin-left:12.75pt;text-align:left;text-indent:-.55pt'><span
lang=EN-US>index:(cells * ##(off_bytes * 8)) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:74.85pt;
margin-bottom:1.8pt;margin-left:12.75pt;text-align:left;text-indent:-.55pt'><span
lang=EN-US>cell_data:(tot_cells_size * [ uint8 ]) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:74.85pt;
margin-bottom:1.8pt;margin-left:12.75pt;text-align:left;text-indent:-.55pt'><span
lang=EN-US>crc</span><span lang=RU>32</span><span lang=EN-US>c</span><span
lang=RU>:</span><span lang=EN-US>uint</span><span lang=RU>32 = </span><span
lang=EN-US>BagOfCells</span><span lang=RU>;</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:74.85pt;
margin-bottom:1.8pt;margin-left:12.75pt;text-align:left;text-indent:-.55pt'><span
lang=RU>&nbsp;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.35pt;
margin-left:-.25pt'><span lang=RU>5.3.10. Хранение скомпилированного </span><span
lang=EN-US>TVM</span><span lang=RU>-кода в файлах. Обратите внимание, что
приведенная выше процедура сериализации пакетов ячеек может быть использована
для сериализации скомпилированных смарт-контрактов и другого кода </span><span
lang=EN-US>TVM</span><span lang=RU>. Необходимо определить конструктор </span><span
lang=EN-US>TL</span><span lang=RU>-</span><span lang=EN-US>B</span><span
lang=RU>, подобный следующему:</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:.5pt;margin-left:-.25pt;text-align:left;line-height:103%'><span
lang=EN-US>compiled</span><span lang=RU>_</span><span lang=EN-US>smart</span><span
lang=RU>_</span><span lang=EN-US>contract</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:19.55pt;
margin-bottom:0cm;margin-left:12.8pt;text-align:left;line-height:103%'><span
lang=EN-US>compiled_at:uint32 code:^Cell data:^Cell description:(Maybe^TinyString)</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:43.05pt;text-align:left;text-indent:-30.75pt;
line-height:103%'><span lang=EN-US>_:^[ source_file:(Maybe^ TinyString) </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:13.8pt;
margin-bottom:1.8pt;margin-left:43.05pt;text-align:left;text-indent:-7.6pt;
line-height:103%'><span lang=EN-US>compiler_version:(Maybe^ TinyString) ]</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:1.05pt;
margin-bottom:0cm;margin-left:-.75pt;text-align:left;text-indent:12.3pt;
line-height:199%'><span lang=EN-US>= CompiledSmartContract; </span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:1.05pt;
margin-bottom:0cm;margin-left:-.75pt;text-align:left;text-indent:12.3pt;
line-height:199%'><span lang=EN-US>tiny_string#_ len:(#&lt;= 126) str:(len * [
uint8 ]) = TinyString;</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Затем скомпилированный смарт-контракт может
быть представлен значением типа </span><i><span lang=EN-US>CompiledSmartContract</span></i><i><span
lang=RU>, преобразован в дерево ячеек, а затем в мешок ячеек, а затем
сериализован с помощью одного из конструкторов, перечисленных в 5.3.9.
Полученная строка октета может быть затем записана в файл с суффиксом .</span><span
lang=EN-US>tvc</span></i><i><span lang=RU> («смарт-контракт </span><span
lang=EN-US>TVM</span></i><i><span lang=RU>»), и этот файл может быть
использован для распространения скомпилированного смарт-контракта, загрузки его
в приложение кошелька для развертывания в блокчейне </span><span lang=EN-US>TON</span></i><i><span
lang=RU> и так далее.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>5.3.11. Хэши Меркла для октетической струны.
В некоторых случаях мы должны определить хэш-хэш Меркла </span><span
lang=EN-US>Hash<sub>M</sub></span><span lang=RU>(</span><span lang=EN-US>s</span><span
lang=RU>) произвольной строки октета </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>s</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>длиной </span><span
lang=RU style='font-family:"Cambria",serif'>|</span><span lang=EN-US
style='font-family:"Cambria",serif'>s</span><span lang=RU style='font-family:
"Cambria",serif'>|. </span><span lang=EN-US style='font-family:"Cambria",serif'>Мы
делаем это следующим образом:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:13.8pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Если </span><span lang=RU style='font-family:"Cambria",serif'>|</span><span
lang=EN-US style='font-family:"Cambria",serif'>s</span><span lang=RU
style='font-family:"Cambria",serif'>| ≤ 256 </span><span lang=RU>октетов, то
хэш </span><span lang=EN-US>Merkle</span><span lang=EN-US> </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>— это просто его </span><span
lang=EN-US>sha</span><span lang=RU>256:</span></p>

<p class=MsoNormal align=right style='margin-top:0cm;margin-right:-.55pt;
margin-bottom:18.45pt;margin-left:0cm;text-align:right;text-indent:0cm;
line-height:107%'><span lang=RU style='font-size:11.0pt;line-height:107%'>                                </span><span
lang=EN-US>Hash<sub>M</sub>(s) := sha256(s)          </span><span lang=RU>если</span><span
lang=EN-US>  </span><span lang=EN-US style='font-family:"Cambria",serif'> </span><span
lang=EN-US> </span><span lang=EN-US style='font-family:"Cambria",serif'>|s| ≤
256.               (19)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Если </span><span lang=RU style='font-family:"Cambria",serif'>|</span><span
lang=EN-US style='font-family:"Cambria",serif'>s</span><span lang=RU
style='font-family:"Cambria",serif'>| <i>&gt; </i>256, пусть </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 2</span><sup><span lang=EN-US style='font-family:"Cambria",serif'>k</span></sup><span
lang=EN-US style='font-family:"Cambria",serif'> </span><span lang=RU>будет
наибольшей мощностью двух меньше </span><span lang=RU style='font-family:"Cambria",serif'>|с|
</span><span lang=RU>(т.е. </span><span lang=RU style='font-family:"Cambria",serif'><img
width=140 height=14 id="Рисунок 2"
src="tblkch_convertio_ru_done.fld/image015.jpg"></span><span lang=RU
style='font-family:"Cambria",serif'>. Если </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>s</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>— префикс </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>длины </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, а </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>s</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’’ </span></i><span lang=RU>— суффикс </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>длины </span><span
lang=RU style='font-family:"Cambria",serif'>|</span><span lang=EN-US
style='font-family:"Cambria",serif'>s</span><span lang=RU style='font-family:
"Cambria",serif'>| − </span><i><span lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, так что </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>— конкатенация </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’.</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>s</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’’ </span></i><span lang=RU>из </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’’, определим</span></i></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:-.75pt;
margin-bottom:8.9pt;margin-left:51.1pt;text-align:left;line-height:107%'><span
lang=EN-US>Hash<sub>M</sub>(s) := sha256 (</span><span lang=EN-US
style='font-size:10.0pt;line-height:107%'>INT</span><sub><span lang=EN-US>64</span></sub><span
lang=EN-US>(|s|). Hash<sub>M</sub> (s’). Hash<sub>M</sub></span><span
lang=EN-US> (s’’))            (20)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:12.25pt;
margin-left:29.75pt'><span lang=RU>Другими словами, мы объединяем 64-битное
представление биг-эндиана </span><span lang=RU style='font-family:"Cambria",serif'>|</span><span
lang=EN-US style='font-family:"Cambria",serif'>s</span><span lang=RU
style='font-family:"Cambria",serif'>| </span><span lang=RU>и рекурсивно
вычисленные хэши Меркла </span><i><span lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’’ и вычислить </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>sha</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>256 результирующей строки.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.5pt;
margin-left:-.25pt'><span lang=RU>Можно проверить, что </span><span lang=EN-US>Hash<sub>M</sub></span><span
lang=RU>(</span><span lang=EN-US>s</span><span lang=RU>) = </span><span
lang=EN-US>Hash<sub>M</sub></span><span lang=RU>(</span><span lang=EN-US>t</span><span
lang=RU>) для строк октета </span><i><span lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>длиной менее </span><span
lang=RU style='font-family:"Cambria",serif'>264 − 256 подразумевает </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= </span><i><span lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>,</span></i><span lang=RU> если не
найдено хэш-коллизия для </span><span lang=EN-US>sha</span><span lang=RU>256.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>5.3.12. Хеш сериализации блока. Конструкция
раздела 5.3.11 применяется, в частности, к сериализации мешка ячеек,
представляющих собой неподписанный шардчейн или мастерчейн. Валидаторы
подписывают не только хэш представления беззнакового блока, но и «хэш сериализации»
беззнакового блока, определяемый как </span><span lang=EN-US>Hash<sub>M</sub></span><span
lang=RU> сериализации беззнакового блока. Таким образом, валидаторы
удостоверяют, что эта строка октета действительно является сериализацией
соответствующего блока.</span></p>

</div>

<span lang=RU style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'><br clear=all style='page-break-before:always'>
</span>

<div class=WordSection22>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:0cm;
margin-bottom:25.45pt;margin-left:0cm;text-align:center;text-indent:0cm;
line-height:107%'><span lang=EN-US>Ссылки</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:4.45pt;margin-left:-.25pt;text-align:left;line-height:107%'><span
lang=EN-US style='font-size:17.0pt;line-height:107%'>Ссылки</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:6.0pt;
margin-left:21.25pt;text-indent:-21.25pt;line-height:107%'><span lang=EN-US>[1]
Daniel J. Bernstein, Curve25519: New Diffie–Hellman Speed Records (2006), in:
M. Yung, Ye. Dodis, A. Kiayas et al, Public Key Cryptography, Lecture Notes in
Computer Science 3958, pp. 207–228. Available at
https://cr.yp.to/ecdh/curve25519-20060209.pdf. </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:6.0pt;
margin-left:21.25pt;text-indent:-21.25pt;line-height:107%'><span lang=EN-US>[2]
Daniel J. Bernstein, Niels Duif, Tanja Lange et al., Highspeed high-security
signatures (2012), Journal of Cryptographic Engineering 2 (2), pp. 77–89.
Available at https://ed25519.cr.yp.to/ ed25519-20110926.pdf. </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:6.0pt;
margin-left:21.25pt;text-indent:-21.25pt;line-height:107%'><span lang=EN-US>[3]
N. Durov, Telegram Open Network, 2017. </span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:6.0pt;
margin-left:21.25pt;text-indent:-21.25pt;line-height:107%'><span lang=EN-US>[4]
N. Durov, Telegram Open Network Virtual Machine, 2018. <br clear=all
style='page-break-before:always'>
</span></p>

<h1 style='margin-left:-.75pt;text-indent:0cm'><a name="_Toc150782"><span
lang=EN-US>A</span></a><span lang=RU>    Криптография эллиптических кривых</span></h1>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:0cm;
margin-left:-.25pt'><span lang=RU>Это приложение содержит формальное описание
криптографии эллиптической кривой, используемой в настоящее время в </span><span
lang=EN-US>TON</span><span lang=RU>, особенно в блокчейне </span><span
lang=EN-US>TON</span><span lang=RU> и сети </span><span lang=EN-US>TON</span><span
lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:21.35pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=EN-US>TON</span><span
lang=RU> использует две формы криптографии эллиптических кривых: </span><span
lang=EN-US>Ed</span><span lang=RU>25519 используется для криптографических
сигнатур Шнорра, а </span><span lang=EN-US>Curve</span><span lang=RU>25519
используется для асимметричной криптографии. Эти кривые используются
стандартным способом (как определено в оригинальных статьях [1] и [2] Д.
Бернштейна и </span><span lang=EN-US>RFC</span><span lang=RU> 7748 и 8032);
однако некоторые детали сериализации, характерные для </span><span lang=EN-US>TON</span><span
lang=RU>, должны быть объяснены. Одна из уникальных адаптаций этих кривых для </span><span
lang=EN-US>TON</span><span lang=RU> заключается в том, что </span><span
lang=EN-US>TON</span><span lang=RU> поддерживает автоматическое преобразование
ключей </span><span lang=EN-US>Ed</span><span lang=RU>25519 в ключи </span><span
lang=EN-US>Curve</span><span lang=RU>25519, так что одни и те же ключи могут
использоваться для сигнатур и для асимметричной криптографии.</span></p>

<h2 style='margin-left:-.75pt;text-indent:0cm'><a name="_Toc150783"><span
lang=EN-US>A</span></a><span lang=RU>.1 Эллиптические кривые</span></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Некоторые общие факты об эллиптических кривых
над конечными полями, относящиеся к криптографии эллиптических кривых, собраны
в этом разделе.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:11.75pt;
margin-left:-.25pt'><span lang=EN-US>A</span><span lang=RU>.1.1. Конечные поля.
Рассмотрим эллиптические кривые над конечными полями. Для целей алгоритмов </span><span
lang=EN-US>Curve</span><span lang=RU>25519 и </span><span lang=EN-US>Ed</span><span
lang=RU>25519 мы будем в основном заниматься эллиптическими кривыми над
конечным простым полем </span><i><span lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>:= </span><span lang=EN-US>F<sub>p</sub></span><span
lang=RU> остатков по модулю </span><i><span lang=EN-US style='font-family:"Cambria",serif'>p</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, где </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>p</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 2255 − 19 </span><span lang=RU>— простое число, и над
конечными расширениями </span><span lang=EN-US>F<sub>q</sub></span><span
lang=EN-US> </span><span lang=EN-US>F<sub>p</sub></span><span lang=RU>,
особенно квадратичным расширением </span><span lang=EN-US>F<sub>p</sub></span><sub><span
lang=RU>2</span></sub><span lang=RU>.</span><a href="#_ftn41" name="_ftnref41"
title=""><sup><span lang=EN-US><sup><span lang=EN-US style='font-size:12.0pt;
line-height:104%;font-family:"Calibri",sans-serif;color:black'>[41]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.25pt;
margin-left:-.25pt;line-height:136%'><span lang=EN-US>A</span><span lang=RU>.1.2.
Эллиптические кривые. <i>Эллиптическая кривая </i></span><i><span lang=EN-US
style='font-family:"Cambria",serif'>E</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= (</span><span lang=EN-US style='font-family:"Cambria",serif'>E</span><span
lang=RU style='font-family:"Cambria",serif'>,</span><span lang=EN-US
style='font-family:"Cambria",serif'>O</span><span lang=RU style='font-family:
"Cambria",serif'>) </span><span lang=RU>над полем </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>k</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>представляет
собой геометрически интегральную гладкую проективную кривую </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>/</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>k</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>рода </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>g</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 1, наряду с отмеченной </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>k</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>-рациональной точкой      </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>O</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>∈ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>k</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>). Известно, что эллиптическая кривая </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>над полем </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>может быть
представлена в (обобщенной) форме Вейерштрасса: </span></p>

<p class=MsoNormal align=center style='margin-top:0cm;margin-right:.25pt;
margin-bottom:8.25pt;margin-left:-.25pt;text-align:center;line-height:136%'><i><span
lang=EN-US style='font-family:"Cambria",serif'>y<sup>2</sup> </span></i><span
lang=EN-US style='font-family:"Cambria",serif'>+ <i>a<sub>1</sub>xy </i>+ <i>a<sub>3</sub>y
</i>= <i>x<sup>3</sup> </i>+ <i>a<sub>2</sub>x<sup>2</sup> </i>+ <i>a<sub>4</sub>x
</i>+ <i>a<sub>6</sub> </i></span><span lang=RU>для</span><span lang=RU> </span><span
lang=RU>некоторых</span><span lang=RU> </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>a<sub>1</sub>,..., a<sub>6</sub> </span></i><span
lang=EN-US style='font-family:"Cambria",serif'>∈ <i>k.      </i></span><i><span
lang=RU style='font-family:"Cambria",serif'>(21)</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Точнее, это только аффинная часть
эллиптической кривой, записанная в координатах </span><span lang=RU
style='font-family:"Cambria",serif'>(</span><span lang=EN-US style='font-family:
"Cambria",serif'>x</span><span lang=RU style='font-family:"Cambria",serif'>,</span><span
lang=EN-US style='font-family:"Cambria",serif'>y</span><span lang=RU
style='font-family:"Cambria",serif'>). Для любого расширения поля </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>K</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>из </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>E</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>K</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU>состоит из всех
решений </span><span lang=RU style='font-family:"Cambria",serif'>(</span><span
lang=EN-US style='font-family:"Cambria",serif'>x</span><span lang=RU
style='font-family:"Cambria",serif'>,</span><span lang=EN-US style='font-family:
"Cambria",serif'>y</span><span lang=RU style='font-family:"Cambria",serif'>) ∈ </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>K</span></i><i><sup><span
lang=RU style='font-family:"Cambria",serif'>2</span></sup></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU>уравнения (21),
называемых конечными <i>точками </i></span><i><span lang=EN-US
style='font-family:"Cambria",serif'>E</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>K</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>), вместе с точкой в бесконечности, которая
является отмеченной точкой </span></i><i><span lang=EN-US style='font-family:
"Cambria",serif'>O</span></i><i><span lang=RU style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:11.1pt;
margin-left:-.25pt;line-height:110%'><span lang=EN-US>A</span><span lang=RU>.1.3.
Форма Вейерштрасса в однородных координатах. В однородных координатах </span><span
lang=RU style='font-family:"Cambria",serif'>[</span><span lang=EN-US
style='font-family:"Cambria",serif'>X</span><span lang=RU style='font-family:
"Cambria",serif'> : </span><i><span lang=EN-US style='font-family:"Cambria",serif'>Y</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>: </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>Z</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>], (21) соответствует</span></i></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:-.75pt;
margin-bottom:12.4pt;margin-left:0cm;text-align:left;text-indent:0cm;
line-height:107%'><span lang=RU style='font-size:11.0pt;line-height:107%'>                         </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>Y </span></i><sup><span
lang=EN-US style='font-family:"Cambria",serif'>2</span></sup><span lang=EN-US
style='font-family:"Cambria",serif'>Z<sup> </sup>+ <i>a<sub>1</sub>XY Z </i>+ <i>a<sub>3</sub>Y
Z<sup>2</sup> </i>= <i>X<sup>3</sup> </i>+ <i>a<sub>2</sub>X<sup>2</sup>Z </i>+
<i>a<sub>4</sub>XZ<sup>2</sup> </i>+ <i>a<sub>6</sub>Z<sup>3</sup></i><sup>                            </sup></span><span
lang=EN-US>(22)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.2pt;
margin-left:-.25pt'><span lang=RU>Когда </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>Z</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>≠ 0, мы можем установить </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>x</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>:= </span><i><span lang=EN-US style='font-family:"Cambria",serif'>X</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>/</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>Z</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>y</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>:= </span><i><span lang=EN-US style='font-family:"Cambria",serif'>Y</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>/</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>Z</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> и получить решение </span></i><span
lang=RU style='font-family:"Cambria",serif'>(</span><span lang=EN-US
style='font-family:"Cambria",serif'>x</span><span lang=RU style='font-family:
"Cambria",serif'>,</span><span lang=EN-US style='font-family:"Cambria",serif'>y</span><span
lang=RU style='font-family:"Cambria",serif'>) </span><span lang=RU>из (21)
(т.е. конечную точку </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>). С другой стороны, единственным
решением (вплоть до пропорциональности) (22) с </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>Z</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 0 </span><span lang=RU>является </span><span lang=RU
style='font-family:"Cambria",serif'>[0 : 1 : 0]; это точка в бесконечности </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>O</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:12.15pt;
margin-left:-.25pt'><span lang=EN-US>A</span><span lang=RU>.1.4. Стандартная
форма Вейерштрасса. Когда характеристический </span><span lang=RU
style='font-family:"Cambria",serif'>символ </span><span lang=RU>поля </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><i><span lang=RU
style='font-family:"Cambria",serif'>≠ </span></i><span lang=RU
style='font-family:"Cambria",serif'>2, 3, форма Вейерштрасса (21) или (22)
может быть упрощена с помощью линейных <i>преобразований </i></span><i><span
lang=EN-US style='font-family:"Cambria",serif'>y</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ </span></i><span lang=RU
style='font-family:"Cambria",serif'>:= </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>y</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>+</span><span lang=EN-US style='font-family:"Cambria",serif'>a</span><sub><span
lang=RU style='font-family:"Cambria",serif'>1</span></sub><span lang=EN-US
style='font-family:"Cambria",serif'>x</span><span lang=RU style='font-family:
"Cambria",serif'>/2+</span><span lang=EN-US style='font-family:"Cambria",serif'>a</span><sub><span
lang=RU style='font-family:"Cambria",serif'>3</span></sub><span lang=RU
style='font-family:"Cambria",serif'>/2,      </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>x</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ </span></i><span lang=RU
style='font-family:"Cambria",serif'>:= </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>x</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>+</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>a</span></i><i><sub><span lang=RU
style='font-family:"Cambria",serif'>2</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'>/3, таким образом получая </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>a</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>1</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= </span><i><span lang=EN-US style='font-family:"Cambria",serif'>a</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>3</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= </span><i><span lang=EN-US style='font-family:"Cambria",serif'>a</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>2</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 0 </span><span lang=RU>и получая</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:-.75pt;
margin-bottom:11.1pt;margin-left:0cm;text-align:left;text-indent:0cm;
line-height:107%'><span lang=RU style='font-size:11.0pt;line-height:107%'>                                                   </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>y<sup>2</sup> </span></i><span
lang=EN-US style='font-family:"Cambria",serif'>= <i>x<sup>3</sup> </i>+ <i>a<sub>4</sub>x
</i>+ <i>a<sub>6</sub></i><sub>                                                                   </sub></span><span
lang=EN-US>(23)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:1.1pt;
margin-left:-.25pt'><span lang=EN-US>и</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:-.75pt;
margin-bottom:7.15pt;margin-left:0cm;text-align:left;text-indent:0cm;
line-height:107%'><span lang=EN-US style='font-size:11.0pt;line-height:107%'>                                              </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>Y </span></i><sup><span
lang=EN-US style='font-family:"Cambria",serif'>2</span></sup><span lang=EN-US
style='font-family:"Cambria",serif'>Z<sup> </sup>= <i>X<sup>3</sup> </i>+ <i>a<sub>4</sub>XZ<sup>2</sup>
</i>+ <i>a<sub>6</sub>Z<sup>3</sup></i><sup>                                                           </sup></span><span
lang=EN-US>(24)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:1.7pt;
margin-left:-.25pt'><span lang=RU>Такое уравнение определяет эллиптическую
кривую тогда и только тогда, когда кубический многочлен</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:7.15pt;
margin-left:-.25pt'><i><span lang=EN-US style='font-family:"Cambria",serif'>P</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>x</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) := </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>x</span></i><i><sup><span lang=RU
style='font-family:"Cambria",serif'>3</span></sup></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>+ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>a</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>4</span></sub></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>+ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>a</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>6</span></sub></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU>не имеет
нескольких корней, т.е. если дискриминант </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>D</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>:= </span><span lang=RU><img width=62 height=13
id="Picture 148336" src="tblkch_convertio_ru_done.fld/image016.jpg"></span><span
lang=RU> не равен нулю.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:12.05pt;
margin-left:-.25pt'><span lang=EN-US>A</span><span lang=RU>.1.5. Сложение точек
на эллиптической кривой </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>. Пусть </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>K</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>— расширение поля
</span><i><span lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, а </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>E</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= (</span><span lang=EN-US style='font-family:"Cambria",serif'>E</span><span
lang=RU style='font-family:"Cambria",serif'>,</span><span lang=EN-US
style='font-family:"Cambria",serif'>O</span><span lang=RU style='font-family:
"Cambria",serif'>) — </span><span lang=RU>любая эллиптическая кривая в форме
Вейерштрасса, определённая над </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>k</span></i><i><span lang=RU style='font-family:"Cambria",serif'>.
Тогда любая прямая </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>l</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>⊂ </span><span lang=EN-US>P</span><sup><span
lang=RU>2</span></sup><sub><span lang=EN-US>K</span></sub><span lang=RU>
пересекает эллиптическую кривую </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>E</span></i><i><span lang=RU style='font-family:"Cambria",serif'>(</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>K</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU>(которая
является базовым изменением кривой </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>E</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>на поле </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>K</span></i><i><span lang=RU style='font-family:"Cambria",serif'>,
т. е. кривой, определяемой теми же уравнениями над большим полем </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>K</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) ровно в трех точках </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>P</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>Q</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>R</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, рассматриваемых с кратностью. Мы
определяем сложение </span></i><i><span lang=RU>точек </span></i><span lang=RU>на
эллиптической кривой </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>(или,
скорее, сложение ее </span><i><span lang=EN-US style='font-family:"Cambria",serif'>K</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>-значных точек </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>K</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>)), требуя, чтобы</span></i></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:11.75pt;margin-left:0cm;text-align:left;text-indent:0cm'><i><span
lang=EN-US style='font-family:"Cambria",serif'>P</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>+ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>Q</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>+ </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>R</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= </span><i><span lang=EN-US style='font-family:"Cambria",serif'>O</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>       </span></i><span lang=RU>всякий
раз, когда </span><span lang=RU style='font-family:"Cambria",serif'>{</span><span
lang=EN-US style='font-family:"Cambria",serif'>P</span><span lang=RU
style='font-family:"Cambria",serif'>,</span><span lang=EN-US style='font-family:
"Cambria",serif'>Q</span><span lang=RU style='font-family:"Cambria",serif'>,</span><span
lang=EN-US style='font-family:"Cambria",serif'>R</span><span lang=RU
style='font-family:"Cambria",serif'>} = </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>l</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>∩ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>для
некоторой линии </span><i><span lang=EN-US style='font-family:"Cambria",serif'>l</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>⊂ </span><span lang=EN-US>P</span><sup><span
lang=RU>2</span></sup><sub><span lang=EN-US>K</span></sub><span lang=RU>.                                                                                                                        
(25)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Хорошо известно, что это требование
определяет уникальный коммутативный закон </span><span lang=RU
style='font-family:"Cambria",serif'>[+] : </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>E</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>×</span><sub><span lang=EN-US style='font-family:"Cambria",serif'>k</span></sub><span
lang=EN-US style='font-family:"Cambria",serif'> </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>E</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>→ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>на
точках эллиптической кривой </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, имея </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>O</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>в качестве
нейтрального элемента. Когда эллиптическая кривая </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>E</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>представлена
формой Вейерштрасса (21), можно записать явные формулы, выражающие координаты </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>x<sub>P</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>Q</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'>, </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>y<sub>P</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>Q</span></sub></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>суммы </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>P</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>+</span><span lang=EN-US style='font-family:"Cambria",serif'>Q</span><span
lang=EN-US style='font-family:"Cambria",serif'> </span><span lang=RU>двух </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>K</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>-значных точек      </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>P</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>Q</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>∈ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>K</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU>эллиптической
кривой </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>как
рациональные функции координат </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>x<sub>P</sub></span></i><i><span lang=RU style='font-family:
"Cambria",serif'>,</span></i><span lang=RU> </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>y<sub>P</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>,</span><i><span
lang=RU style='font-family:"Cambria",serif'> </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>x<sub>Q</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>y<sub>Q</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>∈ </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>K</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>точек </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>P</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>Q</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>и коэффициентов </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>a<sub>i</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>∈ </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>k</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>(21).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:14.0pt;
margin-left:-.25pt'><span lang=EN-US>A</span><span lang=RU>.1.6. Карты
мощности. Поскольку </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>K</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU>является
абелевой группой, можно определить <i>кратные </i>или <i>степени </i></span><span
lang=RU style='font-family:"Cambria",serif'>[</span><span lang=EN-US
style='font-family:"Cambria",serif'>n</span><span lang=RU style='font-family:
"Cambria",serif'>]</span><span lang=EN-US style='font-family:"Cambria",serif'>X</span><span
lang=EN-US style='font-family:"Cambria",serif'> </span><span lang=RU>для любой
точки </span><i><span lang=EN-US style='font-family:"Cambria",serif'>X</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>∈ </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>E</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>K</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU>и любого целого
числа </span><i><span lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>∈ </span><span lang=EN-US>Z</span><span
lang=RU>. Если </span><i><span lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= 0, то [0]</span><span lang=EN-US
style='font-family:"Cambria",serif'>X</span><span lang=RU style='font-family:
"Cambria",serif'> = </span><i><span lang=EN-US style='font-family:"Cambria",serif'>O</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>; если </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> &gt; </span></i><span lang=RU
style='font-family:"Cambria",serif'>0, то [</span><span lang=EN-US
style='font-family:"Cambria",serif'>n</span><span lang=RU style='font-family:
"Cambria",serif'>]</span><span lang=EN-US style='font-family:"Cambria",serif'>X</span><span
lang=RU style='font-family:"Cambria",serif'> = [</span><span lang=EN-US
style='font-family:"Cambria",serif'>n</span><span lang=RU style='font-family:
"Cambria",serif'> − 1]</span><span lang=EN-US style='font-family:"Cambria",serif'>X</span><span
lang=RU style='font-family:"Cambria",serif'> + </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>X</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>; если </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>n</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> &lt; </span></i><span lang=RU
style='font-family:"Cambria",serif'>0, то [</span><span lang=EN-US
style='font-family:"Cambria",serif'>n</span><span lang=RU style='font-family:
"Cambria",serif'>]</span><span lang=EN-US style='font-family:"Cambria",serif'>X</span><span
lang=RU style='font-family:"Cambria",serif'> = −[−</span><span lang=EN-US
style='font-family:"Cambria",serif'>n</span><span lang=RU style='font-family:
"Cambria",serif'>]</span><span lang=EN-US style='font-family:"Cambria",serif'>X</span><span
lang=RU style='font-family:"Cambria",serif'>. Карта [</span><span lang=EN-US
style='font-family:"Cambria",serif'>n</span><span lang=RU style='font-family:
"Cambria",serif'>] = [</span><span lang=EN-US style='font-family:"Cambria",serif'>n</span><span
lang=RU style='font-family:"Cambria",serif'>]</span><sub><span lang=EN-US
style='font-family:"Cambria",serif'>E</span></sub><span lang=RU
style='font-family:"Cambria",serif'> : </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>E</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>→ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>для </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><i><span lang=RU
style='font-family:"Cambria",serif'>≠</span></i><span lang=RU style='font-family:
"Cambria",serif'> 0 </span><span lang=RU>является <i>изогенией, что означает,
что она является непостоянным гомоморфизмом для группового закона </i></span><i><span
lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>:</span></i></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:14.6pt;margin-left:0cm;text-align:left;text-indent:0cm;
line-height:110%'><span lang=RU style='font-size:11.0pt;line-height:110%'>            </span><span
lang=RU style='font-family:"Cambria",serif'>[</span><span lang=EN-US
style='font-family:"Cambria",serif'>n</span><span lang=RU style='font-family:
"Cambria",serif'>](</span><span lang=EN-US style='font-family:"Cambria",serif'>P</span><span
lang=RU style='font-family:"Cambria",serif'> + </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>Q</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) = [</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>n</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>]</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>P</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>+ [</span><span lang=EN-US style='font-family:"Cambria",serif'>n</span><span
lang=RU style='font-family:"Cambria",serif'>]</span><span lang=EN-US
style='font-family:"Cambria",serif'>Q</span><i><span lang=RU style='font-family:
"Cambria",serif'>         </span></i><span lang=RU>для любых </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>P</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>Q</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>∈ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>K</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>∈ </span><span lang=EN-US>Z</span><span lang=RU>.            (26)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:11.8pt;
margin-left:-.25pt'><span lang=RU>В частности, </span><span lang=RU
style='font-family:"Cambria",serif'>[−1]</span><sub><span lang=EN-US
style='font-family:"Cambria",serif'>E</span></sub><span lang=RU
style='font-family:"Cambria",serif'> : </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>E</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>→ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>P</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>→7 −</span><span lang=EN-US style='font-family:"Cambria",serif'>P</span><span
lang=RU style='font-family:"Cambria",serif'>, является инволютивным
автоморфизмом эллиптической кривой </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>E</span></i><i><span lang=RU style='font-family:"Cambria",serif'>.
Если </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>находится
в форме Вейерштрасса, </span><span lang=RU style='font-family:"Cambria",serif'>[−1]</span><sub><span
lang=EN-US style='font-family:"Cambria",serif'>E</span></sub><span lang=EN-US
style='font-family:"Cambria",serif'> </span><span lang=RU>карты </span><span
lang=RU style='font-family:"Cambria",serif'>(</span><span lang=EN-US
style='font-family:"Cambria",serif'>x</span><span lang=RU style='font-family:
"Cambria",serif'>,</span><span lang=EN-US style='font-family:"Cambria",serif'>y</span><span
lang=RU style='font-family:"Cambria",serif'>) → (</span><span lang=EN-US
style='font-family:"Cambria",serif'>x</span><span lang=RU style='font-family:
"Cambria",serif'>,−</span><span lang=EN-US style='font-family:"Cambria",serif'>y</span><span
lang=RU style='font-family:"Cambria",serif'>), а две точки </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>P</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>Q</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>∈ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>F<sub>q</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU>имеют </span><i><span
lang=RU style='font-family:"Cambria",serif'>равные </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>-координаты тогда и только тогда, когда </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>Q</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= ±</span><span lang=EN-US style='font-family:"Cambria",serif'>P</span><span
lang=RU style='font-family:"Cambria",serif'>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:4.25pt;
margin-left:-.25pt;line-height:128%'><span lang=RU>А.1.7. Порядок группы
рациональных точек </span><i><span lang=RU style='font-family:"Cambria",serif'>Е.
Пусть </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>—
эллиптическая кривая, определённая над конечным базовым полем </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, и пусть </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>K</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= </span><span lang=EN-US>F<sub>q</sub></span><span lang=RU> —
конечное расширение </span><i><span lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>. Тогда </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>F<sub>q</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU>является
конечной абелевой группой. По известному результату Хассе порядок </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>этой группы не
слишком далек от </span><i><span lang=EN-US style='font-family:"Cambria",serif'>q</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>:</span></i></p>

<p class=MsoNormal align=left style='margin:0cm;text-align:left;text-indent:
0cm;line-height:107%'><span lang=RU style='font-size:11.0pt;line-height:107%'>                                                                           </span><sup><span
lang=RU style='font-family:"Cambria",serif'>                                                 </span></sup></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:15.75pt;margin-left:0cm;text-align:left;text-indent:0cm;
line-height:110%'><span lang=RU style='font-size:11.0pt;line-height:110%'>                    </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= | </span><span lang=EN-US style='font-family:"Cambria",serif'>E</span><span
lang=RU style='font-family:"Cambria",serif'>(</span><span lang=EN-US
style='font-family:"Cambria",serif'>F<sub>q</sub></span><span lang=RU
style='font-family:"Cambria",serif'>)| = </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>q</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>− </span><i><span lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>+ 1 </span><span lang=RU>, где </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><sup><span
lang=RU style='font-family:"Cambria",serif'>2 </span></sup></i><i><span
lang=RU style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>≤ 4</span><span lang=EN-US
style='font-family:"Cambria",serif'>q</span><span lang=RU style='font-family:
"Cambria",serif'>, т.е. |</span><span lang=EN-US style='font-family:"Cambria",serif'>t</span><span
lang=RU style='font-family:"Cambria",serif'>| ≤ 2√</span><i><span lang=EN-US
style='font-family:"Cambria",serif'>q</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.                  (27)</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.4pt;
margin-left:-.25pt'><span lang=RU>Нас больше всего заинтересует случай </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>K</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= </span><i><span lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= </span><span lang=EN-US>F<sub>p</sub></span><span
lang=RU>, где </span><i><span lang=EN-US style='font-family:"Cambria",serif'>q</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>p</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>— простое число.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:2.15pt;
margin-left:-.25pt'><span lang=EN-US>A</span><span lang=RU>.1.8. Циклические
подгруппы большого простого порядка. Криптография эллиптических кривых обычно
выполняется с использованием эллиптических кривых, которые допускают
(обязательно циклическую) подгруппу </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>C</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>⊂ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>F<sub>q</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU>простого порядка
</span><i><span lang=EN-US>e</span></i><i><span lang=RU style='font-family:
"Cambria",serif'>. Эквивалентно, может быть задана рациональная точка </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>G</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>∈ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>F<sub>q</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU>простого порядка
</span><i><span lang=EN-US>e</span></i><span lang=RU>; тогда </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>C</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>может быть
восстановлена как циклическая подгруппа </span><b><span lang=EN-US
style='font-family:"Cambria Math",serif;color:#202122;background:white'>⟨</span></b><span
lang=EN-US style='line-height:104%'>G</span><b><span lang=EN-US
style='font-family:"Cambria Math",serif;color:#202122;background:white'>⟩</span></b><span
lang=RU style='font-family:"Cambria",serif'>,</span><span lang=RU> порожденная </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>G</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>. Чтобы убедиться, что точка </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>G</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>∈ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>F<sub>q</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU>порождает
циклическую группу простого порядка </span><i><span lang=EN-US>e</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, можно проверить, что </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>G</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><i><span lang=RU
style='font-family:"Cambria",serif'>≠</span></i><span lang=RU style='font-family:
"Cambria",serif'> </span><i><span lang=EN-US style='font-family:"Cambria",serif'>O</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, но </span></i><span lang=RU
style='font-family:"Cambria",serif'>[</span><i><span lang=EN-US>e</span></i><span
lang=RU style='font-family:"Cambria",serif'>]</span><span lang=EN-US
style='font-family:"Cambria",serif'>G</span><span lang=RU style='font-family:
"Cambria",serif'> = </span><i><span lang=EN-US style='font-family:"Cambria",serif'>O</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:15.7pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Согласно теореме
Лежандра, </span><i><span lang=EN-US>e</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>обязательно
является делителем  порядка </span><i><span lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= | </span><span lang=EN-US
style='font-family:"Cambria",serif'>E</span><span lang=RU style='font-family:
"Cambria",serif'>(</span><span lang=EN-US style='font-family:"Cambria",serif'>F<sub>q</sub></span><span
lang=RU style='font-family:"Cambria",serif'>)| </span><span lang=RU>конечной
абелевой группы </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>F<sub>q</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>):</span></i></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:14.35pt;margin-left:0cm;text-align:left;text-indent:0cm;
line-height:110%'><span lang=RU style='font-size:11.0pt;line-height:110%'>                               </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= | </span><span lang=EN-US style='font-family:"Cambria",serif'>E</span><span
lang=RU style='font-family:"Cambria",serif'>(</span><span lang=EN-US
style='font-family:"Cambria",serif'>F<sub>q</sub></span><span lang=RU
style='font-family:"Cambria",serif'>)| = </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>c</span></i><i><span lang=EN-US> </span><span
lang=EN-US>e</span></i><i><span lang=RU style='font-family:"Cambria",serif'> </span></i><span
lang=RU>для некоторого целого числа </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>c</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>≥ 1       </span><span lang=RU>(28)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Целое число </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>c</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>называется <i>кофактором;
обычно хочется, чтобы кофактор был как можно меньше, чтобы сделать </i></span><i><span
lang=EN-US>e</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU style='font-family:"Cambria",serif'>= </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>/</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>c</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>как можно
большим. Напомним, что </span><i><span lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>всегда
имеет тот же порядок величины, что </span><i><span lang=RU style='font-family:
"Cambria",serif'>и </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>q</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>на
(27), поэтому его нельзя сильно изменить, изменяя </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>E</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>после того, как </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>q</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>зафиксирован.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:9.05pt;
margin-left:-.25pt'><span lang=EN-US>A</span><span lang=RU>.1.9. Данные для
криптографии эллиптических кривых. Чтобы определить конкретную криптографию
эллиптической кривой, необходимо зафиксировать конечное базовое поле </span><span
lang=EN-US>F<sub>q</sub></span><span lang=RU> (если </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>q</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= </span><i><span lang=EN-US style='font-family:"Cambria",serif'>p</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>является
простым числом, достаточно зафиксировать простое </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>p</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>), эллиптическую кривую </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>/</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>F<sub>q</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>(обычно
представленную коэффициентами ее формы Вейерштрасса (23) или (21)), базовую
точку </span><i><span lang=EN-US style='font-family:"Cambria",serif'>O</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>(которая
обычно является точкой бесконечности эллиптической кривой, записанной в форме
Вейерштрасса), и генератор </span><i><span lang=EN-US style='font-family:"Cambria",serif'>G</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>∈ </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>E</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>F<sub>q</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU>(обычно
определяется его координатами </span><span lang=RU style='font-family:"Cambria",serif'>(</span><span
lang=EN-US style='font-family:"Cambria",serif'>x</span><span lang=RU
style='font-family:"Cambria",serif'>,</span><span lang=EN-US style='font-family:
"Cambria",serif'>y</span><span lang=RU style='font-family:"Cambria",serif'>) </span><span
lang=RU>относительно уравнения эллиптической кривой) циклической подгруппы
большого простого порядка </span><i><span lang=EN-US>e</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>. Простое число </span><span
lang=EN-US>e</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>и кофактор </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>c</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>обычно также
являются частью данных эллиптической криптографии.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:1.95pt;
margin-left:-.25pt'><span lang=EN-US>A</span><span lang=RU>.1.10. Основные
операции криптографии эллиптических кривых. Криптография эллиптических кривых
обычно имеет дело с фиксированной циклической подгруппой </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>C</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>большого простого
порядка </span><i><span lang=EN-US>e</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>внутри группы
точек эллиптической кривой </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>над
конечным полем </span><span lang=EN-US>F<sub>q</sub></span><span lang=RU>.
Генератор </span><i><span lang=EN-US style='font-family:"Cambria",serif'>G</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>из </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>C</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>обычно
фиксирован. Обычно предполагается, что, учитывая точку </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>X</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>из </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>C</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, нельзя найти ее «дискретное
логарифмическое основание </span></i><i><span lang=EN-US style='font-family:
"Cambria",serif'>G</span></i><i><span lang=RU style='font-family:"Cambria",serif'>»
(т. е. остаток </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>n</span></i><span
lang=EN-US> </span><span lang=RU>по модулю </span><i><span lang=EN-US>e</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>такой,
что </span><i><span lang=EN-US style='font-family:"Cambria",serif'>X</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= [</span><span lang=EN-US
style='font-family:"Cambria",serif'>n</span><span lang=RU style='font-family:
"Cambria",serif'>]</span><span lang=EN-US style='font-family:"Cambria",serif'>G</span><span
lang=RU style='font-family:"Cambria",serif'>) быстрее, чем в <i>операциях       </i></span><i><span
lang=EN-US style='font-family:"Cambria",serif'>O</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><i><span lang=RU
style='font-family:"Cambria",serif'>(√</span><span lang=EN-US>e</span></i><span
lang=RU>). Наиболее важными операциями, используемыми в криптографии
эллиптических кривых, являются сложение точек из </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>C</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>⊂ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>F<sub>q</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU>и вычисление их
степеней, или кратных.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=EN-US>A</span><span lang=RU>.1.11. Закрытые и
открытые ключи для криптографии эллиптических кривых. Обычно закрытым ключом для
криптографии эллиптических кривых, описываемым данными, перечисленными в </span><span
lang=EN-US>A</span><span lang=RU>.1.9, является «случайное» целое число </span><span
lang=RU style='font-family:"Cambria",serif'>0 <i>&lt;</i></span><i><span
lang=EN-US style='font-family:"Cambria",serif'>a</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> &lt;</span></i><i><span lang=RU> </span><span
lang=EN-US>e</span></i><i><span lang=RU style='font-family:"Cambria",serif'>,
называемое </span></i><i><span lang=RU>секретной экспонентой, а соответствующим
открытым ключом является точка </span></i><i><span lang=EN-US style='font-family:
"Cambria",serif'>A</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU style='font-family:"Cambria",serif'>:= [</span><span
lang=EN-US style='font-family:"Cambria",serif'>a</span><span lang=RU
style='font-family:"Cambria",serif'>]</span><span lang=EN-US style='font-family:
"Cambria",serif'>G</span><span lang=EN-US style='font-family:"Cambria",serif'> </span><span
lang=RU>(или просто ее </span><i><span lang=EN-US style='font-family:"Cambria",serif'>xcoordinate</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>x<sub>A</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>), соответствующим образом сериализованная.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:13.0pt;
margin-left:-.25pt'><span lang=EN-US>A</span><span lang=RU>.1.12. Кривые
Монтгомери. Эллиптические кривые с конкретным уравнением Вейерштрасса</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:13.4pt;margin-left:0cm;text-align:left;text-indent:0cm'><span
lang=RU style='font-size:11.0pt;line-height:104%'>       </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>y</span></i><i><sup><span
lang=RU style='font-family:"Cambria",serif'>2</span></sup></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= </span><i><span lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><sup><span
lang=RU style='font-family:"Cambria",serif'>3</span></sup></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>+ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>Ax</span></i><i><sup><span
lang=RU style='font-family:"Cambria",serif'>2</span></sup></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>+ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>        </span></i><span lang=RU>,
где </span><i><span lang=EN-US style='font-family:"Cambria",serif'>A</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= 4</span><span lang=EN-US
style='font-family:"Cambria",serif'>a</span><span lang=RU style='font-family:
"Cambria",serif'> − 2 </span><span lang=RU>для некоторых </span><span lang=RU
style='font-family:"Cambria",serif'>∈ </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>k</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>a</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><i><span lang=RU
style='font-family:"Cambria",serif'>≠ </span></i><span lang=RU
style='font-family:"Cambria",serif'>6, </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>a</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><i><span lang=RU
style='font-family:"Cambria",serif'>≠</span></i><span lang=RU style='font-family:
"Cambria",serif'> 1     </span><span lang=RU>(29)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:6.85pt;
margin-left:-.25pt;line-height:124%'><span lang=RU>называются <i>кривыми
Монтгомери. Они обладают удобным свойством, что </i></span><i><span lang=EN-US
style='font-family:"Cambria",serif'>x<sub>P</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>Q</span></sub></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>x<sub>P</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>−</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>Q</span></sub></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>может
быть выражена как простая рациональная функция </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>x<sub>P</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>x<sub>Q</sub></span></i><i><span
lang=RU style='font-family:"Cambria",serif'>:</span></i></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:9.9pt;margin-left:0cm;text-align:left;text-indent:0cm;line-height:
110%'><span lang=RU style='font-size:11.0pt;line-height:110%'>                                         </span><span
lang=RU><img width=144 height=31 id="Picture 148337"
src="tblkch_convertio_ru_done.fld/image017.jpg"></span><span lang=RU>                                  (30)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:3.4pt;
margin-left:-.25pt'><span lang=RU>Это означает, что </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>x<sub>P</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>Q</span></sub></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>может
быть вычислен при условии</span><i><span lang=RU style='font-family:"Cambria",serif'>,
что </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>x<sub>P</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>−</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>Q</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'>, </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>x<sub>P</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>x<sub>Q</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>известный. В частности, если </span><i><span
lang=RU style='font-family:"Cambria",serif'>известны </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>x<sub>P</sub></span></i><span
lang=RU>, </span><i><span lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>[</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></sub></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>]</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>P</span></sub></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>[</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></sub></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+1]</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>P</span></sub></i><span lang=RU>,
то </span><i><span lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>[2</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></sub></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>]</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>P</span></sub></i><span lang=RU>,
</span><i><span lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>[2</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></sub></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+1]</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>P</span></sub></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>[2</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></sub></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+2]</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>P</span></sub></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>могут
быть вычислены. Используя двоичное представление               </span><span
lang=RU style='font-family:"Cambria",serif'>0 <i>&lt; </i></span><i><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> &lt; </span></i><span lang=RU
style='font-family:"Cambria",serif'>2</span><sup><span lang=EN-US
style='font-family:"Cambria",serif'>s</span></sup><span lang=RU
style='font-family:"Cambria",serif'>, можно вычислить </span><span lang=RU><img
width=141 height=13 id="Рисунок 1"
src="tblkch_convertio_ru_done.fld/image018.jpg"></span><span lang=RU>для </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>i</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 0, 1,..., </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>s</span></i><i><span lang=RU style='font-family:"Cambria",serif'>,
получив таким образом</span></i><span lang=RU> </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>x</span></i><i><sub><span lang=RU
style='font-family:"Cambria",serif'>[</span></sub></i><i><sub><span lang=EN-US
style='font-family:"Cambria",serif'>n</span></sub></i><i><sub><span lang=RU
style='font-family:"Cambria",serif'>]</span></sub></i><i><sub><span lang=EN-US
style='font-family:"Cambria",serif'>P</span></sub></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>(этот алгоритм
для быстрого вычисления </span><i><span lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>[</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>n</span></sub></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>]</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>P</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'>,</span></i><span lang=RU> начиная
с </span><i><span lang=EN-US style='font-family:"Cambria",serif'>x<sub>P</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>на
кривых Монтгомери, называется лестницей <i>Монтгомери). Следовательно, мы видим
важность кривых Монтгомери для криптографии эллиптических кривых.</i></span></p>

</div>

<span lang=RU style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'><br clear=all style='page-break-before:always'>
</span>

<div class=WordSection23>

<h2 style='margin-left:-.75pt;text-indent:0cm'><a name="_Toc150784"><span
lang=EN-US>A</span></a><span lang=RU>.2       Криптография </span><span
lang=EN-US>Curve</span><span lang=RU>25519</span></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>В этом разделе описывается известная
криптография </span><span lang=EN-US>Curve</span><span lang=RU>25519,
предложенная Даниэлем Бернштейном [1], и ее использование в </span><span
lang=EN-US>TON</span><span lang=RU>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.35pt;margin-bottom:
2.95pt;margin-left:13.15pt;text-indent:-13.9pt;line-height:198%'><span
lang=EN-US>A</span><span lang=RU>.2.1. </span><span lang=EN-US>Curve</span><span
lang=RU>25519. </span><i><span lang=EN-US>Curve</span></i><i><span lang=RU>25519
</span></i><span lang=RU>определяется как кривая Монтгомери           </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>y</span></i><i><sup><span
lang=RU style='font-family:"Cambria",serif'>2</span></sup></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= </span><i><span lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><sup><span
lang=RU style='font-family:"Cambria",serif'>3</span></sup></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>+ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>Ax</span></i><i><sup><span
lang=RU style='font-family:"Cambria",serif'>2</span></sup></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>+ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>над </span><span
lang=EN-US>F<sub>p</sub></span><span lang=RU>, где </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>p</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 2<sup>255</sup> − 19 </span><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>A</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 486662.                (31)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.35pt;margin-bottom:
11.9pt;margin-left:-.25pt'><span lang=RU>Порядок этой кривой равен </span><span
lang=RU style='font-family:"Cambria",serif'>8</span><i><span lang=EN-US>e</span></i><span
lang=RU style='font-family:"Cambria",serif'>, где </span><i><span lang=EN-US>e</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>—
простое число, а </span><i><span lang=EN-US style='font-family:"Cambria",serif'>c</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= 8 </span><span lang=RU>— кофактор.
Циклическая подгруппа порядка </span><i><span lang=RU style='font-family:"Cambria",serif'>'
</span></i><span lang=RU>порождается точкой </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>G</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>с </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>x<sub>G</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= 9 </span><span lang=RU>(это определяет </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>G</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>до знака </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>y<sub>G</sub></span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, что неважно). Порядок
квадратичного скручивания </span></i><span lang=RU style='font-family:"Cambria",serif'>2</span><span
lang=EN-US style='font-family:"Cambria",serif'>y</span><sup><span lang=RU
style='font-family:"Cambria",serif'>2</span></sup><span lang=RU
style='font-family:"Cambria",serif'> = </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>x</span></i><i><sup><span lang=RU
style='font-family:"Cambria",serif'>3</span></sup></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>+ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>Ax</span></i><i><sup><span
lang=RU style='font-family:"Cambria",serif'>2</span></sup></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>+ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=EN-US>Curve</span><span
lang=RU>25519 равен </span><span lang=RU style='font-family:"Cambria",serif'>4</span><i><span
lang=RU> </span><span lang=EN-US>e</span></i><span lang=RU style='font-family:
"Cambria",serif'>‘ </span><span lang=RU>для другого простого числа </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>e</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’.</span></i><a href="#_ftn42"
name="_ftnref42" title=""><sup><span lang=EN-US><sup><span lang=EN-US
style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'>[42]</span></sup></span></sup></a></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=EN-US>A</span><span lang=RU>.2.2. Параметры </span><span
lang=EN-US>Curve</span><span lang=RU>25519. Параметры </span><span lang=EN-US>Curve</span><span
lang=RU>25519 следующие:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:13.75pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Базовое поле: Простое конечное поле </span><span
lang=EN-US>F<sub>p</sub></span><span lang=RU> для </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>p</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 2255 − 19.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:12.8pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Уравнение: </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>y</span></i><i><sup><span lang=RU
style='font-family:"Cambria",serif'>2</span></sup></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= </span><i><span lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><sup><span
lang=RU style='font-family:"Cambria",serif'>3</span></sup></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>+ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>Ax</span></i><i><sup><span
lang=RU style='font-family:"Cambria",serif'>2</span></sup></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>+ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>для </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>A</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 486662.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:13.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Базовая точка </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>G</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>: характеризуется </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>x<sub>G</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= 9 </span><span lang=RU>(девять —
наименьшее положительное целое число </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>x</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>-координат генератора подгруппы большого
простого порядка </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>F<sub>p</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>)).</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:16.1pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=EN-US style='line-height:
104%;font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=EN-US>Порядок </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>E(F<sub>p</sub>):</span></i></p>

<p class=MsoNormal align=right style='margin-top:0cm;margin-right:0cm;
margin-bottom:5.9pt;margin-left:0cm;text-align:right;text-indent:0cm;
line-height:107%'><span lang=EN-US style='font-family:"Cambria",serif'>| E(F<sub>p</sub>)|
=p − <i>t </i>+ 1 = 8</span><i><span lang=EN-US>e</span></i><span lang=EN-US
style='font-family:"Cambria",serif'>,<i>        </i></span><span lang=EN-US>где                                                 
(32)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:-.55pt;margin-bottom:
.75pt;margin-left:0cm;text-indent:0cm;line-height:107%'><span lang=RU
style='font-size:11.0pt;line-height:107%'> </span><i><span lang=EN-US>e</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= 2<sup>252</sup> +
27742317777372353535851937790883648493 </span><span lang=RU>является простым.  </span><span
lang=EN-US>                                                                                                                      (33)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Порядок </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>E</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> ̃(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>F<sub>p</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>), где </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>E</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> ̃ </span></i><span lang=RU>— квадратичное
скручивание </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>:</span></i></p>

<p class=MsoNormal align=right style='margin-top:0cm;margin-right:0cm;
margin-bottom:5.9pt;margin-left:0cm;text-align:right;text-indent:0cm;
line-height:107%'><span lang=RU style='font-size:11.0pt;line-height:107%'> </span><span
lang=RU style='font-family:"Cambria",serif'>| </span><span lang=EN-US
style='font-family:"Cambria",serif'>E</span><span lang=RU style='font-family:
"Cambria",serif'> ̃(</span><span lang=EN-US style='font-family:"Cambria",serif'>F<sub>p</sub></span><span
lang=RU style='font-family:"Cambria",serif'>)| =</span><span lang=EN-US
style='font-family:"Cambria",serif'>p</span><span lang=RU style='font-family:
"Cambria",serif'> + </span><i><span lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>+ 1 = 2</span><span lang=EN-US
style='font-family:"Cambria",serif'>p</span><span lang=RU style='font-family:
"Cambria",serif'> + 2 − 8</span><i><span lang=EN-US>e</span></i><span lang=RU
style='font-family:"Cambria",serif'> = 4</span><i><span lang=EN-US>e</span></i><i><span
lang=RU>’</span></i><span lang=RU style='font-family:"Cambria",serif'>,          
где                   </span><span lang=RU>(34)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:-.55pt;margin-bottom:
1.35pt;margin-left:0cm;text-indent:1.0cm;line-height:107%'><span lang=RU
style='font-size:11.0pt;line-height:107%'> </span><i><span lang=EN-US>e’</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= 2<sup>253</sup> – 55484635554744707071703875581767296995
</span><span lang=RU>является простым.                                                                                                                      
(35)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.35pt;margin-bottom:
.7pt;margin-left:0cm;text-indent:0cm'><span lang=EN-US>A</span><span lang=RU>.2.3.
Закрытый и открытый ключи для стандартного </span><span lang=EN-US>Curve</span><span
lang=RU>25519 </span><span lang=EN-US>cryptog</span><span lang=RU>-</span><span
lang=EN-US>raphy</span><span lang=RU>. Закрытый ключ для криптографии </span><span
lang=EN-US>Curve</span><span lang=RU>25519 обычно определяется как секретная <i>экспонента
</i></span><i><span lang=EN-US style='font-family:"Cambria",serif'>a</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, в то время как соответствующий
открытый ключ — </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>x<sub>A</sub></span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, координата </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> точки </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>A</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>:= [</span><i><span lang=EN-US style='font-family:"Cambria",serif'>a</span></i><span
lang=RU style='font-family:"Cambria",serif'>]</span><span lang=EN-US
style='font-family:"Cambria",serif'>G</span><span lang=RU style='font-family:
"Cambria",serif'>. Обычно этого достаточно для выполнения </span><span
lang=EN-US style='font-family:"Cambria",serif'>ECDH</span><span lang=RU
style='font-family:"Cambria",serif'> (эллиптическая кривая Обмена ключами
Диффи-Хеллмана) и асимметричной криптографии эллиптических кривых, а именно:</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.35pt;margin-bottom:
5.35pt;margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Если сторона хочет
отправить сообщение </span><i><span lang=EN-US style='font-family:"Cambria",serif'>M</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>другой
стороне, которая имеет открытый ключ </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>x<sub>A</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>(и
закрытый ключ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>a</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>), выполняются следующие вычисления.
Генерируется одноразовая случайная секретная экспонента </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>b</span></i><span lang=RU>, а </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>x<sub>B</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>:= </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>x</span></i><i><sub><span lang=RU
style='font-family:"Cambria",serif'>[</span></sub></i><i><sub><span lang=EN-US
style='font-family:"Cambria",serif'>b</span></sub></i><i><sub><span lang=RU
style='font-family:"Cambria",serif'>]</span></sub></i><i><sub><span lang=EN-US
style='font-family:"Cambria",serif'>G</span></sub></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>[</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>b</span></sub></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>]</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>A</span></sub></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>вычисляются
с помощью лестницы Монтгомери. После этого сообщение </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>M</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>шифруется
симметричным шифром, таким как </span><span lang=EN-US>AES</span><span lang=RU>,
используя 256-битный «общий секрет» </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>S</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>:= </span><i><span lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>[</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>b</span></sub></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>]</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>A</span></sub></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>в
качестве ключа, а 256-битное целое число («одноразовый открытый ключ») </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>x<sub>B</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>предваряется
зашифрованному сообщению. Как только сторона с открытым ключом </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>x<sub>A</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>получает
это сообщение, она может вычислять </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>x</span></i><i><sub><span lang=RU style='font-family:"Cambria",serif'>[</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>a</span></sub></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>]</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>B</span></sub></i><span lang=RU>,
начиная с </span><i><span lang=EN-US style='font-family:"Cambria",serif'>x<sub>B</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>(передается
с зашифрованным сообщением) и закрытого </span><i><span lang=RU
style='font-family:"Cambria",serif'>ключа </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>a</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>. Поскольку </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>x</span></i><i><sub><span lang=RU
style='font-family:"Cambria",serif'>[</span></sub></i><i><sub><span lang=EN-US
style='font-family:"Cambria",serif'>a</span></sub></i><i><sub><span lang=RU
style='font-family:"Cambria",serif'>]</span></sub></i><i><sub><span lang=EN-US
style='font-family:"Cambria",serif'>B</span></sub></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= </span><i><span lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>[</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>ab</span></sub></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>]</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>G</span></sub></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>x</span></i><i><sub><span lang=RU
style='font-family:"Cambria",serif'>[</span></sub></i><i><sub><span lang=EN-US
style='font-family:"Cambria",serif'>b</span></sub></i><i><sub><span lang=RU
style='font-family:"Cambria",serif'>]</span></sub></i><i><sub><span lang=EN-US
style='font-family:"Cambria",serif'>A</span></sub></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= </span><i><span lang=EN-US style='font-family:"Cambria",serif'>S</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, принимающая сторона
восстанавливает общий секрет </span></i><i><span lang=EN-US style='font-family:
"Cambria",serif'>S</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>и может расшифровать оставшуюся часть сообщения.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.35pt;margin-bottom:
0cm;margin-left:0cm;text-indent:0cm'><span lang=EN-US>A</span><span lang=RU>.2.4.
Открытые и закрытые ключи для криптографии </span><span lang=EN-US>TON</span><span
lang=EN-US> </span><span lang=EN-US>Curve</span><span lang=RU>25519. </span><span
lang=EN-US>TON</span><span lang=RU> использует другую форму для открытых и
закрытых ключей криптографии </span><span lang=EN-US>Curve</span><span lang=RU>25519,
заимствованную из криптографии </span><span lang=EN-US>Ed</span><span lang=RU>25519.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.35pt;margin-bottom:
1.95pt;margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Закрытый ключ для
криптографии </span><span lang=EN-US>TON</span><span lang=EN-US> </span><span
lang=EN-US>Curve</span><span lang=RU>25519 — это просто случайная 256-битная
строка </span><i><span lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>. Он используется для вычисления </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>sha</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>512(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>k</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>), взятия первых 256 бит результата, </span></i><span
lang=RU>интерпретации их как 256-битного целого числа </span><span lang=EN-US>a</span><span
lang=RU> с младшим порядком байтов </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>a</span></i><i><span lang=RU style='font-family:"Cambria",serif'>,
очистки битов </span></i><span lang=RU style='font-family:"Cambria",serif'>0,
1, 2 и 255 </span><span lang=RU>из </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>a</span></i><i><span lang=RU style='font-family:"Cambria",serif'>
и установки бита </span></i><span lang=RU style='font-family:"Cambria",serif'>254
</span><span lang=RU>таким образом, чтобы получить значение </span><span
lang=RU style='font-family:"Cambria",serif'>2<sup>254</sup> ≤ </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>a</span></i><span lang=EN-US
style='font-family:"Cambria",serif'> </span><i><span lang=RU style='font-family:
"Cambria",serif'>&lt; </span></i><span lang=RU style='font-family:"Cambria",serif'>2<sup>255</sup>,
делимое на восемь. </span><span lang=RU>Полученное таким образом значение </span><span
lang=EN-US>a</span><span lang=RU> является <i>секретной экспонентой</i>,</span><i><span
lang=RU style='font-family:"Cambria",serif'> соответствующей </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>; между тем, оставшиеся 256 бит </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>sha</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>512(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>k</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU>составляют <i>секретную
соль </i></span><i><span lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>’’.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.35pt;margin-bottom:
10.65pt;margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Открытый ключ, </span><i><span
lang=RU style='font-family:"Cambria",serif'>соответствующий </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> или секретной экспоненте </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>a</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, является просто координатой </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>x<sub>A</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>точки </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>A</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>:= [</span><span lang=EN-US style='font-family:"Cambria",serif'>a</span><span
lang=RU style='font-family:"Cambria",serif'>]</span><span lang=EN-US
style='font-family:"Cambria",serif'>G</span><span lang=RU style='font-family:
"Cambria",serif'>. После <i>вычисления </i></span><i><span lang=EN-US
style='font-family:"Cambria",serif'>a</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>x<sub>A</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>они
используются точно так же, как и в </span><span lang=EN-US>A</span><span
lang=RU>.2.3. В частности, если </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>x<sub>A</sub></span></i><i><span lang=EN-US style='font-family:
"Cambria",serif'> </span></i><span lang=RU>необходимо сериализовать, он
сериализуется в 32 октета как беззнаковое 256-битное целое число с младшим
порядком байтов.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.35pt;margin-bottom:
21.35pt;margin-left:-.25pt'><span lang=EN-US>A</span><span lang=RU>.2.5. </span><span
lang=EN-US>Curve</span><span lang=RU>25519 используется в сети </span><span
lang=EN-US>TON</span><span lang=RU>. Обратите внимание, что асимметричная
криптография </span><span lang=EN-US>Curve</span><span lang=RU>25519, описанная
в </span><span lang=EN-US>A</span><span lang=RU>.2.4, широко используется сетью
</span><span lang=EN-US>TON</span><span lang=RU>, особенно протоколом </span><span
lang=EN-US>ADNL</span><span lang=RU> (</span><span lang=EN-US>Abstract</span><span
lang=EN-US> </span><span lang=EN-US>Datagram</span><span lang=EN-US> </span><span
lang=EN-US>Network</span><span lang=EN-US> </span><span lang=EN-US>Layer</span><span
lang=RU>). Тем не менее, </span><span lang=EN-US>TON</span><span lang=EN-US> </span><span
lang=EN-US>Blockchain</span><span lang=RU> нуждается в криптографии
эллиптических кривых в основном для подписей. Для этого используются подписи </span><span
lang=EN-US>Ed</span><span lang=RU>25519, описанные в следующем разделе.</span></p>

<h2 style='margin-left:-.75pt;text-indent:0cm'><a name="_Toc150785"><span
lang=EN-US>A</span></a><span lang=RU>.3   </span><span lang=EN-US>Ed</span><span
lang=RU>25519 криптография</span></h2>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.35pt;margin-bottom:
10.65pt;margin-left:-.25pt'><span lang=RU>Криптография </span><span lang=EN-US>Ed</span><span
lang=RU>25519 широко используется для быстрых криптографических подписей как
блокчейном </span><span lang=EN-US>TON</span><span lang=RU>, так и сетью </span><span
lang=EN-US>TON</span><span lang=RU>. В этом разделе описывается вариант
криптографии </span><span lang=EN-US>Ed</span><span lang=RU>25519, используемый
</span><span lang=EN-US>TON</span><span lang=RU>. Важным отличием от
стандартных подходов (определяемых </span><span lang=EN-US>D</span><span
lang=RU>. </span><span lang=EN-US>Bernstein</span><span lang=EN-US> </span><span
lang=EN-US>et</span><span lang=EN-US> </span><span lang=EN-US>al</span><span
lang=RU>. в [2]) является то, что </span><span lang=EN-US>TON</span><span
lang=RU> обеспечивает автоматическое преобразование закрытых и публичных ключей
</span><span lang=EN-US>Ed</span><span lang=RU>25519 в ключи </span><span
lang=EN-US>Curve</span><span lang=RU>25519, так что одни и те же ключи могут
использоваться как для шифрования/расшифровки, так и для подписи сообщений.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:13.5pt;
margin-left:-.25pt'><span lang=EN-US>A</span><span lang=RU>.3.1. Скрученные
кривые Эдвардса. <i>Скрученная кривая Эдвардса </i></span><i><span lang=EN-US
style='font-family:"Cambria",serif'>E<sub>a</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>,</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>d</span></sub></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>с
параметрами </span><i><span lang=EN-US style='font-family:"Cambria",serif'>a</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><i><span lang=RU
style='font-family:"Cambria",serif'>≠</span></i><span lang=RU style='font-family:
"Cambria",serif'> 0 </span><span lang=RU>и </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>d</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>≠ 0,</span><span lang=EN-US style='font-family:"Cambria",serif'>a</span><span
lang=EN-US style='font-family:"Cambria",serif'> </span><span lang=RU>над полем </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>задается
уравнением</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:15.0pt;margin-left:0cm;text-align:left;text-indent:0cm;
line-height:110%'><span lang=RU style='font-size:11.0pt;line-height:110%'>                                      </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>E<sub>a,d</sub> </span></i><span
lang=EN-US style='font-family:"Cambria",serif'>: <i>ax<sup>2</sup> </i>+ <i>y<sup>2</sup>
</i>= 1 + <i>dx<sup>2</sup>y<sup>2</sup></i><sup>            </sup></span><span
lang=EN-US>над </span><i><span lang=EN-US style='font-family:"Cambria",serif'>k                              </span></i><span
lang=EN-US>(36)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.5pt;
margin-left:-.25pt'><span lang=RU>Если </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>a</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 1, это уравнение определяет (раскрученную) кривую Эдвардса.
Точка </span><i><span lang=EN-US style='font-family:"Cambria",serif'>O</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>(0,1) </span></i><span lang=RU>обычно
выбирается в качестве обозначенной точки </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>E<sub>a</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>,</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>d</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:4.4pt;margin-bottom:12.3pt;
margin-left:-.25pt;line-height:110%'><span lang=EN-US>A</span><span lang=RU>.3.2.
Искривленные кривые Эдвардса бирационально эквивалентны кривым Монтгомери.
Искривленная кривая Эдвардса </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>E<sub>a</sub></span></i><i><sub><span lang=RU
style='font-family:"Cambria",serif'>,</span></sub></i><i><sub><span lang=EN-US
style='font-family:"Cambria",serif'>d</span></sub></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>бирационально
эквивалентна эллиптической кривой Монтгомери</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:15.2pt;margin-left:0cm;text-align:left;text-indent:0cm;
line-height:107%'><span lang=RU style='font-size:11.0pt;line-height:107%'>                                                </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>M<sub>A</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>: </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>v</span></i><i><sup><span lang=RU
style='font-family:"Cambria",serif'>2</span></sup></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= </span><i><span lang=EN-US style='font-family:"Cambria",serif'>u</span></i><i><sup><span
lang=RU style='font-family:"Cambria",serif'>3</span></sup></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>+ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>Au</span></i><i><sup><span
lang=RU style='font-family:"Cambria",serif'>2</span></sup></i><i><span lang=RU
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>+ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>u</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>                                          </span></i><span
lang=RU>(37)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:7.35pt;
margin-left:-.25pt;line-height:126%'><span lang=EN-US>где </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>A </span></i><span lang=EN-US
style='font-family:"Cambria",serif'>= 2(a + <i>d)/(a </i>− <i>d) </i></span><span
lang=EN-US>и </span><i><span lang=EN-US style='font-family:"Cambria",serif'>d/a
</span></i><span lang=EN-US style='font-family:"Cambria",serif'>= (A − 2)/(A +
2). </span><span lang=RU style='font-family:"Cambria",serif'>Бирациональная
эквивалентность </span><i><span lang=EN-US style='font-family:"Cambria",serif'>φ</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>: </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>E<sub>a</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>,</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>d</span></sub></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=EN-US
style='font-family:Wingdings'></span><span lang=EN-US> </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>M<sub>A</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>и ее
обратный </span><i><span lang=EN-US style='font-family:"Cambria",serif'>φ</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>−1 </span></i><span lang=RU>задаются
формулой</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:6.4pt;margin-left:0cm;text-align:left;text-indent:0cm;line-height:
110%'><span lang=RU style='font-size:11.0pt;line-height:110%'>                                       </span><span
lang=RU><img width=157 height=29 id="Picture 148338"
src="tblkch_convertio_ru_done.fld/image019.jpg"></span><span lang=RU>                                 (38)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:129.75pt;margin-bottom:
.5pt;margin-left:-.25pt'><span lang=RU>и</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:6.4pt;margin-left:0cm;text-align:left;text-indent:0cm;line-height:
110%'><span lang=RU style='font-size:11.0pt;line-height:110%'>                                          </span><span
lang=RU><img width=138 height=58 id="Picture 148339"
src="tblkch_convertio_ru_done.fld/image020.jpg"></span><span lang=RU>                                    (39)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:162.2pt;margin-bottom:
.5pt;margin-left:-.25pt'><span lang=RU>где</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:4.25pt;margin-left:0cm;text-align:left;text-indent:0cm;
line-height:110%'><span lang=RU style='font-size:11.0pt;line-height:110%'>                                                       </span><span
lang=RU><img width=64 height=29 id="Picture 148340"
src="tblkch_convertio_ru_done.fld/image021.jpg"></span><span lang=RU>                                               (40)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Обратите внимание, что </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>φ</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>преобразует
отмеченную </span><i><span lang=RU style='font-family:"Cambria",serif'>точку </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>O</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>(0,1) </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>E<sub>a</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>,</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>d</span></sub></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>в
отмеченную точку </span><i><span lang=EN-US style='font-family:"Cambria",serif'>M<sub>A</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>(т.е.
ее точку в бесконечности).</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.75pt;
margin-left:-.25pt'><span lang=EN-US>A</span><span lang=RU>.3.3. Сложение точек
на искривленной кривой Эдвардса. Поскольку </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>E<sub>a</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>,</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>d</span></sub></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>бирационально
эквивалентен эллиптической кривой </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>M<sub>A</sub></span></i><i><span lang=RU style='font-family:
"Cambria",serif'>, сложение точек на </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>M<sub>A</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>может
быть перенесено в </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E<sub>a</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>,</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>d</span></sub></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>путем
установки</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:9.8pt;margin-left:0cm;text-align:left;text-indent:0cm;line-height:
110%'><span lang=RU style='font-size:11.0pt;line-height:110%'>                   </span><span
lang=RU><img width=144 height=15 id="Picture 148341"
src="tblkch_convertio_ru_done.fld/image022.jpg"></span><span lang=RU> для
любого </span><i><span lang=EN-US style='font-family:"Cambria",serif'>P</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>Q</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>∈ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E<sub>a</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>,</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>d</span></sub></i><i><span
lang=RU style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>k</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>).(41)</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Обратите внимание, что отмеченная точка </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>O</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>(0,1) </span></i><span lang=RU>является
нейтральным элементом по отношению к этому дополнению, и что </span><span
lang=RU style='font-family:"Cambria",serif'>−(</span><span lang=EN-US
style='font-family:"Cambria",serif'>x<sub>P</sub></span><span lang=RU
style='font-family:"Cambria",serif'>,</span><i><span lang=EN-US
style='font-family:"Cambria",serif'>y<sub>P</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>)</span></i><span lang=RU style='font-family:
"Cambria",serif'> = (−</span><span lang=EN-US style='font-family:"Cambria",serif'>x<sub>P</sub></span><span
lang=RU style='font-family:"Cambria",serif'>,</span><i><span lang=EN-US
style='font-family:"Cambria",serif'>y<sub>P</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>)</span></i><span lang=RU style='font-family:
"Cambria",serif'>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:6.25pt;
margin-left:-.25pt;line-height:124%'><span lang=EN-US>A</span><span lang=RU>.3.4.
Формулы для добавления точек на искривленной кривой Эдвардса. Координаты </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>x<sub>P</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>Q</span></sub></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>y<sub>P</sub></span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>+</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>Q</span></sub></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>допускают
простые выражения как рациональные функции </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>x<sub>P</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>,</span></i><span lang=RU> </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>y<sub>P</sub></span></i><i><span
lang=RU style='font-family:"Cambria",serif'>,</span></i><span lang=RU> </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>x<sub>Q</sub></span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>y<sub>Q</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>:</span></i></p>

<p class=MsoNormal align=left style='margin:0cm;text-align:left;text-indent:
0cm;line-height:110%'><span lang=RU style='font-size:11.0pt;line-height:110%'>                                             </span><span
lang=RU><img width=120 height=27 id="Picture 148342"
src="tblkch_convertio_ru_done.fld/image023.jpg"></span><span lang=RU>                                      (42)</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:8.8pt;margin-left:0cm;text-align:left;text-indent:0cm;line-height:
110%'><span lang=RU style='font-size:11.0pt;line-height:110%'>                                              </span><span
lang=RU><img width=119 height=25 id="Picture 148343"
src="tblkch_convertio_ru_done.fld/image024.jpg"></span><span lang=RU>                                      (43)</span></p>

</div>

<span lang=RU style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black'><br clear=all style='page-break-before:always'>
</span>

<div class=WordSection24>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Эти выражения могут быть эффективно
вычислены, особенно если </span><i><span lang=EN-US style='font-family:"Cambria",serif'>a</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= −1. Именно по этой причине искривленные
кривые Эдвардса важны для криптографии быстрых эллиптических кривых.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=EN-US>A</span><span lang=RU>.3.5. </span><span
lang=EN-US>Ed</span><span lang=RU>25519 как скрученная кривая Эдвардса. </span><span
lang=EN-US>Ed</span><span lang=RU>25519 — закрученная кривая Эдвардса </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>−1,</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>d</span></sub></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>над </span><span
lang=EN-US>F<sub>p</sub></span><span lang=RU>, где </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>p</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 2<sup>255</sup> − 19 </span><span lang=RU>— то же простое
число, что и для </span><span lang=EN-US>Curve</span><span lang=RU>25519, а </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>d</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= −(</span><span lang=EN-US style='font-family:"Cambria",serif'>A</span><span
lang=RU style='font-family:"Cambria",serif'>−2)/(</span><span lang=EN-US
style='font-family:"Cambria",serif'>A</span><span lang=RU style='font-family:
"Cambria",serif'>+2) = −121665/121666, где </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>A</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 486662 </span><span lang=RU>то же самое, что и в уравнении
(31):</span></p>

<p class=MsoNormal align=left style='margin-top:0cm;margin-right:0cm;
margin-bottom:10.75pt;margin-left:0cm;text-align:left;text-indent:0cm;
line-height:110%'><span lang=RU style='font-size:11.0pt;line-height:110%'>                 </span><span
lang=RU><img width=143 height=25 id="Picture 148344"
src="tblkch_convertio_ru_done.fld/image025.jpg"></span><span lang=RU> для </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>y</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>∈ </span><span lang=EN-US>F<sub>p</sub></span><span lang=RU>, </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>p</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 2255 − 19.(44)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Таким образом, кривая </span><span
lang=EN-US>Ed</span><span lang=RU>25519 </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>E</span></i><i><sub><span lang=RU
style='font-family:"Cambria",serif'>−1,</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>d</span></sub></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>бирационно
эквивалентна </span><span lang=EN-US>Curve</span><span lang=RU>25519 (31), и
можно использовать </span><i><span lang=EN-US style='font-family:"Cambria",serif'>E</span></i><i><sub><span
lang=RU style='font-family:"Cambria",serif'>−1,</span></sub></i><i><sub><span
lang=EN-US style='font-family:"Cambria",serif'>d</span></sub></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>и
формулы (42)–(43) для сложения точек на </span><span lang=EN-US>Ed</span><span
lang=RU>25519 или </span><span lang=EN-US>Curve</span><span lang=RU>25519,
используя (38) и (39) для преобразования точек на </span><span lang=EN-US>Ed</span><span
lang=RU>25519 в соответствующие точки на </span><span lang=EN-US>Curve</span><span
lang=RU>25519, и наоборот.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:0cm;margin-bottom:1.75pt;
margin-left:-.25pt;line-height:103%'><span lang=EN-US>A</span><span lang=RU>.3.6.
Генератор </span><span lang=EN-US>Ed</span><span lang=RU>25519. Генератором </span><span
lang=EN-US>Ed</span><span lang=RU>25519 является точка </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>G</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>с        </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>y</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>G</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’) = 4/5 </span></i><span lang=RU>и </span><span
lang=RU style='font-family:"Cambria",serif'>0 ≤ </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>x</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>G</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’) &lt; </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>p</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>чётным. Согласно
(38), он соответствует точке </span><span lang=RU style='font-family:"Cambria",serif'>(</span><span
lang=EN-US style='font-family:"Cambria",serif'>u</span><span lang=RU
style='font-family:"Cambria",serif'>,</span><span lang=EN-US style='font-family:
"Cambria",serif'>v</span><span lang=RU style='font-family:"Cambria",serif'>) </span><span
lang=EN-US>Curve</span><span lang=RU>25519 с </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>u</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= (1 + 4/5)/(1 − 4/5) = 9 </span><span lang=RU>(т.е.
генератору </span><i><span lang=EN-US style='font-family:"Cambria",serif'>G</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=EN-US>Curve</span><span
lang=RU>25519, выбранному в </span><span lang=EN-US>A</span><span lang=RU>.2.2).
В частности, </span><i><span lang=EN-US style='font-family:"Cambria",serif'>G</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>φ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>G</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’), </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>G</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ </span></i><span lang=RU>порождает
циклическую подгруппу того же большого простого порядка </span><i><span
lang=EN-US>e</span></i><i><span lang=RU style='font-family:"Cambria",serif'>,</span></i><span
lang=RU> заданного в (32), а для любого целого числа </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>a</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>,</span></i></p>

<p class=MsoNormal align=right style='margin-top:0cm;margin-right:-.55pt;
margin-bottom:5.9pt;margin-left:0cm;text-align:right;text-indent:0cm;
line-height:107%'><span lang=RU style='font-size:11.0pt;line-height:107%'>                                                 </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>φ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>([</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>a</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>]</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>G</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’) = [</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>a</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>]</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>G</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>  .                                                 </span></i><span
lang=RU>(45)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Таким образом, мы можем выполнять вычисления
с помощью </span><span lang=EN-US>Curve</span><span lang=RU>25519 и его
генератора </span><i><span lang=EN-US style='font-family:"Cambria",serif'>G</span></i><i><span
lang=RU style='font-family:"Cambria",serif'> или с помощью </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>Ed</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>25519 и генератора </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>G</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>’ и получать по существу те же результаты.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:1.85pt;
margin-left:-.25pt'><span lang=EN-US>A</span><span lang=RU>.3.7. Стандартное
представление точек на </span><span lang=EN-US>Ed</span><span lang=RU>25519.
Точка </span><i><span lang=EN-US style='font-family:"Cambria",serif'>P</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>x</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>,</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>y</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU>на </span><span
lang=EN-US>Ed</span><span lang=RU>25519 может быть представлена двумя ее
координатами </span><i><span lang=EN-US style='font-family:"Cambria",serif'>x<sub>P</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>y<sub>P</sub></span></i><i><span
lang=RU style='font-family:"Cambria",serif'>,</span></i><span lang=RU>
остатками по модулю </span><i><span lang=EN-US style='font-family:"Cambria",serif'>p</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= 2<sup>255</sup> − 19. В свою очередь, обе
эти координаты могут быть представлены беззнаковыми 255- или 256-битными целыми
числами 0 ≤ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>x<sub>P</sub></span></i><i><span
lang=RU style='font-family:"Cambria",serif'>,</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>y<sub>P</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'> &lt; </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>p</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> &lt; </span></i><span lang=RU
style='font-family:"Cambria",serif'>2<sup>255</sup>.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:1.6pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Тем не менее, более
компактное представление </span><i><span lang=EN-US style='font-family:"Cambria",serif'>P</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>одним
младшим порядком байтов без знака 256-битным целым числом </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>P</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> ̃ </span></i><span lang=RU>обычно
используется (и также используется </span><span lang=EN-US>TON</span><span
lang=RU>). А именно, 255 битов нижнего порядка </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>P</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> ̃ </span></i><span lang=RU>содержат </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>y<sub>P</sub></span></i><i><span
lang=RU style='font-family:"Cambria",serif'>,</span></i><span lang=RU> </span><span
lang=RU style='font-family:"Cambria",serif'>0 ≤ </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>y<sub>P</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'> &lt; </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>p</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> &lt; </span></i><span lang=RU
style='font-family:"Cambria",serif'>2<sup>255</sup>, а бит 255 используется для
хранения </span><i><span lang=EN-US style='font-family:"Cambria",serif'>x<sub>P</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=EN-US
style='font-family:"Cambria",serif'>mod</span><span lang=RU style='font-family:
"Cambria",serif'> 2, бита нижнего порядка </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>x<sub>P</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i><span lang=RU> Поскольку </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>y<sub>P</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>всегда
определяет </span><i><span lang=EN-US style='font-family:"Cambria",serif'>x<sub>P</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>до
знака (т.е. вплоть до замены </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>x<sub>P</sub></span></i><i><span lang=EN-US style='font-family:
"Cambria",serif'> </span></i><i><span lang=RU style='font-family:"Cambria",serif'>на
</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>p</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>−</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>x<sub>P</sub></span></i><i><span lang=RU
style='font-family:"Cambria",serif'>)</span></i><span lang=RU>, </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>x<sub>P</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>p</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>−</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>x<sub>P</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>всегда
можно отличить по их биту более низкого порядка, </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>p</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>является
нечетным.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.4pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Если достаточно знать,</span><span
lang=RU style='font-family:"Cambria",serif'> ±</span><span lang=EN-US
style='font-family:"Cambria",serif'>P</span><span lang=EN-US style='font-family:
"Cambria",serif'> </span><span lang=RU>до знака, можно игнорировать </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>x<sub>P</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=EN-US
style='font-family:"Cambria",serif'>mod</span><span lang=RU style='font-family:
"Cambria",serif'> 2 </span><span lang=RU>и рассматривать только 255-битное
целое число </span><span lang=EN-US>y<sub>P</sub></span><span lang=RU> с
младшим порядком байтов</span><i><span lang=RU style='font-family:"Cambria",serif'>,</span></i><span
lang=RU> произвольно устанавливая бит 255, игнорируя его ранее определенное
значение или очищая его.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:3.55pt;
margin-left:-.25pt'><span lang=EN-US>A</span><span lang=RU>.3.8. Закрытый ключ
для </span><span lang=EN-US>Ed</span><span lang=RU>25519. Закрытый <i>ключ </i>для
</span><span lang=EN-US>Ed</span><span lang=RU>25519 — это просто произвольная
256-битная строка </span><i><span lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>. </span></i><i><span lang=RU>Секретная
экспонента </span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>a</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>и <i>секретная
соль </i></span><i><span lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>’’ </span></i><span lang=RU>выводятся
из </span><i><span lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>путем
вычисления </span><span lang=EN-US>sha</span><span lang=RU>512(</span><span
lang=EN-US>k</span><span lang=RU>), а затем принятия первых 256 бит этого </span><span
lang=EN-US>sha</span><span lang=RU>512 в качестве представления с младшим
порядковым </span><i><span lang=RU style='font-family:"Cambria",serif'>числом </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>a</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>(но с очищенными
битами 255, 2, 1 и 0 и набором битов 254); последние 256 бит </span><span
lang=EN-US>sha</span><span lang=RU>512(</span><span lang=EN-US>k</span><span
lang=RU>) затем составляют </span><i><span lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>’’.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:8.75pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>По сути, это та же
процедура, что описана в </span><span lang=EN-US>A</span><span lang=RU>.2.4, но
с заменой </span><span lang=EN-US>Curve</span><span lang=RU>25519 на
бирационно-эквивалентную кривую </span><span lang=EN-US>Ed</span><span lang=RU>25519.
(На самом деле все наоборот: эта процедура является стандартной для
криптографии эллиптических кривых на основе </span><span lang=EN-US>Ed</span><span
lang=RU>25519, и </span><span lang=EN-US>TON</span><span lang=RU> расширяет
процедуру до </span><span lang=EN-US>Curve</span><span lang=RU>25519.)</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=EN-US>A</span><span lang=RU>.3.9. Открытый ключ
для </span><span lang=EN-US>Ed</span><span lang=RU>25519. <i>Открытый ключ,</i>
соответствующий закрытому ключу </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>k</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>для </span><span lang=EN-US>Ed</span><span lang=RU>25519,
является стандартным представлением (ср. </span><span lang=EN-US>A</span><span
lang=RU>.3.7) точки </span><i><span lang=EN-US style='font-family:"Cambria",serif'>A</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= [</span><span lang=EN-US
style='font-family:"Cambria",serif'>a</span><span lang=RU style='font-family:
"Cambria",serif'>]</span><span lang=EN-US style='font-family:"Cambria",serif'>G</span><span
lang=RU style='font-family:"Cambria",serif'>’, где </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>a</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>— секретная
экспонента (ср. </span><span lang=EN-US>A</span><span lang=RU>.3.8),
определяемая закрытым ключом </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>k</span></i><i><span lang=RU style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.75pt;text-indent:17.55pt'><span lang=RU>Обратите внимание, что </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>φ</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>(</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>A</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>) </span></i><span lang=RU>является
открытым ключом для </span><span lang=EN-US>Curve</span><span lang=RU>25519,
определяемым тем же закрытым ключом </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>k</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>в соответствии с </span><span
lang=EN-US>A</span><span lang=RU>.2.4 и (45). Таким образом, мы можем
конвертировать открытые ключи для </span><span lang=EN-US>Ed</span><span
lang=RU>25519 в соответствующие открытые ключи для </span><span lang=EN-US>Curve</span><span
lang=RU>25519, и наоборот. Закрытые ключи вообще не нужно трансформировать.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:12.85pt;
margin-left:-.25pt'><span lang=EN-US>A</span><span lang=RU>.3.10.
Криптографические </span><span lang=EN-US>Ed</span><span lang=RU>25519-подписи.
Если сообщение (строка октета) </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>M</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>должно быть подписано закрытым ключом </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>,</span></i><span lang=RU> определяющим
секретную экспоненту </span><i><span lang=EN-US style='font-family:"Cambria",serif'>a</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>и
секретную соль </span><i><span lang=EN-US style='font-family:"Cambria",serif'>k</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>’’, выполняются следующие
вычисления:</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=EN-US style='font-family:"Cambria",serif'>r</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>:= </span><span lang=EN-US>sha</span><span
lang=RU>512(</span><span lang=EN-US>k</span><span lang=RU>’’| </span><span
lang=EN-US>M</span><span lang=RU>), интерпретируемый как 512-битное целое число
с младшим порядком байтов. Здесь </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>s</span></i><span lang=RU style='font-family:"Cambria",serif'>|</span><i><span
lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>обозначает
сцепление октетовых струн </span><i><span lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>t</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:14.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=EN-US style='font-family:"Cambria",serif'>R</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>:= [</span><span lang=EN-US
style='font-family:"Cambria",serif'>r</span><span lang=RU style='font-family:
"Cambria",serif'>]</span><span lang=EN-US style='font-family:"Cambria",serif'>G</span><span
lang=RU style='font-family:"Cambria",serif'>’ </span><span lang=RU>— точка на </span><span
lang=EN-US>Ed</span><span lang=RU>25519.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=EN-US style='font-family:"Cambria",serif'>R</span></i><i><span
lang=RU style='font-family:"Cambria",serif'> ̃ </span></i><span lang=RU>—
стандартное представление (ср. </span><span lang=EN-US>A</span><span lang=RU>.3.7)
точки </span><i><span lang=EN-US style='font-family:"Cambria",serif'>R</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>в виде
32-октетной струны.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:13.55pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><i><span lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>:= </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>r</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>+ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>a</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>· </span><span lang=EN-US>sha</span><span
lang=RU>512(</span><span lang=EN-US>R</span><span lang=RU> ̃| </span><span
lang=EN-US>A</span><span lang=RU> ̃| </span><span lang=EN-US>M</span><span
lang=RU>) </span><span lang=EN-US>mod</span><span lang=EN-US> </span><i><span
lang=EN-US>e</span></i><i><span lang=RU style='font-family:"Cambria",serif'>,
закодированный как 256-битное целое число байтов. Здесь </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>A</span></i><i><span lang=RU
style='font-family:"Cambria",serif'> ̃ </span></i><span lang=RU>является
стандартным представлением точки </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>A</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU style='font-family:"Cambria",serif'>= [</span><span
lang=EN-US style='font-family:"Cambria",serif'>a</span><span lang=RU
style='font-family:"Cambria",serif'>]</span><span lang=EN-US style='font-family:
"Cambria",serif'>G</span><span lang=RU style='font-family:"Cambria",serif'>’,
открытого ключа, соответствующего </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>k</span></i><i><span lang=RU style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:-.25pt'><span lang=RU>Сигнатура (Шнорра) представляет собой
64-октетную строку </span><span lang=RU style='font-family:"Cambria",serif'>(</span><span
lang=EN-US style='font-family:"Cambria",serif'>R</span><span lang=RU
style='font-family:"Cambria",serif'>,</span><span lang=EN-US style='font-family:
"Cambria",serif'>s</span><span lang=RU style='font-family:"Cambria",serif'> ̃),
состоящую из стандартного представления точки </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>R</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>и 256-битного
целого числа </span><i><span lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>.</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:11.9pt;
margin-left:-.25pt'><span lang=EN-US>A</span><span lang=RU>.3.11. Проверка
подписей </span><span lang=EN-US>Ed</span><span lang=RU>25519. Для проверки
подписи </span><span lang=RU style='font-family:"Cambria",serif'>(</span><span
lang=EN-US style='font-family:"Cambria",serif'>R</span><span lang=RU
style='font-family:"Cambria",serif'>,</span><span lang=EN-US style='font-family:
"Cambria",serif'>s</span><span lang=RU style='font-family:"Cambria",serif'> ̃) </span><span
lang=RU>сообщения </span><i><span lang=EN-US style='font-family:"Cambria",serif'>M</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>, предположительно сделанного
владельцем закрытого ключа </span></i><i><span lang=EN-US style='font-family:
"Cambria",serif'>k</span></i><i><span lang=RU style='font-family:"Cambria",serif'>,</span></i><span
lang=RU> соответствующего известному открытому </span><i><span lang=RU
style='font-family:"Cambria",serif'>ключу </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>A</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>, выполняются следующие шаги:</span></i></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:11.9pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Точки </span><span lang=RU style='font-family:"Cambria",serif'>[</span><span
lang=EN-US style='font-family:"Cambria",serif'>s</span><span lang=RU
style='font-family:"Cambria",serif'>]</span><span lang=EN-US style='font-family:
"Cambria",serif'>G</span><span lang=RU style='font-family:"Cambria",serif'>’ </span><span
lang=RU>и </span><i><span lang=EN-US style='font-family:"Cambria",serif'>R</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>+ [</span><span lang=EN-US
style='font-family:"Cambria",serif'>sha</span><span lang=RU style='font-family:
"Cambria",serif'>512(</span><span lang=EN-US style='font-family:"Cambria",serif'>R</span><span
lang=RU style='font-family:"Cambria",serif'> ̃| </span><span lang=EN-US
style='font-family:"Cambria",serif'>A</span><span lang=RU style='font-family:
"Cambria",serif'> ̃| </span><span lang=EN-US style='font-family:"Cambria",serif'>M</span><span
lang=RU style='font-family:"Cambria",serif'>)]</span><span lang=EN-US
style='font-family:"Cambria",serif'>A</span><span lang=EN-US style='font-family:
"Cambria",serif'> </span><span lang=RU>из </span><span lang=EN-US>Ed</span><span
lang=RU>25519 вычисляются.</span></p>

<p class=MsoNormal style='margin-top:0cm;margin-right:.25pt;margin-bottom:10.65pt;
margin-left:29.3pt;text-indent:-11.85pt'><span lang=RU style='line-height:104%;
font-family:"Cambria",serif'>•<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;
</span></span><span lang=RU>Если эти два пункта совпадают, подпись правильная.</span></p>

</div>

<div><br clear=all>

<hr align=left size=1 width="33%">

<div id=ftn1>

<p class=footnotedescription style='margin-right:2.0pt;text-indent:13.45pt;
line-height:103%'><a href="#_ftnref1" name="_ftn1" title=""><span
class=footnotemark><span lang=EN-US><span class=footnotemark><span lang=EN-US
style='font-size:10.0pt;line-height:104%'>[1]</span></span></span></span></a><span
lang=RU> По состоянию на август 2018 года этот документ не содержит подробного
описания сериализованных доказательств недействительности, поскольку они,
вероятно, значительно изменятся в ходе разработки программного обеспечения
валидатора. Обсуждаются только общие принципы проектирования условий
согласованности и серийных доказательств недействительности.</span></p>

</div>

<div id=ftn2>

<p class=footnotedescription style='text-indent:13.45pt;line-height:113%'><a
href="#_ftnref2" name="_ftn2" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[2]</span></span></span></span></a><span lang=RU> Он не
включен в настоящий вариант настоящего документа, но будет представлен в
отдельном добавлении к будущему пересмотренному варианту.</span></p>

</div>

<div id=ftn3>

<p class=footnotedescription style='text-indent:13.45pt;line-height:103%'><a
href="#_ftnref3" name="_ftn3" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[3]</span></span></span></span></a><span lang=RU> Полностью
идентичные ячейки часто идентифицируются в памяти и в дисковом хранилище;
именно по этой причине деревья клеток прозрачно трансформируются в </span><span
lang=EN-US>DAG</span><span lang=RU> клеток. С этой точки зрения группа
обеспечения доступности баз данных — это просто оптимизация хранилища базового
дерева ячеек, не имеющая значения для большинства соображений.</span></p>

</div>

<div id=ftn4>

<p class=footnotedescription style='text-indent:13.45pt;line-height:113%'><a
href="#_ftnref4" name="_ftn4" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[4]</span></span></span></span></a><span lang=RU> [4,
3.3.3–4], где приведен и объяснен пример в ожидании более полной ссылки</span></p>

</div>

<div id=ftn5>

<p class=footnotedescription style='text-indent:13.45pt;line-height:113%'><a
href="#_ftnref5" name="_ftn5" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[5]</span></span></span></span></a><span lang=RU> Если
транзакций, связанных со счетом, нет, соответствующий виртуальный блок пуст и
опущен в блоке </span><span lang=EN-US>shardchain</span></p>

</div>

<div id=ftn6>

<p class=footnotedescription style='text-indent:13.45pt;line-height:102%'><a
href="#_ftnref6" name="_ftn6" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[6]</span></span></span></span></a><span lang=RU> Напомним,
что </span><span lang=EN-US>TON</span><span lang=EN-US> </span><span
lang=EN-US>Blockchain</span><span lang=RU> поддерживает <i>динамическое </i>шардинг,
поэтому конфигурация сегмента может меняться от блока к блоку из-за событий
слияния и разделения сегментов. Поэтому мы не можем просто сказать, что каждый
шардчейн соответствует фиксированному набору цепей счетов.</span></p>

</div>

<div id=ftn7>

<p class=footnotedescription style='text-indent:13.45pt;line-height:105%'><a
href="#_ftnref7" name="_ftn7" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[7]</span></span></span></span></a><span lang=RU> Это условие
применяется, если существует точно один непосредственный предшественник (т.е.
если событие слияния шардчейна не произошло непосредственно перед
рассматриваемым блоком); в противном случае это состояние становится более
запутанным.</span></p>

</div>

<div id=ftn8>

<p class=footnotedescription style='text-indent:13.45pt;line-height:123%'><a
href="#_ftnref8" name="_ftn8" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[8]</span></span></span></span></a><span lang=RU> Этот пример
немного упрощен, так как не учитывает наличие в </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=RU> транзитных сообщений, которые не обрабатываются какой-либо явной
транзакцией.</span></i></p>

</div>

<div id=ftn9>

<p class=footnotedescription style='margin-right:4.3pt;text-indent:0cm'><a
href="#_ftnref9" name="_ftn9" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[9]</span></span></span></span></a><span lang=RU> Интересно
отметить, что эта часть работы может быть выполнена практически автоматически.</span></p>

</div>

<div id=ftn10>

<p class=footnotedescription style='margin-right:7.5pt;line-height:125%'><a
href="#_ftnref10" name="_ftn10" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[10]</span></span></span></span></a><span lang=RU> Чтобы
правильно выразить это условие при наличии динамического шардинга, следует
зафиксировать некоторый счет </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>ξ</span></i><i><span lang=RU style='font-family:"Cambria",serif'>,
и рассмотреть последние блоки </span></i><i><span lang=EN-US style='font-family:
"Cambria",serif'>S</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>и </span><i><span lang=EN-US style='font-family:"Cambria",serif'>S</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>0 </span></i><span lang=RU>шардчейнов,
содержащих </span><i><span lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>в
конфигурациях оскочек как </span><i><span lang=EN-US style='font-family:"Cambria",serif'>B</span></i><span
lang=RU>, так и </span><i><span lang=EN-US style='font-family:"Cambria",serif'>B</span></i><i><span
lang=RU style='font-family:"Cambria",serif'>0, так как осколки, содержащие </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>ξ</span></i><span lang=EN-US> </span><span
lang=RU>могут отличаться в </span><i><span lang=EN-US style='font-family:"Cambria",serif'>B</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>и </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>B</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>'</span></i></p>

</div>

<div id=ftn11>

<p class=footnotedescription><a href="#_ftnref11" name="_ftn11" title=""><span
class=footnotemark><span lang=EN-US><span class=footnotemark><span lang=EN-US
style='font-size:10.0pt;line-height:104%'>[11]</span></span></span></span></a><span
lang=RU> Значимые сообщения с установленным флагом </span><span lang=EN-US>bounce</span><span
lang=RU> не будут приниматься неинициализированной учетной записью, а будут
«возвращены» обратно.</span></p>

</div>

<div id=ftn12>

<p class=footnotedescription style='margin-right:.05pt;line-height:103%'><a
href="#_ftnref12" name="_ftn12" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[12]</span></span></span></span></a><span lang=RU> «Сообщения
в никуда» могут иметь некоторые специальные поля в своем теле, указывающие на
их назначение за пределами блокчейна </span><span lang=EN-US>TON</span><span
lang=RU> — например, учетная запись в каком-либо другом блокчейне или </span><span
lang=EN-US>IP</span><span lang=RU>-адрес и порт — которые могут быть
соответствующим образом интерпретированы сторонним программным обеспечением.
Такие поля игнорируются блокчейном </span><span lang=EN-US>TON</span><span
lang=RU>.</span></p>

</div>

<div id=ftn13>

<p class=footnotedescription style='margin-right:.05pt;line-height:100%'><a
href="#_ftnref13" name="_ftn13" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[13]</span></span></span></span></a><span lang=RU> Проблема
обхода возможной цензуры валидатора, которая может произойти, например, если
все валидаторы вступают в сговор с целью не включать внешние сообщения,
отправленные на учетные записи, принадлежащие к некоторому набору учетных
записей, занесенных в черный список, рассматривается отдельно в другом месте.
Основная идея заключается в том, что валидаторы могут быть вынуждены пообещать
включить сообщение с известным хэшем в будущий блок, ничего не зная об
идентификации отправителя или получателя; они должны будут сдержать это
обещание впоследствии, когда будет представлено само сообщение с заранее
согласованным хэшем.</span></p>

</div>

<div id=ftn14>

<p class=footnotedescription><a href="#_ftnref14" name="_ftn14" title=""><span
class=footnotemark><span lang=EN-US><span class=footnotemark><span lang=EN-US
style='font-size:10.0pt;line-height:104%'>[14]</span></span></span></span></a><span
lang=RU> Однако внутренний процесс маршрутизации, описанный в 2.1.11,
применяется сразу после этого, что может дополнительно изменить транзитный
адрес.</span></p>

</div>

<div id=ftn15>

<p class=footnotedescription style='margin-right:.05pt;line-height:106%'><a
href="#_ftnref15" name="_ftn15" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[15]</span></span></span></span></a><span lang=RU> Когда
задействованные адреса имеют разную длину (например, потому что они принадлежат
разным рабочим цепочкам), следует учитывать только первые 96 бит адресов в
приведенной выше формуле.</span></p>

</div>

<div id=ftn16>

<p class=footnotedescription style='margin-right:.05pt;line-height:103%'><a
href="#_ftnref16" name="_ftn16" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[16]</span></span></span></span></a><span lang=RU> Вместо
оптимальности Хэмминга мы могли бы рассмотреть эквивалентное свойство <i>оптимальности
Кадемлии, записанное для расстояния Кадемлия (или взвешенного </i></span><i><span
lang=EN-US style='font-family:"Cambria",serif'>L</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>1), заданного </span></i><span lang=RU
style='font-family:"Cambria",serif'>||</span><span lang=EN-US style='font-family:
"Cambria",serif'>ξ</span><span lang=EN-US style='font-family:"Cambria",serif'> </span><span
lang=RU style='font-family:"Cambria",serif'>– </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>η</span></i><span lang=RU style='font-family:
"Cambria",serif'>||</span><i><sub><span lang=EN-US style='font-family:"Cambria",serif'>K</span></sub></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>:= </span><span
lang=EN-US style='font-size:12.0pt;line-height:104%;font-family:"Calibri",sans-serif;
color:black;position:relative;top:4.0pt'><img width=18 height=15
src="tblkch_convertio_ru_done.fld/image026.jpg"></span><i><sup><span lang=RU
style='font-family:"Cambria",serif'>-</span></sup></i><i><sup><span lang=EN-US
style='font-family:"Cambria",serif'>i</span></sup></i><span lang=RU
style='font-family:"Cambria",serif'>|</span><span lang=EN-US style='font-family:
"Cambria",serif'>ξ<sub>i</sub></span><span lang=RU style='font-family:"Cambria",serif'>
– </span><span lang=EN-US style='font-family:"Cambria",serif'>η<sub>i</sub></span><span
lang=RU style='font-family:"Cambria",serif'>|</span><span lang=RU
style='line-height:103%;font-family:"Cambria",serif'> </span><span lang=RU>вместо
расстояния Хэмминга.</span></p>

</div>

<div id=ftn17>

<p class=footnotedescription style='margin-right:.05pt;line-height:106%'><a
href="#_ftnref17" name="_ftn17" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[17]</span></span></span></span></a><span lang=RU> Обратите
внимание, что вычисления </span><span lang=EN-US>next</span><span lang=RU>-</span><span
lang=EN-US>hop</span><span lang=RU> и внутренней маршрутизации по-прежнему
применяются к таким сообщениям, так как текущая </span><span lang=EN-US>shardchain</span><span
lang=RU> может быть разделена перед обработкой сообщения. В этом случае новая
подшардцепь, содержащая адрес назначения, унаследует сообщение.</span></p>

</div>

<div id=ftn18>

<p class=footnotedescription style='margin-right:.05pt;line-height:113%'><a
href="#_ftnref18" name="_ftn18" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[18]</span></span></span></span></a><span lang=RU> Мы можем
определить (виртуальную) очередь вывода учетной записи (цепочки) как
подмножество </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=EN-US> </span></i><span lang=RU>сегмента, в настоящее время содержащего
эту учетную запись, которая состоит из сообщений с транзитными адресами,
равными адресу учетной записи.</span></p>

</div>

<div id=ftn19>

<p class=footnotedescription style='line-height:113%'><a href="#_ftnref19"
name="_ftn19" title=""><span class=footnotemark><span lang=EN-US><span
class=footnotemark><span lang=EN-US style='font-size:10.0pt;line-height:104%'>[19]</span></span></span></span></a><span
lang=RU> В частности, если хэш недавнего блока соседнего шардчейна еще не
отражен в последнем блоке мастерчейна, то его модификации </span><i><span
lang=EN-US>OutMsgQueue</span></i><i><span lang=EN-US> </span></i><span lang=RU>не
должны приниматься во внимание.</span></p>

</div>

<div id=ftn20>

<p class=footnotedescription style='text-indent:0cm'><a href="#_ftnref20"
name="_ftn20" title=""><span class=footnotemark><span lang=EN-US><span
class=footnotemark><span lang=EN-US style='font-size:10.0pt;line-height:104%'>[20]</span></span></span></span></a><span
lang=RU> Это утверждение не так тривиально, как кажется на первый взгляд,
потому что некоторые из шардчейнов</span></p>

</div>

<div id=ftn21>

<p class=footnotedescription style='line-height:105%'><a href="#_ftnref21"
name="_ftn21" title=""><span class=footnotemark><span lang=EN-US><span
class=footnotemark><span lang=EN-US style='font-size:10.0pt;line-height:104%'>[21]</span></span></span></span></a><span
lang=RU> Необходимо не только искать ключ </span><span lang=EN-US>Hash</span><span
lang=RU>(</span><span lang=EN-US>m</span><span lang=RU>) в </span><i><span
lang=EN-US>InMsgDescr</span></i><i><span lang=EN-US> </span></i><span lang=RU>этих
блоков, но и проверять промежуточные адреса в конверте соответствующей записи,
если они найдены.</span></p>

</div>

<div id=ftn22>

<p class=footnotedescription style='margin-right:5.1pt;line-height:110%'><a
href="#_ftnref22" name="_ftn22" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[22]</span></span></span></span></a><span lang=RU> Описание
более старой версии </span><span lang=EN-US>TL</span><span lang=RU> можно найти
на </span><span lang=EN-US><a href="https://core.telegram.org/mtproto/TL"><span
style='color:black;text-decoration:none'>https</span><span lang=RU
style='color:black;text-decoration:none'>://</span><span style='color:black;
text-decoration:none'>core</span><span lang=RU style='color:black;text-decoration:
none'>.</span><span style='color:black;text-decoration:none'>telegram</span><span
lang=RU style='color:black;text-decoration:none'>. </span></a><a
href="https://core.telegram.org/mtproto/TL"><span style='color:black;
text-decoration:none'>org</span><span lang=RU style='color:black;text-decoration:
none'>/</span><span style='color:black;text-decoration:none'>mtproto</span><span
lang=RU style='color:black;text-decoration:none'>/</span><span
style='color:black;text-decoration:none'>TL</span></a><a
href="https://core.telegram.org/mtproto/TL"><span lang=RU style='color:black;
text-decoration:none'>. </span></a></span><span lang=RU> В качестве
альтернативы неофициальное введение в схемы </span><span lang=EN-US>TL</span><span
lang=RU>-</span><span lang=EN-US>B</span><span lang=RU> можно найти в [4,
3.3.4].</span></p>

</div>

<div id=ftn23>

<p class=footnotedescription style='margin-right:5.1pt;line-height:108%'><a
href="#_ftnref23" name="_ftn23" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[23]</span></span></span></span></a><span lang=EN-US> </span><i><span
lang=RU>Переписывание адресов </span></i><span lang=RU>— это функция,
используемая для реализации «адресов </span><span lang=EN-US>anycast</span><span
lang=RU>», используемых так называемыми <i>большими </i>или <i>глобальными </i>смарт-контрактами
(см. [3, 2.3.18]), которые могут иметь экземпляры в нескольких шардчейнах.
Когда переписывание адресов включено, сообщение может быть перенаправлено и
обработано смарт-контрактом с адресом, совпадающим с адресом назначения до
первых </span><i><span lang=RU style='font-family:"Cambria",serif'>битов </span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'>d</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>,</span></i><span lang=RU> где </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>d</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>≤ 32 </span><span lang=RU>— «глубина расщепления»
смарт-контракта, указанная в поле </span><span lang=EN-US>anycast</span><span
lang=RU>.</span><span lang=EN-US>depth</span><span lang=RU> (см. 2.1.7). В
противном случае адреса должны точно совпадать.</span></p>

</div>

<div id=ftn24>

<p class=footnotedescription style='margin-right:5.1pt;line-height:107%'><a
href="#_ftnref24" name="_ftn24" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[24]</span></span></span></span></a><span lang=RU> Точнее,
информация из поля </span><span lang=EN-US>init</span><span lang=RU> входящего
сообщения используется либо тогда, когда принимающая учетная запись не
инициализирована или заморожена с хэшем </span><i><span lang=EN-US>StateInit</span></i><i><span
lang=RU>,</span></i><span lang=RU> равным ожидаемому учетной записью, либо
когда принимающая учетная запись активна, а ее код или данные являются внешней
хэш-ссылкой, соответствующей хэшу кода или данным, полученным в </span><i><span
lang=EN-US>StateInit</span></i><i><span lang=EN-US> </span></i><span lang=RU>сообщения.</span></p>

</div>

<div id=ftn25>

<p class=footnotedescription style='line-height:106%'><a href="#_ftnref25"
name="_ftn25" title=""><span class=footnotemark><span lang=EN-US><span
class=footnotemark><span lang=EN-US style='font-size:10.0pt;line-height:104%'>[25]</span></span></span></span></a><span
lang=RU> Строго говоря, </span><i><span lang=EN-US>InMsgDescr</span></i><i><span
lang=EN-US> </span></i><span lang=RU>является <i>типом </i>этой структуры; мы
намеренно используем одну и ту же нотацию для описания единственного экземпляра
этого типа в блоке.</span></p>

</div>

<div id=ftn26>

<p class=footnotedescription align=left style='margin-left:9.5pt;text-align:
left;text-indent:0cm'><a href="#_ftnref26" name="_ftn26" title=""><span
class=footnotemark><span lang=EN-US><span class=footnotemark><span lang=EN-US
style='font-size:10.0pt;line-height:104%'>[26]</span></span></span></span></a><span
lang=RU> Напомним, что шардчейн считается соседом самого себя.</span></p>

</div>

<div id=ftn27>

<p class=footnotedescription style='margin-right:.45pt;line-height:113%'><a
href="#_ftnref27" name="_ftn27" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[27]</span></span></span></span></a><span lang=RU> Такая
ситуация встречается редко и возникает только после событий слияния шардчейнов.
Обычно сообщения, импортированные из </span><i><span lang=EN-US>OutMsgQueue</span></i><i><span
lang=EN-US> </span></i><span lang=RU>того же </span><span lang=EN-US>shardchain</span><span
lang=RU>, имеют места назначения внутри этого </span><span lang=EN-US>shardchain</span><span
lang=RU> и обрабатываются соответствующим образом, а не повторно ставятся в
очередь.</span></p>

</div>

<div id=ftn28>

<p class=footnotedescription style='line-height:123%'><a href="#_ftnref28"
name="_ftn28" title=""><span class=footnotemark><span lang=EN-US><span
class=footnotemark><span lang=EN-US style='font-size:10.0pt;line-height:104%'>[28]</span></span></span></span></a><span
lang=RU> Для простоты мы иногда рассматриваем мастерчейн как просто еще одну
рабочую цепь с </span><i><span lang=EN-US>workchain</span></i><i><span lang=RU>_</span><span
lang=EN-US>id</span></i><i><span lang=EN-US> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= −1.</span></p>

</div>

<div id=ftn29>

<p class=footnotedescription style='margin-right:4.25pt;line-height:115%'><a
href="#_ftnref29" name="_ftn29" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[29]</span></span></span></span></a><span lang=RU>
Фактически, до первых </span><i><span lang=EN-US style='font-family:"Cambria",serif'>d</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>биты
заменяются таким образом, что каждый сегмент содержит не более одного
экземпляра большого смарт-контракта, и что сегменты </span><span lang=RU
style='font-family:"Cambria",serif'>(</span><span lang=EN-US style='font-family:
"Cambria",serif'>w</span><span lang=RU style='font-family:"Cambria",serif'>,</span><span
lang=EN-US style='font-family:"Cambria",serif'>s</span><span lang=RU
style='font-family:"Cambria",serif'>) </span><span lang=RU>с префиксом </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>s</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU>длины </span><span
lang=RU style='font-family:"Cambria",serif'>|</span><span lang=EN-US
style='font-family:"Cambria",serif'>s</span><span lang=RU style='font-family:
"Cambria",serif'>| ≤ </span><i><span lang=EN-US style='font-family:"Cambria",serif'>d</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>содержат
ровно один экземпляр.</span></p>

</div>

<div id=ftn30>

<p class=footnotedescription style='line-height:124%'><a href="#_ftnref30"
name="_ftn30" title=""><span class=footnotemark><span lang=EN-US><span
class=footnotemark><span lang=EN-US style='font-size:10.0pt;line-height:104%'>[30]</span></span></span></span></a><span
lang=RU> В этой схеме используются анонимные конструкторы и анонимные поля,
представленные символом подчеркивания _.</span></p>

</div>

<div id=ftn31>

<p class=footnotedescription style='margin-right:8.2pt;line-height:108%'><a
href="#_ftnref31" name="_ftn31" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[31]</span></span></span></span></a><span lang=RU> В
частности, если пользователь по ошибке отправит некоторые средства на
несуществующий адрес в отказываемом сообщении, средства не будут потрачены
впустую, а скорее будут возвращены (возвращены) обратно. Поэтому приложение
кошелька пользователя должно устанавливать флаг возврата во всех
сгенерированных сообщениях по умолчанию, если явно не указано иное. Однако в
некоторых ситуациях сообщения, не подлежащие отражению, необходимы (см. 1.7.6).</span></p>

</div>

<div id=ftn32>

<p class=footnotedescription style='margin-right:8.2pt;line-height:103%'><a
href="#_ftnref32" name="_ftn32" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[32]</span></span></span></span></a><span lang=RU> Эталонная
реализация эмулятора </span><span lang=EN-US>TVM</span><span lang=RU>,
работающего в урезанной версии </span><span lang=EN-US>TVM</span><span lang=RU>,
может быть зафиксирована в мастерчейне для использования при возникновении
разногласий между валидаторами по конкретному запуску </span><span lang=EN-US>TVM</span><span
lang=RU>. Таким образом, могут быть обнаружены дефектные реализации </span><span
lang=EN-US>TVM</span><span lang=RU>. Затем эталонная реализация служит
авторитетной</span></p>

<p class=footnotedescription align=left style='text-align:left;text-indent:
0cm'><span lang=RU>источник по оперативной семантике ТВМ. (См. [4, В.2])</span></p>

</div>

<div id=ftn33>

<p class=footnotedescription style='line-height:119%'><a href="#_ftnref33"
name="_ftn33" title=""><span class=footnotemark><span lang=EN-US><span
class=footnotemark><span lang=EN-US style='font-size:10.0pt;line-height:104%'>[33]</span></span></span></span></a><span
lang=RU> Обратите внимание, что эта запись не представляет собой изменение
состояния учетной записи, поскольку транзакция все еще может быть прервана на
этапе действия. В этом случае новые постоянные данные, на которые косвенно
ссылается </span><span lang=EN-US>vm</span><span lang=RU>_</span><span
lang=EN-US>final</span><span lang=RU>_</span><span lang=EN-US>state</span><span
lang=RU>_</span><span lang=EN-US>hash</span><span lang=RU>, будут отброшены.</span></p>

</div>

<div id=ftn34>

<p class=footnotedescription align=left style='text-align:left;line-height:
113%'><a href="#_ftnref34" name="_ftn34" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[34]</span></span></span></span></a><span lang=RU> Наиболее
распространенным способом создания разделяемых библиотек для </span><span
lang=EN-US>TVM</span><span lang=RU> является публикация ссылки на корневую
ячейку библиотеки в мастерчейне.</span></p>

</div>

<div id=ftn35>

<p class=footnotedescription style='margin-right:1.95pt;line-height:106%'><a
href="#_ftnref35" name="_ftn35" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[35]</span></span></span></span></a><span lang=RU> Постоянные
данные смарт-контракта не должны загружаться полностью, чтобы это произошло.
Вместо этого загружается корень, и </span><span lang=EN-US>TVM</span><span
lang=RU> может загружать другие ячейки своими ссылками из корня только при
доступе к ним, обеспечивая тем самым форму виртуальной памяти.</span></p>

</div>

<div id=ftn36>

<p class=footnotedescription style='line-height:113%'><a href="#_ftnref36"
name="_ftn36" title=""><span class=footnotemark><span lang=EN-US><span
class=footnotemark><span lang=EN-US style='font-size:10.0pt;line-height:104%'>[36]</span></span></span></span></a><span
lang=RU> Как глобальный лимит газа, так и цена на газ являются настраиваемыми
параметрами, определяемыми текущим состоянием мастерчейна.</span></p>

</div>

<div id=ftn37>

<p class=footnotedescription style='line-height:102%'><a href="#_ftnref37"
name="_ftn37" title=""><span class=footnotemark><span lang=EN-US><span
class=footnotemark><span lang=EN-US style='font-size:10.0pt;line-height:104%'>[37]</span></span></span></span></a><span
lang=RU> В принципе, экспериментальная версия </span><span lang=EN-US>TON</span><span
lang=EN-US> </span><span lang=EN-US>Blockchain</span><span lang=RU> может
предпочесть сохранить только хэши начального и конечного состояний шардчейна.
Обновление </span><span lang=EN-US>Merkle</span><span lang=RU> увеличивает
размер блока, но оно удобно для полных узлов, которые хотят сохранить и
обновить свою копию состояния </span><span lang=EN-US>shardchain</span><span
lang=RU>. В противном случае полным узлам пришлось бы повторять все вычисления,
содержащиеся в блоке, чтобы самостоятельно вычислить обновленное состояние </span><span
lang=EN-US>shardchain</span><span lang=RU>.</span></p>

</div>

<div id=ftn38>

<p class=footnotedescription style='line-height:103%'><a href="#_ftnref38"
name="_ftn38" title=""><span class=footnotemark><span lang=EN-US><span
class=footnotemark><span lang=EN-US style='font-size:10.0pt;line-height:104%'>[38]</span></span></span></span></a><span
lang=RU> Обратите внимание, что эти «отсутствующие ячейки» отличаются от
библиотечных ссылочных и внешних ссылочных ячеек, которые являются
разновидностями экзотических ячеек (ср. [4, 3.1.7]). Отсутствующие клетки,
напротив, вводятся только с целью сериализации неполных мешков клеток и никогда
не могут быть обработаны </span><span lang=EN-US>TVM</span><span lang=RU>.</span></p>

</div>

<div id=ftn39>

<p class=footnotedescription align=left style='text-align:left;line-height:
105%'><a href="#_ftnref39" name="_ftn39" title=""><span class=footnotemark><span
lang=EN-US><span class=footnotemark><span lang=EN-US style='font-size:10.0pt;
line-height:104%'>[39]</span></span></span></span></a><span lang=RU> Обратите
внимание, что экзотические ячейки (с </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>s</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 1) всегда имеют </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>b</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU style='font-family:"Cambria",serif'>≥ 8, причем тип
ячейки закодирован в первых восьми битах данных (ср. [4, 3.1.7]).</span></p>

</div>

<div id=ftn40>

<p class=footnotedescription style='line-height:113%'><a href="#_ftnref40"
name="_ftn40" title=""><span class=footnotemark><span lang=EN-US><span
class=footnotemark><span lang=EN-US style='font-size:10.0pt;line-height:104%'>[40]</span></span></span></span></a><span
lang=RU> Если мешок клеток не является полным, некоторые из этих клеточных
ссылок могут относиться к клеткам </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>c</span></i><i><span lang=RU style='font-family:"Cambria",serif'>’,</span></i><span
lang=RU> отсутствующим в сумке клеток. В этом случае специальные «отсутствующие
ячейки» с </span><i><span lang=EN-US style='font-family:"Cambria",serif'>r</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= 7 </span><span lang=RU>включаются в мешок
клеток и им присваиваются некоторые индексы </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>j</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>. Эти индексы затем используются для
представления ссылок на отсутствующие ячейки.</span></i></p>

</div>

<div id=ftn41>

<p class=footnotedescription style='line-height:119%'><a href="#_ftnref41"
name="_ftn41" title=""><span class=footnotemark><span lang=EN-US><span
class=footnotemark><span lang=EN-US style='font-size:10.0pt;line-height:104%'>[41]</span></span></span></span></a><span
lang=RU> Арифметический модуль </span><i><span lang=EN-US style='font-family:
"Cambria",serif'>p</span></i><i><span lang=EN-US style='font-family:"Cambria",serif'>
</span></i><span lang=RU>для модуля </span><span lang=EN-US>p</span><span
lang=EN-US> </span><span lang=RU>вблизи степени два может быть реализован очень
эффективно. С другой стороны, остатки по модулю </span><span lang=RU
style='font-family:"Cambria",serif'>2255 − 19 </span><span lang=RU>могут быть
представлены 255-битными целыми числами. Именно по этой причине именно это
значение </span><i><span lang=EN-US style='font-family:"Cambria",serif'>p</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>было
выбрано Д. Бернштейном.</span></p>

</div>

<div id=ftn42>

<p class=footnotedescription style='margin-top:0cm;margin-right:4.35pt;
margin-bottom:2.3pt;margin-left:0cm;text-indent:0cm'><a href="#_ftnref42"
name="_ftn42" title=""><span class=footnotemark><span lang=EN-US><span
class=footnotemark><span lang=EN-US style='font-size:10.0pt;line-height:104%'>[42]</span></span></span></span></a><span
lang=RU> Собственно, Д. Бернштейн выбрал </span><i><span lang=EN-US
style='font-family:"Cambria",serif'>A</span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'> </span></i><span lang=RU style='font-family:
"Cambria",serif'>= 486662 </span><span lang=RU>потому что это наименьшее
положительное целое число.</span></p>

<p class=footnotedescription style='margin-right:4.35pt;text-indent:0cm;
line-height:132%'><i><span lang=RU style='font-family:"Cambria",serif'>А </span></i><span
lang=RU style='font-family:"Cambria",serif'>≡ 2 (</span><span lang=EN-US
style='font-family:"Cambria",serif'>mod</span><span lang=RU style='font-family:
"Cambria",serif'> 4) </span><span lang=RU>таким образом, что и соответствующая
кривая Монтгомери (31) над </span><span lang=EN-US>F<sub>p</sub></span><span
lang=RU> для </span><i><span lang=EN-US style='font-family:"Cambria",serif'>p</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>= 2<sup>255</sup> −19,</span><span lang=RU>
и квадратичная кривая этой кривой имеют небольшие кофакторы. Такое расположение
позволяет избежать необходимости проверять, определяет ли </span><i><span
lang=EN-US style='font-family:"Cambria",serif'>x</span></i><i><span lang=RU
style='font-family:"Cambria",serif'>-координата </span></i><i><span lang=EN-US
style='font-family:"Cambria",serif'>x<sub>P</sub></span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU
style='font-family:"Cambria",serif'>∈ </span><span lang=EN-US>F<sub>p</sub></span><span
lang=RU> точки </span><i><span lang=EN-US style='font-family:"Cambria",serif'>P</span></i><i><span
lang=EN-US style='font-family:"Cambria",serif'> </span></i><span lang=RU>точку </span><span
lang=RU style='font-family:"Cambria",serif'>(</span><span lang=EN-US
style='font-family:"Cambria",serif'>x<sub>P</sub></span><span lang=RU
style='font-family:"Cambria",serif'>, </span><span lang=EN-US style='font-family:
"Cambria",serif'>y<sub>P</sub></span><span lang=RU style='font-family:"Cambria",serif'>)
∈ </span><span lang=EN-US>F</span><sup><span lang=RU>2</span></sup><sub><span
lang=EN-US>p</span></sub><span lang=RU>, лежащую на самой кривой Монтгомери или
на ее квадратичном скручивании.</span></p>

</div>

</div>

</body>

</html>
